<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>CS Calendar - LIFF Popup</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    label { display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 8px; margin-top: 4px; }
    button { margin-top: 12px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #45a049; }
    select, input[type="text"], input[type="number"] {font-size: 20px; height: 44px; }
      /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ scroll ‡∏ä‡πâ‡∏≤ */
    select[multiple] {height: 300px; overflow-y: auto; scroll-behavior: smooth; }
  </style>
</head>
<body>
  <h2>üìÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô / ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô (Multiple booking)</h2>
  <form id="saveForm">
    <label>Name:   (On PC push Ctrl + select Name  for multiple select)
      <select name="name" id="nameDropdown" multiple required>
        <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î --</option>
      </select>
    </label>
    <label>Year: <input type="number" name="year" id="yearInput" required></label>
    <label>Month: <input type="number" name="month" id="monthInput" required></label>
    <label>Date:   (On PC push Ctrl + select date  for multiple select)
      <select name="date" id="dateSelect" multiple required size="30">
        <script>for (let i = 1; i <= 31; i++) document.write(`<option value="${i}">${i}</option>`);</script>
      </select>
    </label>
    <label>Type:
      <select name="type">
        <option value="Service">Service</option>
        <option value="Standby">Standby</option>
        <option value="Telephone">Telephone</option>
        <option value="Meeting">Meeting</option>
        <option value="Inspection">Inspection</option>
        <option value="TrainingSafety">TrainingSafety</option>
        <option value="Training">Training</option>
        <option value="LTC">LTC</option>
        <option value="Warranty">Warranty</option>
        <option value="RepairPP">RepairPP</option>
        <option value="Sales">Sales</option>
        <option value="Holiday">Holiday</option>
        <option value="Leave">Leave</option>
        <option value="SafetyHealth">SafetyHealth</option>
        <option value="Other">Other</option>
      </select>
    </label>
    <label>Customer: <input type="text" name="customer"></label>
    <label>Time: <input type="text" name="time"></label>
    <label>Detail: <input type="text" name="datail"></label>
    <label>Place: <input type="text" name="place"></label>
    <label>Job Owner: <input type="text" name="jobowner"></label>
    <label>Charge:
      <select name="charge">
        <option value="Nocharge">Nocharge</option>
        <option value="Charge">Charge</option>
        <option value="Warranty">Warranty</option>
        <option value="Sales">Sales</option>
        <option value="Other">Other</option>
      </select>
    </label>
    <input type="hidden" name="action" value="save">
    <input type="checkbox" id="popupSendEmail">
    <label for="popupSendEmail">Send e-mail</label><br>
    <button type="submit">Save</button>
  </form>

  <div id="result"></div>

  <script>
    const GOOGLE_SHEET_NAMES_URL = 'https://script.google.com/macros/s/AKfycbzr7NVLwYbYDQfaF6Y5SWWwlpKKLnIp_KZUQ8NF9_gXUj7R3tmSEum7yS_Z_A5y23Wi/exec';
    const SUBMIT_URL = 'https://script.google.com/macros/s/AKfycbzr7NVLwYbYDQfaF6Y5SWWwlpKKLnIp_KZUQ8NF9_gXUj7R3tmSEum7yS_Z_A5y23Wi/exec';

    async function loadNames() {
      try {
        const res = await fetch(GOOGLE_SHEET_NAMES_URL);
        const names = await res.json();
        const dropdown = document.getElementById('nameDropdown');
        dropdown.innerHTML = names.map(n => `<option value="${n}">${n}</option>`).join('');
      } catch (err) {
        console.error("Error loading names:", err);
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ");
      }
    }

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const now = new Date();
    document.getElementById('yearInput').value = now.getFullYear();
    document.getElementById('monthInput').value = now.getMonth() + 1;

    document.getElementById('saveForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const submitBtn = this.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = "Saving...";

      const form = new FormData(this);
      const names = Array.from(document.getElementById("nameDropdown").selectedOptions).map(opt => opt.value);
      const dates = Array.from(document.getElementById("dateSelect").selectedOptions).map(opt => opt.value);
      const sendEmailChecked = document.getElementById("popupSendEmail").checked;
      let count = 0;
      for (const name of names) {
        for (const date of dates) {
          const copy = new FormData();
          for (let [key, val] of form.entries()) {
            copy.append(key, val);
          }
          copy.set("name", name);
          copy.set("date", date);
          copy.set("sendEmail", sendEmailChecked ? "true" : "false"); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

          await fetch(SUBMIT_URL, {
            method: 'POST',
            body: copy
          });

          count++;
        }
      }

      document.getElementById("result").textContent = `‚úÖ ${count} Job Saved`;
      if (liff && liff.closeWindow) liff.closeWindow();
 
      // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      submitBtn.disabled = false;
      submitBtn.textContent = "Saved";
      setTimeout(() => location.reload(), 1500);
    });

    loadNames();
  </script>
</body>
</html>
