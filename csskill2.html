<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skills Table (Google Sheet → CSV)</title>
  <style>
    :root{
      --sticky-left-0:0px;--sticky-left-1:0px;
      --head1:40px; /* set by JS */
      --row-h:40px;
      --c-bg:#ffffff;--c-fg:#0f172a;--c-line:#e5e7eb;--c-head-bg:#111827;--c-head-fg:#ffffff;
      --danger:#ef4444; --accent:#2563eb;
      --edited-bg:#fff7ed; --edited-border:#fb923c;
    }
    html,body{height:100%;margin:0}
    body{background:var(--c-bg);color:var(--c-fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
    .wrap{width:100vw;max-width:none;margin:0;padding:12px}
    .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:4px 0 8px;flex-wrap:wrap}
    .rowadd{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .rowadd input{height:40px;border:1px solid #d1d5db;border-radius:10px;padding:0 12px;width:min(260px,38vw)}
    .btn{height:36px;border:1px solid #d1d5db;background:var(--accent);color:#fff;border-radius:10px;padding:0 12px;cursor:pointer}
    .btn.danger{background:var(--danger);border-color:#dc2626}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .table-shell{border:1px solid var(--c-line);border-radius:12px;overflow:hidden;background:#fff;height:calc(100vh - 106px)}
    .scroll{overflow:auto;width:100%;height:calc(100% - 40px)}
    table{border-collapse:separate;border-spacing:0;min-width:1100px;width:100%}
    thead th{position:sticky;top:0;background:var(--c-head-bg);color:var(--c-head-fg);z-index:4;border-bottom:1px solid var(--c-line);font-weight:700}
    thead tr:nth-child(1) th{top:0}
    thead tr:nth-child(2) th{top:var(--head1)}
    th,td{padding:8px 10px;border-right:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb;height:var(--row-h);white-space:nowrap}
    tbody tr:nth-child(odd) td{background:#fafafa}
    .sticky-col-0{position:sticky;left:var(--sticky-left-0);z-index:3;background:#f8fafc}
    .sticky-col-1{position:sticky;left:var(--sticky-left-1);z-index:3;background:#f8fafc}
    thead .sticky-col-0, thead .sticky-col-1{z-index:5;background:var(--c-head-bg)}
    select.skill{height:30px;border-radius:8px;background:#fff;color:#111827;border:1px solid #d1d5db;padding:0 6px;width:64px}
    td.edited{ background: var(--edited-bg); box-shadow: inset 0 0 0 2px var(--edited-border); }
    .foot{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;height:40px;border-top:1px solid var(--c-line);background:#f9fafb}
    .legend{display:flex;gap:10px;align-items:center}
    .legend .chip{display:inline-block;width:14px;height:14px;border-radius:4px;background:var(--edited-bg);box-shadow: inset 0 0 0 2px var(--edited-border)}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 6px">ตารางสกิลจาก Google Sheet</h1>

    <div class="bar">
      <div class="rowadd">
        <input id="newBranch" placeholder="branch" />
        <input id="newName" placeholder="name" />
        <button class="btn" id="addRowBtn">เพิ่ม</button>
        <button class="btn danger" id="delByNameBtn">ลบด้วยชื่อ</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="saveBtn">บันทึกการเปลี่ยนแปลง</button>
        <span id="saving" style="display:none;color:#2563eb;margin-left:8px">กำลังทำงาน…</span>
      </div>
    </div>

    <div class="table-shell">
      <div class="scroll" id="scroller">
        <table id="grid"><thead id="thead"></thead><tbody id="tbody"></tbody></table>
      </div>
      <div class="foot">
        <small>คอลัมน์ <b>name</b> และ <b>branch</b> ถูกตรึงไว้ — หัวตาราง 2 แถวจะติดอยู่ด้านบนเมื่อเลื่อน</small>
        <div class="legend"><span class="chip"></span><small>เซลที่แก้ (รอเซฟ)</small></div>
      </div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const SHEET_ID = '1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k';
  const GID = '0';
  const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;
  // ใช้ URL /exec ล่าสุดจาก Deploy Web App
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbyKXUiyvt_LHeRBSiWyOinkdK3w-OSlkpLwXbSwHIjWgXW9ACycZio_TTKu6nC-HUSExA/exec';

  // ====== STATE ======
  let header1=[], header2=[], rows=[];
  const edits=new Map();          // sheetRowIndex (0-based from start of sheet) -> updated row array
  const editedCells=new Set();    // 'rIdx|cIdx' เพื่อคงไฮไลต์ข้าม re-render
  const inflight={ add:false, save:false, del:false }; // กันกดซ้ำ

  const thead=document.getElementById('thead');
  const tbody=document.getElementById('tbody');

  // ====== HELPERS ======
  function makeRequestId(){ return 'req_'+Date.now()+'_'+Math.random().toString(36).slice(2,8); }

  async function fetchCsvRows(){
    const res=await fetch(CSV_URL,{cache:'no-store'});
    const text=await res.text();
    const data=Papa.parse(text,{skipEmptyLines:false}).data;
    return (data||[]).slice(2); // ตัด 2 แถวหัว
  }

  // ตรวจว่า append แล้วแถวโผล่จริงไหม
  async function verifyAppend(name, branch){
    try{
      const rowsNow = await fetchCsvRows();
      return rowsNow.some(r => String(r[0]||'').trim()===name && String(r[1]||'').trim()===branch);
    }catch{ return false; }
  }

  // ตรวจว่า delete by name แล้วไม่เหลือชื่อนี้แล้ว
  async function verifyDeleteByName(nameLC){
    try{
      const rowsNow = await fetchCsvRows();
      return !rowsNow.some(r => String(r[0]||'').trim().toLowerCase()===nameLC);
    }catch{ return false; }
  }

  // ตรวจว่า update แล้วค่าตรงตามที่แก้ (เช็คทุกแถวใน payload)
  async function verifyUpdates(updates){
    try{
      const rowsNow = await fetchCsvRows();
      // สร้างดัชนี name||branch -> row array
      const map = new Map();
      rowsNow.forEach(r=>{
        const key = (String(r[0]||'').trim().toLowerCase()+'||'+String(r[1]||'').trim().toLowerCase());
        map.set(key, r);
      });
      return updates.every(u=>{
        const vals = u.rowValues||[];
        const key = (String(vals[0]||'').trim().toLowerCase()+'||'+String(vals[1]||'').trim().toLowerCase());
        const actual = map.get(key);
        if(!actual) return false;
        // เทียบเฉพาะช่วงความยาวที่แก้
        for(let i=0;i<vals.length;i++){
          if(String(actual[i]??'') !== String(vals[i]??'')) return false;
        }
        return true;
      });
    }catch{ return false; }
  }

  // ====== LOAD CSV ======
  async function loadCsv(){
    try{
      const rowsNow = await fetchCsvRows();
      const resHead=await fetch(CSV_URL,{cache:'no-store'});
      const text=await resHead.text();
      const data=Papa.parse(text,{skipEmptyLines:false}).data;
      header1=data[0]||[]; header2=data[1]||[]; rows=rowsNow;
      render();
    }catch(err){
      console.error(err);
      alert('โหลดตารางไม่สำเร็จ: '+err.message+'\nโปรดตรวจสอบสิทธิ์ของไฟล์ Google Sheet และลิงก์ CSV');
      thead.innerHTML=''; tbody.innerHTML='';
    }
  }

  function render(){
    renderHeader(header1,header2);
    renderBody();
    requestAnimationFrame(()=>{updateStickyLefts();fixHeaderTop();});
  }

  // ====== HEADER (merge-aware) ======
  function renderHeader(h1,h2){
    const tr1=document.createElement('tr');
    const tr2=document.createElement('tr');
    const n=Math.max(h1.length,h2.length);
    let i=0;
    while(i<n){
      const title=(h1[i]??'').trim();
      if(i===0||i===1){
        const th=document.createElement('th');
        th.textContent= title || (i===0?'name':'branch');
        th.classList.add(i===0?'sticky-col-0':'sticky-col-1');
        th.setAttribute('rowspan',2); tr1.appendChild(th); i++; continue;
      }
      if(!title){ const th=document.createElement('th'); th.setAttribute('rowspan',2); tr1.appendChild(th); i++; continue; }
      let j=i+1; while(j<n && (h1[j]??'').trim()==='') j++;
      const groupEnd=j, colspan=Math.max(1,groupEnd-i);
      let hasSub=false; for(let k=i;k<groupEnd;k++){ if((h2[k]??'').trim()!==''){hasSub=true;break;} }
      const thGroup=document.createElement('th'); thGroup.textContent=title;
      if(hasSub){ thGroup.setAttribute('colspan',colspan); } else { thGroup.setAttribute('rowspan',2); }
      tr1.appendChild(thGroup);
      if(hasSub){ for(let k=i;k<groupEnd;k++){ const th2=document.createElement('th'); th2.textContent=(h2[k]??'').trim(); tr2.appendChild(th2);} }
      i=groupEnd;
    }
    thead.innerHTML=''; thead.append(tr1,tr2);
  }

  function fixHeaderTop(){
    const tr1=thead.querySelector('tr:first-child'); if(!tr1) return;
    const h = Math.round(tr1.getBoundingClientRect().height);
    document.documentElement.style.setProperty('--head1', h+'px');
  }

  // ====== BODY ======
  function renderBody(){
    tbody.innerHTML='';
    rows.forEach((row,rIdx)=>{
      const tr=document.createElement('tr');
      tr.dataset.index = rIdx;
      const cols = Math.max(row.length, header1.length, header2.length);
      for(let c=0;c<cols;c++){
        const td=document.createElement('td'); const val=row[c]??'';
        if(c===0){ td.textContent=val; td.classList.add('sticky-col-0'); }
        else if(c===1){ td.textContent=val; td.classList.add('sticky-col-1'); }
        else{
          const sel=document.createElement('select'); sel.className='skill';
          ['0','1','2'].forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;if((val+'')===v)o.selected=true;sel.appendChild(o)});
          sel.addEventListener('change',()=>{
            markEdit(rIdx,c,sel.value);
            td.classList.add('edited');
            editedCells.add(`${rIdx}|${c}`);
          });
          td.appendChild(sel);
        }
        if(editedCells.has(`${rIdx}|${c}`)) td.classList.add('edited');
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    });
  }

  function updateStickyLefts(){
    const first=tbody.querySelector('tr'); if(!first) return;
    const w0=first.children[0]?.getBoundingClientRect().width||160;
    document.documentElement.style.setProperty('--sticky-left-0','0px');
    document.documentElement.style.setProperty('--sticky-left-1',w0+'px');
  }

  // ====== EDIT / ADD / DELETE ======
  function markEdit(rIdx,cIdx,newVal){
    const copy = (rows[rIdx] ? rows[rIdx].slice() : []);
    copy[cIdx]=newVal;
    rows[rIdx]=copy;
    edits.set(rIdx+2, copy); // sheet row index = data index + 2 header rows
  }

  // เพิ่ม (ส่งครั้งเดียว + ตรวจยืนยันจากชีต)
  async function onAddRow(){
    if(inflight.add) return; inflight.add=true;
    const addBtn=document.getElementById('addRowBtn'); addBtn.disabled=true;

    const branch=document.getElementById('newBranch').value.trim();
    const name=document.getElementById('newName').value.trim();
    if(!name||!branch){ alert('กรุณากรอก name และ branch'); inflight.add=false; addBtn.disabled=false; return; }

    const cols = Math.max(header1.length, header2.length, (rows[0]||[]).length);
    const newRow = new Array(cols).fill('0'); newRow[0]=name; newRow[1]=branch;

    const payload = { requestId: makeRequestId(), appends: [{ name, branch, values:newRow }] };
    const saving=document.getElementById('saving');

    try{
      saving.style.display='inline';
      let ok=false;
      try{
        const res = await fetch(GAS_URL, { method:'POST', mode:'cors', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify(payload) });
        await res.text().catch(()=>null);
        ok = res.ok;
      }catch{ ok=false; }

      const appeared = await verifyAppend(name, branch);
      if (!appeared && !ok) throw new Error('Failed to fetch');

      document.getElementById('newBranch').value='';
      document.getElementById('newName').value='';
      await loadCsv();
      alert('เพิ่มสำเร็จ');
    }catch(err){
      alert('เพิ่มไม่สำเร็จ: '+err.message);
      console.error(err);
    }finally{
      saving.style.display='none';
      inflight.add=false; addBtn.disabled=false;
    }
  }

  // ลบด้วยชื่อ (ส่งครั้งเดียว + ตรวจยืนยันจากชีต)
  async function onDeleteByNameImmediate(){
    if(inflight.del) return; inflight.del=true;
    const delBtn=document.getElementById('delByNameBtn'); delBtn.disabled=true;

    const nameRaw=document.getElementById('newName').value.trim();
    if(!nameRaw){ alert('พิมพ์ชื่อในช่อง name ก่อน'); inflight.del=false; delBtn.disabled=false; return; }
    const nameLC = nameRaw.toLowerCase();

    const payload = { requestId: makeRequestId(), deletesNames: [nameLC] };
    try{
      document.getElementById('saving').style.display='inline';
      let ok=false;
      try{
        const res = await fetch(GAS_URL, { method:'POST', mode:'cors', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify(payload) });
        await res.text().catch(()=>null);
        ok=res.ok;
      }catch{ ok=false; }

      const gone = await verifyDeleteByName(nameLC);
      if (!gone && !ok) throw new Error('Failed to fetch');

      await loadCsv();
      alert('ลบสำเร็จ');
    }catch(err){
      alert('ลบไม่สำเร็จ: '+err.message);
      console.error(err);
    }finally{
      document.getElementById('saving').style.display='none';
      inflight.del=false; delBtn.disabled=false;
    }
  }

  // เซฟอัปเดตหลายแถว (ส่งครั้งเดียว + ตรวจยืนยันจากชีต)
  async function onSave(){
    if(inflight.save) return; inflight.save=true;

    const updates = Array.from(edits.entries()).map(([sheetRowIndex,rowValues])=>({sheetRowIndex,rowValues}));
    if(updates.length===0){ alert('ยังไม่มีการเปลี่ยนแปลง'); inflight.save=false; return; }

    const payload={ requestId: makeRequestId(), updates };
    const saving=document.getElementById('saving');

    try{
      saving.style.display='inline';
      let ok=false;
      try{
        const res=await fetch(GAS_URL,{ method:'POST', mode:'cors', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body:JSON.stringify(payload) });
        await res.text().catch(()=>null);
        ok=res.ok;
      }catch{ ok=false; }

      const verified = await verifyUpdates(updates);
      if (!verified && !ok) throw new Error('Failed to fetch');

      edits.clear(); editedCells.clear();
      await loadCsv();
      alert('บันทึกสำเร็จ');
    }catch(e){
      alert('บันทึกไม่สำเร็จ: '+e.message);
      console.error(e);
    }finally{
      saving.style.display='none';
      inflight.save=false;
    }
  }

  // ====== LISTENERS ======
  document.getElementById('addRowBtn').addEventListener('click',onAddRow);
  document.getElementById('delByNameBtn').addEventListener('click',onDeleteByNameImmediate);
  document.getElementById('saveBtn').addEventListener('click',onSave);
  window.addEventListener('resize',()=>{updateStickyLefts();fixHeaderTop();});

  // เริ่มโหลด
  console.log('[init] CSV_URL=', CSV_URL);
  console.log('[init] GAS_URL=', GAS_URL);
  loadCsv();
</script>
</body>
</html>
