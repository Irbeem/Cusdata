<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skills Table (Google Sheet → CSV)</title>
  <style>
    :root{
      --sticky-left-0:0px;--sticky-left-1:0px;
      --head1:40px; /* set by JS */
      --row-h:40px;
      --c-bg:#ffffff;--c-fg:#0f172a;--c-line:#e5e7eb;--c-head-bg:#111827;--c-head-fg:#ffffff;
      --danger:#ef4444;
    }
    html,body{height:100%;margin:0}
    body{background:var(--c-bg);color:var(--c-fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
    .wrap{width:100vw;max-width:none;margin:0;padding:12px}
    .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:4px 0 8px;flex-wrap:wrap}
    .rowadd{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .rowadd input{height:40px;border:1px solid #d1d5db;border-radius:10px;padding:0 12px;width:min(260px,38vw)}
    .btn{height:36px;border:1px solid #d1d5db;background:#2563eb;color:#fff;border-radius:10px;padding:0 12px;cursor:pointer}
    .btn.danger{background:var(--danger);border-color:#dc2626}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .table-shell{border:1px solid var(--c-line);border-radius:12px;overflow:hidden;background:#fff;height:calc(100vh - 106px)}
    .scroll{overflow:auto;width:100%;height:calc(100% - 40px)}

    table{border-collapse:separate;border-spacing:0;min-width:1100px;width:100%}
    thead th{position:sticky;top:0;background:var(--c-head-bg);color:var(--c-head-fg);z-index:4;border-bottom:1px solid var(--c-line);font-weight:700}
    thead tr:nth-child(1) th{top:0}
    thead tr:nth-child(2) th{top:var(--head1)}

    th,td{padding:8px 10px;border-right:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb;height:var(--row-h);white-space:nowrap}
    tbody tr:nth-child(odd) td{background:#fafafa}

    .sticky-col-0{position:sticky;left:var(--sticky-left-0);z-index:3;background:#f8fafc}
    .sticky-col-1{position:sticky;left:var(--sticky-left-1);z-index:3;background:#f8fafc}
    thead .sticky-col-0, thead .sticky-col-1{z-index:5;background:var(--c-head-bg)}

    select.skill{height:30px;border-radius:8px;background:#fff;color:#111827;border:1px solid #d1d5db;padding:0 6px;width:64px}
    .foot{display:flex;align-items:center;justify-content:flex-end;padding:8px 10px;height:40px;border-top:1px solid var(--c-line);background:#f9fafb}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 6px">ตารางสกิลจาก Google Sheet</h1>

    <div class="bar">
      <div class="rowadd">
        <input id="newBranch" placeholder="branch" />
        <input id="newName" placeholder="name" />
        <button class="btn" id="addRowBtn">เพิ่ม</button>
        <button class="btn danger" id="delByNameBtn">ลบด้วยชื่อ</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="saveBtn">บันทึกการเปลี่ยนแปลง</button>
        <span id="saving" style="display:none;color:#2563eb;margin-left:8px">กำลังทำงาน…</span>
      </div>
    </div>

    <div class="table-shell">
      <div class="scroll" id="scroller">
        <table id="grid"><thead id="thead"></thead><tbody id="tbody"></tbody></table>
      </div>
      <div class="foot"><small>คอลัมน์ <b>name</b> และ <b>branch</b> ถูกตรึงไว้ — หัวตาราง 2 แถวจะติดอยู่ด้านบนเมื่อเลื่อน</small></div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const SHEET_ID = '1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k';
  const GID = '0';
  const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbyKXUiyvt_LHeRBSiWyOinkdK3w-OSlkpLwXbSwHIjWgXW9ACycZio_TTKu6nC-HUSExA/exec';

  // ====== STATE ======
  let header1=[], header2=[], rows=[];
  const edits=new Map();      // sheetRowIndex (0-based from start of sheet) -> updated row array
  const appends=[];           // [{name, branch, values}]

  const thead=document.getElementById('thead');
  const tbody=document.getElementById('tbody');

  // ====== LOAD CSV ======
  async function loadCsv(){
    const res=await fetch(CSV_URL,{cache:'no-store'});
    const text=await res.text();
    const data=Papa.parse(text,{skipEmptyLines:false}).data;
    header1=data[0]||[]; header2=data[1]||[]; rows=data.slice(2);
    render();
  }

  function render(){
    renderHeader(header1,header2);
    renderBody();
    requestAnimationFrame(()=>{updateStickyLefts();fixHeaderTop();});
  }

  // ====== HEADER (merge-aware) ======
  function renderHeader(h1,h2){
    const tr1=document.createElement('tr');
    const tr2=document.createElement('tr');
    const n=Math.max(h1.length,h2.length);
    let i=0;
    while(i<n){
      const title=(h1[i]??'').trim();
      if(i===0||i===1){
        const th=document.createElement('th');
        th.textContent= title || (i===0?'name':'branch');
        th.classList.add(i===0?'sticky-col-0':'sticky-col-1');
        th.setAttribute('rowspan',2); tr1.appendChild(th); i++; continue;
      }
      if(!title){ const th=document.createElement('th'); th.setAttribute('rowspan',2); tr1.appendChild(th); i++; continue; }
      let j=i+1; while(j<n && (h1[j]??'').trim()==='') j++;
      const groupEnd=j, colspan=Math.max(1,groupEnd-i);
      let hasSub=false; for(let k=i;k<groupEnd;k++){ if((h2[k]??'').trim()!==''){hasSub=true;break;} }
      const thGroup=document.createElement('th'); thGroup.textContent=title;
      if(hasSub){ thGroup.setAttribute('colspan',colspan); } else { thGroup.setAttribute('rowspan',2); }
      tr1.appendChild(thGroup);
      if(hasSub){ for(let k=i;k<groupEnd;k++){ const th2=document.createElement('th'); th2.textContent=(h2[k]??'').trim(); tr2.appendChild(th2);} }
      i=groupEnd;
    }
    thead.innerHTML=''; thead.append(tr1,tr2);
  }

  function fixHeaderTop(){
    const tr1=thead.querySelector('tr:first-child'); if(!tr1) return;
    const h = Math.round(tr1.getBoundingClientRect().height);
    document.documentElement.style.setProperty('--head1', h+'px');
  }

  // ====== BODY ======
  function renderBody(){
    tbody.innerHTML='';
    rows.forEach((row,rIdx)=>{
      const tr=document.createElement('tr');
      tr.dataset.index = rIdx;
      const cols = Math.max(row.length, header1.length, header2.length);
      for(let c=0;c<cols;c++){
        const td=document.createElement('td'); const val=row[c]??'';
        if(c===0){ td.textContent=val; td.classList.add('sticky-col-0'); }
        else if(c===1){ td.textContent=val; td.classList.add('sticky-col-1'); }
        else{
          const sel=document.createElement('select'); sel.className='skill';
          ['0','1','2'].forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;if((val+'')===v)o.selected=true;sel.appendChild(o)});
          sel.addEventListener('change',()=>markEdit(rIdx,c,sel.value));
          td.appendChild(sel);
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    });
  }

  function updateStickyLefts(){
    const first=tbody.querySelector('tr'); if(!first) return;
    const w0=first.children[0]?.getBoundingClientRect().width||160;
    document.documentElement.style.setProperty('--sticky-left-0','0px');
    document.documentElement.style.setProperty('--sticky-left-1',w0+'px');
  }

  // ====== EDIT / ADD ======
  function markEdit(rIdx,cIdx,newVal){ const copy=rows[rIdx].slice(); copy[cIdx]=newVal; rows[rIdx]=copy; edits.set(rIdx+2,copy); }

  async function onAddRow(){
    const branch=document.getElementById('newBranch').value.trim();
    const name=document.getElementById('newName').value.trim();
    if(!name||!branch){ alert('กรุณากรอก name และ branch'); return; }

    // เตรียมแถวใหม่ (จำนวนคอลัมน์ยึดตามส่วนหัวที่ยาวสุด)
    const cols = Math.max(header1.length, header2.length, (rows[0]||[]).length);
    const newRow = new Array(cols).fill('0');
    newRow[0]=name; newRow[1]=branch;

    const payload = { appends: [{ name, branch, values:newRow }] };

    // ส่งไป Google Sheet ก่อน แล้วค่อยรีโหลดหน้าเว็บจาก CSV
    const saving=document.getElementById('saving');
    try{
      saving.style.display='inline';
      try {
        const res = await fetch(GAS_URL, { method:'POST', mode:'cors', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify(payload)});
        const text = await res.text(); let json={}; try{ json = JSON.parse(text);}catch{}
        if(!res.ok || json.error) throw new Error(json.error||text||'append failed');
      } catch(e){
        // fallback กัน CORS
        await fetch(GAS_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify(payload)});
      }
      // เคลียร์ช่องกรอกและรีโหลดจากชีตจริง
      document.getElementById('newBranch').value='';
      document.getElementById('newName').value='';
      await loadCsv();
      alert('เพิ่มสำเร็จ');
    }catch(err){
      alert('เพิ่มไม่สำเร็จ: '+err.message);
      console.error(err);
    }finally{
      saving.style.display='none';
    }
  }
    const cols= rows.length? rows[0].length : Math.max(header1.length,header2.length);
    const newRow=new Array(cols).fill('0'); newRow[0]=name; newRow[1]=branch;
    let insertAt=rows.length; for(let i=rows.length-1;i>=0;i--){ if((rows[i][1]??'').trim()===branch){ insertAt=i+1; break; } }
    rows.splice(insertAt,0,newRow); appends.push({ name, branch, values:newRow });
    renderBody(); requestAnimationFrame(()=>{updateStickyLefts();});
    document.getElementById('newBranch').value=''; document.getElementById('newName').value='';
  }

  // ====== DELETE BY NAME (IMMEDIATE) ======
  async function onDeleteByNameImmediate(){
    const nameRaw = document.getElementById('newName').value.trim();
    if(!nameRaw){ alert('พิมพ์ชื่อในช่อง name ก่อน'); return; }
    const name = nameRaw.toLowerCase();

    const payload = { deletesNames: [name] };
    try{
      document.getElementById('saving').style.display='inline';
      // ปิด modal CORS โดยส่งเป็น text/plain และลองโหมด cors ก่อน ถ้า fail ค่อย no-cors
      try {
        const res = await fetch(GAS_URL, { method:'POST', mode:'cors', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify(payload)});
        const t = await res.text(); let j={}; try{ j = JSON.parse(t);}catch{}
        if(!res.ok || j.error) throw new Error(j.error||t||'delete failed');
      } catch(e){
        await fetch(GAS_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify(payload)});
      }
      await loadCsv();
      alert('ลบสำเร็จ');
    }catch(err){
      alert('ลบไม่สำเร็จ: '+err.message);
      console.error(err);
    }finally{
      document.getElementById('saving').style.display='none';
    }
  }

  // ====== SAVE (UPDATES + APPENDS) ======
  async function onSave(){
    const payload={
      updates:Array.from(edits.entries()).map(([sheetRowIndex,rowValues])=>({sheetRowIndex,rowValues})),
      appends
    };
    const saving=document.getElementById('saving');
    try{
      saving.style.display='inline';
      try {
        const res=await fetch(GAS_URL,{ method:'POST', mode:'cors', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body:JSON.stringify(payload)});
        const text=await res.text(); let json={}; try{json=JSON.parse(text);}catch{}
        if(!res.ok||json.error) throw new Error(json.error||text||'save failed');
      } catch(err){
        await fetch(GAS_URL,{ method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body:JSON.stringify(payload)});
      }
      edits.clear(); appends.length=0;
      await loadCsv();
      alert('บันทึกสำเร็จ');
    }catch(e){ alert('บันทึกไม่สำเร็จ: '+e.message); console.error(e); }
    finally{ saving.style.display='none'; }
  }

  // ====== LISTENERS ======
  document.getElementById('addRowBtn').addEventListener('click',onAddRow);
  document.getElementById('delByNameBtn').addEventListener('click',onDeleteByNameImmediate);
  document.getElementById('saveBtn').addEventListener('click',onSave);
  window.addEventListener('resize',()=>{updateStickyLefts();fixHeaderTop();});
  loadCsv();
</script>
</body>
</html>
