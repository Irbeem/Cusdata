<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skills Table (Google Sheet → CSV)</title>
  <style>
    :root {
      --sticky-left-0: 0px;
      --sticky-left-1: 0px;
      --row-height: 36px;
      --header-bg: #0f172a;
      --header-fg: #fff;
      --body-bg: #0b1022;
      --body-fg: #e5e7eb;
      --muted: #94a3b8;
      --line: #1f2937;
    }
    html, body { height: 100%; margin: 0; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; background: var(--body-bg); color: var(--body-fg); }
    .wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 12px; }
    input, select { height: 36px; background: #0f172a; color: var(--body-fg); border: 1px solid var(--line); border-radius: 8px; padding: 0 10px; }
    .btn { height: 36px; border: 1px solid var(--line); background: #2563eb; color: white; border-radius: 10px; padding: 0 12px; cursor: pointer; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .table-shell { border: 1px solid var(--line); border-radius: 12px; overflow: hidden; background: #0b1022; }
    .scroll { overflow: auto; max-height: 70vh; }
    table { border-collapse: separate; border-spacing: 0; min-width: 900px; width: 100%; }
    thead th { position: sticky; top: 0; background: var(--header-bg); color: var(--header-fg); z-index: 4; border-bottom: 1px solid var(--line); font-weight: 600; }
    thead tr:nth-child(1) th { top: 0; }
    thead tr:nth-child(2) th { top: var(--row-height); }
    th, td { padding: 6px 10px; border-right: 1px solid var(--line); border-bottom: 1px solid var(--line); height: var(--row-height); white-space: nowrap; }
    .sticky-col-0 { position: sticky; left: var(--sticky-left-0); z-index: 3; background: #0e1328; }
    .sticky-col-1 { position: sticky; left: var(--sticky-left-1); z-index: 3; background: #0e1328; }
    select.skill { height: 28px; border-radius: 8px; background: #0f172a; color: var(--body-fg); border: 1px solid var(--line); padding: 0 6px; width: 64px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>ตารางสกิลจาก Google Sheet (CSV)</h1>
    <div class="controls">
      <label>Sheet CSV URL:</label>
      <input id="csvUrl" style="width:520px" />
      <button class="btn" id="reloadBtn">โหลดใหม่</button>
    </div>
    <div class="controls">
      <label>เพิ่มคน/แผนก:</label>
      <input id="newBranch" placeholder="branch" />
      <input id="newName" placeholder="name" />
      <button class="btn" id="addRowBtn">เพิ่ม</button>
    </div>
    <div class="table-shell">
      <div class="scroll" id="scroller">
        <table id="grid">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div>
        <button class="btn" id="saveBtn">บันทึกการเปลี่ยนแปลง</button>
        <span id="saving" style="display:none;">กำลังบันทึก...</span>
      </div>
    </div>
  </div>

<script>
const SHEET_ID = '1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k';
const GID = '0';
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyKXUiyvt_LHeRBSiWyOinkdK3w-OSlkpLwXbSwHIjWgXW9ACycZio_TTKu6nC-HUSExA/exec';

let header1 = [], header2 = [], rows = [], edits = new Map(), appends = [];
const csvUrlEl = document.getElementById('csvUrl');
csvUrlEl.value = CSV_URL;

async function load(url) {
  const res = await fetch(url);
  const text = await res.text();
  const parsed = Papa.parse(text).data;
  header1 = parsed[0];
  header2 = parsed[1];
  rows = parsed.slice(2);
  render();
}

function render() {
  renderHeader(header1, header2);
  renderBody();
  requestAnimationFrame(updateStickyLefts);
}

function renderHeader(h1, h2) {
  const tr1 = document.createElement('tr');
  const tr2 = document.createElement('tr');
  const n = Math.max(h1.length, h2.length);
  let i = 0;
  while (i < n) {
    const title = (h1[i] ?? '').trim();
    if (i === 0 || i === 1) {
      const th1 = document.createElement('th');
      th1.textContent = title || (i === 0 ? 'name' : 'branch');
      th1.classList.add(i === 0 ? 'sticky-col-0' : 'sticky-col-1');
      th1.setAttribute('rowspan', 2);
      tr1.appendChild(th1);
      i++; continue;
    }
    if (!title) { const th = document.createElement('th'); th.setAttribute('rowspan', 2); tr1.appendChild(th); i++; continue; }
    let j = i + 1; while (j < n && (h1[j] ?? '').trim() === '') j++;
    const groupEnd = j, colspan = Math.max(1, groupEnd - i);
    let hasSub = false; for (let k = i; k < groupEnd; k++) if ((h2[k] ?? '').trim()) hasSub = true;
    const thGroup = document.createElement('th'); thGroup.textContent = title;
    if (hasSub) thGroup.setAttribute('colspan', colspan); else thGroup.setAttribute('rowspan', 2);
    tr1.appendChild(thGroup);
    if (hasSub) { for (let k = i; k < groupEnd; k++) { const th2 = document.createElement('th'); th2.textContent = (h2[k] ?? '').trim(); tr2.appendChild(th2);} }
    i = groupEnd;
  }
  thead.innerHTML = ''; thead.append(tr1, tr2);
}

function renderBody() {
  tbody.innerHTML = '';
  rows.forEach((r, ri) => {
    const tr = document.createElement('tr');
    r.forEach((v, ci) => {
      const td = document.createElement('td');
      if (ci === 0) { td.textContent = v; td.classList.add('sticky-col-0'); }
      else if (ci === 1) { td.textContent = v; td.classList.add('sticky-col-1'); }
      else {
        const sel = document.createElement('select'); sel.className='skill';
        ['0','1','2'].forEach(optVal=>{ const o=document.createElement('option'); o.value=optVal; o.textContent=optVal; if(optVal===v) o.selected=true; sel.append(o); });
        sel.onchange = ()=>markEdit(ri, ci, sel.value);
        td.append(sel);
      }
      tr.append(td);
    });
    tbody.append(tr);
  });
}

function updateStickyLefts() {
  const fr = tbody.querySelector('tr'); if(!fr)return;
  const w0 = fr.children[0].getBoundingClientRect().width;
  document.documentElement.style.setProperty('--sticky-left-0', '0px');
  document.documentElement.style.setProperty('--sticky-left-1', w0+'px');
}

function markEdit(r,c,v){ const rowCopy=rows[r].slice(); rowCopy[c]=v; edits.set(r+2,rowCopy); }

function onAddRow(){
  const b=document.getElementById('newBranch').value.trim(); const n=document.getElementById('newName').value.trim();
  if(!n||!b){alert('กรุณากรอกให้ครบ');return;}
  const cols = rows.length?rows[0].length:Math.max(header1.length,header2.length);
  const newRow=new Array(cols).fill('0'); newRow[0]=n; newRow[1]=b;
  let insertAt=rows.length; for(let i=rows.length-1;i>=0;i--){if((rows[i][1]??'').trim()===b){insertAt=i+1;break;}}
  rows.splice(insertAt,0,newRow); appends.push({name:n,branch:b,values:newRow}); renderBody(); requestAnimationFrame(updateStickyLefts);
}

async function onSave(){
  const payload={updates:Array.from(edits.entries()).map(([r,row])=>({sheetRowIndex:r,rowValues:row})),appends};
  try{
    document.getElementById('saving').style.display='inline';
    const res=await fetch(GAS_URL,{method:'POST',mode:'cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const text=await res.text(); let js={}; try{js=JSON.parse(text);}catch{}
    if(!res.ok||js.error)throw new Error(js.error||text);
    alert('บันทึกสำเร็จ'); edits.clear(); appends.length=0;
  }catch(e){alert('Error: '+e.message);}finally{document.getElementById('saving').style.display='none';}
}

const thead=document.getElementById('thead'); const tbody=document.getElementById('tbody');

document.getElementById('reloadBtn').onclick=()=>load(csvUrlEl.value);
document.getElementById('addRowBtn').onclick=onAddRow;
document.getElementById('saveBtn').onclick=onSave;

load(CSV_URL);
</script>
</body>
</html>
