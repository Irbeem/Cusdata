<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ค้นหาคนตามสกิล (หัว 2 ชั้น + คอลัมน์ซ้ายตรึง + ไอคอนสกิล) - YAPT</title>
  <style>
    :root{
      --c-bg:#ffffff; --c-fg:#0f172a; --c-line:#e5e7eb; --accent:#2563eb;
      --thead-row1-h: 42px;
      --sticky-left-0:0px; --sticky-left-1:0px; --sticky-left-2:0px;
    }
    html,body{height:100%;margin:0}
    body{ background:var(--c-bg); color:var(--c-fg);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial; }

    .page{ min-height:100dvh; display:flex; flex-direction:column; }
    @supports not (height: 1dvh){ .page{ min-height:100vh; } }

    .wrap{ width:100%; max-width:none; margin:0 auto; padding:clamp(10px,2vw,16px); }
    h1{ margin:0 0 8px; }

    .card{ border:1px solid var(--c-line); border-radius:12px; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .card .hd{ padding:12px 14px; border-bottom:1px solid var(--c-line); font-weight:700; }
    .card .bd{ padding:14px; }

    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    label{ font-size:14px; opacity:.9 }
    select,button{ height:40px; border:1px solid #d1d5db; border-radius:10px; padding:0 12px; background:#fff; color:#0f172a; }
    button.btn{ background:var(--accent); color:#fff; border-color:#1e40af; cursor:pointer }
    button.btn:disabled{ opacity:.6; cursor:not-allowed }
    .group{ display:flex; gap:8px; align-items:center; border:1px solid var(--c-line); border-radius:12px; padding:8px 10px; background:#fff }

    .pill{ display:inline-block; border:1px solid #d1d5db; border-radius:999px; padding:6px 10px; font-size:13px; background:#fff; cursor:pointer; }
    .pill:hover{ background:#f3f4f6; }

    .muted{ opacity:.75 }
    .stats{ font-size:14px; margin:6px 0 0 }

    .skill-groups{ border:1px solid var(--c-line); border-radius:12px; padding:8px; }
    details.group{ border:1px solid var(--c-line); border-radius:10px; margin:6px 0; background:#fff; }
    details.group[open]{ box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .group-head{ display:flex; align-items:center; gap:8px; padding:10px 12px; cursor:pointer; }
    .group-title{ font-weight:600; }
    .group-tools{ margin-left:auto; display:flex; gap:6px; }
    .group-body{ padding:8px 12px 12px; }
    .skill-grid{ display:grid; grid-template-columns:repeat(1, minmax(0,1fr)); gap:6px; }
    .skill-item{ display:flex; align-items:center; gap:8px; min-width:0; }
    .skill-item input{ accent-color:#2563eb; }
    @media (min-width:640px){ .skill-grid{ grid-template-columns:repeat(2, minmax(0,1fr)); } }
    @media (min-width:1000px){ .skill-grid{ grid-template-columns:repeat(3, minmax(0,1fr)); } }

    .results-shell{ flex:1; display:flex; flex-direction:column; min-height:0; margin-top:12px; }
    .results-card{ flex:1; display:flex; flex-direction:column; min-height:0; }
    .results-card .bd{ flex:1; min-height:0; display:flex; flex-direction:column; }
    .results-scroll{
      flex:1; min-height:0; overflow:auto;
      -webkit-overflow-scrolling:touch; overscroll-behavior:contain;
      border:1px solid var(--c-line); border-radius:10px; background:#fff;
    }

    /* ตาราง + หัว 2 ชั้น sticky */
    table{ border-collapse:separate; border-spacing:0; width:100%; min-width:720px; }
    thead th{ position:sticky; background:#111827; color:#fff; z-index:3; }
    thead tr:nth-child(1) th{ top:0; }
    thead tr:nth-child(2) th{ top:var(--thead-row1-h); z-index:2; }

    th,td{ padding:10px 12px; border-bottom:1px solid #e5e7eb; white-space:nowrap; }
    tr:hover td{ background:#f9fafb }

    /* คอลัมน์ซ้ายตรึง */
    .sticky-col-0{ position:sticky; left:var(--sticky-left-0); z-index:6; }
    .sticky-col-1{ position:sticky; left:var(--sticky-left-1); z-index:6; }
    .sticky-col-2{ position:sticky; left:var(--sticky-left-2); z-index:6; }
    thead .sticky-col-0, thead .sticky-col-1, thead .sticky-col-2{ background:#0b1220; color:#fff; }
    tbody .sticky-col-0, tbody .sticky-col-1, tbody .sticky-col-2{ background:#fff; color:#0f172a; }
    .sticky-shadow{ box-shadow: 4px 0 6px -4px rgba(0,0,0,.25); }

    /* Match % chips + สีตามเกณฑ์ */
    .chip{ display:inline-block; min-width:46px; text-align:center;
           padding:2px 8px; border-radius:999px; border:1px solid #c7d2fe; background:#dbeafe; font-weight:600; }
    .chip.green  { background:#dcfce7; border-color:#86efac; } /* ≥80% */
    .chip.yellow { background:#fef9c3; border-color:#fde047; } /* 50–79% */
    .chip.orange { background:#ffedd5; border-color:#fdba74; } /* <50% */
    .sub{ font-size:12px; opacity:.8; margin-left:6px; }

    /* ===== สัญลักษณ์สกิลในผลลัพธ์ ===== */
    td.skill { text-align:center; }
    .skill-pill{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      width:48px; height:26px; border:1px solid #d1d5db; border-radius:14px; background:#fff;
      user-select:none;
    }
    .skill-pill .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
    .skill-pill[data-skill="1"]{ background:#22c55e; color:#ffffff; }   /* เขียว */
    .skill-pill[data-skill="1"] .dot{ background:#ffffff; }
    .skill-pill[data-skill="2"]{ background:#2563eb; color:#ffffff; }   /* น้ำเงิน */
    .skill-pill[data-skill="2"] .dot{ background:#000000; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div class="page">
  <div class="wrap">
    <h1>ค้นหาคนตามสกิล (หัว 2 ชั้น + คอลัมน์ซ้ายตรึง + ไอคอนสกิล) – YAPT</h1>

    <!-- ฟิลเตอร์ -->
    <div class="card">
      <div class="hd">ตัวกรอง</div>
      <div class="bd">
        <div class="row" style="margin-bottom:10px">
          <div class="group">
            <label for="branch">Branch:</label>
            <select id="branch"><option value="*">All branch</option></select>
          </div>

          <div class="group">
            <label>ระดับสกิล:</label>
            <label><input type="radio" name="level" value="1" checked> Can do (≥ 1)</label>
            <label><input type="radio" name="level" value="2"> Can teach (= 2)</label>
          </div>

          <div class="group">
            <label>โหมดจับคู่:</label>
            <label><input type="radio" name="mode" value="AND" checked> AND (ต้องครบทุกสกิล)</label>
            <label><input type="radio" name="mode" value="OR"> OR (อย่างน้อยหนึ่ง)</label>
          </div>

          <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
            <button class="btn" id="searchBtn">ค้นหา</button>
          </div>
        </div>

        <div class="row" style="gap:8px; align-items:center; margin-bottom:6px">
          <span class="muted">เลือกสกิล (หลายรายการ):</span>
          <button type="button" id="selectAll" class="pill">เลือกทั้งหมด</button>
          <button type="button" id="selectNone" class="pill">ล้างที่เลือก</button>
          <span class="muted" id="skillCount" style="margin-left:auto"></span>
        </div>

        <div id="skillGroups" class="skill-groups"></div>
        <div id="info" class="stats muted">กำลังโหลดข้อมูล…</div>
      </div>
    </div>

    <!-- ผลลัพธ์ -->
    <div class="results-shell">
      <div class="card results-card">
        <div class="hd">ผลลัพธ์</div>
        <div class="bd">
          <div class="results-scroll" id="resultScroll">
            <table id="resultTable">
              <thead id="thead">
                <tr id="theadRowTop">
                  <!-- 3 หัวซ้าย ใช้ rowspan=2 + sticky-left -->
                  <th class="sticky-col-0 sticky-shadow" rowspan="2">Name</th>
                  <th class="sticky-col-1 sticky-shadow" rowspan="2">Branch</th>
                  <!-- (ถ้าเป็น OR จะเติม Match % ที่นี่แบบ rowspan=2 ด้วย JS) -->
                </tr>
                <tr id="theadRowBottom"></tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // ====== CONFIG ======
  const SHEET_ID = '1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k';
  const GID = '0';
  const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

  // ====== STATE ======
  let header1=[], header2=[], rows=[];
  // groups: Map<Head1 -> [{idx, head2, short}]>
  let groups = new Map();
  // metaของคอลัมน์: { [colIndex]: { group: string, head2: string, short: string } }
  let idxMeta = {};

  const infoEl = document.getElementById('info');
  const branchEl = document.getElementById('branch');
  const theadRowTop = document.getElementById('theadRowTop');
  const theadRowBottom = document.getElementById('theadRowBottom');
  const tbody = document.getElementById('tbody');
  const skillGroupsEl = document.getElementById('skillGroups');
  const skillCountEl = document.getElementById('skillCount');

  async function fetchCsvAll(){
    const r = await fetch(CSV_URL,{cache:'no-store'});
    if(!r.ok) throw new Error('CSV HTTP '+r.status);
    const text = await r.text();
    return Papa.parse(text,{skipEmptyLines:false}).data || [];
  }
  function uniqueBranches(list){
    const set=new Set();
    list.forEach(r=>{ const b=(r[1]??'').trim(); if(b) set.add(b); });
    return Array.from(set).sort((a,b)=>a.localeCompare(b,'en'));
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function toShortLabel(label){ const tail=String(label).trim(); return tail.length>16 ? tail.slice(0,16)+'…' : tail; }
  function okVal(v, level){ return level===2 ? (v===2) : (v>=1); }

  // สร้าง HTML ไอคอนสกิล (0,1,2) แบบจัดกลาง
  function skillHTML(v){
    const n = Number(v)||0;
    if(n===1) return `<span class="skill-pill" data-skill="1"><span class="dot"></span></span>`;
    if(n===2) return `<span class="skill-pill" data-skill="2"><span class="dot"></span></span>`;
    return '–';
  }

  // ====== Build grouped skills (forward-fill merge) ======
  function buildGroupedSkills(){
    groups = new Map();
    idxMeta = {};
    const n = Math.max(header1.length, header2.length);
    let lastGroup = '';
    for(let i=2;i<n;i++){
      const gRaw = String(header1[i] ?? '').trim();
      const sRaw = String(header2[i] ?? '').trim();

      if (gRaw) lastGroup = gRaw;
      const groupName = lastGroup || 'Other';
      if (!sRaw) continue;

      const head2 = sRaw;
      const short = toShortLabel(head2);
      if(!groups.has(groupName)) groups.set(groupName, []);
      groups.get(groupName).push({ idx:i, head2, short });
      idxMeta[i] = { group: groupName, head2, short };
    }

    const totalSkills = [...groups.values()].reduce((a,arr)=>a+arr.length,0);
    skillCountEl.textContent = `รวมสกิลทั้งหมด: ${totalSkills} รายการ / กลุ่ม: ${groups.size}`;

    const html = [...groups.entries()].map(([gName, arr])=>`
      <details class="group" open>
        <summary class="group-head">
          <span class="group-title">${escapeHtml(gName)}</span>
          <span class="muted">(${arr.length})</span>
          <span class="group-tools">
            <button type="button" class="pill" data-act="group-all" data-group="${escapeHtml(gName)}">เลือกทั้งหมด</button>
            <button type="button" class="pill" data-act="group-none" data-group="${escapeHtml(gName)}">ล้าง</button>
          </span>
        </summary>
        <div class="group-body">
          <div class="skill-grid">
            ${arr.map(o => `
              <label class="skill-item" title="${escapeHtml(o.head2)}">
                <input type="checkbox" name="skill" value="${o.idx}" data-group="${escapeHtml(gName)}">
                <span>${escapeHtml(o.head2)}</span>
              </label>
            `).join('')}
          </div>
        </div>
      </details>
    `).join('') || '<div class="muted">ไม่พบสกิลจากหัวตาราง</div>';

    skillGroupsEl.innerHTML = html;
  }

  function populateBranch(){
    const items = uniqueBranches(rows);
    branchEl.innerHTML = '<option value="*">All branch</option>' + items.map(b=>`<option value="${b}">${b}</option>`).join('');
  }

  function getSelectedSkillIndices(){
    return Array.from(document.querySelectorAll('input[name="skill"]:checked')).map(el=>Number(el.value));
  }
  function getSelectedLevel(){
    const el = document.querySelector('input[name="level"]:checked');
    return el ? Number(el.value) : 1;
  }
  function getMode(){
    const el = document.querySelector('input[name="mode"]:checked');
    return el ? el.value : 'AND';
  }

  // Header 2 ชั้น + ตรึงซ้าย
  function renderHeaderCols(selected, showMatchPercent){
    const ordered = selected.slice().sort((a,b)=>a-b);

    // กลุ่มต่อเนื่อง
    const runs = [];
    let cur=null, cnt=0;
    ordered.forEach(idx=>{
      const g = (idxMeta[idx]?.group) || 'Other';
      if(g!==cur){ if(cur!==null) runs.push({name:cur,count:cnt}); cur=g; cnt=1; }
      else cnt++;
    });
    if(cur!==null) runs.push({name:cur,count:cnt});

    // เคลียร์หัว
    theadRowTop.innerHTML = '';
    theadRowBottom.innerHTML = '';

    // Name / Branch / Match%
    const thName = document.createElement('th');
    thName.className = 'sticky-col-0 sticky-shadow'; thName.rowSpan = 2; thName.textContent = 'Name';
    theadRowTop.appendChild(thName);

    const thBranch = document.createElement('th');
    thBranch.className = 'sticky-col-1 sticky-shadow'; thBranch.rowSpan = 2; thBranch.textContent = 'Branch';
    theadRowTop.appendChild(thBranch);

    let hasMatch = false;
    if(showMatchPercent){
      const thM = document.createElement('th');
      thM.className = 'sticky-col-2 sticky-shadow'; thM.rowSpan = 2; thM.textContent = 'Match %';
      theadRowTop.appendChild(thM);
      hasMatch = true;
    }

    // กลุ่ม Head1
    runs.forEach(r=>{
      const th = document.createElement('th');
      th.textContent = r.name;
      th.colSpan = r.count;
      theadRowTop.appendChild(th);
    });

    // แถวล่าง: ชื่อสกิล (head2)
    ordered.forEach(idx=>{
      const meta = idxMeta[idx];
      const th = document.createElement('th');
      th.textContent = meta ? meta.short : ('@'+(idx+1));
      th.title = meta ? meta.head2 : '';
      theadRowBottom.appendChild(th);
    });

    // อัปเดต offset sticky + ตำแหน่งซ้าย
    requestAnimationFrame(()=>{
      const h = theadRowTop.getBoundingClientRect().height;
      document.documentElement.style.setProperty('--thead-row1-h', Math.round(h)+'px');
      updateStickyLefts(hasMatch);
    });

    return { ordered, hasMatch };
  }

  // ตำแหน่งคอลัมน์ซ้ายตรึง
  function updateStickyLefts(hasMatch){
    const topRow = theadRowTop;
    const w0 = topRow.cells[0]?.getBoundingClientRect().width || 160; // Name
    const w1 = topRow.cells[1]?.getBoundingClientRect().width || 140; // Branch
    const w2 = hasMatch ? (topRow.cells[2]?.getBoundingClientRect().width || 120) : 0;

    document.documentElement.style.setProperty('--sticky-left-0','0px');
    document.documentElement.style.setProperty('--sticky-left-1', w0 + 'px');
    document.documentElement.style.setProperty('--sticky-left-2', (w0 + w1) + 'px');

    // ติดคลาสให้ body cells
    const rows = document.querySelectorAll('#resultTable tbody tr');
    rows.forEach(tr=>{
      if(tr.cells[0]) tr.cells[0].classList.add('sticky-col-0','sticky-shadow');
      if(tr.cells[1]) tr.cells[1].classList.add('sticky-col-1','sticky-shadow');
      if(hasMatch && tr.cells[2]) tr.cells[2].classList.add('sticky-col-2','sticky-shadow');
    });
  }

  // ค้นหา
  function search(){
    const selected = getSelectedSkillIndices();
    if(selected.length===0){
      infoEl.innerHTML = `กรุณาเลือกสกิลอย่างน้อย 1 รายการ`;
      tbody.innerHTML = '';
      theadRowTop.innerHTML = `
        <th class="sticky-col-0 sticky-shadow" rowspan="2">Name</th>
        <th class="sticky-col-1 sticky-shadow" rowspan="2">Branch</th>`;
      theadRowBottom.innerHTML = '';
      updateStickyLefts(false);
      return;
    }
    const level = getSelectedLevel();
    const mode  = getMode();
    const branch= branchEl.value || '*';

    const showMatchPercent = (mode==='OR');
    const { ordered, hasMatch } = renderHeaderCols(selected, showMatchPercent);

    const matches = rows.filter(r=>{
      if(branch!=='*' && String(r[1]||'').trim()!==branch) return false;
      const checks = ordered.map(idx => okVal(Number(r[idx]??0)||0, level));
      return mode==='AND' ? checks.every(Boolean) : checks.some(Boolean);
    });

    tbody.innerHTML = '';
    matches.forEach(r=>{
      const tds = [];
      tds.push(`<td class="sticky-col-0 sticky-shadow">${escapeHtml(r[0]??'')}</td>`);
      tds.push(`<td class="sticky-col-1 sticky-shadow">${escapeHtml(r[1]??'')}</td>`);

      if(hasMatch){
        const pass = ordered.reduce((acc,idx)=> acc + (okVal(Number(r[idx]??0)||0, level) ? 1 : 0), 0);
        const pct  = Math.round((pass/ordered.length)*100);
        const cls  = (pct >= 80) ? 'green' : (pct >= 50 ? 'yellow' : 'orange');
        tds.push(`<td class="sticky-col-2 sticky-shadow"><span class="chip ${cls}">${pct}%</span><span class="sub">${pass}/${ordered.length}</span></td>`);
      }

      ordered.forEach(idx=>{
        const v = Number(r[idx]??0)||0;
        tds.push(`<td class="skill">${skillHTML(v)}</td>`);
      });

      const tr = document.createElement('tr');
      tr.innerHTML = tds.join('');
      tbody.appendChild(tr);
    });

    const labels = ordered.map(i=> escapeHtml(idxMeta[i]?.short || ('@'+(i+1)))).join(', ');
    infoEl.innerHTML = `ผลลัพธ์: พบ <strong>${matches.length}</strong> คน | โหมด <strong>${mode}</strong> | ระดับ <strong>${level===2?'Can teach (=2)':'Can do (≥1)'}</strong>${branch!=='*'?' | Branch: <strong>'+escapeHtml(branch)+'</strong>':''}<br><span class="muted">สกิลที่เลือก: ${labels}</span>`;

    requestAnimationFrame(()=> updateStickyLefts(hasMatch));
  }

  // ปุ่มควบคุม
  document.getElementById('selectAll').addEventListener('click', ()=>{
    document.querySelectorAll('input[name="skill"]').forEach(el=> el.checked = true);
  });
  document.getElementById('selectNone').addEventListener('click', ()=>{
    document.querySelectorAll('input[name="skill"]').forEach(el=> el.checked = false);
  });
  document.getElementById('skillGroups').addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const act = btn.dataset.act;
    const gName = btn.dataset.group || '';
    const boxes = Array.from(document.querySelectorAll(`input[name="skill"][data-group="${CSS.escape(gName)}"]`));
    if(act==='group-all')  boxes.forEach(b=> b.checked = true);
    if(act==='group-none') boxes.forEach(b=> b.checked = false);
  });

  document.getElementById('searchBtn').addEventListener('click', search);
  window.addEventListener('resize', ()=> requestAnimationFrame(()=> updateStickyLefts(document.querySelector('.sticky-col-2')!==null)));

  // Init
  async function init(){
    try{
      infoEl.textContent = 'กำลังโหลดข้อมูล…';
      const data = await fetchCsvAll();
      if(!data || data.length<3) throw new Error('CSV format not matched (ต้องมี 2 header + อย่างน้อย 1 แถวข้อมูล)');
      header1 = data[0]||[];
      header2 = data[1]||[];
      rows = data.slice(2);

      buildGroupedSkills();
      populateBranch();
      infoEl.textContent = 'พร้อมค้นหาแล้ว';
      updateStickyLefts(false);
    }catch(err){
      console.error(err);
      infoEl.textContent = 'โหลดข้อมูลล้มเหลว: '+err.message;
    }
  }
  window.addEventListener('load', init);
</script>
</body>
</html>
