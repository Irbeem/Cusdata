<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å Google Sheets</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    h2 { margin-bottom: 0.5rem; }
    .calendar-row { display: flex; align-items: flex-start; margin-bottom: 10px; }
    .name { width: 150px; font-weight: bold; }
    .day-cell {
      border: 1px solid #ccc;
      min-width: 100px;
      min-height: 60px;
      margin: 1px;
      padding: 4px;
      border-radius: 5px;
      font-size: 0.75rem;
    }
    .day-cell b { display: block; margin-bottom: 2px; }
    .day-container { display: flex; flex-wrap: nowrap; overflow-x: auto; }
    .header { font-weight: bold; background: #eee; }
  </style>
</head>
<body>
  <h2>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Sheets)</h2>
  <div id="calendar">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

  <script>
    const SHEET_ID = '1ySiuPMVyrNOpNxx5fR0olf2Dbaq84zKVlVaVo6mFBi8';
    const SHEET_NAME = 'Carlendar';
    const endpoint = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json`;

    fetch(endpoint)
      .then(res => res.text())
      .then(text => {
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const cols = json.table.cols.map(c => c.label);
        const rows = json.table.rows.map(r => {
          const obj = {};
          r.c.forEach((cell, i) => {
            const key = cols[i];
            if (key === "date" && cell && typeof cell.v === "string" && cell.v.includes("Date(")) {
              const match = cell.v.match(/Date\((\d+),(\d+),(\d+)\)/);
              if (match) {
                const [_, y, m, d] = match;
                obj[key] = new Date(Number(y), Number(m), Number(d));
              }
            } else {
              obj[key] = cell ? cell.v : "";
            }
          });
          return obj;
        });

        renderCalendar(rows);
      })
      .catch(err => {
        document.getElementById("calendar").innerHTML = `<p style="color:red;">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${err.message}</p>`;
      });

    function renderCalendar(data) {
      // ‡∏´‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      const validDates = data.map(e => e.date).filter(d => d instanceof Date);
      const latest = new Date(Math.max(...validDates));
      const month = latest.getMonth();
      const year = latest.getFullYear();

      const daysInMonth = new Date(year, month + 1, 0).getDate();

      // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
      const monthData = data.filter(e =>
        e.date instanceof Date &&
        e.date.getMonth() === month &&
        e.date.getFullYear() === year
      );

      // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠
      const grouped = {};
      monthData.forEach(e => {
        if (!grouped[e.name]) grouped[e.name] = {};
        const day = e.date.getDate();
        if (!grouped[e.name][day]) grouped[e.name][day] = [];
        grouped[e.name][day].push(e);
      });

      const container = document.getElementById("calendar");
      container.innerHTML = `<h3>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${month + 1} ‡∏õ‡∏µ ${year}</h3>`;

      // header ‡∏ß‡∏±‡∏ô
      const header = document.createElement("div");
      header.className = "calendar-row";
      header.innerHTML = `<div class="name"></div>`;
      for (let d = 1; d <= daysInMonth; d++) {
        const cell = document.createElement("div");
        cell.className = "day-cell header";
        cell.innerHTML = `<b>${d}</b>`;
        header.appendChild(cell);
      }
      container.appendChild(header);

      // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô
      Object.keys(grouped).forEach(name => {
        const row = document.createElement("div");
        row.className = "calendar-row";

        const nameBox = document.createElement("div");
        nameBox.className = "name";
        nameBox.textContent = name;
        row.appendChild(nameBox);

        for (let d = 1; d <= daysInMonth; d++) {
          const cell = document.createElement("div");
          cell.className = "day-cell";

          const events = grouped[name][d];
          if (events) {
            events.forEach(e => {
              const type = e.type || "";
              const time = e.time || "";
              const note = e.note || "";
              cell.innerHTML += `<b>${type}</b>${time}<br>${note}<br>`;
              cell.style.background = getColor(type);
            });
          }

          row.appendChild(cell);
        }

        container.appendChild(row);
      });
    }

    function getColor(type) {
      const colors = {
        "‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°": "#ffcccc",
        "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î": "#cce5ff",
        "‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô": "#d4edda",
        "‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£": "#fff3cd",
        "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": "#e2e3e5"
      };
      return colors[type] || "#f8f9fa";
    }
  </script>
</body>
</html>
