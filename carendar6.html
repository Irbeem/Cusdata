<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏à‡∏≤‡∏Å Google Sheets</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }
    .calendar-wrapper {
      overflow-x: auto;
      max-width: 100%;
      margin-top: 1rem;
    }
    table {
      border-collapse: collapse;
      width: max-content;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      min-width: 120px;
      text-align: left;
      vertical-align: top;
      background: white;
    }
    thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: #f8f8f8;
    }
    td:first-child,
    th:first-child {
      position: sticky;
      left: 0;
      z-index: 3;
      background: #f1f1f1;
      font-weight: bold;
    }
    .event {
      display: block;
      margin-bottom: 3px;
      padding: 4px;
      border-radius: 4px;
      font-size: 0.85rem;
      color: #000;
    }
    .Warranty { background-color: #72d572; }
    .Service { background-color: #2a36b1; color: white; }
    .Sales { background-color: #c41411; color: white; }
    .Oth { background-color: #fff176; }

    .sun { background-color: #ffd6d6 !important; }
    .mon { background-color: #fffacc !important; }
    .tue { background-color: #ffd1e3 !important; }
    .wed { background-color: #d0f0c0 !important; }
    .thu { background-color: #ffe0b3 !important; }
    .fri { background-color: #d0e6ff !important; }
    .sat { background-color: #e0ccff !important; }

    @media (max-width: 768px) {
      table, th, td {
        font-size: 0.75rem;
        min-width: 80px;
      }
    }
  </style>
</head>
<body>
  <h2>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (‡∏à‡∏≤‡∏Å Google Sheets)</h2>

  <label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:
    <select id="month"></select>
  </label>
  <label>‡∏õ‡∏µ:
    <select id="year"></select>
  </label>
  <label>‡∏ä‡∏∑‡πà‡∏≠:
    <select id="nameFilter">
      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
    </select>
  </label>

  <div class="calendar-wrapper">
    <table id="calendar-table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
  <div id="summary"></div>

<script>
const SHEET_ID = '1ySiuPMVyrNOpNxx5fR0olf2Dbaq84zKVlVaVo6mFBi8';
const SHEET_NAME = 'Carlendar';
const ENDPOINT = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json`;

let allData = [];

(() => {
  const monthSel = document.getElementById("month");
  const yearSel = document.getElementById("year");
  const now = new Date();
  for (let i = 1; i <= 12; i++) {
    const opt = document.createElement("option");
    opt.value = i;
    opt.text = i;
    if (i === now.getMonth() + 1) opt.selected = true;
    monthSel.appendChild(opt);
  }
  const y = now.getFullYear();
  for (let i = y - 2; i <= y + 1; i++) {
    const opt = document.createElement("option");
    opt.value = i;
    opt.text = i;
    if (i === y) opt.selected = true;
    yearSel.appendChild(opt);
  }
  monthSel.onchange = yearSel.onchange = renderCalendarTable;
  document.getElementById("nameFilter").onchange = renderCalendarTable;
})();

fetch(ENDPOINT)
  .then(res => res.text())
  .then(text => {
    const json = JSON.parse(text.substring(47).slice(0, -2));
    const cols = json.table.cols.map(c => c.label);
    const rows = json.table.rows.map(r => {
      const obj = {};
      r.c.forEach((cell, i) => obj[cols[i]] = cell ? cell.v : "");
      return obj;
    });
    allData = rows;
    renderCalendarTable();
    renderNameFilter();
  });

function renderNameFilter() {
  const nameSel = document.getElementById("nameFilter");
  const names = [...new Set(allData.map(e => e.name))];
  names.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.text = name;
    nameSel.appendChild(opt);
  });
}

function renderCalendarTable() {
  const month = +document.getElementById("month").value;
  const year = +document.getElementById("year").value;
  const nameFilter = document.getElementById("nameFilter").value;

  const daysInMonth = new Date(year, month, 0).getDate();

  const filtered = allData.filter(e => +e["year"] === year && +e["month"] === month && (!nameFilter || e.name === nameFilter));

  const names = [...new Set(filtered.map(e => e.name))];
  const dataMap = {};
  const summary = { Warranty: 0, Service: 0, Sales: 0, Oth: 0 };
  const workingDays = new Set();
  const uniqueJobs = new Set();

  names.forEach(name => {
    dataMap[name] = {};
  });

  filtered.forEach(e => {
    const key = e.name;
    const day = +e.date;
    const jobKey = `${e.year}-${e.month}-${e.date}-${e.type}-${e.time}-${e.datail}`;
    if (!uniqueJobs.has(jobKey)) {
      uniqueJobs.add(jobKey);
      if (summary[e.type] !== undefined) summary[e.type]++;
      if (e.date) workingDays.add(e.date);
    }
    const info = `<div class='event ${e.type}'>${e.type}<br>${e.time}<br>${e.datail}</div>`;
    if (!dataMap[key][day]) dataMap[key][day] = [];
    if (!dataMap[key][day].includes(info)) dataMap[key][day].push(info);
  });

  const thead = document.querySelector("#calendar-table thead");
  const daysRow = ["<th>‡∏ä‡∏∑‡πà‡∏≠</th>"];
  for (let i = 1; i <= daysInMonth; i++) {
    const day = new Date(year, month - 1, i).getDay();
    const dayClass = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"][day];
    daysRow.push(`<th class="${dayClass}">${i}</th>`);
  }
  thead.innerHTML = `<tr>${daysRow.join("")}</tr>`;

  const tbody = document.querySelector("#calendar-table tbody");
  tbody.innerHTML = names.map(name => {
    const row = ["<td>" + name + "</td>"];
    for (let d = 1; d <= daysInMonth; d++) {
      const cells = dataMap[name][d] ? dataMap[name][d].join("") : "";
      row.push(`<td>${cells}</td>`);
    }
    return `<tr>${row.join("")}</tr>`;
  }).join("");

  document.getElementById("summary").innerHTML = `
    <ul>
      <li>üîß Warranty: ${summary.Warranty} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>
      <li>üõ†Ô∏è Service: ${summary.Service} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>
      <li>üíº Sales: ${summary.Sales} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>
      <li>üìÅ Oth: ${summary.Oth} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>
      <li>üìÖ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${workingDays.size} ‡∏ß‡∏±‡∏ô</li>
    </ul>
  `;
}
</script>
</body>
</html>
