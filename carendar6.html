<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏à‡∏≤‡∏Å Google Sheets</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }

    .calendar-wrapper {
      overflow: auto;
      max-height: 80vh;
    }

    table {
      border-collapse: collapse;
      width: max-content;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      min-width: 100px;
      text-align: left;
      vertical-align: top;
      background: white;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #f2f2f2;
      z-index: 3;
    }

    td:first-child,
    th:first-child {
      position: sticky;
      left: 0;
      background: #f1f1f1;
      z-index: 2;
      font-weight: bold;
      min-width: 150px;
    }

    thead th:first-child {
      z-index: 4;
    }

    .event {
      border-radius: 5px;
      padding: 4px;
      margin-bottom: 3px;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <h2>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Sheets)</h2>
  <div id="calendar">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

  <script>
    const SHEET_ID = '1ySiuPMVyrNOpNxx5fR0olf2Dbaq84zKVlVaVo6mFBi8';
    const SHEET_NAME = 'Carlendar';
    const endpoint = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json`;

    fetch(endpoint)
      .then(res => res.text())
      .then(text => {
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const cols = json.table.cols.map(c => c.label);
        const rows = json.table.rows.map(r => {
          const obj = {};
          r.c.forEach((cell, i) => {
            const key = cols[i];
            if (key === "date" && cell && typeof cell.v === "string" && cell.v.includes("Date(")) {
              const match = cell.v.match(/Date\((\d+),(\d+),(\d+)\)/);
              if (match) {
                const [_, y, m, d] = match;
                obj[key] = new Date(Number(y), Number(m), Number(d));
              }
            } else {
              obj[key] = cell ? cell.v : "";
            }
          });
          return obj;
        });

        renderHorizontalCalendar(rows);
      })
      .catch(err => {
        document.getElementById("calendar").innerHTML = `<p style="color:red;">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${err.message}</p>`;
      });

    function renderHorizontalCalendar(data) {
      const validDates = data.map(e => e.date).filter(d => d instanceof Date);
      const latest = new Date(Math.max(...validDates));
      const month = latest.getMonth();
      const year = latest.getFullYear();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const monthData = data.filter(e =>
        e.date instanceof Date &&
        e.date.getMonth() === month &&
        e.date.getFullYear() === year
      );

      const names = [...new Set(monthData.map(e => e.name))];

      const tableMap = {};
      names.forEach(name => {
        tableMap[name] = {};
        for (let d = 1; d <= daysInMonth; d++) {
          tableMap[name][d] = [];
        }
      });

      monthData.forEach(e => {
        const d = e.date.getDate();
        tableMap[e.name][d].push(e);
      });

      const container = document.getElementById("calendar");
      let html = `<h3>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${month + 1} ‡∏õ‡∏µ ${year}</h3>`;
      html += `<div class="calendar-wrapper"><table><thead><tr><th>üë§ ‡∏ä‡∏∑‡πà‡∏≠</th>`;
      for (let d = 1; d <= daysInMonth; d++) {
        html += `<th>${d}</th>`;
      }
      html += `</tr></thead><tbody>`;

      names.forEach(name => {
        html += `<tr><td>${name}</td>`;
        for (let d = 1; d <= daysInMonth; d++) {
          html += `<td>`;
          tableMap[name][d].forEach(e => {
            html += `<div class="event" style="background:${getColor(e.type)}"><b>${e.type}</b><br>${e.time}<br>${e.note}</div>`;
          });
          html += `</td>`;
        }
        html += `</tr>`;
      });

      html += `</tbody></table></div>`;
      container.innerHTML = html;
    }

    function getColor(type) {
      const colors = {
        "‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°": "#ffcccc",
        "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î": "#cce5ff",
        "‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô": "#d4edda",
        "‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£": "#fff3cd",
        "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": "#e2e3e5"
      };
      return colors[type] || "#f0f0f0";
    }
  </script>
</body>
</html>
