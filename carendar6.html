<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏à‡∏≤‡∏Å Google Sheets</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }

    .calendar-wrapper {
      overflow: auto;
      max-height: 80vh;
    }

    table {
      border-collapse: collapse;
      width: max-content;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      min-width: 100px;
      text-align: left;
      vertical-align: top;
      background: white;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 3;
    }

    td:first-child,
    th:first-child {
      position: sticky;
      left: 0;
      z-index: 2;
      background: #f1f1f1;
      font-weight: bold;
      min-width: 150px;
    }

    thead th:first-child {
      z-index: 4;
    }

    .event {
      border-radius: 5px;
      padding: 4px;
      margin-bottom: 3px;
      font-size: 0.85rem;
    }

    .sun { background-color: #E22427 !important; }
    .mon { background-color: #FDFD95 !important; }
    .tue { background-color: #FB6F92 !important; }
    .wed { background-color: #92CA68 !important; }
    .thu { background-color: #FFB58A !important; }
    .fri { background-color: #78A3D4 !important; }
    .sat { background-color: #9379C2 !important; }
  </style>
</head>
<body>
  <h2>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Sheets)</h2>
  <div id="calendar">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

<script>
  const SHEET_ID = '1ySiuPMVyrNOpNxx5fR0olf2Dbaq84zKVlVaVo6mFBi8';
  const SHEET_NAME = 'Carlendar'; // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠ tab ‡πÉ‡∏ô Google Sheets
  const endpoint = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json`;

  let allData = [];

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á dropdown ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ
  (() => {
    const monthSel = document.getElementById("month");
    const yearSel = document.getElementById("year");
    const now = new Date();
    for (let i = 1; i <= 12; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.text = i;
      if (i === now.getMonth() + 1) opt.selected = true;
      monthSel.appendChild(opt);
    }
    const y = now.getFullYear();
    for (let i = y - 2; i <= y + 1; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.text = i;
      if (i === y) opt.selected = true;
      yearSel.appendChild(opt);
    }
  })();

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets
  fetch(endpoint)
    .then(res => res.text())
    .then(text => {
      const json = JSON.parse(text.substring(47).slice(0, -2));
      const cols = json.table.cols.map(c => c.label);
      const rows = json.table.rows.map(r => {
        const obj = {};
        r.c.forEach((cell, i) => obj[cols[i]] = cell ? cell.v : "");
        return obj;
      });
      allData = rows;
      filterData();
    })
    .catch(err => {
      document.getElementById("timeline").innerHTML = `<p style="color:red;">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</p>`;
    });

  function filterData() {
    const m = +document.getElementById("month").value;
    const y = +document.getElementById("year").value;

    const filtered = allData.filter(e => {
      const d = new Date(+e["year"], +e["month"] - 1, +e["date"]);
      return d.getMonth() + 1 === m && d.getFullYear() === y;
    });

    renderTimeline(filtered);
  }

  function renderTimeline(data) {
    const grouped = {};
    data.forEach(e => {
      if (!grouped[e["name"]]) grouped[e["name"]] = [];
      grouped[e["name"]].push(e);
    });

    for (let name in grouped) {
      grouped[name].sort((a, b) => {
        const d1 = new Date(+a["year"], +a["month"] - 1, +a["date"]);
        const d2 = new Date(+b["year"], +b["month"] - 1, +b["date"]);
        return d1 - d2;
      });
    }

    const container = document.getElementById("timeline");
    container.innerHTML = "";

    Object.keys(grouped).forEach(name => {
      const row = document.createElement("div");
      row.className = "row";
      const nameCell = document.createElement("div");
      nameCell.className = "name";
      nameCell.textContent = name;
      row.appendChild(nameCell);

      grouped[name].forEach(event => {
        const ev = document.createElement("div");
        ev.className = "event";
        ev.style.backgroundColor = getColor(event["type"]);
        const dateObj = new Date(+event["year"], +event["month"] - 1, +event["date"]);
        ev.innerHTML = `<b>${
          dateObj.toLocaleDateString("th-TH", { day: "2-digit", month: "2-digit", year: "numeric" })
        }</b><br>${event["time"]}<br>${event["type"]}<br>${event["datail"] || ""}`;
        row.appendChild(ev);
      });

      container.appendChild(row);
    });
  }

    function getColor(type) {
      const colors = {
        "Office": "#000000",
        "Service": "#2a36b1",
        "Sales": "#c41411",
        "Warranty": "#72d572",
        "Other": "#fff176"
      };
      return colors[type] || "#f0f0f0";
    }
  </script>
</body>
</html>
