<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skill Matrix (0/1/2) — YAPTCSSKILL</title>
  <style>
    :root { --pad: 12px; --border: #e5e7eb; --sticky: #f9fafb; }
    html, body { margin:0; padding:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", Arial; color:#111827; background:#fff; }
    header { padding: var(--pad); border-bottom: 1px solid var(--border); background: white; position: sticky; top:0; z-index: 3; }
    h1 { font-size: 16px; margin: 0 0 8px 0; }
    .controls { display:flex; flex-wrap: wrap; gap:8px; align-items:center; }
    select, button { padding: 8px 10px; border: 1px solid var(--border); border-radius: 10px; background:#fff; }
    button.primary { background:#111827; color:white; border-color:#111827; cursor:pointer; }
    button.secondary { background:white; color:#111827; cursor:pointer; }
    .status { font-size: 13px; color:#374151; margin-top:8px; }
    .wrap { padding: var(--pad); }
    .table-wrap { overflow: auto; border: 1px solid var(--border); border-radius: 12px; }
    table { border-collapse: separate; border-spacing: 0; width: max-content; min-width: 100%; }
    th, td { border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 6px 8px; background: white; white-space: nowrap; }
    th:first-child, td:first-child { border-left: 1px solid var(--border); }
    thead th { position: sticky; top: 0; background: var(--sticky); z-index: 2; }
    thead tr:nth-child(1) th { top: 0; }
    thead tr:nth-child(2) th { top: 34px; }
    tbody td:first-child, thead th:first-child { position: sticky; left: 0; background: var(--sticky); z-index: 1; }
    tbody tr:hover td { background: #fcfcfd; }
    .name-cell { font-weight: 600; background:#fafafa; }
    .readonly { color:#6b7280; }
    .center { text-align: center; }
    .dirty { outline: 2px solid #f59e0b; outline-offset: -2px; }
    .small { font-size:12px; color:#6b7280; }
    iframe { display:none; }
    /* ปุ่มวงกลมระดับสกิล */
    .lvbtn{
      display:inline-flex; align-items:center; justify-content:center;
      width:28px; height:28px; border:1px solid #d1d5db; border-radius:8px;
      background:#fff; cursor:pointer; font-size:18px; line-height:1;
      user-select:none;
    }
    .lvbtn.readonly{ background:#f9fafb; color:#9ca3af; cursor:default; }
    .lvbtn.dirty{ outline:2px solid #f59e0b; outline-offset:-2px; }
    /* กล่องสกรอลล์ของตาราง */
    .table-wrap{
      max-height: calc(100vh - 180px); /* ปรับตาม layout ของคุณ */
      overflow: auto;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
    }
    
    /* ห้ามใช้ transform/backdrop-filter กับบรรพบุรุษ ไม่งั้น sticky จะพัง */
    .table-wrap, .table-wrap *{
      transform: none !important;
      filter: none !important;
      backdrop-filter: none !important;
    }
    
    /* หัวตาราง sticky (รองรับหัว 2 แถว) */
    thead th{
      position: sticky;
      background: #f9fafb; /* สีพื้นของหัวเวลา sticky */
      z-index: 2;
    }
    
    /* แถวหัวแถวที่ 1 ติดบนสุด */
    thead tr:first-child th{
      top: 0;
      z-index: 3; /* สูงกว่าแถว 2 */
    }
    
    /* แถวหัวแถวที่ 2 ให้เลื่อนตามความสูงแถว 1 */
    :root{ --h1: 34px; }              /* fallback ถ้า JS ยังไม่คำนวณ */
    thead tr:nth-child(2) th{
      top: var(--h1);
    }
    
    /* ล็อกคอลัมน์ชื่อ (คอลัมน์แรก) */
    thead th:first-child,
    tbody td:first-child{
      position: sticky;
      left: 0;
      z-index: 4;         /* สูงกว่าหัวอื่น ๆ */
      background: #f9fafb;
      font-weight: 600;
      white-space: nowrap;
    }
    /* กล่องสกรอลล์ */
.table-wrap{
  max-height: calc(100vh - 180px);
  overflow: auto;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
}

/* ห้าม transform/filter บรรพบุรุษ sticky */
.table-wrap, .table-wrap *{
  transform: none !important;
  filter: none !important;
  backdrop-filter: none !important;
}

/* === Sticky header (2 แถว) === */
:root{ --h1: 34px; }           /* JS จะอัปเดตให้อัตโนมัติ */

thead th{
  position: sticky;
  background:#fff;             /* ให้ทึบเพื่อบังของที่เลื่อนใต้หัว */
}

/* แถวหัวแถวที่ 1 */
thead tr:first-child th{
  top: 0;
  z-index: 40;                 /* สูงกว่าคอลัมน์ name */
}

/* แถวหัวแถวที่ 2 */
thead tr:nth-child(2) th{
  top: var(--h1);
  z-index: 39;
}

/* มุมซ้ายบน (หัวคอลัมน์ name) ให้สูงสุด */
thead th:first-child{
  left: 0;
  z-index: 41;
}

/* === Sticky คอลัมน์แรก (name) === */
tbody td:first-child{
  position: sticky;
  left: 0;
  background:#f9fafb;
  z-index: 20;                 /* ต่ำกว่าหัวตาราง -> หัวบังได้เวลาสกรอลล์ขึ้น */
  font-weight: 600;
  white-space: nowrap;
}
/* ===== THEME ===== */
:root{
  --bg: #ffffff;
  --card: #ffffff;
  --muted: #6b7280;
  --border: #e5e7eb;

  /* แพเลตหลัก */
  --brand-50:#eef2ff; --brand-100:#e0e7ff; --brand-200:#c7d2fe;
  --brand-400:#6366f1; --brand-500:#4f46e5; --brand-600:#4338ca;

  --green-500:#10b981;
  --amber-500:#f59e0b;
  --rose-500:#f43f5e;

  --header-grad: linear-gradient(180deg, #f9fafb 0%, #ffffff 100%);
}

/* ===== Header bar / toolbar ===== */
header{
  background: var(--header-grad);
  border-bottom: 1px solid var(--border);
  box-shadow: 0 4px 14px rgba(15, 23, 42, .06);
}

.controls select,
.controls input{
  border: 1px solid var(--border);
  background: #fff;
  border-radius: 10px;
  padding: 8px 12px;
  transition: box-shadow .15s ease, border-color .15s ease;
}
.controls select:focus,
.controls input:focus{
  outline: none;
  border-color: var(--brand-400);
  box-shadow: 0 0 0 4px color-mix(in srgb, var(--brand-400) 20%, transparent);
}

/* ===== Buttons ===== */
button{
  border-radius: 10px;
  padding: 10px 14px;
  border: 1px solid transparent;
  font-weight: 600;
  transition: transform .05s ease, box-shadow .15s ease, background .15s ease;
}
button:active{ transform: translateY(1px); }

button.primary{
  background: var(--brand-500);
  border-color: var(--brand-500);
  color: #fff;
  box-shadow: 0 6px 14px rgba(79,70,229,.25);
}
button.primary:hover{ background: var(--brand-600); }

button.secondary{
  background: #fff;
  color: var(--brand-600);
  border-color: var(--brand-200);
}
button.secondary:hover{
  background: var(--brand-50);
  border-color: var(--brand-400);
}

/* ปุ่ม เพิ่ม / ลบ แนะนำสีเฉพาะ */
#btnAdd.secondary{
  color: var(--green-500);
  border-color: color-mix(in srgb, var(--green-500) 35%, #ffffff);
}
#btnAdd.secondary:hover{
  background: color-mix(in srgb, var(--green-500) 12%, #ffffff);
  border-color: var(--green-500);
}
#btnDel.secondary{
  color: var(--rose-500);
  border-color: color-mix(in srgb, var(--rose-500) 35%, #ffffff);
}
#btnDel.secondary:hover{
  background: color-mix(in srgb, var(--rose-500) 10%, #ffffff);
  border-color: var(--rose-500);
}

/* ===== Table wrapper ===== */
.table-wrap{
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  box-shadow: 0 12px 24px rgba(15, 23, 42, .05);
}

/* ===== Table ===== */
table{ border-spacing:0; width:max-content; min-width:100%; }
th, td{
  border-right: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  padding: 10px 12px;
  background: #fff;
}

/* หัวแถว 1 (กลุ่ม) */
#groupRow th{
  background: color-mix(in srgb, var(--brand-50) 65%, #ffffff);
  color:#111827;
  font-weight: 700;
  letter-spacing:.2px;
  border-bottom: 2px solid var(--brand-200);
}

/* หัวแถว 2 (สกิล) */
#skillRow th{
  background:#fff;
  font-weight: 700;
  color:#0f172a;
}

/* คอลัมน์ชื่อ (sticky ด้านซ้าย) */
thead th:first-child,
tbody td:first-child{
  background: linear-gradient(90deg, #f8fafc 0%, #ffffff 100%);
  font-weight: 700;
  color:#0f172a;
}

/* ไฮไลต์ row hover + คาดเส้นสลับสี */
tbody tr:nth-child(even) td{ background:#fcfcff; }
tbody tr:hover td{ background:#f8faff; }

/* ===== Level buttons (วงกลม 0/1/2) ===== */
.lvbtn{
  width: 32px; height: 32px; font-size: 18px;
  border-radius: 10px;
  border: 1px solid var(--brand-200);
  background: #fff;
  color:#111827;
  box-shadow: 0 1px 0 rgba(0,0,0,.04);
}
.lvbtn:hover{ box-shadow: 0 0 0 4px color-mix(in srgb, var(--brand-400) 15%, transparent); }
.lvbtn.readonly{ background:#f3f4f6; color:#9ca3af; border-color:#e5e7eb; }

/* แสดงสถานะที่แก้ไข (dirty) */
.lvbtn.dirty{
  border-color: var(--amber-500);
  box-shadow: 0 0 0 4px color-mix(in srgb, var(--amber-500) 25%, transparent);
}

/* ===== Sticky z-index (คง behavior เดิม) ===== */
thead tr:first-child th{ top:0; z-index:40; }
thead tr:nth-child(2) th{ top: var(--h1); z-index:39; }
thead th:first-child{ left:0; z-index:41; }
tbody td:first-child{ left:0; z-index:20; }
    #groupRow th{ background: linear-gradient(180deg, var(--brand-50) 0%, #fff 90%); }
    
  </style>
</head>
<body>
  <header>
    <h1>Skill Matrix — ตารางกลุ่ม/สกิล (0/1/2)</h1>
  <div class="controls">
    <label>พนักงาน (เลือกเพื่อแก้ไข):
      <select id="person"></select>
    </label>
    <button id="saveBtn" class="primary">บันทึกการเปลี่ยนแปลง</button>
    <button id="resetBtn" class="secondary">ยกเลิก</button>
    <span class="small">แก้ไขได้เฉพาะแถวของคนที่เลือก</span>
  </div>
  <div>
  <!-- 🔵 เพิ่มปุ่ม/ช่องจัดการรายชื่อ -->
    <input id="newName" placeholder="ชื่อพนักงาน" style="margin-left:8px; min-width:180px;" />
    <button id="btnAdd" class="secondary" title="เพิ่มชื่อใหม่">➕ เพิ่มชื่อ</button>
    <button id="btnDel" class="secondary" title="ลบชื่อที่เลือก">🗑 ลบชื่อ</button>
  </div>
  </header>
  <form id="gasForm" method="POST" target="gasTarget" action="">
  <input type="hidden" name="name" id="f_name">
  <!-- 🔵 เพิ่มสองตัวนี้ -->
  <input type="hidden" name="action"   id="f_action">
  <input type="hidden" name="new_name" id="f_new_name">
  <!-- ช่อง u_skill[] / u_level[] จะถูกเติมตอนกด Save -->
  <div id="msg" class="status"></div>
  </form>
  <div class="wrap">
    <div class="table-wrap">
      <table id="skillTable" aria-label="Skill matrix table">
        <thead>
          <tr id="groupRow"></tr>
          <tr id="skillRow"></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- ส่งข้อมูลไป Apps Script ผ่าน iframe (เลี่ยง CORS) -->
  <iframe id="gasTarget" name="gasTarget"></iframe>
  <form id="gasForm" method="POST" target="gasTarget" action="">
    <input type="hidden" name="name" id="f_name">
    <!-- จะเติม <input name="u_skill[]"> และ <input name="u_level[]"> ด้วย JS ตอนกด Save -->
  </form>

<script>
/* =========================== CONFIG =========================== */
/* เปลี่ยนเป็น export raw CSV เพื่อให้โครงสร้างตรงชีต 100% */
const CSV_URL = "https://docs.google.com/spreadsheets/d/1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k/export?format=csv&gid=0";

/* Apps Script Web App URL (exec) */
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzPMwWO8ir9wa8kSVDn_aWn_-vyY11K8Z2msF4nY2Aj7iyRyYJctzEo3F-VlYW-w-68jQ/exec";
/* ============================================================= */

let state = {
  nameCol: 0,
  names: [],
  groups: [],   // group header (row 1) after forward-fill
  skills: [],   // [{idx, label, group}]
  rows: [],     // data rows (from row after skill header)
  levels: {},   // { name: { skillLabel: "0"|"1"|"2"|"" } }
  current: "",  // selected person
  dirty: new Map()
};

const $ = (id) => document.getElementById(id);
const elPerson   = $("person");
const elMsg      = $("msg");
const elGroupRow = $("groupRow");
const elSkillRow = $("skillRow");
const elTbody    = $("tbody");

function setMessage(t){ elMsg.textContent = t; }
function toStr(v){ return String(v ?? "").trim(); }
function esc(s){ return s.replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[m])); }

/* ---------------- CSV Loader + Parse ---------------- */
/* ค้นหาแถวหัวอัตโนมัติ: แถวที่พบคำว่า "name" = หัวสกิล; แถวก่อนหน้า = หัวกลุ่ม */
async function loadCSV(){
  setMessage("กำลังโหลดข้อมูลจาก Google Sheet...");
  const r = await fetch(CSV_URL, { cache: "no-store" });
  if (!r.ok) throw new Error("โหลด CSV ไม่สำเร็จ");
  const text = await r.text();
  const matrix = parseCSV(text);

  // 1) หาแถวที่มีคำว่า "name" (แถวหัวสกิลที่แท้จริง)
  let skillHeaderRowIdx = -1, nameCol = -1;
  for (let i = 0; i < Math.min(15, matrix.length); i++) {
    const row = matrix[i];
    const idx = row.findIndex(v => String(v ?? '').trim().toLowerCase() === 'name');
    if (idx !== -1) { skillHeaderRowIdx = i; nameCol = idx; break; }
  }
  if (skillHeaderRowIdx < 0) throw new Error('ไม่พบคอลัมน์ "name" ในส่วนหัว');

  // 2) แถวบนคือหัวกลุ่ม (เผื่อ merge)
  const groupHeaderRowIdx = Math.max(0, skillHeaderRowIdx - 1);
  const groupRowRaw = matrix[groupHeaderRowIdx].map(x => String(x ?? '').replace(/\s+/g,' ').trim());

  // 3) เอาแถวหัวสกิล
  let skillRow = matrix[skillHeaderRowIdx].map(x => String(x ?? '').replace(/\s+/g,' ').trim());

  // 3.1) กันพลาด: ถ้าแถวหัวสกิล “เหมือนแถวกลุ่ม” (เช่น export เพี้ยน) ให้เลื่อนลง 1 แถว
  const looksLikeGroup =
    skillRow.some((v,i) => i !== nameCol && v) &&                       // มีคอลัมน์ไม่ว่าง
    skillRow.every((v,i) => i === nameCol || v === groupRowRaw[i]);     // และค่าเท่ากับหัวกลุ่มทุกช่อง
  if (looksLikeGroup && matrix[skillHeaderRowIdx + 1]) {
    skillHeaderRowIdx += 1;
    skillRow = matrix[skillHeaderRowIdx].map(x => String(x ?? '').replace(/\s+/g,' ').trim());
  }

  // 4) ส่วนข้อมูล
  const dataRows = matrix.slice(skillHeaderRowIdx + 1);

  // 5) forward-fill group header
  const groupRow = [];
  let lastGroup = "";
  for (let c=0; c<groupRowRaw.length; c++){
    const g = groupRowRaw[c];
    if (g) lastGroup = g;
    groupRow[c] = lastGroup;
  }

  // 6) รวบรวมคอลัมน์สกิล (ข้าม name และหัวว่าง)
  const skillCols = [];
  for (let c=0; c<skillRow.length; c++){
    if (c === nameCol) continue;
    const s = skillRow[c];
    if (!s) continue;
    skillCols.push({ idx: c, label: s, group: groupRow[c] || '' });
  }

  // 7) names + levels
  const names = [];
  const levels = {};
  for (const row of dataRows){
    const nm = String(row[nameCol] ?? '').trim();
    if (!nm) continue;
    names.push(nm);
    const mp = {};
    for (const col of skillCols){
      const raw = row[col.idx];
      const v = (raw === undefined || raw === null) ? '' : String(raw).trim();
      mp[col.label] = (v === '0' || v === '1' || v === '2') ? v : '';
    }
    levels[nm] = mp;
  }

  // 8) อัปเดต state + เรนเดอร์
  state.nameCol = nameCol;
  state.names   = names;
  state.groups  = groupRow;
  state.skills  = skillCols;
  state.rows    = dataRows;
  state.levels  = levels;
  state.current = names[0] || "";
  state.dirty.clear();

  buildThead(skillCols);
  buildTbody();

  const options = names.map(n => `<option value="${n.replace(/&/g,"&amp;").replace(/</g,"&lt;")}">${n}</option>`).join("");
  document.getElementById("person").innerHTML = options;
  document.getElementById("person").value = state.current;

  setMessage("พร้อมใช้งาน");
}
  
/* -------------- Basic CSV Parser (quoted) -------------- */
function parseCSV(text){
  const rows = [];
  let i=0, cur="", row=[], inq=false;
  while(i<text.length){
    const ch = text[i];
    if (inq){
      if (ch === '"'){
        if (text[i+1] === '"'){ cur += '"'; i+=2; continue; }
        inq = false; i++; continue;
      } else { cur += ch; i++; continue; }
    } else {
      if (ch === '"'){ inq=true; i++; continue; }
      if (ch === ','){ row.push(cur); cur=""; i++; continue; }
      if (ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=""; i++; continue; }
      if (ch === '\r'){ i++; continue; }
      cur += ch; i++;
    }
  }
  row.push(cur); rows.push(row);
  return rows;
}

/* ---------------- Render THEAD (2 rows) ---------------- */
function buildThead(skillCols){
  elGroupRow.innerHTML = "";
  elSkillRow.innerHTML = "";

  // name column → rowspan=2
  const thName = document.createElement("th");
  thName.textContent = "name";
  thName.rowSpan = 2;
  elGroupRow.appendChild(thName);

  // groups with colspan
  let i = 0;
  while (i < skillCols.length) {
    const g = skillCols[i].group || "";
    let span = 1;
    let j = i + 1;
    while (j < skillCols.length && (skillCols[j].group || "") === g) { span++; j++; }
    const th = document.createElement("th");
    th.textContent = g;
    th.colSpan = span;
    elGroupRow.appendChild(th);
    i = j;
  }

  // skill names row
  for (const col of skillCols){
    const th = document.createElement("th");
    th.textContent = col.label;
    elSkillRow.appendChild(th);
  }
}

/* ---------------- Render TBODY ---------------- */
function buildTbody(){
  elTbody.innerHTML = "";
  for (const name of state.names){
    const tr = document.createElement("tr");

    // คอลัมน์ชื่อ
    const tdName = document.createElement("td");
    tdName.className = "name-cell";
    tdName.textContent = name;
    tr.appendChild(tdName);

    const editable = (name === state.current);

    for (const col of state.skills){
      const skill = col.label;
      const baseline = (state.levels[name]?.[skill] ?? '0') || '0'; // '' -> '0'
      const current  = (name === state.current && state.dirty.has(skill))
        ? state.dirty.get(skill)
        : baseline;
      const td = document.createElement("td");
      td.className = "center";

      // ปุ่มวงกลม
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "lvbtn";
      btn.textContent = symbolForLevel(current);
      btn.dataset.skill = skill;
      btn.dataset.value = current;

      if (!editable){
        btn.classList.add("readonly");
      } else {
        if (current !== baseline) btn.classList.add("dirty");

        btn.addEventListener("click", ()=>{
          const oldVal = btn.dataset.value;
          const newVal = nextLevel(oldVal);
          btn.dataset.value = newVal;
          btn.textContent = symbolForLevel(newVal);

          if (newVal === baseline){
            state.dirty.delete(skill);
            btn.classList.remove("dirty");
          } else {
            state.dirty.set(skill, newVal);
            btn.classList.add("dirty");
          }
        });
      }

      td.appendChild(btn);
      tr.appendChild(td);
    }

    elTbody.appendChild(tr);
  }
}
/* ---------------- Events ---------------- */
elPerson.addEventListener("change", ()=>{
  state.current = elPerson.value;
  state.dirty.clear();
  buildTbody();
});

$("resetBtn").addEventListener("click", ()=>{
  state.dirty.clear();
  buildTbody();
  setMessage("ล้างการแก้ไขที่ยังไม่บันทึกแล้ว");
});

/* ====== SAVE (วิธี B: u_skill[] / u_level[]) ====== */
document.getElementById("saveBtn").addEventListener("click", saveViaIframeArray);

function saveViaIframeArray(){
  const selectedName = state.current;
  if (!selectedName){ setMessage("❌ ไม่พบชื่อพนักงาน"); return; }
  if (state.dirty.size === 0){ setMessage("ไม่มีการแก้ไข"); return; }

  const form   = document.getElementById("gasForm");
  const iframe = document.getElementById("gasTarget");

  form.action = GAS_ENDPOINT;

  // ใส่ชื่อ
  document.getElementById("f_name").value = selectedName;

  // ลบอินพุตเก่า u_skill[] / u_level[]
  [...form.querySelectorAll('input[name="u_skill[]"], input[name="u_level[]"]')]
    .forEach(el => el.remove());

  // เติมอินพุตใหม่ตาม dirty
  for (const [skill, level] of state.dirty.entries()){
    const a = document.createElement('input');
    a.type='hidden'; a.name='u_skill[]'; a.value=skill; form.appendChild(a);
    const b = document.createElement('input');
    b.type='hidden'; b.name='u_level[]'; b.value=level; form.appendChild(b);
  }

  // ส่งฟอร์ม
  const onLoad = ()=>{
    const mp = state.levels[selectedName] || (state.levels[selectedName] = {});
    for (const [skill, level] of state.dirty.entries()) mp[skill] = level;
    state.dirty.clear();
    buildTbody();
    setMessage("✅ บันทึกสำเร็จ");
    iframe.removeEventListener('load', onLoad);
  };
  iframe.addEventListener('load', onLoad, { once: true });

  setMessage("กำลังบันทึก...");
  form.submit();
}

/* ---------------- Boot ---------------- */
loadCSV().catch(err=>{
  setMessage("❌ โหลดข้อมูลไม่สำเร็จ: " + (err.message || err));
});

// ===== ปุ่มเพิ่ม/ลบชื่อ =====
document.getElementById("btnAdd").addEventListener("click", addName);
document.getElementById("btnDel").addEventListener("click", deleteName);

function addName(){
  const input = document.getElementById("newName");
  const newName = (input.value || "").trim();
  if (!newName){ alert("กรุณากรอกชื่อพนักงาน"); return; }

  const form   = document.getElementById("gasForm");
  const iframe = document.getElementById("gasTarget");
  form.action = GAS_ENDPOINT;

  // ตั้ง action + payload
  document.getElementById("f_action").value   = "addName";
  document.getElementById("f_new_name").value = newName;

  // ปิดปุ่มกันคลิกซ้ำ
  const btnAdd = document.getElementById("btnAdd");
  const btnDel = document.getElementById("btnDel");
  btnAdd.disabled = true; btnDel.disabled = true;

  const cleanup = () => {
    document.getElementById("f_action").value   = "";
    document.getElementById("f_new_name").value = "";
    // ✅ ล้างช่อง input หลังทำงานเสร็จ
    input.value = "";
    btnAdd.disabled = false; btnDel.disabled = false;
  };

  iframe.onload = () => {
    iframe.onload = null;
    cleanup();
    setMessage("✅ เพิ่มชื่อสำเร็จ: " + newName);
    // รีโหลด + เลือกชื่อที่เพิ่งเพิ่ม
    loadCSV().then(()=> {
      const sel = document.getElementById("person");
      if ([...sel.options].some(o => o.value === newName)) {
        sel.value = newName;
        state.current = newName;
        buildTbody();
      }
    });
  };

  setMessage("กำลังเพิ่มชื่อ...");
  form.submit();
}

function deleteName(){
  const input  = document.getElementById("newName");
  const target = (input.value || document.getElementById("person").value || "").trim();
  if (!target){ alert("ไม่พบชื่อที่จะลบ"); return; }
  if (!confirm(`ยืนยันลบชื่อ "${target}" ออกจากชีต?`)) return;

  const form   = document.getElementById("gasForm");
  const iframe = document.getElementById("gasTarget");
  form.action = GAS_ENDPOINT;

  // ล้าง field ที่ไม่เกี่ยว จะได้ไม่ไปอัปเดตสกิล
  document.getElementById("f_name").value = "";
  [...form.querySelectorAll('input[name="u_skill[]"], input[name="u_level[]"]')]
    .forEach(el => el.remove());

  // ตั้ง action + payload
  document.getElementById("f_action").value   = "deleteName";
  document.getElementById("f_new_name").value = target;

  // ปิดปุ่มกันคลิกซ้ำ
  const btnAdd = document.getElementById("btnAdd");
  const btnDel = document.getElementById("btnDel");
  btnAdd.disabled = true; btnDel.disabled = true;

  const cleanup = () => {
    document.getElementById("f_action").value   = "";
    document.getElementById("f_new_name").value = "";
    // ✅ ล้างช่อง input หลังทำงานเสร็จ
    input.value = "";
    btnAdd.disabled = false; btnDel.disabled = false;
  };

  iframe.onload = () => {
    iframe.onload = null;
    cleanup();
    setMessage("✅ ลบชื่อสำเร็จ: " + target);
    // รีโหลด + ถ้า current ถูกลบให้เลือกชื่อแรก
    loadCSV().then(()=> {
      const sel = document.getElementById("person");
      if (![...sel.options].some(o => o.value === state.current)) {
        state.current = sel.options[0]?.value || "";
        sel.value = state.current;
        buildTbody();
      }
    });
  };

  setMessage("กำลังลบชื่อ...");
  form.submit();
}

function symbolForLevel(lv){
  // แสดง 0 เป็น "-" (visual only)
  return lv === '2' ? '●' : (lv === '1' ? '○' : '-');
}
function nextLevel(lv){
  return lv === '0' ? '1' : (lv === '1' ? '2' : '0');
}

function updateStickyHeaderOffset(){
  const r1 = document.querySelector('#groupRow');   // แถวหัวแถวแรก
  const h  = (r1 && r1.offsetHeight) ? r1.offsetHeight : 34;
  document.documentElement.style.setProperty('--h1', h + 'px');
}
window.addEventListener('load', updateStickyHeaderOffset);
window.addEventListener('resize', updateStickyHeaderOffset);

// ถ้าคุณมี buildThead() ให้เรียกหลังเรนเดอร์เสร็จ
const _buildThead = buildThead;
buildThead = function(...args){
  const res = _buildThead.apply(this, args);
  requestAnimationFrame(updateStickyHeaderOffset);
  return res;
};
</script>
</body>
</html>
