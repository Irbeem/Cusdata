<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skill Matrix (0/1/2) ‚Äî YAPTCSSKILL</title>
  <style>
    :root{
      --h1: 34px;                 /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡∏±‡∏ß‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏î‡πâ‡∏ß‡∏¢ JS) */
      --border:#e5e7eb;
      --brand-50:#eef2ff; --brand-200:#c7d2fe; --brand-500:#4f46e5; --brand-600:#4338ca;
      --row-select-bg: #eef2ff;   /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß */
      --row-select-left: #6366f1; /* ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ñ‡∏ö‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å ‡πÜ */
    }
    
    html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans",Arial;color:#111827;background:#fff}
    
    /* Header */
    header{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(180deg,#f9fafb 0%,#fff 100%);
      border-bottom:1px solid var(--border); padding:12px;
      box-shadow:0 4px 14px rgba(15,23,42,.06);
    }
    h1{margin:0 0 8px 0;font-size:16px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .controls select,.controls input{border:1px solid var(--border);border-radius:10px;padding:8px 12px;background:#fff}
    button{border-radius:10px;padding:10px 14px;border:1px solid transparent;font-weight:600;cursor:pointer}
    button.primary{background:var(--brand-500);color:#fff}
    button.primary:hover{background:var(--brand-600)}
    button.secondary{background:#fff;border:1px solid var(--brand-200);color:#1f2937}
    .status{font-size:13px;color:#374151;margin-top:8px}
    
    .wrap{padding:12px}
    .table-wrap{
      max-height:calc(100vh - 180px);
      overflow:auto;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      box-shadow:0 12px 24px rgba(15,23,42,.05);
    }
    
    /* Table */
    table{border-collapse:separate;border-spacing:0;width:max-content;min-width:100%}
    th,td{border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:10px 12px;background:#fff;white-space:nowrap}
    th:first-child,td:first-child{border-left:1px solid var(--border)}
    
    /* Sticky header 2 ‡∏ä‡∏±‡πâ‡∏ô */
    thead th{position:sticky;background:#fff}
    thead tr:first-child th{top:0;z-index:40}          /* ‡πÅ‡∏ñ‡∏ß‡∏Å‡∏•‡∏∏‡πà‡∏° */
    thead tr:nth-child(2) th{top:var(--h1);z-index:39} /* ‡πÅ‡∏ñ‡∏ß‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏Å‡∏¥‡∏• */
    thead th:first-child{left:0;z-index:41}            /* ‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô */
    
    /* Sticky ‡∏ä‡∏∑‡πà‡∏≠ (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å) ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ï‡πâ‡∏´‡∏±‡∏ß */
    tbody td:first-child{position:sticky;left:0;background:#f8fafc;z-index:20;font-weight:700}
    
    /* ‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏´‡∏±‡∏ß‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å) ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ï‡πà‡∏≤‡∏á‡∏ô‡∏¥‡∏î */
    #groupRow th{background:linear-gradient(180deg,var(--brand-50) 0%,#fff 95%);border-bottom:2px solid var(--brand-200)}
    
    /* Row hover + ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏µ‡∏≠‡πà‡∏≠‡∏ô */
    tbody tr:nth-child(even) td{background:#fcfcff}
    tbody tr:hover td{background:#f8faff}
    
/* ===== 2) ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏£‡∏≤‡∏™‡∏ï‡πå‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (readonly) ===== */
/* ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏° */
    .lvbtn{
      display:inline-flex;align-items:center;justify-content:center;
      width:32px;height:32px;font-size:22px;
      border:1px solid var(--brand-200);
      border-radius:10px;background:#4159c4;color:#fff;
    }
    
    /* ‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö: ‡πÉ‡∏´‡πâ 0 (‡πÅ‡∏™‡∏î‡∏á "-") ‡πÇ‡∏ó‡∏ô‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
    .lvbtn[data-value="0"]{ color:#6b7280; background:#f8fafc; border-color:#e5e7eb; }
    /* 1/2 ‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô + ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° */
    .lvbtn[data-value="1"],.lvbtn[data-value="2"]{ background:#4159c4; color:#fff; }
    
    /* ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á ‚Äú‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‚Äù ‚Üí ‡∏¢‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏ä‡∏±‡∏î */
    .lvbtn.readonly{
      background:#eef2ff;              /* ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
      color:#374151;                    /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏° */
      border-color:#c7d2fe;             /* ‡∏Ç‡∏≠‡∏ö‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô */
      cursor: default;
      opacity: 1;                       /* ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏µ‡∏î */
    }
    
    /* ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÅ‡∏•‡∏∞ readonly ‚Üí ‡πÇ‡∏ó‡∏ô‡∏≠‡πà‡∏≠‡∏ô‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏ä‡∏±‡∏î */
    .lvbtn.readonly[data-value="0"]{
      background:#f3f4ff;              /* ‡∏ü‡πâ‡∏≤‡∏≠‡∏°‡∏°‡πà‡∏ß‡∏á‡∏≠‡πà‡∏≠‡∏ô */
      color:#4b5563;
      border-color:#dbe3ff;
    }
    
    /* ‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (dirty) ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
    .lvbtn.dirty{ outline:2px solid #f59e0b; outline-offset:-3px; }
    /* ===== 1) ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏ô‡πÄ‡∏ã‡∏•‡∏•‡πå ===== */
    /* ‡∏≠‡∏¢‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á display ‡πÉ‡∏´‡πâ <td> ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î */
    td.center{
      text-align: center;        /* ‡∏à‡∏±‡∏î‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
      vertical-align: middle;    /* ‡∏à‡∏±‡∏î‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
      padding: 10px 12px;
    }
    
    /* ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡πÄ‡∏ã‡∏•‡∏•‡πå */
    td.center .cell{
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;               /* ‡∏Å‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡∏•‡∏•‡πå */
    }
    
    /* ‡∏Å‡∏±‡∏ô margin/inline ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° */
    td.center .lvbtn{
      display: inline-flex;
      margin: 0;
    }
    /* ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
    tr.is-selected td{
      background: var(--row-select-bg) !important;
      position: relative;
      transition: background .15s ease;
    }
    
    /* ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å (sticky) ‡∏Å‡∏•‡∏°‡∏Å‡∏•‡∏∑‡∏ô */
    tr.is-selected td:first-child{
      background: linear-gradient(90deg, #eaf0ff 0%, var(--row-select-bg) 100%) !important;
      font-weight: 700;
    }
    
    /* ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏ö‡∏≤‡∏á ‡πÜ ‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô */
    tr.is-selected td:first-child::before{
      content: "";
      position: absolute; inset: 0 auto 0 0;
      width: 4px; background: var(--row-select-left);
      border-top-left-radius: 6px; border-bottom-left-radius: 6px;
    }
    
    /* hover ‡∏ã‡πâ‡∏≠‡∏ô: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏™‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ */
    tbody tr:hover td{ background:#f8faff; }
    tbody tr.is-selected:hover td{ background: var(--row-select-bg); }
  </style>
</head>
<body>
  <header>
    <h1>Skill Matrix ‚Äî ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏™‡∏Å‡∏¥‡∏• (0/1/2)</h1>
  <div class="controls">
    <label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç):
      <select id="person"></select>
    </label>
    <button id="saveBtn" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
    <button id="resetBtn" class="secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    <span class="small">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
  </div>
  <div>
  <!-- üîµ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°/‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ -->
    <label>‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô :
    <input id="newName" placeholder="Name" style="margin-left:8px; min-width:180px;" />
    <button id="btnAdd" class="secondary" title="Add new">‚ûï Add</button>
    <button id="btnDel" class="secondary" title="Delete">üóë Del</button>
  </div>
  </header>
  <form id="gasForm" method="POST" target="gasTarget" action="">
  <input type="hidden" name="name" id="f_name">
  <!-- üîµ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ -->
  <input type="hidden" name="action"   id="f_action">
  <input type="hidden" name="new_name" id="f_new_name">
  <!-- ‡∏ä‡πà‡∏≠‡∏á u_skill[] / u_level[] ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≠‡∏ô‡∏Å‡∏î Save -->
  <div id="msg" class="status"></div>
  </form>
  <div class="wrap">
    <div class="table-wrap">
      <table id="skillTable" aria-label="Skill matrix table">
        <thead>
          <tr id="groupRow"></tr>
          <tr id="skillRow"></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Apps Script ‡∏ú‡πà‡∏≤‡∏ô iframe (‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS) -->
  


<script>
/* =========================== CONFIG =========================== */
/* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô export raw CSV ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏ä‡∏µ‡∏ï 100% */
const CSV_URL = "https://docs.google.com/spreadsheets/d/1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k/export?format=csv&gid=0";

/* Apps Script Web App URL (exec) */
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzPMwWO8ir9wa8kSVDn_aWn_-vyY11K8Z2msF4nY2Aj7iyRyYJctzEo3F-VlYW-w-68jQ/exec";
/* ============================================================= */

let state = {
  nameCol: 0,
  names: [],
  groups: [],   // group header (row 1) after forward-fill
  skills: [],   // [{idx, label, group}]
  rows: [],     // data rows (from row after skill header)
  levels: {},   // { name: { skillLabel: "0"|"1"|"2"|"" } }
  current: "",  // selected person
  dirty: new Map()
};

const $ = (id) => document.getElementById(id);
const elPerson   = $("person");
const elMsg      = $("msg");
const elGroupRow = $("groupRow");
const elSkillRow = $("skillRow");
const elTbody    = $("tbody");

function setMessage(t){ elMsg.textContent = t; }
function toStr(v){ return String(v ?? "").trim(); }
function esc(s){ return s.replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[m])); }

/* ---------------- CSV Loader + Parse ---------------- */
/* ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "name" = ‡∏´‡∏±‡∏ß‡∏™‡∏Å‡∏¥‡∏•; ‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ = ‡∏´‡∏±‡∏ß‡∏Å‡∏•‡∏∏‡πà‡∏° */
async function loadCSV(){
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet...");
  const r = await fetch(CSV_URL, { cache: "no-store" });
  if (!r.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î CSV ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  const text = await r.text();
  const matrix = parseCSV(text);

  // 1) ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "name" (‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏™‡∏Å‡∏¥‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á)
  let skillHeaderRowIdx = -1, nameCol = -1;
  for (let i = 0; i < Math.min(15, matrix.length); i++) {
    const row = matrix[i];
    const idx = row.findIndex(v => String(v ?? '').trim().toLowerCase() === 'name');
    if (idx !== -1) { skillHeaderRowIdx = i; nameCol = idx; break; }
  }
  if (skillHeaderRowIdx < 0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "name" ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß');

  // 2) ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡∏Å‡∏•‡∏∏‡πà‡∏° (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ merge)
  const groupHeaderRowIdx = Math.max(0, skillHeaderRowIdx - 1);
  const groupRowRaw = matrix[groupHeaderRowIdx].map(x => String(x ?? '').replace(/\s+/g,' ').trim());

  // 3) ‡πÄ‡∏≠‡∏≤‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏™‡∏Å‡∏¥‡∏•
  let skillRow = matrix[skillHeaderRowIdx].map(x => String(x ?? '').replace(/\s+/g,' ').trim());

  // 3.1) ‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î: ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏™‡∏Å‡∏¥‡∏• ‚Äú‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏ñ‡∏ß‡∏Å‡∏•‡∏∏‡πà‡∏°‚Äù (‡πÄ‡∏ä‡πà‡∏ô export ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô) ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á 1 ‡πÅ‡∏ñ‡∏ß
  const looksLikeGroup =
    skillRow.some((v,i) => i !== nameCol && v) &&                       // ‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á
    skillRow.every((v,i) => i === nameCol || v === groupRowRaw[i]);     // ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á
  if (looksLikeGroup && matrix[skillHeaderRowIdx + 1]) {
    skillHeaderRowIdx += 1;
    skillRow = matrix[skillHeaderRowIdx].map(x => String(x ?? '').replace(/\s+/g,' ').trim());
  }

  // 4) ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  const dataRows = matrix.slice(skillHeaderRowIdx + 1);

  // 5) forward-fill group header
  const groupRow = [];
  let lastGroup = "";
  for (let c=0; c<groupRowRaw.length; c++){
    const g = groupRowRaw[c];
    if (g) lastGroup = g;
    groupRow[c] = lastGroup;
  }

  // 6) ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏Å‡∏¥‡∏• (‡∏Ç‡πâ‡∏≤‡∏° name ‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏ß‡πà‡∏≤‡∏á)
  const skillCols = [];
  for (let c=0; c<skillRow.length; c++){
    if (c === nameCol) continue;
    const s = skillRow[c];
    if (!s) continue;
    skillCols.push({ idx: c, label: s, group: groupRow[c] || '' });
  }

  // 7) names + levels
  const names = [];
  const levels = {};
  for (const row of dataRows){
    const nm = String(row[nameCol] ?? '').trim();
    if (!nm) continue;
    names.push(nm);
    const mp = {};
    for (const col of skillCols){
      const raw = row[col.idx];
      const v = (raw === undefined || raw === null) ? '' : String(raw).trim();
      mp[col.label] = (v === '0' || v === '1' || v === '2') ? v : '';
    }
    levels[nm] = mp;
  }

  // 8) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï state + ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå
  state.nameCol = nameCol;
  state.names   = names;
  state.groups  = groupRow;
  state.skills  = skillCols;
  state.rows    = dataRows;
  state.levels  = levels;
  state.current = names[0] || "";
  state.dirty.clear();

  buildThead(skillCols);
  buildTbody();

  const options = names.map(n => `<option value="${n.replace(/&/g,"&amp;").replace(/</g,"&lt;")}">${n}</option>`).join("");
  document.getElementById("person").innerHTML = options;
  document.getElementById("person").value = state.current;

  setMessage("‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
}
  
/* -------------- Basic CSV Parser (quoted) -------------- */
function parseCSV(text){
  const rows = [];
  let i=0, cur="", row=[], inq=false;
  while(i<text.length){
    const ch = text[i];
    if (inq){
      if (ch === '"'){
        if (text[i+1] === '"'){ cur += '"'; i+=2; continue; }
        inq = false; i++; continue;
      } else { cur += ch; i++; continue; }
    } else {
      if (ch === '"'){ inq=true; i++; continue; }
      if (ch === ','){ row.push(cur); cur=""; i++; continue; }
      if (ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=""; i++; continue; }
      if (ch === '\r'){ i++; continue; }
      cur += ch; i++;
    }
  }
  row.push(cur); rows.push(row);
  return rows;
}

/* ---------------- Render THEAD (2 rows) ---------------- */
function buildThead(skillCols){
  elGroupRow.innerHTML = "";
  elSkillRow.innerHTML = "";

  // name column ‚Üí rowspan=2
  const thName = document.createElement("th");
  thName.textContent = "name";
  thName.rowSpan = 2;
  elGroupRow.appendChild(thName);

  // groups with colspan
  let i = 0;
  while (i < skillCols.length) {
    const g = skillCols[i].group || "";
    let span = 1;
    let j = i + 1;
    while (j < skillCols.length && (skillCols[j].group || "") === g) { span++; j++; }
    const th = document.createElement("th");
    th.textContent = g;
    th.colSpan = span;
    elGroupRow.appendChild(th);
    i = j;
  }

  // skill names row
  for (const col of skillCols){
    const th = document.createElement("th");
    th.textContent = col.label;
    elSkillRow.appendChild(th);
  }
}

/* ---------------- Render TBODY ---------------- */
function buildTbody(){
  elTbody.innerHTML = "";
  for (const name of state.names){
    const tr = document.createElement("tr");

    // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ä‡∏∑‡πà‡∏≠
    const tdName = document.createElement("td");
    tdName.className = "name-cell";
    tdName.textContent = name;
    tr.appendChild(tdName);

    const editable = (name === state.current);

    for (const col of state.skills){
      const skill = col.label;
      const baseline = (state.levels[name]?.[skill] ?? '0') || '0'; // '' -> '0'
      const current  = (name === state.current && state.dirty.has(skill))
        ? state.dirty.get(skill)
        : baseline;
      const td = document.createElement("td");
      td.className = "center";
      
      const wrap = document.createElement("div");
      wrap.className = "cell";     // << wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö flex
      


      // ‡∏õ‡∏∏‡πà‡∏°‡∏ß‡∏á‡∏Å‡∏•‡∏°
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "lvbtn";
      btn.textContent = symbolForLevel(current);
      btn.dataset.skill = skill;
      btn.dataset.value = current;

      if (!editable){
        btn.classList.add("readonly");
      } else {
        if (current !== baseline) btn.classList.add("dirty");

        btn.addEventListener("click", ()=>{
          const oldVal = btn.dataset.value;
          const newVal = nextLevel(oldVal);
          btn.dataset.value = newVal;
          btn.textContent = symbolForLevel(newVal);

          if (newVal === baseline){
            state.dirty.delete(skill);
            btn.classList.remove("dirty");
          } else {
            state.dirty.set(skill, newVal);
            btn.classList.add("dirty");
          }
        });
      }
      wrap.appendChild(btn);
      td.appendChild(wrap);
      //td.appendChild(btn);
      tr.appendChild(td);
    }

    elTbody.appendChild(tr);
  }
}
/* ---------------- Events ---------------- */
elPerson.addEventListener("change", ()=>{
  state.current = elPerson.value;
  state.dirty.clear();
  buildTbody();
});

$("resetBtn").addEventListener("click", ()=>{
  state.dirty.clear();
  buildTbody();
  setMessage("‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
});

/* ====== SAVE (‡∏ß‡∏¥‡∏ò‡∏µ B: u_skill[] / u_level[]) ====== */
document.getElementById("saveBtn").addEventListener("click", saveViaIframeArray);

function saveViaIframeArray(){
  const selectedName = state.current;
  if (!selectedName){ setMessage("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); return; }
  if (state.dirty.size === 0){ setMessage("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"); return; }

  const form   = document.getElementById("gasForm");
  const iframe = document.getElementById("gasTarget");

  form.action = GAS_ENDPOINT;

  // ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠
  document.getElementById("f_name").value = selectedName;

  // ‡∏•‡∏ö‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï‡πÄ‡∏Å‡πà‡∏≤ u_skill[] / u_level[]
  [...form.querySelectorAll('input[name="u_skill[]"], input[name="u_level[]"]')]
    .forEach(el => el.remove());

  // ‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏° dirty
  for (const [skill, level] of state.dirty.entries()){
    const a = document.createElement('input');
    a.type='hidden'; a.name='u_skill[]'; a.value=skill; form.appendChild(a);
    const b = document.createElement('input');
    b.type='hidden'; b.name='u_level[]'; b.value=level; form.appendChild(b);
  }

  // ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
  const onLoad = ()=>{
    const mp = state.levels[selectedName] || (state.levels[selectedName] = {});
    for (const [skill, level] of state.dirty.entries()) mp[skill] = level;
    state.dirty.clear();
    buildTbody();
    setMessage("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    iframe.removeEventListener('load', onLoad);
  };
  iframe.addEventListener('load', onLoad, { once: true });

  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");
  form.submit();
}

/* ---------------- Boot ---------------- */
loadCSV().catch(err=>{
  setMessage("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (err.message || err));
});

// ===== ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠ =====
document.getElementById("btnAdd").addEventListener("click", addName);
document.getElementById("btnDel").addEventListener("click", deleteName);

function addName(){
  const input = document.getElementById("newName");
  const newName = (input.value || "").trim();
  if (!newName){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); return; }

  const form   = document.getElementById("gasForm");
  const iframe = document.getElementById("gasTarget");
  form.action = GAS_ENDPOINT;

  // ‡∏ï‡∏±‡πâ‡∏á action + payload
  document.getElementById("f_action").value   = "addName";
  document.getElementById("f_new_name").value = newName;

  // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ã‡πâ‡∏≥
  const btnAdd = document.getElementById("btnAdd");
  const btnDel = document.getElementById("btnDel");
  btnAdd.disabled = true; btnDel.disabled = true;

  const cleanup = () => {
    document.getElementById("f_action").value   = "";
    document.getElementById("f_new_name").value = "";
    // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á input ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à
    input.value = "";
    btnAdd.disabled = false; btnDel.disabled = false;
  };

  iframe.onload = () => {
    iframe.onload = null;
    cleanup();
    setMessage("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + newName);
    // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î + ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°
    loadCSV().then(()=> {
      const sel = document.getElementById("person");
      if ([...sel.options].some(o => o.value === newName)) {
        sel.value = newName;
        state.current = newName;
        buildTbody();
      }
    });
  };

  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠...");
  form.submit();
}

function deleteName(){
  const input  = document.getElementById("newName");
  const target = (input.value || document.getElementById("person").value || "").trim();
  if (!target){ alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö"); return; }
  if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠ "${target}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï?`)) return;

  const form   = document.getElementById("gasForm");
  const iframe = document.getElementById("gasTarget");
  form.action = GAS_ENDPOINT;

  // ‡∏•‡πâ‡∏≤‡∏á field ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏Å‡∏¥‡∏•
  document.getElementById("f_name").value = "";
  [...form.querySelectorAll('input[name="u_skill[]"], input[name="u_level[]"]')]
    .forEach(el => el.remove());

  // ‡∏ï‡∏±‡πâ‡∏á action + payload
  document.getElementById("f_action").value   = "deleteName";
  document.getElementById("f_new_name").value = target;

  // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ã‡πâ‡∏≥
  const btnAdd = document.getElementById("btnAdd");
  const btnDel = document.getElementById("btnDel");
  btnAdd.disabled = true; btnDel.disabled = true;

  const cleanup = () => {
    document.getElementById("f_action").value   = "";
    document.getElementById("f_new_name").value = "";
    // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á input ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à
    input.value = "";
    btnAdd.disabled = false; btnDel.disabled = false;
  };

  iframe.onload = () => {
    iframe.onload = null;
    cleanup();
    setMessage("‚úÖ ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + target);
    // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î + ‡∏ñ‡πâ‡∏≤ current ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏£‡∏Å
    loadCSV().then(()=> {
      const sel = document.getElementById("person");
      if (![...sel.options].some(o => o.value === state.current)) {
        state.current = sel.options[0]?.value || "";
        sel.value = state.current;
        buildTbody();
      }
    });
  };

  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠...");
  form.submit();
}

function symbolForLevel(lv){
  // ‡πÅ‡∏™‡∏î‡∏á 0 ‡πÄ‡∏õ‡πá‡∏ô "-" (visual only)
  return lv === '2' ? '‚óè' : (lv === '1' ? '‚óã' : '-');
}
function nextLevel(lv){
  return lv === '0' ? '1' : (lv === '1' ? '2' : '0');
}

function updateStickyHeaderOffset(){
  const r1 = document.querySelector('#groupRow');   // ‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å
  const h  = (r1 && r1.offsetHeight) ? r1.offsetHeight : 34;
  document.documentElement.style.setProperty('--h1', h + 'px');
}
window.addEventListener('load', updateStickyHeaderOffset);
window.addEventListener('resize', updateStickyHeaderOffset);

// ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ buildThead() ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏£‡πá‡∏à
const _buildThead = buildThead;
buildThead = function(...args){
  const res = _buildThead.apply(this, args);
  requestAnimationFrame(updateStickyHeaderOffset);
  return res;
};
</script>
</body>
</html>
