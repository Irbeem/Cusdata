<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skill Matrix (0/1/2) ‚Äî YAPTCSSKILL</title>
  <style>
    :root{
      --h1: 34px;                   /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏´‡∏±‡∏ß‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏î‡πâ‡∏ß‡∏¢ JS) */
      --firstW: 220px;              /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå name (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏î‡πâ‡∏ß‡∏¢ JS) */
      --border:#e5e7eb;

      /* ‡πÅ‡∏û‡πÄ‡∏•‡∏ï */
      --brand-50:#eef2ff; --brand-100:#e0e7ff; --brand-200:#c7d2fe;
      --brand-400:#6366f1; --brand-500:#4f46e5; --brand-600:#4338ca;

      --row-select-bg:#FFE6D6;      /* ‡∏™‡∏µ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
      --row-hover:#f6f8ff;
      --cell-green:#dff7ea;         /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏Å‡∏¥‡∏•‡∏Ñ‡πà‡∏≤ 1 */
      --cell-blue:#dfe8ff;          /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏Å‡∏¥‡∏•‡∏Ñ‡πà‡∏≤ 2 */
    }

    html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans",Arial;color:#111827;background:#fff}

    /* Header / Toolbar */
    header{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(180deg,#f9fafb 0%,#fff 100%);
      border-bottom:1px solid var(--border); padding:12px;
      box-shadow:0 4px 14px rgba(15,23,42,.06);
    }
    h1{margin:0 0 8px 0;font-size:16px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .controls select,.controls input{
      border:1px solid var(--border);border-radius:10px;padding:8px 12px;background:#fff;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    .controls select:focus,.controls input:focus{
      outline:none;border-color:var(--brand-400);
      box-shadow:0 0 0 4px color-mix(in srgb, var(--brand-400) 20%, transparent);
    }
    button{border-radius:10px;padding:10px 14px;border:1px solid transparent;font-weight:600;cursor:pointer}
    button.primary{background:var(--brand-500);color:#fff}
    button.primary:hover{background:var(--brand-600)}
    button.secondary{background:#fff;border:1px solid var(--brand-200);color:#1f2937}
    .status{font-size:13px;color:#374151;margin-top:8px}

    .wrap{padding:12px}
    .table-wrap{
      max-height:calc(100vh - 200px);
      overflow:auto;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      box-shadow:0 12px 24px rgba(15,23,42,.05);
    }

    /* Table */
    table{border-collapse:separate;border-spacing:0;width:max-content;min-width:100%}
    th,td{border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:10px 12px;background:#fff;white-space:nowrap}
    th:first-child,td:first-child{border-left:1px solid var(--border)}

    /* Sticky header (‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô) */
    thead th{position:sticky;background:#fff}
    thead tr:first-child th{top:0;z-index:40}          /* ‡πÅ‡∏ñ‡∏ß‡∏Å‡∏•‡∏∏‡πà‡∏° */
    thead tr:nth-child(2) th{top:var(--h1);z-index:39} /* ‡πÅ‡∏ñ‡∏ß‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏Å‡∏¥‡∏• */

    /* name & branch ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠ (rowspan=2) ‡πÅ‡∏•‡∏∞ sticky ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ */
    thead th.name-th{left:0;z-index:42}
    thead th.branch-th{left:var(--firstW);z-index:41}

    /* ‡πÄ‡∏ã‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ sticky ‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß */
    tbody td.name-td{
      position:sticky; left:0;
      background:#f8fafc; z-index:20; font-weight:700;
    }
    tbody td.branch-td{
      position:sticky; left:var(--firstW);
      background:linear-gradient(90deg,#f8fafc 0%, #fff 100%);
      z-index:19;
    }

    /* ‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏´‡∏±‡∏ß‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å) */
    #groupRow th{
      background:linear-gradient(180deg,var(--brand-50) 0%,#fff 95%);
      border-bottom:2px solid var(--brand-200);
      font-weight:700;
    }

    /* ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏µ/hover */
    tbody tr:nth-child(even) td{background:#fcfcff}
    tbody tr:hover td{background:var(--row-hover)}

    /* ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î) */
    tr.is-selected td{
      background: var(--row-select-bg) !important;
      position: relative;
      transition: background .15s ease;
    }
    tr.is-selected td.name-td{
      background: linear-gradient(90deg,#eaf0ff 0%, var(--row-select-bg) 100%) !important;
    }
    tr.is-selected:hover td{ background: var(--row-select-bg); }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö (0/1/2) */
    td.center{ text-align:center; vertical-align:middle }
    .lvbtn{
      display:inline-flex;align-items:center;justify-content:center;
      width:32px;height:32px;font-size:22px;border-radius:10px;
      border:1px solid var(--brand-200); background:#4159c4; color:#fff;
    }
    .lvbtn[data-value="0"]{ color:#6b7280; background:#f8fafc; border-color:#e5e7eb; }
    .lvbtn[data-value="1"]{ background:#4159c4; color:#fff; }
    .lvbtn[data-value="2"]{ background:#2234a0; color:#fff; }
    .lvbtn.readonly{
      background:#eef2ff; color:#374151; border-color:#c7d2fe; cursor:default; opacity:1;
    }
    .lvbtn.readonly[data-value="0"]{ background:#f3f4ff; color:#4b5563; border-color:#dbe3ff; }
    .lvbtn.dirty{ outline:2px solid #f59e0b; outline-offset:-3px; }

    /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö (‡∏ä‡πà‡∏ß‡∏¢‡∏°‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô) */
    td[data-lv="1"]{ background: var(--cell-green) }
    td[data-lv="2"]{ background: var(--cell-blue) }
  </style>
</head>
<body>
  <header>
    <h1>Skill Matrix ‚Äî ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏™‡∏Å‡∏¥‡∏• (0/1/2)</h1>

    <!-- ‡πÅ‡∏ñ‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á -->
    <div class="controls">
      <label>Branch:
        <select id="branchFilter">
          <option value="__ALL__">All branches</option>
        </select>
      </label>

      <label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç):
        <select id="person"></select>
      </label>

      <button id="saveBtn" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
      <button id="resetBtn" class="secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>

    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
    <div class="controls" style="margin-top:6px">
      <input id="newName" placeholder="Name (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö)" style="min-width:180px" />
      <input id="newBranch" list="branchList" placeholder="Branch (‡πÄ‡∏ä‡πà‡∏ô BKK, CBI)" style="min-width:160px" />
      <datalist id="branchList"></datalist>
      <button id="btnAdd" class="secondary" title="Add new">‚ûï Add</button>
      <button id="btnDel" class="secondary" title="Delete">üóë Delete</button>
    </div>

    <div class="small" style="margin-top:6px">
      Skill: '-' = No , '‚óã' = Can do , '‚óè'  = Can teach
    </div>
  </header>

  <!-- iframe + form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Apps Script -->
  <iframe id="gasTarget" name="gasTarget" style="display:none"></iframe>
  <form id="gasForm" method="POST" target="gasTarget" action="">
    <input type="hidden" name="name" id="f_name">
    <input type="hidden" name="action"   id="f_action">
    <input type="hidden" name="new_name" id="f_new_name">
    <input type="hidden" name="new_branch" id="f_new_branch">
    <input type="hidden" name="del_branch" id="f_del_branch">
  </form>

  <div class="wrap">
    <div id="msg" class="status"></div>
    <div class="table-wrap">
      <table id="skillTable" aria-label="Skill matrix table">
        <thead>
          <tr id="groupRow"></tr>
          <tr id="skillRow"></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
/* =========================== CONFIG =========================== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k/export?format=csv&gid=0";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzPMwWO8ir9wa8kSVDn_aWn_-vyY11K8Z2msF4nY2Aj7iyRyYJctzEo3F-VlYW-w-68jQ/exec";
/* ============================================================= */

let state = {
  nameCol: 0,
  branchCol: null,
  names: [],
  branches: [],           // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ branch ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (unique)
  groups: [],
  skills: [],
  rows: [],
  levels: {},
  rowByName: {},
  current: "",
  dirty: new Map(),
  branchFilter: "__ALL__"
};

const $ = (id) => document.getElementById(id);
const elPerson      = $("person");
const elMsg         = $("msg");
const elGroupRow    = $("groupRow");
const elSkillRow    = $("skillRow");
const elTbody       = $("tbody");
const elBranchFlt   = $("branchFilter");
const elBranchList  = $("branchList");

function setMessage(t){ elMsg.textContent = t; }
function toStr(v){ return String(v ?? "").trim(); }

/* ---------------- CSV Loader + Parse ---------------- */
async function loadCSV(){
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet...");
  const r = await fetch(CSV_URL, { cache: "no-store" });
  if (!r.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î CSV ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  const text = await r.text();
  const matrix = parseCSV(text);

  // 1) ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß "name"
  let skillHeaderRowIdx = -1, nameCol = -1;
  for (let i = 0; i < Math.min(15, matrix.length); i++) {
    const row = matrix[i];
    const idx = row.findIndex(v => String(v ?? '').trim().toLowerCase() === 'name');
    if (idx !== -1) { skillHeaderRowIdx = i; nameCol = idx; break; }
  }
  if (skillHeaderRowIdx < 0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "name" ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß');

  // branch = ‡∏ñ‡∏±‡∏î‡∏à‡∏≤‡∏Å name
  const branchCol = nameCol + 1;
  state.nameCol = nameCol;
  state.branchCol = branchCol;

  // 2) ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡∏Å‡∏•‡∏∏‡πà‡∏°
  const groupHeaderRowIdx = Math.max(0, skillHeaderRowIdx - 1);
  const groupRowRaw = matrix[groupHeaderRowIdx].map(x => String(x ?? '').replace(/\s+/g,' ').trim());

  // 3) ‡πÄ‡∏≠‡∏≤‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏™‡∏Å‡∏¥‡∏• (‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î)
  let skillRow = matrix[skillHeaderRowIdx].map(x => String(x ?? '').replace(/\s+/g,' ').trim());
  const looksLikeGroup =
    skillRow.some((v,i) => i !== nameCol && v) &&
    skillRow.every((v,i) => i === nameCol || v === groupRowRaw[i]);
  if (looksLikeGroup && matrix[skillHeaderRowIdx + 1]) {
    skillHeaderRowIdx += 1;
    skillRow = matrix[skillHeaderRowIdx].map(x => String(x ?? '').replace(/\s+/g,' ').trim());
  }

  // 4) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  const dataRows = matrix.slice(skillHeaderRowIdx + 1);

  // 5) forward-fill group header
  const groupRow = [];
  let lastGroup = "";
  for (let c=0; c<groupRowRaw.length; c++){
    const g = groupRowRaw[c];
    if (g) lastGroup = g;
    groupRow[c] = lastGroup;
  }

  // 6) ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏Å‡∏¥‡∏• (‡∏Ç‡πâ‡∏≤‡∏° name/branch)
  const skillCols = [];
  for (let c=0; c<skillRow.length; c++){
    if (c === nameCol || c === branchCol) continue;
    const s = skillRow[c];
    if (!s) continue;
    skillCols.push({ idx: c, label: s, group: groupRow[c] || '' });
  }

  // 7) names + levels + rowByName + branches
  const names = [];
  const levels = {};
  const rowByName = {};
  const branchSet = new Set();

  for (const row of dataRows){
    const nm = String(row[nameCol] ?? '').trim();
    if (!nm) continue;
    names.push(nm);
    rowByName[nm] = row;

    const br = String(row[branchCol] ?? '').trim();
    if (br) branchSet.add(br);

    const mp = {};
    for (const col of skillCols){
      const raw = row[col.idx];
      const v = (raw === undefined || raw === null) ? '' : String(raw).trim();
      mp[col.label] = (v === '0' || v === '1' || v === '2') ? v : '';
    }
    levels[nm] = mp;
  }

  state.names      = names;
  state.groups     = groupRow;
  state.skills     = skillCols;
  state.rows       = dataRows;
  state.levels     = levels;
  state.rowByName  = rowByName;
  state.branches   = Array.from(branchSet).sort((a,b)=>a.localeCompare(b));
  if (!state.current || !names.includes(state.current)) state.current = names[0] || "";
  state.dirty.clear();

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß/‡∏ï‡∏±‡∏ß
  buildThead(skillCols);
  buildPersonSelector();        // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô (‡∏ï‡∏≤‡∏° filter)
  buildBranchFilter();          // ‡∏î‡∏£‡∏≠‡∏õ‡∏î‡∏≤‡∏ß‡∏ô‡πå branch
  buildBranchDatalist();        // datalist ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö
  buildTbody();

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï sticky offset/width
  requestAnimationFrame(()=>{
    updateStickyHeaderOffset();
    updateFirstColWidth();
  });

  setMessage("‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
}

function buildPersonSelector(){
  const filtered = filteredNames();
  elPerson.innerHTML = filtered.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join("");
  // ‡∏ñ‡πâ‡∏≤ current ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å filter ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡πÅ‡∏£‡∏Å
  if (!filtered.includes(state.current)){
    state.current = filtered[0] || "";
  }
  elPerson.value = state.current;
}

function buildBranchFilter(){
  const cur = state.branchFilter;
  const opts = ['__ALL__', ...state.branches];
  elBranchFlt.innerHTML = opts.map(v =>
    `<option value="${escapeHtml(v)}">${v==='__ALL__'?'All branches':escapeHtml(v)}</option>`
  ).join("");
  elBranchFlt.value = cur;
}

function buildBranchDatalist(){
  elBranchList.innerHTML = state.branches.map(br => `<option value="${escapeHtml(br)}">`).join("");
}

/* -------------- Basic CSV Parser (quoted) -------------- */
function parseCSV(text){
  const rows = [];
  let i=0, cur="", row=[], inq=false;
  while(i<text.length){
    const ch = text[i];
    if (inq){
      if (ch === '"'){
        if (text[i+1] === '"'){ cur += '"'; i+=2; continue; }
        inq = false; i++; continue;
      } else { cur += ch; i++; continue; }
    } else {
      if (ch === '"'){ inq=true; i++; continue; }
      if (ch === ','){ row.push(cur); cur=""; i++; continue; }
      if (ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=""; i++; continue; }
      if (ch === '\r'){ i++; continue; }
      cur += ch; i++;
    }
  }
  row.push(cur); rows.push(row);
  return rows;
}

/* ---------------- Render THEAD (2 rows) ---------------- */
function buildThead(skillCols){
  elGroupRow.innerHTML = "";
  elSkillRow.innerHTML = "";

  // name
  const thName = document.createElement("th");
  thName.textContent = "name";
  thName.rowSpan = 2;
  thName.className = "name-th";
  elGroupRow.appendChild(thName);

  // branch
  const thBranch = document.createElement("th");
  thBranch.textContent = "branch";
  thBranch.rowSpan = 2;
  thBranch.className = "branch-th";
  elGroupRow.appendChild(thBranch);

  // group headers
  let i = 0;
  while (i < skillCols.length) {
    const g = skillCols[i].group || "";
    let span = 1;
    let j = i + 1;
    while (j < skillCols.length && (skillCols[j].group || "") === g) { span++; j++; }
    const th = document.createElement("th");
    th.textContent = g;
    th.colSpan = span;
    elGroupRow.appendChild(th);
    i = j;
  }

  // skill headers
  for (const col of skillCols){
    const th = document.createElement("th");
    th.textContent = col.label;
    elSkillRow.appendChild(th);
  }
}

/* ---------------- Render TBODY ---------------- */
function filteredNames(){
  const f = state.branchFilter;
  if (f === "__ALL__") return state.names.slice();
  return state.names.filter(n => {
    const row = state.rowByName[n];
    const br  = row ? String(row[state.branchCol]||'').trim() : '';
    return br === f;
  });
}

function buildTbody(){
  elTbody.innerHTML = "";
  const list = filteredNames();

  for (const name of list){
    const tr = document.createElement("tr");
    if (name === state.current) tr.classList.add("is-selected");

    // name
    const tdName = document.createElement("td");
    tdName.className = "name-td";
    tdName.textContent = name;
    tr.appendChild(tdName);

    // branch
    const tdBranch = document.createElement("td");
    tdBranch.className = "branch-td";
    const row = state.rowByName[name];
    tdBranch.textContent = row ? String(row[state.branchCol] || '').trim() : '';
    tr.appendChild(tdBranch);

    const editable = (name === state.current);

    // skills
    for (const col of state.skills){
      const skill    = col.label;
      const baseline = (state.levels[name]?.[skill] ?? '0') || '0';
      const current  = (editable && state.dirty.has(skill))
        ? state.dirty.get(skill)
        : baseline;

      const td = document.createElement("td");
      td.className = "center";
      td.setAttribute("data-lv", current);

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "lvbtn";
      btn.dataset.skill = skill;
      btn.dataset.value = current;
      btn.textContent = symbolForLevel(current);

      if (!editable){
        btn.classList.add("readonly");
      } else {
        if (current !== baseline) btn.classList.add("dirty");
        btn.addEventListener("click", () => {
          const oldVal = btn.dataset.value;
          const newVal = nextLevel(oldVal);
          btn.dataset.value = newVal;
          btn.textContent   = symbolForLevel(newVal);
          td.setAttribute("data-lv", newVal);

          if (newVal === baseline){
            state.dirty.delete(skill);
            btn.classList.remove("dirty");
          } else {
            state.dirty.set(skill, newVal);
            btn.classList.add("dirty");
          }
        });
      }
      td.appendChild(btn);
      tr.appendChild(td);
    }

    elTbody.appendChild(tr);
  }
}

/* ---------------- Utilities ---------------- */
function symbolForLevel(lv){ return lv === '2' ? '‚óè' : (lv === '1' ? '‚óã' : '-'); }
function nextLevel(lv){ return lv === '0' ? '1' : (lv === '1' ? '2' : '0'); }
function updateStickyHeaderOffset(){
  const r1 = document.querySelector('#groupRow');
  const h  = (r1 && r1.offsetHeight) ? r1.offsetHeight : 34;
  document.documentElement.style.setProperty('--h1', h + 'px');
}
function updateFirstColWidth(){
  const thName = document.querySelector('thead th.name-th');
  const w = thName ? thName.getBoundingClientRect().width : 220;
  document.documentElement.style.setProperty('--firstW', w + 'px');
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

/* ---------------- Events ---------------- */
window.addEventListener('resize', ()=>{
  updateStickyHeaderOffset();
  updateFirstColWidth();
});

elPerson.addEventListener("change", ()=>{
  state.current = elPerson.value;
  state.dirty.clear();
  buildTbody();
  requestAnimationFrame(updateFirstColWidth);
});

elBranchFlt.addEventListener("change", ()=>{
  state.branchFilter = elBranchFlt.value;
  buildPersonSelector();
  buildTbody();
});

$("resetBtn").addEventListener("click", ()=>{
  state.dirty.clear();
  buildTbody();
  setMessage("‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
});

/* ====== SAVE (‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ) ====== */
$("saveBtn").addEventListener("click", ()=>{
  const selectedName = state.current;
  if (!selectedName){ setMessage("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); return; }
  if (state.dirty.size === 0){ setMessage("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"); return; }

  const form   = $("gasForm");
  const iframe = $("gasTarget");
  form.action = GAS_ENDPOINT;

  $("f_name").value = selectedName;

  // ‡∏•‡πâ‡∏≤‡∏á input ‡πÄ‡∏Å‡πà‡∏≤
  [...form.querySelectorAll('input[name="u_skill[]"], input[name="u_level[]"]')]
    .forEach(el => el.remove());

  for (const [skill, level] of state.dirty.entries()){
    const a = document.createElement('input');
    a.type='hidden'; a.name='u_skill[]'; a.value=skill; form.appendChild(a);
    const b = document.createElement('input');
    b.type='hidden'; b.name='u_level[]'; b.value=level; form.appendChild(b);
  }

  const onLoad = ()=>{
    const mp = state.levels[selectedName] || (state.levels[selectedName] = {});
    for (const [skill, level] of state.dirty.entries()) mp[skill] = level;
    state.dirty.clear();
    buildTbody();
    setMessage("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    iframe.removeEventListener('load', onLoad);
  };
  iframe.addEventListener('load', onLoad, { once: true });

  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");
  form.submit();
});

/* ===== ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠ (‡∏£‡∏∞‡∏ö‡∏∏ Branch) ===== */
$("btnAdd").addEventListener("click", ()=>{
  const inputName = $("newName");
  const inputBr   = $("newBranch");
  const newName   = (inputName.value || "").trim();
  const newBranch = (inputBr.value || "").trim();
  if (!newName){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); return; }
  if (!newBranch){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Branch"); return; }

  const form   = $("gasForm");
  const iframe = $("gasTarget");
  form.action = GAS_ENDPOINT;

  $("f_action").value     = "addName";
  $("f_new_name").value   = newName;
  $("f_new_branch").value = newBranch;

  const cleanup = () => {
    $("f_action").value = "";
    $("f_new_name").value = "";
    $("f_new_branch").value = "";
    // ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏Ç‡∏≠‡∏•‡πâ‡∏≤‡∏á name ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡πà‡∏≠
    inputName.value = "";
  };

  iframe.onload = () => {
    iframe.onload = null;
    cleanup();
    setMessage(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${newName} (${newBranch})`);
    // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î + ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å branch filter ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î ‡πÜ
    loadCSV().then(()=> {
      state.branchFilter = newBranch;
      elBranchFlt.value  = newBranch;
      buildPersonSelector();
      if ([...elPerson.options].some(o => o.value === newName)) {
        elPerson.value = newName;
        state.current  = newName;
      }
      buildTbody();
      requestAnimationFrame(updateFirstColWidth);
    });
  };

  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠...");
  form.submit();
});

$("btnDel").addEventListener("click", ()=>{
  const inputName = $("newName");
  const inputBr   = $("newBranch");
  const target    = (inputName.value || elPerson.value || "").trim();
  const br        = (inputBr.value || "").trim(); // ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏ß‡∏¢‡∏•‡∏î‡∏ä‡∏ô‡∏Å‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥

  if (!target){ alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö"); return; }
  if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠ "${target}"${br?` (branch ${br})`:``} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï?`)) return;

  const form   = $("gasForm");
  const iframe = $("gasTarget");
  form.action = GAS_ENDPOINT;

  $("f_name").value = ""; // ‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏Å‡∏¥‡∏•
  [...form.querySelectorAll('input[name="u_skill[]"], input[name="u_level[]"]')].forEach(el => el.remove());

  $("f_action").value     = "deleteName";
  $("f_new_name").value   = target;
  $("f_del_branch").value = br;

  const cleanup = () => {
    $("f_action").value = "";
    $("f_new_name").value = "";
    $("f_del_branch").value = "";
    inputName.value = "";
  };

  iframe.onload = () => {
    iframe.onload = null;
    cleanup();
    setMessage(`‚úÖ ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${target}${br?` (${br})`:``}`);
    loadCSV().then(()=> {
      buildPersonSelector();
      buildTbody();
      requestAnimationFrame(updateFirstColWidth);
    });
  };

  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠...");
  form.submit();
});

/* ---------------- Boot ---------------- */
loadCSV().catch(err=>{
  setMessage("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (err.message || err));
});
</script>
</body>
</html>
