<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Skill Matrix (0/1/2) ‚Äî YAPTCSSKILL</title>
<style>
  /* ===== Theme & Base ===== */
  :root{
    --border:#e5e7eb; --sticky:#f9fafb;
    --brand-25:#f5f7ff; --brand-50:#eef2ff; --brand-100:#e0e7ff; --brand-200:#c7d2fe;
    --brand-400:#6366f1; --brand-500:#4f46e5; --brand-600:#4338ca;
    --green:#16a34a; --blue:#2563eb; --amber:#f59e0b;
    --row-current-overlay: rgba(59,130,246,.14);  /* selected name row overlay (blue-ish) */
    --row-hover-overlay:   rgba(2,132,199,.12);  /* hover overlay (cyan-ish) */
  }
  html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans",Arial;color:#111827;background:#fff}
  header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#f9fafb 0%,#ffffff 100%);border-bottom:1px solid var(--border);box-shadow:0 4px 14px rgba(15,23,42,.06);padding:12px}
  h1{margin:0 0 8px 0;font-size:16px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .controls select,.controls input{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px}
  .controls select:focus,.controls input:focus{outline:none;border-color:var(--brand-400);box-shadow:0 0 0 4px color-mix(in srgb, var(--brand-400) 20%, transparent)}
  button{border-radius:10px;padding:10px 14px;border:1px solid transparent;font-weight:600;transition:transform .05s ease,box-shadow .15s ease;background:#fff}
  button:active{transform:translateY(1px)}
  .primary{background:var(--brand-500);border-color:var(--brand-500);color:#fff;box-shadow:0 6px 14px rgba(79,70,229,.25)}
  .primary:hover{background:var(--brand-600)}
  .secondary{background:#fff;color:var(--brand-600);border-color:var(--brand-200)}
  .secondary:hover{background:var(--brand-50);border-color:var(--brand-400)}
  #btnAdd.secondary{color:var(--green);border-color:color-mix(in srgb, var(--green) 35%, #ffffff)}
  #btnAdd.secondary:hover{background:color-mix(in srgb, var(--green) 12%, #ffffff);border-color:var(--green)}
  #btnDel.secondary{color:#f43f5e;border-color:color-mix(in srgb, #f43f5e 35%, #ffffff)}
  #btnDel.secondary:hover{background:color-mix(in srgb, #f43f5e 10%, #ffffff);border-color:#f43f5e}
  .status{font-size:13px;color:#374151;margin-top:6px}

  /* ===== Table wrapper ===== */
  .wrap{padding:12px}
  .table-wrap{max-height:calc(100vh - 180px);overflow:auto;border:1px solid var(--border);border-radius:14px;box-shadow:0 12px 24px rgba(15,23,42,.05)}
  .table-wrap, .table-wrap *{transform:none !important;filter:none !important;backdrop-filter:none !important}

  table{border-collapse:separate;border-spacing:0;width:max-content;min-width:100%}
  th,td{border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:10px 12px;background:#fff;white-space:nowrap}
  th:first-child,td:first-child{border-left:1px solid var(--border)}
  .center{text-align:center}

  /* ===== Sticky (2 header rows + 2 left cols) ===== */
  :root{ --h1: 36px; } /* header-1 height variable (updated by JS) */
  thead th{position:sticky;background:#fff}
  thead tr:first-child th{top:0;z-index:40}
  thead tr:nth-child(2) th{top:var(--h1);z-index:39}
  /* left sticky columns */
  thead th.sticky-1, tbody td.sticky-1{position:sticky;left:0;z-index:41;background:linear-gradient(90deg,#f8fafc 0%,#fff 100%);font-weight:700}
  thead th.sticky-2, tbody td.sticky-2{position:sticky;left:200px;z-index:40;background:linear-gradient(90deg,#f8fafc 0%,#fff 100%);font-weight:700}
  .col-name{width:200px}
  .col-branch{width:120px}

  /* ===== Vivid Header colors ===== */
  #groupRow th{
    background:linear-gradient(180deg,var(--brand-100) 0%, #ffffff 80%);
    color:#0f172a;font-weight:800;border-bottom:2px solid var(--brand-200);
    box-shadow:inset 0 -2px 0 var(--brand-200);
  }
  #skillRow th{
    background:var(--brand-25);
    color:#0f172a;font-weight:800;border-bottom:2px solid var(--brand-100);
  }
  /* header chips for the two sticky headers */
  thead th.sticky-1, thead th.sticky-2{background:linear-gradient(180deg,#f3f4ff 0%, #ffffff 90%)}

  /* ===== Level cell backgrounds ===== */
  td.lv-0{background:#ffffff}
  td.lv-1{background:#e9f8ef}  /* light green */
  td.lv-2{background:#e9efff}  /* light blue  */

  /* ===== Selected name row (stronger & clear) ===== */
  tr.is-current td{
    /* big inset shadow overlay so it doesn't overwrite per-level background */
    box-shadow: inset 0 0 0 9999px var(--row-current-overlay);
  }
  /* make the first sticky name cell even clearer */
  tr.is-current td.sticky-1{
    color:#0f172a;
    box-shadow: inset 4px 0 0 var(--brand-500), inset 0 0 0 9999px var(--row-current-overlay);
  }

  /* ===== Hover row ‚Äî clearer overlay, but keep level color below ===== */
  tbody tr:hover td{
    box-shadow: inset 0 0 0 9999px var(--row-hover-overlay);
  }

  /* Keep level tint visible but allow hover/selected overlays to show */
  tbody tr:hover td.lv-1{ background:#dff3e8 }
  tbody tr:hover td.lv-2{ background:#e0e7ff }

  /* ===== Level buttons ===== */
  .lvbtn{
    display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;
    font-size:20px;border:1px solid #e5e7eb;border-radius:10px;background:#f3f4f6;color:#1f2937;
    transition:background .12s ease,border-color .12s ease,color .12s ease;user-select:none;cursor:pointer
  }
  .lvbtn.readonly{cursor:default;opacity:.9}
  .lvbtn.dirty{box-shadow:0 0 0 4px color-mix(in srgb, var(--amber) 25%, transparent)}
  .lvbtn.lv-0{background:#f3f4f6;color:#374151;border-color:#e5e7eb} /* 0 */
  .lvbtn.lv-1{background:var(--green);color:#fff;border-color:var(--green)}  /* 1 */
  .lvbtn.lv-2{background:var(--blue); color:#fff;border-color:var(--blue)}   /* 2 */
</style>
</head>
<body>
<header>
  <h1>Skill Matrix ‚Äî ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏™‡∏Å‡∏¥‡∏• (0/1/2)</h1>
  <div class="controls">
    <label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç):
      <select id="person"></select>
    </label>
    <button id="saveBtn" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
    <button id="resetBtn" class="secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    <span style="font-size:13px;color:#6b7280">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
  </div>
  <div class="controls" style="margin-top:6px">
    <input id="newName"   placeholder="Name (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö)" style="min-width:200px" />
    <input id="newBranch" placeholder="Branch (‡πÄ‡∏ä‡πà‡∏ô BKK, CBI)" style="min-width:160px" />
    <button id="btnAdd" class="secondary">‚ûï Add</button>
    <button id="btnDel" class="secondary">üóë Delete</button>
  </div>
  <div id="msg" class="status"></div>
</header>

<div class="wrap">
  <div class="table-wrap">
    <table id="skillTable" aria-label="Skill matrix table">
      <thead>
        <tr id="groupRow"></tr>
        <tr id="skillRow"></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- iframe ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö submit ‡πÑ‡∏õ GAS -->
<iframe id="gasTarget" name="gasTarget" style="display:none"></iframe>
<form id="gasForm" method="POST" target="gasTarget" action="">
  <input type="hidden" name="name" id="f_name">
  <input type="hidden" name="branch" id="f_branch">
  <input type="hidden" name="action" id="f_action">
  <input type="hidden" name="new_name" id="f_new_name">
  <input type="hidden" name="new_branch" id="f_new_branch">
  <!-- u_skill[] / u_level[] ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≠‡∏ô‡∏Å‡∏î Save -->
</form>

<script>
/* =================== CONFIG =================== */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k/export?format=csv&gid=0";

const GAS_ENDPOINT =
  "https://script.google.com/macros/s/AKfycbzPMwWO8ir9wa8kSVDn_aWn_-vyY11K8Z2msF4nY2Aj7iyRyYJctzEo3F-VlYW-w-68jQ/exec";
/* ============================================== */

const $ = id => document.getElementById(id);
const elPerson = $("person"), elMsg = $("msg");
const elGroupRow = $("groupRow"), elSkillRow = $("skillRow"), elTbody = $("tbody");

let state = {
  nameCol: 0,
  branchCol: 1,
  names: [],
  rows: [],
  groups: [],
  skills: [],     // {idx,label,group}
  levels: {},     // { name: { skillLabel: "0"|"1"|"2" } }
  branches: {},   // { name: "BKK" }
  current: "",
  dirty: new Map()
};

function setMessage(t){ elMsg.textContent = t; }
function symbolForLevel(lv){ return lv==='2'?'‚óè':(lv==='1'?'‚óã':'Ôºç'); }
function nextLevel(lv){ return lv==='0'?'1':(lv==='1'?'2':'0'); }

/* -------- CSV Parser (quoted) -------- */
function parseCSV(text){
  const rows=[], len=text.length; let i=0, cur="", row=[], inq=false;
  while(i<len){
    const ch=text[i];
    if(inq){
      if(ch==='"'){ if(text[i+1]==='"'){cur+='"'; i+=2;} else{inq=false; i++;} }
      else{ cur+=ch; i++; }
    }else{
      if(ch==='"'){ inq=true; i++; }
      else if(ch===','){ row.push(cur); cur=""; i++; }
      else if(ch==='\n'){ row.push(cur); rows.push(row); row=[]; cur=""; i++; }
      else if(ch==='\r'){ i++; }
      else{ cur+=ch; i++; }
    }
  }
  row.push(cur); rows.push(row);
  return rows;
}

/* -------- Load CSV & build state -------- */
async function loadCSV(){
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet‚Ä¶");
  const r = await fetch(CSV_URL, {cache:"no-store"});
  if(!r.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î CSV ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  const matrix = parseCSV(await r.text());

  // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß "name"
  let skillHeaderRowIdx=-1, nameCol=-1;
  for(let i=0;i<Math.min(15,matrix.length);i++){
    const idx = matrix[i].findIndex(v=>String(v??'').trim().toLowerCase()==='name');
    if(idx!==-1){ skillHeaderRowIdx=i; nameCol=idx; break; }
  }
  if(skillHeaderRowIdx<0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "name"');

  // ‡∏£‡∏∞‡∏ö‡∏∏ branchCol ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ñ‡∏±‡∏î‡∏à‡∏≤‡∏Å name (‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ branch/brance)
  let branchCol = nameCol + 1;
  const maybe = matrix[skillHeaderRowIdx].findIndex(v=>{
    const s=String(v??'').trim().toLowerCase();
    return s==='branch' || s==='brance';
  });
  if(maybe !== -1) branchCol = maybe;

  // ‡∏´‡∏±‡∏ß‡∏Å‡∏•‡∏∏‡πà‡∏° = ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô
  const groupHeaderRowIdx = Math.max(0, skillHeaderRowIdx-1);
  const groupRaw = matrix[groupHeaderRowIdx].map(x=>String(x??'').replace(/\s+/g,' ').trim());

  // ‡∏´‡∏±‡∏ß‡∏™‡∏Å‡∏¥‡∏•‡∏à‡∏£‡∏¥‡∏á
  let skillRow = matrix[skillHeaderRowIdx].map(x=>String(x??'').replace(/\s+/g,' ').trim());
  const looksLikeGroup = skillRow.some((v,i)=>i!==nameCol && v) &&
                         skillRow.every((v,i)=> i===nameCol || v===groupRaw[i]);
  if(looksLikeGroup && matrix[skillHeaderRowIdx+1]){
    skillHeaderRowIdx += 1;
    skillRow = matrix[skillHeaderRowIdx].map(x=>String(x??'').replace(/\s+/g,' ').trim());
  }

  // forward-fill group
  const groupRow=[]; let last="";
  for(let c=0;c<groupRaw.length;c++){ const g=groupRaw[c]; if(g) last=g; groupRow[c]=last; }

  // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏Å‡∏¥‡∏• (‡∏Ç‡πâ‡∏≤‡∏° name/branch/‡∏ß‡πà‡∏≤‡∏á)
  const skillCols=[];
  for(let c=0;c<skillRow.length;c++){
    if(c===nameCol || c===branchCol) continue;
    const s=skillRow[c]; if(!s) continue;
    skillCols.push({idx:c,label:s,group:groupRow[c]||''});
  }

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  const dataRows = matrix.slice(skillHeaderRowIdx+1);
  const names=[], levels={}, branches={};
  for(const row of dataRows){
    const nm = String(row[nameCol]??'').trim();
    if(!nm) continue;
    names.push(nm);
    branches[nm] = String(row[branchCol]??'').trim();
    const mp={};
    for(const col of skillCols){
      const raw=row[col.idx]; const v=(raw==null)?'':String(raw).trim();
      mp[col.label] = (v==='0'||v==='1'||v==='2')?v:'0';
    }
    levels[nm]=mp;
  }

  state.nameCol=nameCol; state.branchCol=branchCol;
  state.names=names; state.groups=groupRow; state.skills=skillCols;
  state.rows=dataRows; state.levels=levels; state.branches=branches;
  state.current = names[0] || ""; state.dirty.clear();

  buildThead(skillCols);
  buildTbody();

  elPerson.innerHTML = names.map(n=>`<option value="${n.replace(/&/g,"&amp;").replace(/</g,"&lt;")}">${n}</option>`).join("");
  elPerson.value = state.current;

  setMessage("‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
}

/* -------- Paint helper (‡∏™‡∏µ cell & ‡∏õ‡∏∏‡πà‡∏°) -------- */
function paintLevel(td, btn, level){
  td.classList.remove('lv-0','lv-1','lv-2');
  td.classList.add('lv-'+level);
  btn.classList.remove('lv-0','lv-1','lv-2');
  btn.classList.add('lv-'+level);
  btn.textContent = symbolForLevel(level);
}

/* -------- THEAD (2 rows, + name/branch sticky) -------- */
function buildThead(skillCols){
  elGroupRow.innerHTML=""; elSkillRow.innerHTML="";

  // name (rowspan 2)
  const thName=document.createElement('th');
  thName.textContent="name"; thName.rowSpan=2; thName.classList.add('sticky-1','col-name');
  elGroupRow.appendChild(thName);

  // branch (rowspan 2)
  const thBranch=document.createElement('th');
  thBranch.textContent="branch"; thBranch.rowSpan=2; thBranch.classList.add('sticky-2','col-branch');
  elGroupRow.appendChild(thBranch);

  // groups
  let i=0;
  while(i<skillCols.length){
    const g=skillCols[i].group||""; let span=1; let j=i+1;
    while(j<skillCols.length && (skillCols[j].group||"")===g){ span++; j++; }
    const th=document.createElement('th'); th.textContent=g; th.colSpan=span;
    elGroupRow.appendChild(th); i=j;
  }

  // skills
  for(const col of skillCols){
    const th=document.createElement('th'); th.textContent=col.label; elSkillRow.appendChild(th);
  }

  requestAnimationFrame(updateStickyHeaderOffset);
}
function updateStickyHeaderOffset(){
  const r1=document.querySelector('#groupRow'); const h=(r1 && r1.offsetHeight)?r1.offsetHeight:36;
  document.documentElement.style.setProperty('--h1', h+'px');
}

/* -------- TBODY -------- */
function buildTbody(){
  elTbody.innerHTML="";
  for(const name of state.names){
    const tr=document.createElement('tr');
    if(name===state.current) tr.classList.add('is-current');

    // name cell
    const tdName=document.createElement('td');
    tdName.className="sticky-1 col-name"; tdName.textContent=name;
    tr.appendChild(tdName);

    // branch cell
    const tdBranch=document.createElement('td');
    tdBranch.className="sticky-2 col-branch"; tdBranch.textContent=state.branches[name]||"";
    tr.appendChild(tdBranch);

    const editable=(name===state.current);

    for(const col of state.skills){
      const skill=col.label;
      const baseline=(state.levels[name]?.[skill]??'0') || '0';
      const current=(editable && state.dirty.has(skill)) ? state.dirty.get(skill) : baseline;

      const td=document.createElement('td'); td.className="center";

      const btn=document.createElement('button');
      btn.type="button"; btn.className="lvbtn"; btn.dataset.skill=skill; btn.dataset.value=current;
      paintLevel(td, btn, current);

      if(!editable){
        btn.classList.add('readonly');
      }else{
        if(current!==baseline) btn.classList.add('dirty');
        btn.addEventListener('click', ()=>{
          const oldVal=btn.dataset.value;
          const newVal=nextLevel(oldVal);
          btn.dataset.value=newVal;
          paintLevel(td, btn, newVal);
          if(newVal===baseline){ state.dirty.delete(skill); btn.classList.remove('dirty'); }
          else{ state.dirty.set(skill,newVal); btn.classList.add('dirty'); }
        });
      }

      td.appendChild(btn); tr.appendChild(td);
    }

    elTbody.appendChild(tr);
  }
}

/* -------- Events -------- */
elPerson.addEventListener('change', ()=>{
  state.current = elPerson.value;
  state.dirty.clear();
  buildTbody();
});

$('resetBtn').addEventListener('click', ()=>{
  state.dirty.clear(); buildTbody(); setMessage('‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
});

/* -------- Save (u_skill[]/u_level[]) -------- */
$('saveBtn').addEventListener('click', ()=>{
  const selectedName = state.current;
  if(!selectedName){ setMessage("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); return; }
  if(state.dirty.size===0){ setMessage("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"); return; }

  const form=$('gasForm'), iframe=$('gasTarget');
  form.action=GAS_ENDPOINT;
  $('f_name').value=selectedName;
  $('f_branch').value=state.branches[selectedName]||"";

  // ‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤
  [...form.querySelectorAll('input[name="u_skill[]"],input[name="u_level[]"]')].forEach(el=>el.remove());
  for(const [skill,level] of state.dirty.entries()){
    const a=document.createElement('input'); a.type='hidden'; a.name='u_skill[]'; a.value=skill; form.appendChild(a);
    const b=document.createElement('input'); b.type='hidden'; b.name='u_level[]'; b.value=level; form.appendChild(b);
  }

  const onLoad=()=>{
    const mp=state.levels[selectedName]||(state.levels[selectedName]={});
    for(const [skill,level] of state.dirty.entries()) mp[skill]=level;
    state.dirty.clear(); buildTbody(); setMessage("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    iframe.removeEventListener('load', onLoad);
  };
  iframe.addEventListener('load', onLoad, {once:true});
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶"); form.submit();
});

/* -------- Add / Delete name -------- */
$('btnAdd').addEventListener('click', ()=>{
  const name = ($('newName').value||"").trim();
  const branch = ($('newBranch').value||"").trim();
  if(!name){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); return; }
  if(!branch){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ (Branch)"); return; }

  const form=$('gasForm'), iframe=$('gasTarget'); form.action=GAS_ENDPOINT;
  $('f_action').value='addName'; $('f_new_name').value=name; $('f_new_branch').value=branch;

  const cleanup=()=>{ $('f_action').value=''; $('f_new_name').value=''; $('f_new_branch').value=''; $('newName').value=''; $('newBranch').value=''; };
  iframe.onload=()=>{ iframe.onload=null; cleanup(); setMessage("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+name); loadCSV().then(()=>{ if(state.names.includes(name)){ elPerson.value=name; state.current=name; buildTbody(); } }); };
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‚Ä¶"); form.submit();
});

$('btnDel').addEventListener('click', ()=>{
  const target = ($('newName').value || elPerson.value || "").trim();
  if(!target){ alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö"); return; }
  if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö "${target}" ?`)) return;

  const form=$('gasForm'), iframe=$('gasTarget'); form.action=GAS_ENDPOINT;
  $('f_action').value='deleteName'; $('f_new_name').value=target; $('f_new_branch').value='';
  $('f_name').value=''; // ‡∏Å‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏Å‡∏¥‡∏•

  const cleanup=()=>{ $('f_action').value=''; $('f_new_name').value=''; $('newName').value=''; };
  iframe.onload=()=>{ iframe.onload=null; cleanup(); setMessage("‚úÖ ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+target); loadCSV().then(()=>{ elPerson.value=state.current; buildTbody(); }); };
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‚Ä¶"); form.submit();
});

/* -------- Boot -------- */
loadCSV().catch(err=> setMessage("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+(err.message||err)));
window.addEventListener('resize', updateStickyHeaderOffset);
</script>
</body>
</html>
