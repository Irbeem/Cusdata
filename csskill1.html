<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Skill Matrix (0/1/2)</title>
<style>
:root{
  --border:#e5e7eb; --muted:#6b7280; --brand:#4f46e5;
  --head1:#3b37b7; --head1-text:#fff; --head2:#eef2ff;
  --sticky:#f8fafc; --row-hover:#f4f6ff; --selected:#e7f0ff;
  --green:#16a34a; --blue:#2563eb; --gray:#e5e7eb;
  --z-head1:60; --z-head2:59; --z-corner:70; --z-left:55;
  --firstColW:210px; --h1:44px;
}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,"Noto Sans Thai",Arial;color:#111}
header{position:sticky;top:0;z-index:100;background:#fff;border-bottom:1px solid var(--border)}
.hbar{display:flex;gap:10px;align-items:center;padding:10px 12px;flex-wrap:wrap}
select,input,button{border:1px solid var(--border);border-radius:10px;padding:8px 10px}
button.primary{background:var(--brand);border-color:var(--brand);color:#fff;font-weight:700}
button.secondary{background:#fff}
.small{font-size:12px;color:var(--muted)}
.wrap{padding:12px}
.table-wrap{border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:calc(100vh - 170px);background:#fff}
.table-wrap, .table-wrap *{transform:none!important;filter:none!important;backdrop-filter:none!important}
table{border-collapse:separate;border-spacing:0;width:max-content;min-width:100%}
th,td{border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:10px 12px;background:#fff;white-space:nowrap}
th:first-child,td:first-child{border-left:1px solid var(--border)}
thead th{position:sticky;background:#fff}
thead tr:first-child th{top:0;background:var(--head1);color:var(--head1-text);z-index:var(--z-head1);font-weight:800;letter-spacing:.2px}
thead tr:nth-child(2) th{top:var(--h1);background:var(--head2);z-index:var(--z-head2);font-weight:700}
thead th.corner-0{left:0;z-index:var(--z-corner)}
thead th.corner-1{left:var(--firstColW);z-index:var(--z-corner)}
tbody td.sticky-0{position:sticky;left:0;background:linear-gradient(90deg,var(--sticky) 0%,#fff 100%);z-index:var(--z-left);font-weight:700}
tbody td.sticky-1{position:sticky;left:var(--firstColW);background:linear-gradient(90deg,var(--sticky) 0%,#fff 100%);z-index:var(--z-left)}
th.name,td.name{width:var(--firstColW)} th.branch,td.branch{width:120px;text-align:left}
tbody tr:hover td{background:var(--row-hover)}
tbody tr.selected td{background:var(--selected)}
.cell{display:flex;justify-content:center;align-items:center}
.lv{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);font-weight:900;cursor:default;user-select:none;margin:auto}
.lv.edit{cursor:pointer}
.lv[data-lv="0"]{background:#fff;border-color:var(--gray);color:#6b7280}
.lv[data-lv="1"]{background:rgba(22,163,74,.14);border-color:rgba(22,163,74,.40);color:#16a34a}
.lv[data-lv="2"]{background:rgba(37,99,235,.14);border-color:rgba(37,99,235,.40);color:#2563eb}
.lv.edit:hover{box-shadow:0 0 0 4px rgba(79,70,229,.18)}
.lv.dirty{outline:2px solid #f59e0b;outline-offset:-2px}
.group-title{font-weight:900}
#status{padding:8px 12px;color:#374151}
</style>
</head>
<body>
<header>
  <div class="hbar">
    <label>Branch:
      <select id="branchFilter"><option value="ALL">All branches</option></select>
    </label>
    <label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç):
      <select id="person"></select>
    </label>
    <button class="primary" id="saveBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
    <button class="secondary" id="resetBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    <span class="small">‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
  </div>
  <div class="hbar">
    <input id="newName" placeholder="Name (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö)" style="min-width:180px">
    <input id="newBranch" placeholder="Branch (‡πÄ‡∏ä‡πà‡∏ô BKK, CBI)" style="min-width:160px">
    <button id="btnAdd" class="secondary">‚ûï Add</button>
    <button id="btnDel" class="secondary">üóë Delete</button>
  </div>
</header>

<div id="status" class="small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>

<div class="wrap">
  <div class="table-wrap" id="scroller">
    <table id="tbl">
      <thead>
        <tr id="rowGroup"></tr>
        <tr id="rowSkill"></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- submit via iframe -->
<iframe id="gasTarget" name="gasTarget" style="display:none"></iframe>
<form id="gasForm" method="POST" target="gasTarget" action="">
  <input type="hidden" name="name" id="f_name">
  <input type="hidden" name="branch" id="f_branch">
  <input type="hidden" name="action" id="f_action">
  <input type="hidden" name="new_name" id="f_new_name">
  <input type="hidden" name="new_branch" id="f_new_branch">
</form>

<script>
/* ========= CONFIG ========= */
const CSV_URL = "https://docs.google.com/spreadsheets/d/1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k/export?format=csv&gid=0";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzPMwWO8ir9wa8kSVDn_aWn_-vyY11K8Z2msF4nY2Aj7iyRyYJctzEo3F-VlYW-w-68jQ/exec";

/* ========= STATE ========= */
const $ = id => document.getElementById(id);
const elGroup = $("rowGroup"), elSkill = $("rowSkill"), elBody = $("tbody");
const selPerson = $("person"), selBranch = $("branchFilter");
const statusEl = $("status");

let S = {
  nameCol:0, branchCol:1,
  skills:[], groups:[],
  names:[], branches:[],
  levelsByLabel:{},        // { name: {label -> '0/1/2'} }  (‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô save)
  rowByName:{},           // { name: originalRowArray }      << ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå baseline
  nameToBranch:{},
  current:"", dirty:new Map(), filterBranch:"ALL"
};

/* ========= UTILS ========= */
function parseCSV(text){
  const out=[]; let row=[], i=0, cur="", q=false;
  while(i<text.length){
    const ch=text[i];
    if(q){
      if(ch=='"'){ if(text[i+1]=='"'){cur+='"'; i+=2; continue;} q=false; i++; }
      else{ cur+=ch; i++; }
    }else{
      if(ch=='"'){ q=true; i++; }
      else if(ch==','){ row.push(cur); cur=""; i++; }
      else if(ch=='\n'){ row.push(cur); out.push(row); row=[]; cur=""; i++; }
      else if(ch=='\r'){ i++; }
      else{ cur+=ch; i++; }
    }
  }
  row.push(cur); out.push(row); return out;
}
function setStatus(t){ statusEl.textContent = t; }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[m])); }
function symbol(lv){ return lv==='2'?'‚óè':(lv==='1'?'‚óã':'-'); }
function next(lv){ return lv==='0'?'1':(lv==='1'?'2':'0'); }

/* ========= LOADER ========= */
async function loadCSV(){
  setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï‚Ä¶");
  const res = await fetch(CSV_URL, {cache:"no-store"});
  const matrix = parseCSV(await res.text());

  // ‡∏´‡∏≤ header "name"
  let skillHeaderRow=-1, nameCol=-1;
  for(let r=0;r<Math.min(12,matrix.length);r++){
    const idx = matrix[r].findIndex(v => String(v||"").trim().toLowerCase()==='name');
    if(idx>-1){ skillHeaderRow=r; nameCol=idx; break; }
  }
  if(skillHeaderRow<0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "name"');

  const groupHeaderRow = Math.max(0, skillHeaderRow-1);
  const groupRaw = (matrix[groupHeaderRow]||[]).map(x => String(x||"").trim());
  let   skillRow = (matrix[skillHeaderRow]||[]).map(x => String(x||"").trim());

  // ‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏ñ‡∏ß‡∏™‡∏Å‡∏¥‡∏•‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡∏Å‡∏•‡∏∏‡πà‡∏° ‚Üí ‡∏Ç‡∏¢‡∏±‡∏ö‡∏•‡∏á 1
  const likeGroup = (() => {
    let same=0, tot=0;
    for(let c=nameCol+1;c<skillRow.length;c++){
      const v=skillRow[c], g=groupRaw[c]||"";
      if(!v) continue; tot++; if(v===g) same++;
    }
    return tot>0 && same/tot>=0.6;
  })();
  if(likeGroup && matrix[skillHeaderRow+1]){
    skillHeaderRow += 1;
    skillRow = (matrix[skillHeaderRow]||[]).map(x => String(x||"").trim());
  }

  S.nameCol = nameCol;
  S.branchCol = nameCol+1; // branch ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ñ‡∏±‡∏î‡∏à‡∏≤‡∏Å name

  // groups forward-fill
  const groups=[], rawG = groupRaw.slice();
  let last=""; for(let c=0;c<rawG.length;c++){ groups[c]=rawG[c]||last; last=groups[c]; }
  S.groups = groups;

  // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏Å‡∏¥‡∏• (‡∏Ç‡πâ‡∏≤‡∏° name/branch)
  const skills=[];
  for(let c=0;c<skillRow.length;c++){
    if(c===S.nameCol || c===S.branchCol) continue;
    const label = skillRow[c]; if(!label) continue;
    skills.push({ idx:c, label, group: groups[c]||"" });
  }
  S.skills = skills;

  // ‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
  const dataRows = matrix.slice(skillHeaderRow+1);
  const names=[], branches=[], levelsByLabel={}, rowByName={}, nameToBranch={};
  dataRows.forEach(r=>{
    const nm=(r[S.nameCol]||"").toString().trim(); if(!nm) return;
    const br=(r[S.branchCol]||"").toString().trim();
    names.push(nm); nameToBranch[nm]=br; if(br) branches.push(br);
    rowByName[nm]=r;                          // ‡πÄ‡∏Å‡πá‡∏ö raw row ‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
    const byLabel={};
    skills.forEach(col=>{
      const raw=(r[col.idx]??"").toString().trim();
      const v = (raw==='0'||raw==='1'||raw==='2') ? raw : (raw==='-'?'0':'0');
      byLabel[col.label]=v;
    });
    levelsByLabel[nm]=byLabel;
  });

  const uniqBr = Array.from(new Set(branches)).sort();
  selBranch.innerHTML = `<option value="ALL">All branches</option>` +
    uniqBr.map(b=>`<option value="${escapeHTML(b)}">${escapeHTML(b)}</option>`).join("");

  S.names=names; S.branches=uniqBr;
  S.levelsByLabel=levelsByLabel; S.rowByName=rowByName; S.nameToBranch=nameToBranch;
  S.current = names[0] || "";

  buildThead(); buildTbody(); rebuildPersonList();
  setStatus("‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
}

/* ========= RENDER ========= */
function rebuildPersonList(){
  selPerson.innerHTML = S.names
    .filter(n => S.filterBranch==="ALL" || S.nameToBranch[n]===S.filterBranch)
    .map(n=>`<option value="${escapeHTML(n)}">${escapeHTML(n)}</option>`).join("");
  if(S.current) selPerson.value = S.current;
}
function updateStickyHeaderOffset(){
  const h1 = document.querySelector('#rowGroup')?.offsetHeight || 44;
  document.documentElement.style.setProperty('--h1', h1 + 'px');
  const w  = document.querySelector('thead th.corner-0')?.offsetWidth || 210;
  document.documentElement.style.setProperty('--firstColW', w + 'px');
}
function buildThead(){
  elGroup.innerHTML=""; elSkill.innerHTML="";
  const th0=document.createElement("th"); th0.textContent="name"; th0.className="corner-0 name"; th0.rowSpan=2; elGroup.appendChild(th0);
  const th1=document.createElement("th"); th1.textContent="branch"; th1.className="corner-1 branch"; th1.rowSpan=2; elGroup.appendChild(th1);
  for(let i=0;i<S.skills.length;){
    const g=S.skills[i].group||""; let span=1,j=i+1;
    while(j<S.skills.length && (S.skills[j].group||"")===g){ span++; j++; }
    const th=document.createElement("th"); th.colSpan=span; th.innerHTML=`<div class="group-title">${escapeHTML(g||' ')}</div>`;
    elGroup.appendChild(th); i=j;
  }
  S.skills.forEach(col=>{ const th=document.createElement("th"); th.textContent=col.label; elSkill.appendChild(th); });
  requestAnimationFrame(updateStickyHeaderOffset);
}
function buildTbody(){
  elBody.innerHTML="";
  const rows = S.names.filter(n=>S.filterBranch==="ALL" || S.nameToBranch[n]===S.filterBranch);
  rows.forEach(nm=>{
    const tr=document.createElement("tr"); if(nm===S.current) tr.classList.add("selected");
    const tdName=document.createElement("td"); tdName.className="sticky-0 name"; tdName.textContent=nm; tr.appendChild(tdName);
    const tdBr=document.createElement("td"); tdBr.className="sticky-1 branch"; tdBr.textContent=S.nameToBranch[nm]||""; tr.appendChild(tdBr);

    const editable = (nm===S.current);
    const rawRow = S.rowByName[nm] || []; // ‚Üê baseline ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏£‡∏¥‡∏á
    S.skills.forEach(col=>{
      const td=document.createElement("td"); td.className="cell";
      const raw=(rawRow[col.idx]??"").toString().trim();
      const baseline = (raw==='0'||raw==='1'||raw==='2') ? raw : '0';
      const current  = (editable && S.dirty.has(col.label)) ? S.dirty.get(col.label) : baseline;

      const btn=document.createElement("div");
      btn.className="lv"+(editable?" edit":"");
      btn.dataset.lv=current;
      btn.textContent=symbol(current);

      if(editable){
        if(current!==baseline) btn.classList.add("dirty");
        btn.onclick=()=>{
          const nxt=next(btn.dataset.lv);
          btn.dataset.lv=nxt; btn.textContent=symbol(nxt);
          if(nxt===baseline){ S.dirty.delete(col.label); btn.classList.remove("dirty"); }
          else{ S.dirty.set(col.label,nxt); btn.classList.add("dirty"); }
        };
      }

      td.appendChild(btn); tr.appendChild(td);
    });

    elBody.appendChild(tr);
  });
}

/* ========= EVENTS ========= */
selPerson.onchange = ()=>{ S.current=selPerson.value; S.dirty.clear(); buildTbody(); };
selBranch.onchange = ()=>{
  S.filterBranch=selBranch.value||"ALL"; buildTbody(); rebuildPersonList();
  if(!S.names.includes(S.current) || (S.filterBranch!=="ALL" && S.nameToBranch[S.current]!==S.filterBranch)){
    S.current=selPerson.value=(elBody.querySelector('tr .sticky-0')?.textContent||"");
  }
};
$("resetBtn").onclick=()=>{ S.dirty.clear(); buildTbody(); setStatus("‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß"); };
$("saveBtn").onclick=()=>{
  if(!S.current){ setStatus("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠"); return; }
  if(S.dirty.size===0){ setStatus("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"); return; }
  const f=$("gasForm"), ifr=$("gasTarget"); f.action=GAS_ENDPOINT;
  $("f_name").value=S.current; $("f_branch").value=S.nameToBranch[S.current]||"";

  // ‡∏•‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï‡πÄ‡∏Å‡πà‡∏≤
  [...f.querySelectorAll('input[name="u_skill[]"],input[name="u_level[]"]')].forEach(e=>e.remove());
  for(const [skill,lv] of S.dirty.entries()){
    const a=document.createElement('input'); a.type='hidden'; a.name='u_skill[]'; a.value=skill; f.appendChild(a);
    const b=document.createElement('input'); b.type='hidden'; b.name='u_level[]'; b.value=lv; f.appendChild(b);
  }

  const done=()=>{ ifr.removeEventListener('load',done);
    // sync ‡∏ó‡∏±‡πâ‡∏á label ‡πÅ‡∏•‡∏∞ rawRow ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏ú‡∏•‡∏ö‡∏ô‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    const lbl=S.levelsByLabel[S.current]||(S.levelsByLabel[S.current]={});
    const raw=S.rowByName[S.current]||[];
    for(const [label,v] of S.dirty.entries()){
      lbl[label]=v;
      const col=S.skills.find(c=>c.label===label);
      if(col) raw[col.idx]=v; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏£‡∏¥‡∏á
    }
    S.dirty.clear(); buildTbody(); setStatus("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  };
  ifr.addEventListener('load',done,{once:true}); setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶"); f.submit();
};

$("btnAdd").onclick=()=>{
  const nm=($("newName").value||"").trim(), br=($("newBranch").value||"").trim();
  if(!nm||!br){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Name ‡πÅ‡∏•‡∏∞ Branch"); return; }
  const f=$("gasForm"), ifr=$("gasTarget"); f.action=GAS_ENDPOINT;
  $("f_action").value="addName"; $("f_new_name").value=nm; $("f_new_branch").value=br;
  const done=()=>{ ifr.removeEventListener('load',done);
    $("f_action").value=""; $("f_new_name").value=""; $("f_new_branch").value="";
    $("newName").value=""; $("newBranch").value="";
    setStatus("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); loadCSV();
  };
  ifr.addEventListener('load',done,{once:true}); f.submit();
};
$("btnDel").onclick=()=>{
  const nm=($("newName").value||selPerson.value||"").trim(); if(!nm){ alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö"); return; }
  if(!confirm(`‡∏•‡∏ö "${nm}" ?`)) return;
  const f=$("gasForm"), ifr=$("gasTarget"); f.action=GAS_ENDPOINT;
  $("f_action").value="deleteName"; $("f_new_name").value=nm; $("f_new_branch").value="";
  const done=()=>{ ifr.removeEventListener('load',done);
    $("f_action").value=""; $("f_new_name").value=""; $("newName").value="";
    setStatus("‚úÖ ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); loadCSV();
  };
  ifr.addEventListener('load',done,{once:true}); f.submit();
};

/* ========= BOOT ========= */
window.addEventListener('resize', ()=>{
  const h1 = document.querySelector('#rowGroup')?.offsetHeight || 44;
  document.documentElement.style.setProperty('--h1', h1 + 'px');
});
loadCSV().catch(e=>setStatus("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+(e.message||e)));
</script>
</body>
</html>
