<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skill Matrix (0/1/2) ‚Äî YAPTCSSKILL</title>
  <style>
    /* ================= THEME & TOKENS ================ */
    :root{
      --bg: #ffffff;
      --card: #ffffff;
      --muted: #6b7280;
      --border: #e5e7eb;

      --brand-50:#eef2ff; --brand-100:#e0e7ff; --brand-200:#c7d2fe;
      --brand-400:#6366f1; --brand-500:#4f46e5; --brand-600:#4338ca;

      --green-500:#10b981;
      --amber-500:#f59e0b;
      --rose-500:#f43f5e;

      --header-grad: linear-gradient(180deg, #f9fafb 0%, #ffffff 100%);

      --row-select-bg:#fff7d6;   /* ‡∏™‡∏µ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ */
      --row-select-left:#f59e0b; /* ‡∏™‡∏µ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏•‡πá‡∏Å‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ */
      --row-hover-bg:#f0f9ff;    /* ‡∏™‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover ‡πÅ‡∏ñ‡∏ß */

      --h1: 36px;   /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡∏±‡∏ß‡πÅ‡∏ñ‡∏ß 1 (‡∏Å‡∏•‡∏∏‡πà‡∏°) */
      --nameW: 220px; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå name (‡πÉ‡∏´‡πâ JS ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï) */
    }

    html, body { margin:0; padding:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", Arial; color:#111827; background:#fff; }

    header{
      padding: 12px;
      background: var(--header-grad);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 4px 14px rgba(15, 23, 42, .06);
      position: sticky; top:0; z-index: 50;
    }
    h1{ font-size:16px; margin:0 0 8px; }
    .controls{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .controls select,.controls input{
      border:1px solid var(--border); background:#fff; border-radius:10px; padding:8px 12px;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    .controls select:focus,.controls input:focus{
      outline:none; border-color:var(--brand-400);
      box-shadow:0 0 0 4px color-mix(in srgb, var(--brand-400) 20%, transparent);
    }
    button{
      border-radius:10px; padding:10px 14px; border:1px solid transparent; font-weight:600;
      transition:transform .05s ease, box-shadow .15s ease, background .15s ease; cursor:pointer;
    }
    button:active{ transform:translateY(1px); }
    button.primary{
      background:var(--brand-500); border-color:var(--brand-500); color:#fff;
      box-shadow:0 6px 14px rgba(79,70,229,.25);
    }
    button.primary:hover{ background:var(--brand-600); }
    button.secondary{
      background:#fff; color:var(--brand-600); border-color:var(--brand-200);
    }
    button.secondary:hover{ background:var(--brand-50); border-color:var(--brand-400); }

    #btnAdd.secondary{ color:var(--green-500); border-color:color-mix(in srgb, var(--green-500) 35%, #ffffff); }
    #btnAdd.secondary:hover{ background:color-mix(in srgb, var(--green-500) 12%, #ffffff); border-color:var(--green-500); }
    #btnDel.secondary{ color:var(--rose-500); border-color:color-mix(in srgb, var(--rose-500) 35%, #ffffff); }
    #btnDel.secondary:hover{ background:color-mix(in srgb, var(--rose-500) 10%, #ffffff); border-color:var(--rose-500); }

    .wrap{ padding:12px; }
    .table-wrap{
      background:var(--card); border:1px solid var(--border); border-radius:14px;
      box-shadow:0 12px 24px rgba(15, 23, 42, .05);
      max-height: calc(100vh - 180px);
      overflow:auto;
    }

    table{ border-collapse:separate; border-spacing:0; width:max-content; min-width:100%; }
    th, td{
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);
      padding:10px 12px;
      background:#fff; white-space:nowrap;
      vertical-align:middle;
    }
    th:first-child, td:first-child{ border-left:1px solid var(--border); }

    /* ===== Sticky header (‡∏™‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß) ===== */
    thead th{ position:sticky; background:#fff; z-index:2; }
    thead tr:first-child th{ top:0; z-index:40; }
    thead tr:nth-child(2) th{ top:var(--h1); z-index:39; }

    /* ===== Sticky ‡∏ã‡πâ‡∏≤‡∏¢ 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (name/brance) ===== */
    thead th.sticky-1, tbody td.sticky-1{ position:sticky; left:0; z-index:41; background:#f9fafb; }
    thead th.sticky-2, tbody td.sticky-2{ position:sticky; left:var(--nameW); z-index:40; background:#f9fafb; }

    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≤‡∏¢ */
    tbody td.sticky-1, thead th.sticky-1,
    tbody td.sticky-2, thead th.sticky-2{
      font-weight:600;
      background: linear-gradient(90deg, #f8fafc 0%, #ffffff 100%);
    }

    /* Group row (‡∏´‡∏±‡∏ß‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô) */
    #groupRow th{
      background: linear-gradient(180deg, var(--brand-50) 0%, #fff 90%);
      color:#0f172a; font-weight:700; border-bottom:2px solid var(--brand-200);
    }
    #skillRow th{ font-weight:700; color:#0f172a; }

    /* Hover/Selected row */
    tbody tr:nth-child(even) td{ background:#fcfcff; }
    tbody tr:hover td{ background:var(--row-hover-bg); }
    tbody tr.is-selected td{ background:var(--row-select-bg) !important; }
    tbody tr.is-selected td.sticky-1,
    tbody tr.is-selected td.sticky-2{ background:var(--row-select-bg) !important; }

    /* ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏Å‡∏¥‡∏• */
    .center{ text-align:center; }
    .cell{ display:flex; align-items:center; justify-content:center; }
    .lvbtn{
      display:inline-flex; align-items:center; justify-content:center;
      width:32px; height:32px; font-size:22px;
      border:1px solid var(--brand-200); border-radius:10px;
      background:#4159c4; color:#ffffff; box-shadow:0 1px 0 rgba(0,0,0,.04);
      line-height:1; user-select:none; cursor:pointer;
    }
    .lvbtn:hover{
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--brand-400) 18%, transparent);
      filter: brightness(1.03);
    }
    .lvbtn.readonly{ background:#f3f4f6; color:#374151; border-color:#e5e7eb; cursor:default; }
    .lvbtn.dirty{
      border-color:var(--amber-500);
      box-shadow:0 0 0 4px color-mix(in srgb, var(--amber-500) 25%, transparent);
    }

    .status{ font-size:13px; color:#374151; margin-top:8px; }
    iframe{ display:none; }
  </style>
</head>
<body>
  <header>
    <h1>Skill Matrix ‚Äî ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏™‡∏Å‡∏¥‡∏• (0/1/2)</h1>
    <div class="controls">
      <label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç):
        <select id="person"></select>
      </label>
      <button id="saveBtn" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
      <button id="resetBtn" class="secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <span class="status">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
    </div>
    <div class="controls" style="margin-top:6px">
      <input id="newName" placeholder="Name" style="min-width:180px" />
      <button id="btnAdd" class="secondary" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà">‚ûï Add</button>
      <button id="btnDel" class="secondary" title="‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">üóë Del</button>
    </div>
  </header>

  <div class="wrap">
    <div id="msg" class="status"></div>

    <div class="table-wrap">
      <table id="skillTable" aria-label="Skill matrix table">
        <thead>
          <tr id="groupRow"></tr>
          <tr id="skillRow"></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- form/iframe ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö POST ‡πÑ‡∏õ Apps Script -->
  <iframe id="gasTarget" name="gasTarget"></iframe>
  <form id="gasForm" method="POST" target="gasTarget" action="">
    <input type="hidden" name="name" id="f_name">
    <input type="hidden" name="action" id="f_action">
    <input type="hidden" name="new_name" id="f_new_name">
    <!-- ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏° u_skill[] / u_level[] ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î Save -->
  </form>

<script>
/* ====================== CONFIG ====================== */
/* CSV ‡∏Ç‡∏≠‡∏á‡∏ä‡∏µ‡∏ï‡∏´‡∏•‡∏±‡∏Å (‡πÉ‡∏ä‡πâ export raw CSV ‡∏à‡∏∞‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏ä‡∏µ‡∏ï‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î) */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k/export?format=csv&gid=0";

/* Apps Script Web App (deploy ‡πÅ‡∏ö‡∏ö web app /exec) */
const GAS_ENDPOINT =
  "https://script.google.com/macros/s/AKfycbzPMwWO8ir9wa8kSVDn_aWn_-vyY11K8Z2msF4nY2Aj7iyRyYJctzEo3F-VlYW-w-68jQ/exec";

/* ======================= STATE ======================= */
const $ = id => document.getElementById(id);
const elPerson   = $("person");
const elMsg      = $("msg");
const elGroupRow = $("groupRow");
const elSkillRow = $("skillRow");
const elTbody    = $("tbody");

const state = {
  nameCol: -1,
  branchCol: -1,
  names: [],
  branches: {},       // { name: "BKK" | "CBI" | ... }
  groups: [],         // ‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏´‡∏±‡∏ß‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô) ‡∏´‡∏•‡∏±‡∏á forward-fill
  skills: [],         // [{idx, label, group}]
  rows: [],           // raw rows ‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ß
  levels: {},         // { name: { skillLabel: "0"|"1"|"2"|"" } }
  current: "",        // ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  dirty: new Map(),   // Map<skillLabel, "0"|"1"|"2">
};

/* =================== UTIL / STATUS =================== */
function setMessage(t){ elMsg.textContent = t; }
function toStr(v){ return String(v ?? "").trim(); }

/* ====================== CSV PARSER ====================== */
function parseCSV(text){
  const rows = [];
  let i=0, cur="", row=[], inq=false;
  while(i<text.length){
    const ch = text[i];
    if (inq){
      if (ch === '"'){
        if (text[i+1] === '"'){ cur += '"'; i+=2; continue; }
        inq = false; i++; continue;
      } else { cur += ch; i++; continue; }
    } else {
      if (ch === '"'){ inq=true; i++; continue; }
      if (ch === ','){ row.push(cur); cur=""; i++; continue; }
      if (ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=""; i++; continue; }
      if (ch === '\r'){ i++; continue; }
      cur += ch; i++;
    }
  }
  row.push(cur); rows.push(row);
  return rows;
}

/* ======================= LOADER ======================= */
/* ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ header name, brance, group row, skill row ‡πÅ‡∏•‡∏∞ map ‡∏Ñ‡πà‡∏≤ */
async function loadCSV(){
  try{
    setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet...");
    const r = await fetch(CSV_URL, { cache:"no-store" });
    if (!r.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î CSV ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    const text = await r.text();
    const matrix = parseCSV(text);

    // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏™‡∏Å‡∏¥‡∏• (‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ name)
    let skillHeaderRowIdx = -1, nameCol = -1;
    for (let i = 0; i < Math.min(15, matrix.length); i++){
      const idx = matrix[i].findIndex(v => toStr(v).toLowerCase() === "name");
      if (idx !== -1){ skillHeaderRowIdx = i; nameCol = idx; break; }
    }
    if (skillHeaderRowIdx < 0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "name"');

    // ‡∏´‡∏±‡∏ß‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    const groupHeaderRowIdx = Math.max(0, skillHeaderRowIdx - 1);
    const groupRowRaw = matrix[groupHeaderRowIdx].map(x => toStr(x));

    // ‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏™‡∏Å‡∏¥‡∏•
    let skillRow = matrix[skillHeaderRowIdx].map(x => toStr(x));

    // ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ export ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô
    const looksLikeGroup =
      skillRow.some((v,i) => i !== nameCol && v) &&
      skillRow.every((v,i) => i === nameCol || v === groupRowRaw[i]);
    if (looksLikeGroup && matrix[skillHeaderRowIdx + 1]){
      skillHeaderRowIdx += 1;
      skillRow = matrix[skillHeaderRowIdx].map(x => toStr(x));
    }

    // ‡∏´‡∏≤ column brance/branch
    const hdrLower = matrix[skillHeaderRowIdx].map(x => toStr(x).toLowerCase());
    let branchCol = hdrLower.findIndex(v => v === "brance" || v === "branch");
    if (branchCol === -1) branchCol = -1; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≤‡∏Ç‡∏≤

    // forward fill group row
    const groupRow = [];
    let lastG = "";
    for (let c=0; c<groupRowRaw.length; c++){
      const g = groupRowRaw[c];
      if (g) lastG = g;
      groupRow[c] = lastG;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á skillCols (‡∏Ç‡πâ‡∏≤‡∏° name/brance)
    const skillCols = [];
    for (let c=0; c<skillRow.length; c++){
      if (c === nameCol || c === branchCol) continue;
      const s = skillRow[c];
      if (!s) continue;
      skillCols.push({ idx:c, label:s, group: groupRow[c] || "" });
    }

    // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ß)
    const dataRows = matrix.slice(skillHeaderRowIdx + 1);

    const names = [];
    const levels = {};
    const branches = {};
    for (const row of dataRows){
      const nm = toStr(row[nameCol]);
      if (!nm) continue;
      names.push(nm);
      branches[nm] = (branchCol >= 0) ? toStr(row[branchCol]) : "";
      const mp = {};
      for (const col of skillCols){
        const raw = row[col.idx];
        const v = toStr(raw);
        mp[col.label] = (v === "0" || v === "1" || v === "2") ? v : (v ? v : "");
      }
      levels[nm] = mp;
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï state
    state.nameCol   = nameCol;
    state.branchCol = branchCol;
    state.names     = names;
    state.groups    = groupRow;
    state.skills    = skillCols;
    state.rows      = dataRows;
    state.levels    = levels;
    state.branches  = branches;
    state.current   = names[0] || "";
    state.dirty.clear();

    buildThead(skillCols);
    buildTbody();

    // dropdown ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
    elPerson.innerHTML = names.map(n => `<option value="${n.replace(/&/g,"&amp;").replace(/</g,"&lt;")}">${n}</option>`).join("");
    elPerson.value = state.current;

    setMessage("‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
  }catch(err){
    console.error(err);
    setMessage("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (err.message || err));
  }
}

/* ===================== RENDER HEAD ===================== */
function buildThead(skillCols){
  elGroupRow.innerHTML = "";
  elSkillRow.innerHTML = "";

  // name (sticky-1) rowspan 2
  const thName = document.createElement("th");
  thName.textContent = "name";
  thName.rowSpan = 2;
  thName.className = "sticky-1";
  elGroupRow.appendChild(thName);

  // brance (sticky-2) rowspan 2
  if (state.branchCol >= 0){
    const thBr = document.createElement("th");
    thBr.textContent = "brance";
    thBr.rowSpan = 2;
    thBr.className = "sticky-2";
    elGroupRow.appendChild(thBr);
  }

  // group headers
  let i = 0;
  while (i < skillCols.length){
    const g = skillCols[i].group || "";
    let span = 1, j = i + 1;
    while (j < skillCols.length && (skillCols[j].group || "") === g){ span++; j++; }
    const th = document.createElement("th");
    th.textContent = g;
    th.colSpan = span;
    elGroupRow.appendChild(th);
    i = j;
  }

  // skill row
  for (const col of skillCols){
    const th = document.createElement("th");
    th.textContent = col.label;
    elSkillRow.appendChild(th);
  }

  requestAnimationFrame(updateStickyLefts);
}

/* ===================== RENDER BODY ===================== */
function buildTbody(){
  elTbody.innerHTML = "";

  for (const name of state.names){
    const tr = document.createElement("tr");
    if (name === state.current) tr.classList.add("is-selected");

    // name
    const tdName = document.createElement("td");
    tdName.className = "name-cell sticky-1";
    tdName.textContent = name;
    tr.appendChild(tdName);

    // brance
    if (state.branchCol >= 0){
      const tdBr = document.createElement("td");
      tdBr.className = "branch-cell sticky-2";
      tdBr.textContent = state.branches[name] || "";
      tr.appendChild(tdBr);
    }

    const editable = (name === state.current);

    for (const col of state.skills){
      const skill    = col.label;
      const baseline = (state.levels[name]?.[skill] ?? "0") || "0";
      const current  = (editable && state.dirty.has(skill)) ? state.dirty.get(skill) : baseline;

      const td = document.createElement("td");
      td.className = "center";
      const wrap = document.createElement("div");
      wrap.className = "cell";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "lvbtn";
      btn.dataset.skill = skill;
      btn.dataset.value = current;
      btn.textContent   = symbolForLevel(current);

      if (!editable){
        btn.classList.add("readonly");
      }else{
        if (current !== baseline) btn.classList.add("dirty");
        btn.addEventListener("click", () => {
          const oldVal = btn.dataset.value;
          const newVal = nextLevel(oldVal);
          btn.dataset.value = newVal;
          btn.textContent   = symbolForLevel(newVal);
          if (newVal === baseline){
            state.dirty.delete(skill);
            btn.classList.remove("dirty");
          }else{
            state.dirty.set(skill, newVal);
            btn.classList.add("dirty");
          }
        });
      }

      wrap.appendChild(btn);
      td.appendChild(wrap);
      tr.appendChild(td);
    }

    elTbody.appendChild(tr);
  }

  requestAnimationFrame(updateStickyLefts);
}

/* =============== STICKY LEFT CALC (nameW) =============== */
function updateStickyLefts(){
  const thName = document.querySelector('thead th.sticky-1');
  if (!thName) return;
  const w = thName.getBoundingClientRect().width || thName.offsetWidth || 220;
  document.documentElement.style.setProperty('--nameW', w + 'px');
}
window.addEventListener('resize', updateStickyLefts);

/* ===================== SAVE / RESET ===================== */
$("resetBtn").addEventListener("click", () => {
  state.dirty.clear();
  buildTbody();
  setMessage("‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
});

$("saveBtn").addEventListener("click", saveViaIframeArray);

function saveViaIframeArray(){
  const selectedName = state.current;
  if (!selectedName){ setMessage("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); return; }
  if (state.dirty.size === 0){ setMessage("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"); return; }

  const form   = $("gasForm");
  const iframe = $("gasTarget");
  form.action  = GAS_ENDPOINT;

  $("f_name").value = selectedName;

  // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤
  [...form.querySelectorAll('input[name="u_skill[]"], input[name="u_level[]"]')]
    .forEach(el => el.remove());

  // ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ
  for (const [skill, level] of state.dirty.entries()){
    const a = document.createElement("input");
    a.type="hidden"; a.name="u_skill[]"; a.value=skill; form.appendChild(a);
    const b = document.createElement("input");
    b.type="hidden"; b.name="u_level[]"; b.value=level; form.appendChild(b);
  }

  const onLoad = () => {
    iframe.removeEventListener('load', onLoad);
    const mp = state.levels[selectedName] || (state.levels[selectedName] = {});
    for (const [skill, level] of state.dirty.entries()) mp[skill] = level;
    state.dirty.clear();
    buildTbody();
    setMessage("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  };
  iframe.addEventListener('load', onLoad, { once:true });

  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");
  form.submit();
}

/* ============== ADD / DELETE NAME (GAS) ============== */
$("btnAdd").addEventListener("click", addName);
$("btnDel").addEventListener("click", deleteName);

function addName(){
  const input = $("newName");
  const newName = (input.value || "").trim();
  if (!newName){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); return; }

  const form   = $("gasForm");
  const iframe = $("gasTarget");
  form.action  = GAS_ENDPOINT;

  $("f_action").value   = "addName";
  $("f_new_name").value = newName;

  const btnAdd = $("btnAdd"), btnDel = $("btnDel");
  btnAdd.disabled = true; btnDel.disabled = true;

  const cleanup = () => {
    $("f_action").value = ""; $("f_new_name").value = ""; input.value = "";
    btnAdd.disabled = false; btnDel.disabled = false;
  };

  iframe.onload = () => {
    iframe.onload = null;
    cleanup();
    setMessage("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + newName);
    loadCSV().then(() => {
      if ([...elPerson.options].some(o => o.value === newName)){
        elPerson.value = newName;
        state.current = newName;
        buildTbody();
      }
    });
  };

  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠...");
  form.submit();
}

function deleteName(){
  const input  = $("newName");
  const target = (input.value || elPerson.value || "").trim();
  if (!target){ alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö"); return; }
  if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠ "${target}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï?`)) return;

  const form   = $("gasForm");
  const iframe = $("gasTarget");
  form.action  = GAS_ENDPOINT;

  // ‡∏•‡πâ‡∏≤‡∏á payload ‡∏™‡∏Å‡∏¥‡∏•
  $("f_name").value = "";
  [...form.querySelectorAll('input[name="u_skill[]"], input[name="u_level[]"]')].forEach(el => el.remove());

  $("f_action").value   = "deleteName";
  $("f_new_name").value = target;

  const btnAdd = $("btnAdd"), btnDel = $("btnDel");
  btnAdd.disabled = true; btnDel.disabled = true;

  const cleanup = () => {
    $("f_action").value = ""; $("f_new_name").value = ""; input.value = "";
    btnAdd.disabled = false; btnDel.disabled = false;
  };

  iframe.onload = () => {
    iframe.onload = null;
    cleanup();
    setMessage("‚úÖ ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + target);
    loadCSV().then(() => {
      if (![...elPerson.options].some(o => o.value === state.current)){
        state.current = elPerson.options[0]?.value || "";
        elPerson.value = state.current;
        buildTbody();
      }
    });
  };

  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠...");
  form.submit();
}

/* =================== PERSON SWITCH =================== */
elPerson.addEventListener("change", () => {
  state.current = elPerson.value;
  state.dirty.clear();
  buildTbody();
});

/* ====================== HELPERS ====================== */
function symbolForLevel(lv){
  // ‡πÅ‡∏™‡∏î‡∏á 0 ‚Üí '-', 1 ‚Üí '‚óã', 2 ‚Üí '‚óè'
  return lv === "2" ? "‚óè" : (lv === "1" ? "‚óã" : "-");
}
function nextLevel(lv){ return lv === "0" ? "1" : (lv === "1" ? "2" : "0"); }

/* ======================== BOOT ======================== */
loadCSV();
</script>
</body>
</html>
