<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Skill Matrix (0/1/2) ‚Äî YAPTCSSKILL</title>

<style>
/* ===== Theme tokens ===== */
:root{
  --border:#e5e7eb;
  --muted:#64748b;
  --brand-50:#eef2ff; --brand-100:#e0e7ff; --brand-200:#c7d2fe;
  --brand-400:#6366f1; --brand-500:#4f46e5; --brand-600:#4338ca;

  --gray-50:#f8fafc;  --gray-100:#f1f5f9; --gray-300:#cbd5e1; --gray-500:#64748b;

  --header-grad: linear-gradient(180deg,#f8fafc 0%, #ffffff 100%);

  /* sticky metrics (JS ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï) */
  --h1: 40px;
  --nameW: 220px;
}

html,body{margin:0;padding:0;background:#fff;color:#0f172a;
  font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans",Arial}

/* ===== Top bar ===== */
header{position:sticky;top:0;z-index:100;background:var(--header-grad);
  border-bottom:1px solid var(--border);padding:14px 12px 10px 12px;
  box-shadow:0 6px 22px rgba(15,23,42,.06)}
h1{margin:0 0 10px 0;font-size:16px}
.controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.controls select,.controls input{
  border:1px solid var(--border);border-radius:10px;padding:8px 12px;background:#fff;
}
.controls select:focus,.controls input:focus{
  outline:none;border-color:var(--brand-400);
  box-shadow:0 0 0 4px color-mix(in srgb, var(--brand-400) 20%, transparent)
}
button{
  border:1px solid transparent;border-radius:10px;padding:10px 14px;font-weight:700;
  transition:transform .05s ease, box-shadow .15s ease, background .15s ease; cursor:pointer
}
button:active{transform:translateY(1px)}
button.primary{background:var(--brand-500);color:#fff;border-color:var(--brand-500);
  box-shadow:0 8px 20px rgba(79,70,229,.25)}
button.primary:hover{background:var(--brand-600)}
button.secondary{background:#fff;color:var(--brand-600);border-color:var(--brand-200)}
button.secondary:hover{background:var(--brand-50);border-color:var(--brand-400)}
#btnAdd.secondary{color:#10b981;border-color:color-mix(in srgb,#10b981 35%,#fff)}
#btnAdd.secondary:hover{background:color-mix(in srgb,#10b981 12%,#fff);border-color:#10b981}
#btnDel.secondary{color:#ef4444;border-color:color-mix(in srgb,#ef4444 35%,#fff)}
#btnDel.secondary:hover{background:color-mix(in srgb,#ef4444 10%,#fff);border-color:#ef4444}

.status{font-size:13px;color:var(--muted);margin-top:6px}

/* ===== Table wrapper ===== */
.wrap{padding:12px}
.table-wrap{
  border:1px solid var(--border);border-radius:14px;background:#fff;
  box-shadow:0 12px 24px rgba(15,23,42,.05);overflow:auto;
  max-height: calc(100vh - 200px);
}
table{border-collapse:separate;border-spacing:0;width:max-content;min-width:100%}
th,td{border-right:1px solid var(--border);border-bottom:1px solid var(--border);
  padding:10px 12px;background:#fff;white-space:nowrap}

/* ===== Header colors ===== */
#groupRow th{
  background: linear-gradient(180deg, #4f46e5 0%, #4338ca 100%);
  color:#fff; font-weight:800; letter-spacing:.2px; border-bottom:2px solid #242a5a
}
#skillRow th{
  background:#f8fafc; color:#0f172a; font-weight:800;
  /* ‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏ô‡πâ‡∏ô‡πÉ‡∏ï‡πâ‡∏´‡∏±‡∏ß‡∏™‡∏Å‡∏¥‡∏•‡∏ï‡∏≤‡∏° accent ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô JS) */
  border-bottom: 3px solid color-mix(in srgb, var(--accent, #e5e7eb) 45%, #ffffff);
}

/* ===== Sticky (2 header rows + 2 left columns) ===== */
thead th{ position:sticky; background-clip:padding-box }
thead tr:first-child th{ top:0; z-index:60 }
thead tr:nth-child(2) th{ top:var(--h1); z-index:59 }

/* left sticky (name / branch) */
thead th.sticky-1, tbody td.sticky-1{
  position:sticky; left:0; z-index:80;
  background: linear-gradient(180deg,#eef2ff 0%, #ffffff 100%);
  font-weight:800;
}
thead th.sticky-2, tbody td.sticky-2{
  position:sticky; left:var(--nameW); z-index:79;
  background: linear-gradient(180deg,#eef2ff 0%, #ffffff 100%);
  font-weight:800;
}

/* row styles */
tbody tr:nth-child(even) td{ background:#fcfcff }
tbody tr:hover td{ background:#eef2ff }                /* hover ‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô */
tbody tr.current-row td{ background:#fff7d6 }          /* ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏Ñ‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ) */

/* center content in cells */
td.center{ text-align:center; vertical-align:middle }

/* ===== level buttons (‡∏¢‡πâ‡∏≠‡∏°‡∏ï‡∏≤‡∏° --accent ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå) ===== */
.lvbtn{
  display:inline-flex;align-items:center;justify-content:center;
  width:36px;height:36px;font-size:22px;border-radius:10px;
  border:1px solid var(--gray-300); background:#fff; color:#111827;
  box-shadow: 0 1px 0 rgba(0,0,0,.04);
}
.lvbtn:focus{ outline:none; box-shadow:0 0 0 4px color-mix(in srgb, var(--accent, #6366f1) 20%, transparent) }

/* 0 = ‡∏Ç‡∏µ‡∏î (‡πÄ‡∏ó‡∏≤) */
.lvbtn.val0{
  background:var(--gray-50); color:var(--gray-500); border-color:var(--gray-300)
}
/* 1 = ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏Ç‡∏≤‡∏ß (‡πÇ‡∏ó‡∏ô‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á accent) */
.col-skill .lvbtn.val1{
  background: color-mix(in srgb, var(--accent, #22c55e) 18%, #ffffff);
  color:      color-mix(in srgb, var(--accent, #22c55e) 80%, #000);
  border-color: color-mix(in srgb, var(--accent, #22c55e) 45%, #ffffff);
}
/* 2 = ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏î‡∏≥ (‡πÇ‡∏ó‡∏ô‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏≠‡∏á accent) */
.col-skill .lvbtn.val2{
  background: color-mix(in srgb, var(--accent, #2563eb) 28%, #ffffff);
  color:      color-mix(in srgb, var(--accent, #2563eb) 90%, #000);
  border-color: color-mix(in srgb, var(--accent, #2563eb) 60%, #ffffff);
}

/* read only: ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡πà‡∏ô‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏µ */
.lvbtn.readonly{ filter:saturate(.9) brightness(.98); opacity:.95; cursor:default }

/* ===== ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤ + accent ===== */
.col-skill.skill.level1{ background: color-mix(in srgb, var(--accent, #22c55e) 10%, #ffffff) }
.col-skill.skill.level2{ background: color-mix(in srgb, var(--accent, #2563eb) 16%, #ffffff) }

iframe{display:none}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<header>
  <h1>Skill Matrix ‚Äî ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏™‡∏Å‡∏¥‡∏• (0/1/2)</h1>

  <div class="controls">
    <label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç):
      <select id="person"></select>
    </label>
    <button id="saveBtn" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
    <button id="resetBtn" class="secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    <span class="small">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
  </div>

  <div class="controls" style="margin-top:6px">
    <input id="newName"   placeholder="Name (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö)" style="min-width:180px"/>
    <input id="newBranch" placeholder="Branch (‡πÄ‡∏ä‡πà‡∏ô BKK, CBI)" style="min-width:180px"/>
    <button id="btnAdd" class="secondary">‚ûï Add</button>
    <button id="btnDel" class="secondary">üóë Delete</button>
  </div>

  <div id="msg" class="status"></div>
</header>

<div class="wrap">
  <div class="table-wrap">
    <table id="skillTable" aria-label="Skill matrix table">
      <thead>
        <tr id="groupRow"></tr>
        <tr id="skillRow"></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- Transport form to GAS -->
<iframe id="gasTarget" name="gasTarget"></iframe>
<form id="gasForm" method="POST" target="gasTarget" action="">
  <input type="hidden" name="name"       id="f_name">
  <input type="hidden" name="action"     id="f_action">
  <input type="hidden" name="new_name"   id="f_new_name">
  <input type="hidden" name="new_branch" id="f_new_branch">
  <!-- u_skill[] / u_level[] ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≠‡∏ô save -->
</form>

<script>
/* ====================== CONFIG ====================== */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k/export?format=csv&gid=0";

const GAS_ENDPOINT =
  "https://script.google.com/macros/s/AKfycbzPMwWO8ir9wa8kSVDn_aWn_-vyY11K8Z2msF4nY2Aj7iyRyYJctzEo3F-VlYW-w-68jQ/exec";
/* ==================================================== */

const $ = id => document.getElementById(id);

/* ===== Accent palette (‡∏ß‡∏ô‡∏ã‡πâ‡∏≥‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô) ===== */
const ACCENT_PALETTE = [
  "#22c55e", /* green */
  "#06b6d4", /* cyan  */
  "#8b5cf6", /* violet*/
  "#f59e0b", /* amber */
  "#ef4444", /* red   */
  "#14b8a6", /* teal  */
  "#eab308", /* yellow*/
  "#f97316", /* orange*/
  "#3b82f6", /* blue  */
  "#ec4899"  /* pink  */
];

/* State */
let state = {
  nameCol: -1,
  branchCol: -1,
  names: [],
  branches: {},       // {name: branch}
  groups: [],
  skills: [],         // [{idx,label,group,accent}]
  rows: [],
  levels: {},         // {name: {skill: '0'|'1'|'2'|''}}
  current: "",
  dirty: new Map()
};

const elPerson   = $("person");
const elMsg      = $("msg");
const elGroupRow = $("groupRow");
const elSkillRow = $("skillRow");
const elTbody    = $("tbody");
function setMessage(t){ elMsg.textContent = t }

/* ------------- CSV parse (basic) ------------- */
function parseCSV(text){
  const rows = [];
  let i=0, cur="", row=[], inq=false;
  while(i<text.length){
    const ch = text[i];
    if(inq){
      if(ch === '"'){
        if(text[i+1] === '"'){ cur+='"'; i+=2; continue; }
        inq = false; i++; continue;
      } else { cur+=ch; i++; continue; }
    } else {
      if(ch === '"'){ inq=true; i++; continue; }
      if(ch === ','){ row.push(cur); cur=""; i++; continue; }
      if(ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=""; i++; continue; }
      if(ch === '\r'){ i++; continue; }
      cur+=ch; i++;
    }
  }
  row.push(cur); rows.push(row);
  return rows;
}
const toStr = v => String(v ?? '').trim();

/* ------------- Load Sheet ------------- */
async function loadCSV(){
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet...");
  const r = await fetch(CSV_URL, { cache:"no-store" });
  if(!r.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î CSV ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  const matrix = parseCSV(await r.text());

  // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏™‡∏Å‡∏¥‡∏•: ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "name"
  let skillHeaderRowIdx=-1, nameCol=-1;
  for(let i=0;i<Math.min(15,matrix.length);i++){
    const row = matrix[i];
    const idx = row.findIndex(v => toStr(v).toLowerCase() === 'name');
    if(idx !== -1){ skillHeaderRowIdx=i; nameCol=idx; break; }
  }
  if(skillHeaderRowIdx<0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "name"');

  // ‡∏´‡∏≤ branch/brance
  const rowHead = matrix[skillHeaderRowIdx].map(toStr);
  let branchCol = rowHead.findIndex(v => ['branch','brance'].includes(v.toLowerCase()));
  if(branchCol === -1 && rowHead[nameCol+1]) branchCol = nameCol+1;

  // group row ‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
  const groupHeaderRowIdx = Math.max(0, skillHeaderRowIdx - 1);
  const groupRaw = matrix[groupHeaderRowIdx].map(x => toStr(x).replace(/\s+/g,' ').trim());

  // skill header row
  let skillRow = matrix[skillHeaderRowIdx].map(x => toStr(x).replace(/\s+/g,' ').trim());
  const looksLikeGroup =
    skillRow.some((v,i)=>i!==nameCol && v) &&
    skillRow.every((v,i)=>i===nameCol || v === groupRaw[i]);
  if(looksLikeGroup && matrix[skillHeaderRowIdx+1]){
    skillHeaderRowIdx += 1;
    skillRow = matrix[skillHeaderRowIdx].map(x => toStr(x).replace(/\s+/g,' ').trim());
  }

  // forward-fill group
  const groupRow = [];
  let lastG="";
  for(let c=0;c<groupRaw.length;c++){
    const g = groupRaw[c];
    if(g) lastG=g;
    groupRow[c] = lastG;
  }

  // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏Å‡∏¥‡∏• (+ ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà accent ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö)
  const startIdx = Math.max(nameCol, branchCol) + 1;
  const skillCols=[];
  let paletteIdx = 0;
  for(let c=startIdx;c<skillRow.length;c++){
    const s = skillRow[c];
    if(!s) continue;
    const accent = ACCENT_PALETTE[paletteIdx % ACCENT_PALETTE.length];
    paletteIdx++;
    skillCols.push({ idx:c, label:s, group: groupRow[c] || '', accent });
  }

  // rows + names + branch + levels
  const dataRows = matrix.slice(skillHeaderRowIdx+1);
  const names=[], branches={}, levels={};
  for(const row of dataRows){
    const nm = toStr(row[nameCol]);
    if(!nm) continue;
    const br = toStr(row[branchCol]) || '';
    names.push(nm);
    branches[nm] = br;

    const mp = {};
    for(const col of skillCols){
      const raw = row[col.idx];
      const v = raw==null ? '' : toStr(raw);
      mp[col.label] = (v==='0'||v==='1'||v==='2') ? v : (v==='' ? '' : v);
    }
    levels[nm]=mp;
  }

  // commit
  state.nameCol=nameCol;
  state.branchCol=branchCol;
  state.groups=groupRow;
  state.skills=skillCols;
  state.rows=dataRows;
  state.names=names;
  state.branches=branches;
  state.levels=levels;
  state.current = names[0] || "";
  state.dirty.clear();

  buildThead();
  buildTbody();
  // select list
  elPerson.innerHTML = names.map(n=>`<option value="${n.replace(/&/g,'&amp;').replace(/</g,'&lt;')}">${n}</option>`).join('');
  elPerson.value = state.current;

  setMessage("‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
}

/* ------------- Render THEAD ------------- */
function buildThead(){
  elGroupRow.innerHTML = '';
  elSkillRow.innerHTML = '';

  // th name (rowspan 2) sticky-1
  const thName=document.createElement('th');
  thName.textContent='name';
  thName.className='sticky-1';
  thName.rowSpan=2;
  elGroupRow.appendChild(thName);

  // th branch (rowspan 2) sticky-2
  const thBranch=document.createElement('th');
  thBranch.textContent='branch';
  thBranch.className='sticky-2';
  thBranch.rowSpan=2;
  elGroupRow.appendChild(thBranch);

  // group heads
  let i=0;
  while(i<state.skills.length){
    const g = state.skills[i].group || '';
    let span=1, j=i+1;
    while(j<state.skills.length && (state.skills[j].group||'')===g){ span++; j++; }
    const th=document.createElement('th');
    th.textContent = g || '';
    th.colSpan = span;
    elGroupRow.appendChild(th);
    i=j;
  }

  // skill row
  state.skills.forEach((col, idx)=>{
    const th=document.createElement('th');
    th.textContent = col.label;
    th.style.setProperty('--accent', col.accent);   // << ‡∏ú‡∏π‡∏Å accent ‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
    elSkillRow.appendChild(th);
  });

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï sticky metrics ‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏î
  requestAnimationFrame(updateStickyHeaderMetrics);
}

/* helper: ‡∏õ‡∏£‡∏±‡∏ö class ‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤ */
function setBtnValueClass(btn, val){
  btn.classList.remove('val0','val1','val2');
  if(val==='0') btn.classList.add('val0');
  else if(val==='1') btn.classList.add('val1');
  else if(val==='2') btn.classList.add('val2');
}

/* ------------- Render TBODY ------------- */
function buildTbody(){
  elTbody.innerHTML='';
  const cur = state.current;

  for(const name of state.names){
    const tr=document.createElement('tr');
    if(name===cur) tr.classList.add('current-row');

    // name (sticky-1)
    const tdName=document.createElement('td');
    tdName.className='sticky-1';
    tdName.textContent=name;
    tr.appendChild(tdName);

    // branch (sticky-2)
    const tdBranch=document.createElement('td');
    tdBranch.className='sticky-2';
    tdBranch.textContent= state.branches[name] || '';
    tr.appendChild(tdBranch);

    const editable = (name===cur);
    const baseMap = state.levels[name] || {};

    state.skills.forEach((col)=>{
      const skill = col.label;
      const baseline = (baseMap[skill] ?? '0') || '0';
      const current  = (editable && state.dirty.has(skill)) ? state.dirty.get(skill) : baseline;

      const td=document.createElement('td');
      td.className='center skill col-skill';
      td.style.setProperty('--accent', col.accent);     // << ‡∏ú‡∏π‡∏Å accent ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô cell

      // ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö
      td.classList.toggle('level1', current==='1');
      td.classList.toggle('level2', current==='2');

      const btn=document.createElement('button');
      btn.type='button';
      btn.className='lvbtn';
      btn.textContent = symbolForLevel(current);
      btn.dataset.skill=skill;
      btn.dataset.value=current;
      setBtnValueClass(btn, current);

      if(!editable){
        btn.classList.add('readonly');
      }else{
        if(current!==baseline) btn.classList.add('dirty');
        btn.addEventListener('click', ()=>{
          const oldVal = btn.dataset.value;
          const newVal = nextLevel(oldVal);
          btn.dataset.value=newVal;
          btn.textContent=symbolForLevel(newVal);
          setBtnValueClass(btn, newVal);

          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
          td.classList.toggle('level1', newVal==='1');
          td.classList.toggle('level2', newVal==='2');

          if(newVal===baseline){
            state.dirty.delete(skill);
            btn.classList.remove('dirty');
          }else{
            state.dirty.set(skill, newVal);
            btn.classList.add('dirty');
          }
        });
      }
      td.appendChild(btn);
      tr.appendChild(td);
    });

    elTbody.appendChild(tr);
  }
}

/* ------------- Helpers ------------- */
function symbolForLevel(lv){ return lv==='2'?'‚óè':(lv==='1'?'‚óã':'-') }
function nextLevel(lv){ return lv==='0'?'1':(lv==='1'?'2':'0') }

/* ------------- Sticky metrics (height/width) ------------- */
function updateStickyHeaderMetrics(){
  const r1 = document.querySelector('#groupRow');
  const h1 = Math.max(0, Math.round((r1?.getBoundingClientRect().height || 40)));
  document.documentElement.style.setProperty('--h1', h1+'px');

  const thName = document.querySelector('thead th.sticky-1');
  const nameW = Math.max(120, Math.round((thName?.getBoundingClientRect().width || 220)));
  document.documentElement.style.setProperty('--nameW', nameW+'px');
}
window.addEventListener('resize', updateStickyHeaderMetrics);

/* ------------- Events ------------- */
$("person").addEventListener('change', ()=>{
  state.current = $("person").value;
  state.dirty.clear();
  buildTbody();
});

$("resetBtn").addEventListener("click", ()=>{
  state.dirty.clear();
  buildTbody();
  setMessage("‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
});

$("saveBtn").addEventListener("click", saveViaIframeArray);

function saveViaIframeArray(){
  const selectedName = state.current;
  if(!selectedName){ setMessage("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); return; }
  if(state.dirty.size===0){ setMessage("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"); return; }

  const form=$("gasForm"), iframe=$("gasTarget");
  form.action = GAS_ENDPOINT;

  $("f_name").value = selectedName;
  // ‡∏•‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï‡πÄ‡∏Å‡πà‡∏≤
  [...form.querySelectorAll('input[name="u_skill[]"],input[name="u_level[]"]')].forEach(el=>el.remove());
  // ‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å dirty
  for(const [skill,level] of state.dirty.entries()){
    const a=document.createElement('input'); a.type='hidden'; a.name='u_skill[]'; a.value=skill; form.appendChild(a);
    const b=document.createElement('input'); b.type='hidden'; b.name='u_level[]'; b.value=level; form.appendChild(b);
  }

  const onLoad=()=>{
    const mp= state.levels[selectedName] || (state.levels[selectedName]={});
    for(const [skill,level] of state.dirty.entries()) mp[skill]=level;
    state.dirty.clear();
    buildTbody();
    setMessage("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    iframe.removeEventListener('load', onLoad);
  };
  iframe.addEventListener('load', onLoad, {once:true});

  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");
  form.submit();
}

/* === Add/Delete Name with Branch === */
$("btnAdd").addEventListener("click", ()=>{
  const name = toStr($("newName").value);
  const br   = toStr($("newBranch").value);
  if(!name){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); return; }
  if(!br){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å branch"); return; }

  const form=$("gasForm"), iframe=$("gasTarget");
  form.action=GAS_ENDPOINT;
  $("f_action").value='addName';
  $("f_new_name").value=name;
  $("f_new_branch").value=br;

  const cleanup=()=>{
    $("f_action").value = $("f_new_name").value = $("f_new_branch").value = "";
    $("newName").value=""; $("newBranch").value="";
  };

  iframe.onload = ()=>{
    iframe.onload=null; cleanup();
    setMessage("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+name);
    loadCSV().then(()=>{
      if([...( $("person").options )].some(o=>o.value===name)){
        $("person").value=name; state.current=name; buildTbody();
      }
    });
  };
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠...");
  form.submit();
});

$("btnDel").addEventListener("click", ()=>{
  const target = toStr($("newName").value) || $("person").value;
  if(!target){ alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö"); return; }
  if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö "${target}" ?`)) return;

  const form=$("gasForm"), iframe=$("gasTarget");
  form.action=GAS_ENDPOINT;
  $("f_action").value='deleteName';
  $("f_new_name").value=target;
  $("f_new_branch").value="";

  const cleanup=()=>{
    $("f_action").value = $("f_new_name").value = $("f_new_branch").value = "";
    $("newName").value=""; $("newBranch").value="";
  };

  iframe.onload=()=>{
    iframe.onload=null; cleanup();
    setMessage("‚úÖ ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+target);
    loadCSV().then(()=>{
      const sel=$("person");
      if(![...sel.options].some(o=>o.value===state.current)){
        state.current = sel.options[0]?.value || "";
        sel.value = state.current;
        buildTbody();
      }
    });
  };
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠...");
  form.submit();
});

/* ------------- Boot ------------- */
loadCSV().catch(err=>{
  setMessage("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+(err.message||err));
});
</script>
</body>
</html>
