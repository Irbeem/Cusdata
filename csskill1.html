<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Skill Matrix (0/1/2) ‚Äî YAPTCSSKILL</title>
<style>
:root{
  --nameW: 200px;
  --branchW: 120px;

  --h1: 34px;
  --border:#e5e7eb;
  --brand-50:#eef2ff; --brand-200:#c7d2fe; --brand-500:#4f46e5; --brand-600:#4338ca;
  --row-select-bg:#F6C8B6;
  --row-select-left:#6366f1;
  --row-hover:#f0f4ff;
  --header-grad: linear-gradient(180deg,#6366f1 0%, #4f46e5 80%, #4338ca 100%);
}
html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans",Arial;color:#111827;background:#fff}

/* Header */
header{position:sticky; top:0; z-index:1000; background:#fff; border-bottom:1px solid var(--border)}
header .bar{padding:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center}
h1{margin:0 0 6px 0; font-size:16px; font-weight:700}
.controls select,.controls input{border:1px solid var(--border); border-radius:10px; padding:8px 12px; background:#fff}
button{border-radius:10px; padding:10px 14px; border:1px solid transparent; font-weight:600; cursor:pointer}
button.primary{background:var(--brand-500); color:#fff}
button.primary:hover{background:var(--brand-600)}
button.secondary{background:#fff; border:1px solid var(--brand-200); color:#1f2937}
.status{font-size:13px; color:#374151; padding:0 12px 10px}

/* Table */
.wrap{padding:12px}
.table-wrap{max-height:calc(100vh - 200px); overflow:auto; border:1px solid var(--border); border-radius:12px; background:#fff; box-shadow:0 10px 24px rgba(15,23,42,.06)}
table{border-collapse:separate;border-spacing:0;width:max-content;min-width:100%}
th,td{border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:10px 12px;background:#fff;white-space:nowrap}
th:first-child,td:first-child{border-left:1px solid var(--border)}
thead th{position:sticky;background:#fff; z-index:10}
thead tr:first-child th{top:0}
thead tr:nth-child(2) th{top:var(--h1)}

/* Sticky ‡∏ã‡πâ‡∏≤‡∏¢ 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
thead th.name-th{
  left:0; z-index:120 !important;
  width:var(--nameW); min-width:var(--nameW); max-width:var(--nameW);
  color:#fff; background:var(--header-grad);
  border-bottom:2px solid #c7d2fe;
}
thead th.branch-th{
  left:var(--nameW); z-index:119 !important;
  width:var(--branchW); min-width:var(--branchW); max-width:var(--branchW);
  color:#fff; background:var(--header-grad);
  border-bottom:2px solid #c7d2fe;
}
#groupRow th{ background:var(--header-grad); color:#fff; border-bottom:2px solid #c7d2fe; text-shadow:0 1px 0 rgba(0,0,0,.15); z-index:15 }
#skillRow th{ font-weight:700; background:#fafbff; z-index:14 }

tbody td.name-td{
  position:sticky; left:0; z-index:80;
  width:var(--nameW); min-width:var(--nameW); max-width:var(--nameW);
  background:#f8fafc; font-weight:700;
}
tbody td.branch-td{
  position:sticky; left:var(--nameW); z-index:79;
  width:var(--branchW); min-width:var(--branchW); max-width:var(--branchW);
  background:linear-gradient(90deg,#f8fafc 0%, #fff 100%);
  box-shadow: inset -1px 0 0 var(--border); /* ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡∏ß‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô */
}

/* Hover/Selected */
tbody tr:nth-child(even) td{ background:#fcfcff }
tbody tr:hover td{ background:var(--row-hover) }

/* ‚úÖ FIX: ‡∏≠‡∏¢‡πà‡∏≤ override position (sticky) ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≤‡∏¢ */
tr.is-selected td{ background:var(--row-select-bg) !important; }   /* ‡∏•‡∏ö position:relative ‡∏≠‡∏≠‡∏Å */

/* ‡πÉ‡∏™‡πà position ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ã‡∏•‡∏•‡πå name (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö ::before) */
tr.is-selected td.name-td{ 
  background:linear-gradient(90deg,#eaf0ff 0%, var(--row-select-bg) 100%) !important; 
}
tr.is-selected td.name-td::before{
  content:""; position:absolute; inset:0 auto 0 0; width:4px;
  background:var(--row-select-left); border-top-left-radius:6px; border-bottom-left-radius:6px;
}

/* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏Å‡∏¥‡∏• 0/1/2 */
td.center{ text-align:center; vertical-align:middle }
td.center .cell{ display:flex; align-items:center; justify-content:center; width:100% }
.lvbtn{
  display:inline-flex; align-items:center; justify-content:center;
  width:32px; height:32px; font-size:20px; border-radius:10px; margin:0;
  border:1px solid var(--brand-200); background:#fff; color:#111827;
  box-shadow:0 1px 0 rgba(0,0,0,.04);
}
.lvbtn[data-value="0"]{ background:#f8fafc; color:#6b7280; border-color:#e5e7eb }
.lvbtn[data-value="1"]{ background:#10b98122; color:#047857; border-color:#34d399 }
.lvbtn[data-value="2"]{ background:#3b82f622; color:#1d4ed8; border-color:#93c5fd }
.lvbtn.readonly{ background:#eef2ff; color:#374151; border-color:#c7d2fe }
.lvbtn.dirty{ outline:2px solid #f59e0b; outline-offset:-3px }
.small{ font-size:12px; color:#6b7280; margin-left:12px }
</style>
</head>
<body>

<header>
  <div class="bar" style="border-bottom:1px solid var(--border)">
    <h1>Skill Matrix ‚Äî ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏™‡∏Å‡∏¥‡∏• (0/1/2)</h1>
  </div>
  <div class="bar controls">
    <label>Branch:
      <select id="branchFilter"></select>
    </label>
    <label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç):
      <select id="person"></select>
    </label>
    <button id="saveBtn" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
    <button id="resetBtn" class="secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    <span class="small">Skill: '-' = No, '‚óã' = Can do, '‚óè' = Can teach</span>
  </div>
  <div class="bar controls" style="border-top:1px solid var(--border)">
    <input id="newName" placeholder="Name (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö)" style="min-width:160px" />
    <input id="newBranch" placeholder="Branch (‡πÄ‡∏ä‡πà‡∏ô BKK, CBI)" style="min-width:140px" />
    <button id="btnAdd" class="secondary">‚ûï Add</button>
    <button id="btnDel" class="secondary">üóë Delete</button>
  </div>
  <div id="msg" class="status"></div>
</header>

<div class="wrap">
  <div class="table-wrap">
    <table id="skillTable" aria-label="Skill matrix table">
      <thead>
        <tr id="groupRow"></tr>
        <tr id="skillRow"></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<iframe id="gasTarget" name="gasTarget" style="display:none"></iframe>
<form id="gasForm" method="POST" target="gasTarget" action="">
  <input type="hidden" name="name" id="f_name">
  <input type="hidden" name="branch" id="f_branch">
  <input type="hidden" name="action" id="f_action">
  <input type="hidden" name="new_name" id="f_new_name">
  <input type="hidden" name="new_branch" id="f_new_branch">
</form>

<script>
/* ===== CONFIG ===== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k/export?format=csv&gid=0";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzPMwWO8ir9wa8kSVDn_aWn_-vyY11K8Z2msF4nY2Aj7iyRyYJctzEo3F-VlYW-w-68jQ/exec";

/* ===== STATE ===== */
let state = {
  nameCol: -1, branchCol: -1,
  names: [], branches: [],
  groups: [], skills: [], rows: [],
  levels: {}, current: "", dirty: new Map(),
  filterBranch: "All"
};

/* ===== HELPERS ===== */
const $ = (id) => document.getElementById(id);
const elBranchFilter = $("branchFilter");
const elPerson   = $("person");
const elMsg      = $("msg");
const elGroupRow = $("groupRow");
const elSkillRow = $("skillRow");
const elTbody    = $("tbody");

function setMessage(t){ elMsg.textContent = t; }
function symbolForLevel(lv){ return lv==='2'?'‚óè':(lv==='1'?'‚óã':'-'); }
function nextLevel(lv){ return lv==='0'?'1':(lv==='1'?'2':'0'); }

function parseCSV(text){
  const rows=[]; let i=0, cur="", row=[], inq=false;
  while(i<text.length){
    const ch=text[i];
    if(inq){
      if(ch==='\"'){
        if(text[i+1]==='\"'){cur+='\"'; i+=2; continue;}
        inq=false; i++; continue;
      }else{ cur+=ch; i++; continue; }
    }else{
      if(ch==='\"'){inq=true; i++; continue;}
      if(ch===','){row.push(cur); cur=""; i++; continue;}
      if(ch==='\n'){row.push(cur); rows.push(row); row=[]; cur=""; i++; continue;}
      if(ch==='\r'){i++; continue;}
      cur+=ch; i++;
    }
  }
  row.push(cur); rows.push(row);
  return rows;
}

/* ===== LOAD ===== */
async function loadCSV(){
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
  const r = await fetch(CSV_URL,{cache:"no-store"});
  if(!r.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î CSV ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  const text=await r.text();
  const matrix=parseCSV(text);

  // ‡∏´‡∏≤ header ‡∏ó‡∏µ‡πà‡∏°‡∏µ "name"
  let hdrIdx=-1, nameCol=-1;
  for(let i=0;i<Math.min(20,matrix.length);i++){
    const row=matrix[i];
    const idx=row.findIndex(v=>String(v??"").trim().toLowerCase()==="name");
    if(idx!==-1){ hdrIdx=i; nameCol=idx; break; }
  }
  if(hdrIdx<0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå name");

  // group header ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô 1 ‡πÅ‡∏ñ‡∏ß
  const grpIdx=Math.max(0,hdrIdx-1);
  const groupRowRaw=matrix[grpIdx].map(x=>String(x??"").replace(/\s+/g,' ').trim());
  let skillRow=matrix[hdrIdx].map(x=>String(x??"").replace(/\s+/g,' ').trim());

  // ‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô
  const looksLikeGroup=skillRow.some((v,i)=>i!==nameCol && v) &&
                        skillRow.every((v,i)=>i===nameCol || v===groupRowRaw[i]);
  if(looksLikeGroup && matrix[hdrIdx+1]){
    hdrIdx+=1;
    skillRow=matrix[hdrIdx].map(x=>String(x??"").replace(/\s+/g,' ').trim());
  }

  // ‡∏´‡∏≤ branchCol (‡∏ó‡∏ô‡∏ó‡∏≤‡∏ô)
  let branchCol = skillRow.findIndex(v=>{
    const t=String(v??"").trim().toLowerCase();
    return t==="branch" || t==="brance" || t==="department";
  });

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö ‡∏•‡∏≠‡∏á‡πÄ‡∏î‡∏≤: ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ñ‡∏±‡∏î‡∏à‡∏≤‡∏Å name
  if(branchCol<0){
    const guessCol = nameCol+1;
    const dataRows = matrix.slice(hdrIdx+1);
    let score=0, total=0;
    for(const r of dataRows){
      const val=String(r[guessCol]??"").trim();
      if(val) total++;
      if(/^[A-Za-z]{2,4}$/.test(val)) score++;
    }
    if(total>0 && score/total > 0.6) branchCol=guessCol;
  }

  // forward-fill group
  const groupRow=[];
  let last="";
  for(let c=0;c<groupRowRaw.length;c++){
    const g=groupRowRaw[c]; if(g) last=g; groupRow[c]=last;
  }

  // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏Å‡∏¥‡∏•
  const skillCols=[];
  for(let c=0;c<skillRow.length;c++){
    if(c===nameCol || c===branchCol) continue;
    const s=skillRow[c]; if(!s) continue;
    skillCols.push({idx:c,label:s,group:groupRow[c]||""});
  }

  const dataRows=matrix.slice(hdrIdx+1);
  const names=[], branchSet=new Set(), levels={};
  for(const row of dataRows){
    const nm=String(row[nameCol]??"").trim();
    if(!nm) continue;
    const br = branchCol>=0 ? String(row[branchCol]??"").trim() : "";
    names.push(nm);
    if(br) branchSet.add(br);
    const mp={_branch:br};
    for(const col of skillCols){
      const raw=row[col.idx];
      const v=(raw===undefined||raw===null)?'':String(raw).trim();
      mp[col.label]=(v==='0'||v==='1'||v==='2')?v:'';
    }
    levels[nm]=mp;
  }

  state.nameCol=nameCol; state.branchCol=branchCol;
  state.groups=groupRow; state.skills=skillCols;
  state.rows=dataRows; state.names=names; state.levels=levels;
  state.branches=["All",...([...branchSet].sort((a,b)=>a.localeCompare(b)))];
  if(!state.current || !names.includes(state.current)) state.current=names[0]||"";
  if(!state.branches.includes(state.filterBranch)) state.filterBranch="All";

  buildThead();
  buildBranchFilter();
  buildPeopleDropdown();
  buildTbody();
  setMessage("‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
}

/* ===== RENDER THEAD ===== */
function buildThead(){
  elGroupRow.innerHTML="";
  elSkillRow.innerHTML="";

  const thName=document.createElement("th");
  thName.className="name-th";
  thName.textContent="name";
  thName.rowSpan=2;
  elGroupRow.appendChild(thName);

  const thBranch=document.createElement("th");
  thBranch.className="branch-th";
  thBranch.textContent="branch";
  thBranch.rowSpan=2;
  elGroupRow.appendChild(thBranch);

  // groups
  let i=0, sc=state.skills;
  while(i<sc.length){
    const g=sc[i].group||""; let span=1, j=i+1;
    while(j<sc.length && (sc[j].group||"")===g){ span++; j++; }
    const th=document.createElement("th");
    th.textContent=g;
    th.colSpan=span;
    elGroupRow.appendChild(th);
    i=j;
  }
  // skill labels
  for(const col of state.skills){
    const th=document.createElement("th");
    th.textContent=col.label;
    elSkillRow.appendChild(th);
  }

  requestAnimationFrame(()=>{
    const r1=document.querySelector('#groupRow');
    const h=(r1&&r1.offsetHeight)?r1.offsetHeight:34;
    document.documentElement.style.setProperty('--h1', h+'px');
  });
}

/* ===== RENDER FILTERS ===== */
function getFilteredNames(){
  if(state.filterBranch==="All") return state.names.slice();
  return state.names.filter(n => (state.levels[n]?._branch||"")===state.filterBranch);
}
function buildPeopleDropdown(){
  const list=getFilteredNames();
  elPerson.innerHTML=list.map(n=>`<option value="${n}">${n}</option>`).join("");
  if(list.length){
    if(!list.includes(state.current)) state.current=list[0];
    elPerson.value=state.current;
  }
}
function buildBranchFilter(){
  elBranchFilter.innerHTML=state.branches.map(b=>`<option value="${b}">${b}</option>`).join("");
  elBranchFilter.value=state.filterBranch;
}

/* ===== RENDER BODY ===== */
function buildTbody(){
  elTbody.innerHTML="";
  const names=getFilteredNames();

  for(const name of names){
    const tr=document.createElement("tr");
    if(name===state.current) tr.classList.add("is-selected");

    // name
    const tdName=document.createElement("td");
    tdName.className="name-td";
    tdName.textContent=name;
    tr.appendChild(tdName);

    // branch
    const tdBranch=document.createElement("td");
    tdBranch.className="branch-td";
    tdBranch.textContent=state.levels[name]?._branch || "";
    tr.appendChild(tdBranch);

    const editable=(name===state.current);

    // skills
    for(const col of state.skills){
      const skill=col.label;
      const baseline=(state.levels[name]?.[skill]??'0')||'0';
      const current=(editable && state.dirty.has(skill)) ? state.dirty.get(skill) : baseline;

      const td=document.createElement("td");
      td.className="center";
      const wrap=document.createElement("div"); wrap.className="cell";
      const btn=document.createElement("button");
      btn.type="button"; btn.className="lvbtn";
      btn.dataset.skill=skill; btn.dataset.value=current;
      btn.textContent=symbolForLevel(current);

      if(!editable){
        btn.classList.add("readonly");
      }else{
        if(current!==baseline) btn.classList.add("dirty");
        btn.addEventListener("click", ()=>{
          const newV=nextLevel(btn.dataset.value);
          btn.dataset.value=newV; btn.textContent=symbolForLevel(newV);
          if(newV===baseline){ state.dirty.delete(skill); btn.classList.remove("dirty"); }
          else{ state.dirty.set(skill,newV); btn.classList.add("dirty"); }
        });
      }
      wrap.appendChild(btn); td.appendChild(wrap); tr.appendChild(td);
    }
    elTbody.appendChild(tr);
  }
}

/* ===== EVENTS ===== */
elPerson.addEventListener("change", ()=>{
  state.current=elPerson.value; state.dirty.clear(); buildTbody();
});
$("resetBtn").addEventListener("click", ()=>{
  state.dirty.clear(); buildTbody(); setMessage("‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
});
elBranchFilter.addEventListener("change", ()=>{
  state.filterBranch=elBranchFilter.value||"All";
  buildPeopleDropdown(); state.dirty.clear(); buildTbody();
});

/* SAVE */
$("saveBtn").addEventListener("click", ()=>{
  const selected=state.current;
  if(!selected){ setMessage("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); return; }
  if(state.dirty.size===0){ setMessage("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"); return; }

  const form=$("gasForm"), iframe=$("gasTarget"); form.action=GAS_ENDPOINT;
  $("f_name").value=selected;
  $("f_branch").value=state.levels[selected]?._branch || "";
  [...form.querySelectorAll('input[name="u_skill[]"], input[name="u_level[]"]')].forEach(el=>el.remove());
  for(const [skill,level] of state.dirty.entries()){
    const a=document.createElement("input"); a.type="hidden"; a.name="u_skill[]"; a.value=skill; form.appendChild(a);
    const b=document.createElement("input"); b.type="hidden"; b.name="u_level[]"; b.value=level; form.appendChild(b);
  }
  const onLoad=()=>{
    const mp=state.levels[selected]||(state.levels[selected]={});
    for(const [skill,level] of state.dirty.entries()) mp[skill]=level;
    state.dirty.clear(); buildTbody(); setMessage("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    iframe.removeEventListener("load", onLoad);
  };
  iframe.addEventListener("load", onLoad, {once:true});
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."); form.submit();
});

/* ADD / DELETE */
$("btnAdd").addEventListener("click", ()=>{
  const nm=($("newName").value||"").trim();
  const br=($("newBranch").value||"").trim();
  if(!nm){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); return; }
  const form=$("gasForm"), iframe=$("gasTarget"); form.action=GAS_ENDPOINT;
  $("f_action").value="addName"; $("f_new_name").value=nm; $("f_new_branch").value=br;
  const cleanup=()=>{ $("f_action").value=""; $("f_new_name").value=""; $("f_new_branch").value=""; $("newName").value=""; $("newBranch").value=""; };
  iframe.onload=()=>{ iframe.onload=null; cleanup(); setMessage("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); loadCSV().then(()=>{ if(state.names.includes(nm)){ state.current=nm; if(br && state.branches.includes(br)){ state.filterBranch=br; elBranchFilter.value=br; } buildBranchFilter(); buildPeopleDropdown(); buildTbody(); } }); };
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠..."); form.submit();
});
$("btnDel").addEventListener("click", ()=>{
  const nm=($("newName").value||elPerson.value||"").trim();
  if(!nm){ alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö"); return; }
  if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠ "${nm}" ?`)) return;
  const form=$("gasForm"), iframe=$("gasTarget"); form.action=GAS_ENDPOINT;
  [...form.querySelectorAll('input[name="u_skill[]"], input[name="u_level[]"]')].forEach(el=>el.remove());
  $("f_name").value=""; $("f_action").value="deleteName"; $("f_new_name").value=nm;
  const cleanup=()=>{ $("f_action").value=""; $("f_new_name").value=""; $("newName").value=""; };
  iframe.onload=()=>{ iframe.onload=null; cleanup(); setMessage("‚úÖ ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); loadCSV().then(()=>{ buildBranchFilter(); buildPeopleDropdown(); buildTbody(); }); };
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠..."); form.submit();
});

/* BOOT */
loadCSV().catch(err=> setMessage("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+(err.message||err)));
</script>
</body>
</html>
