<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Skill Matrix (0/1/2)</title>
<style>
/* ---------- Theme ---------- */
:root{
  --border:#e5e7eb; --muted:#6b7280; --brand:#4f46e5;
  --head1:#3b37b7; --head1-text:#fff;
  --head2:#eef2ff;
  --sticky:#f8fafc;
  --row-hover:#f4f6ff;
  --selected:#e7f0ff;
  --green:#16a34a;  /* lv=1 (‚óã) */
  --blue:#2563eb;   /* lv=2 (‚óè) */
  --gray:#e5e7eb;   /* lv=0 (-) */
  --z-head1:60; --z-head2:59; --z-corner:70; --z-left:55;
}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,"Noto Sans Thai",Arial;color:#111}

/* ---------- Toolbar ---------- */
header{position:sticky;top:0;z-index:100;background:#fff;border-bottom:1px solid var(--border)}
.hbar{display:flex;gap:10px;align-items:center;padding:10px 12px;flex-wrap:wrap}
select,input,button{border:1px solid var(--border);border-radius:10px;padding:8px 10px}
button.primary{background:var(--brand);border-color:var(--brand);color:#fff;font-weight:700}
button.secondary{background:#fff;color:#111}
.small{font-size:12px;color:var(--muted)}

/* ---------- Table shell ---------- */
.wrap{padding:12px}
.table-wrap{
  border:1px solid var(--border); border-radius:12px;
  overflow:auto; max-height:calc(100vh - 170px); background:#fff;
}
/* ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ transform/backdrop-filter ‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏£‡∏û‡∏ö‡∏∏‡∏£‡∏∏‡∏© sticky */
.table-wrap, .table-wrap *{transform:none !important; filter:none !important; backdrop-filter:none !important;}

table{border-collapse:separate;border-spacing:0;width:max-content;min-width:100%}
th,td{border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:10px 12px;background:#fff;white-space:nowrap}
th:first-child,td:first-child{border-left:1px solid var(--border)}

/* ---------- Sticky headers (2 ‡πÅ‡∏ñ‡∏ß) ---------- */
thead th{position:sticky;background:#fff}
:root{ --h1:44px }            /* JS ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á */
thead tr:first-child th{
  top:0; background:var(--head1); color:var(--head1-text); z-index:var(--z-head1);
  font-weight:800; letter-spacing:.2px;
}
thead tr:nth-child(2) th{
  top:var(--h1); background:var(--head2); z-index:var(--z-head2); font-weight:700;
}

/* ---------- Sticky corner & left columns ---------- */
thead th.corner-0{left:0; z-index:var(--z-corner)}
thead th.corner-1{left:var(--firstColW); z-index:var(--z-corner)}

tbody td.sticky-0{position:sticky;left:0;background:linear-gradient(90deg,var(--sticky) 0%,#fff 100%); z-index:var(--z-left); font-weight:700}
tbody td.sticky-1{position:sticky;left:var(--firstColW);background:linear-gradient(90deg,var(--sticky) 0%,#fff 100%); z-index:var(--z-left)}

/* ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡πÅ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß 2 ‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å */
thead th.corner-0, thead th.corner-1{background:var(--head1);color:#fff}

/* ---------- Rows / states ---------- */
tbody tr:hover td{background:var(--row-hover)}
tbody tr.selected td{background:var(--selected)}

/* ---------- Level buttons ---------- */
.cell{display:flex;justify-content:center;align-items:center}
.lv{
  width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;
  border:1px solid var(--border); font-weight:900; cursor:default; user-select:none; margin:auto;
}
.lv.edit{cursor:pointer}
.lv[data-lv="0"]{background:#fff;border-color:var(--gray);color:#6b7280}
.lv[data-lv="1"]{background:rgba(22,163,74,.10);border-color:rgba(22,163,74,.35);color:var(--green)}
.lv[data-lv="2"]{background:rgba(37,99,235,.10);border-color:rgba(37,99,235,.35);color:var(--blue)}
.lv.edit:hover{box-shadow:0 0 0 4px rgba(79,70,229,.18)}
.lv.dirty{outline:2px solid #f59e0b; outline-offset:-2px}

/* ---------- Utility widths ---------- */
:root{ --firstColW: 210px }   /* width ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á name */
th.name, td.name{width:var(--firstColW)}
th.branch, td.branch{width:120px;text-align:left}

/* ---------- Head title row inside group ---------- */
.group-title{font-weight:900;text-transform:none}

/* ---------- Status ---------- */
#status{padding:8px 12px;color:#374151}
</style>
</head>
<body>
<header>
  <div class="hbar">
    <label>Branch:
      <select id="branchFilter"><option value="ALL">All branches</option></select>
    </label>
    <label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç):
      <select id="person"></select>
    </label>
    <button class="primary" id="saveBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
    <button class="secondary" id="resetBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    <span class="small">‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
  </div>
  <div class="hbar">
    <input id="newName" placeholder="Name (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö)" style="min-width:180px">
    <input id="newBranch" placeholder="Branch (‡πÄ‡∏ä‡πà‡∏ô BKK, CBI)" style="min-width:160px">
    <button id="btnAdd" class="secondary">‚ûï Add</button>
    <button id="btnDel" class="secondary">üóë Delete</button>
  </div>
</header>

<div id="status" class="small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>

<div class="wrap">
  <div class="table-wrap" id="scroller">
    <table id="tbl">
      <thead>
        <tr id="rowGroup"></tr>
        <tr id="rowSkill"></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- hidden form + iframe (‡∏ß‡∏¥‡∏ò‡∏µ B) -->
<iframe id="gasTarget" name="gasTarget" style="display:none"></iframe>
<form id="gasForm" method="POST" target="gasTarget" action="">
  <input type="hidden" name="name" id="f_name">
  <input type="hidden" name="branch" id="f_branch">
  <input type="hidden" name="action" id="f_action">
  <input type="hidden" name="new_name" id="f_new_name">
  <input type="hidden" name="new_branch" id="f_new_branch">
</form>

<script>
/* ====================== CONFIG ====================== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k/export?format=csv&gid=0";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzPMwWO8ir9wa8kSVDn_aWn_-vyY11K8Z2msF4nY2Aj7iyRyYJctzEo3F-VlYW-w-68jQ/exec";

/* ===================== State ======================== */
const $ = id => document.getElementById(id);
const elGroup = $("rowGroup"), elSkill = $("rowSkill"), elBody = $("tbody");
const selPerson = $("person"), selBranch = $("branchFilter");
const statusEl = $("status");
let S = {
  nameCol: 0, branchCol: 1,
  skills: [], groups: [],
  names: [], branches: [],
  levelsByName: {},    // { name: { skillLabel: "0|1|2" } }
  nameToBranch: {},    // { name: "BKK" }
  current: "",
  dirty: new Map(),    // skill -> level (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß current)
  filterBranch: "ALL"
};

/* =================== CSV Loader ===================== */
function parseCSV(text){
  const rows = []; let i=0, cur="", row=[], q=false;
  while(i<text.length){
    const ch=text[i];
    if(q){ if(ch=='"'){ if(text[i+1]=='"'){cur+='"';i+=2;continue;} q=false; i++; }
          else{ cur+=ch; i++; } }
    else{
      if(ch=='"'){ q=true; i++; }
      else if(ch==','){ row.push(cur);cur="";i++; }
      else if(ch=='\n'){ row.push(cur); rows.push(row); row=[]; cur=""; i++; }
      else if(ch=='\r'){ i++; }
      else{ cur+=ch; i++; }
    }
  }
  row.push(cur); rows.push(row);
  return rows;
}

async function loadCSV(){
  setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï‚Ä¶");
  const res = await fetch(CSV_URL, {cache:"no-store"});
  const matrix = parseCSV(await res.text());

  // ‡∏´‡∏≤ header: ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ "name"
  let skillHeaderRow = -1, nameCol=-1;
  for(let r=0;r<Math.min(10,matrix.length);r++){
    const idx = matrix[r].findIndex(v => String(v).trim().toLowerCase()==='name');
    if(idx>-1){ skillHeaderRow=r; nameCol=idx; break; }
  }
  if(skillHeaderRow<0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "name"');

  const groupHeaderRow = Math.max(0, skillHeaderRow-1);
  const groupRaw = matrix[groupHeaderRow].map(x => (x||"").toString().trim());
  const skillRow  = matrix[skillHeaderRow].map(x => (x||"").toString().trim());

  // forward-fill group
  const groups = []; let last="";
  for(let c=0;c<groupRaw.length;c++){ groups[c] = groupRaw[c] || last; last = groups[c]; }

  // ‡∏£‡∏∞‡∏ö‡∏∏ column
  S.nameCol = nameCol;
  S.branchCol = nameCol+1;            // sheet: col B = branch

  // skills
  const skills = [];
  for(let c=0;c<skillRow.length;c++){
    if(c===S.nameCol || c===S.branchCol) continue;
    const label = skillRow[c]; if(!label) continue;
    skills.push({idx:c,label, group:groups[c]||""});
  }
  S.skills = skills; S.groups = groups;

  // data rows
  const dataRows = matrix.slice(skillHeaderRow+1);
  const names=[], branches=[], levelsByName={}, nameToBranch={};
  dataRows.forEach(r=>{
    const nm = (r[S.nameCol]||"").toString().trim();
    if(!nm) return;
    const br = (r[S.branchCol]||"").toString().trim();
    names.push(nm); nameToBranch[nm]=br; if(br) branches.push(br);
    const mp={};
    skills.forEach(col=>{
      const raw = (r[col.idx]||"").toString().trim();
      mp[col.label] = (raw==='1'||raw==='2'||raw==='0')? raw : (raw==='-'?'0':'0');
    });
    levelsByName[nm]=mp;
  });

  // unique branch list
  const uniqBr = Array.from(new Set(branches)).sort();
  buildBranchFilter(uniqBr);

  S.names=names; S.branches=uniqBr; S.levelsByName=levelsByName; S.nameToBranch=nameToBranch;
  S.current = names[0]||"";
  buildThead();
  buildTbody();
  rebuildPersonList();
  setStatus("‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
}

/* =================== UI Builders ==================== */
function setStatus(t){ statusEl.textContent=t; }

function rebuildPersonList(){
  selPerson.innerHTML = S.names.map(n=>`<option value="${escapeHTML(n)}">${escapeHTML(n)}</option>`).join("");
  if(S.current) selPerson.value=S.current;
}

function buildBranchFilter(list){
  selBranch.innerHTML = `<option value="ALL">All branches</option>` +
    list.map(b=>`<option value="${escapeHTML(b)}">${escapeHTML(b)}</option>`).join("");
  selBranch.value = S.filterBranch;
}

function buildThead(){
  elGroup.innerHTML=""; elSkill.innerHTML="";
  // corner cells (name/branch)
  const th0 = document.createElement("th");
  th0.textContent = "name"; th0.className="corner-0 name"; th0.rowSpan=2; elGroup.appendChild(th0);
  const th1 = document.createElement("th");
  th1.textContent = "branch"; th1.className="corner-1 branch"; th1.rowSpan=2; elGroup.appendChild(th1);

  // groups
  for(let i=0;i<S.skills.length;){
    const g = S.skills[i].group||"";
    let span=1, j=i+1;
    while(j<S.skills.length && (S.skills[j].group||"")===g){ span++; j++; }
    const th = document.createElement("th");
    th.colSpan = span; th.innerHTML = `<div class="group-title">${escapeHTML(g||' ')}</div>`;
    elGroup.appendChild(th);
    i=j;
  }

  // skills
  S.skills.forEach(col=>{
    const th = document.createElement("th"); th.textContent = col.label; elSkill.appendChild(th);
  });

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì offset ‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡πÅ‡∏ñ‡∏ß 2
  requestAnimationFrame(updateStickyHeaderOffset);
}

function buildTbody(){
  elBody.innerHTML="";
  const rows = S.names.filter(n => S.filterBranch==="ALL" || S.nameToBranch[n]===S.filterBranch);

  rows.forEach(nm=>{
    const tr = document.createElement("tr");
    if(nm===S.current) tr.classList.add("selected");

    // name (sticky 0)
    const tdName = document.createElement("td");
    tdName.className="sticky-0 name"; tdName.textContent = nm; tr.appendChild(tdName);

    // branch (sticky 1)
    const tdBr = document.createElement("td");
    tdBr.className="sticky-1 branch"; tdBr.textContent = S.nameToBranch[nm]||""; tr.appendChild(tdBr);

    // skills
    const editable = (nm===S.current);
    S.skills.forEach(col=>{
      const td = document.createElement("td"); td.className="cell";
      const baseline = (S.levelsByName[nm]?.[col.label] ?? "0");
      const current  = (editable && S.dirty.has(col.label)) ? S.dirty.get(col.label) : baseline;

      const btn = document.createElement("div");
      btn.className = "lv" + (editable ? " edit" : "");
      btn.dataset.lv = current;
      btn.textContent = symbol(current);

      if(editable){
        if(current!==baseline) btn.classList.add("dirty");
        btn.onclick = ()=>{
          const nxt = next(current);
          btn.dataset.lv = nxt; btn.textContent = symbol(nxt);
          if(nxt===baseline){ S.dirty.delete(col.label); btn.classList.remove("dirty"); }
          else{ S.dirty.set(col.label,nxt); btn.classList.add("dirty"); }
        };
      }
      td.appendChild(btn);
      tr.appendChild(td);
    });

    elBody.appendChild(tr);
  });
}

/* ============== Sticky offsets / z-index ============= */
function updateStickyHeaderOffset(){
  const h1 = document.querySelector('#rowGroup')?.offsetHeight || 44;
  document.documentElement.style.setProperty('--h1', h1 + 'px');

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå name ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô branch ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ
  const firstTh = document.querySelector('thead th.corner-0');
  const w = firstTh ? firstTh.offsetWidth : 210;
  document.documentElement.style.setProperty('--firstColW', w + 'px');
}

/* =================== Helpers / Events ================ */
function escapeHTML(s){ return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[m])); }
function symbol(lv){ return lv==='2'?'‚óè' : (lv==='1'?'‚óã':'-'); }
function next(lv){ return lv==='0'?'1' : (lv==='1'?'2':'0'); }

selPerson.addEventListener('change', ()=>{
  S.current = selPerson.value;
  S.dirty.clear();
  buildTbody();
});

selBranch.addEventListener('change', ()=>{
  S.filterBranch = selBranch.value || "ALL";
  buildTbody();
  rebuildPersonList();              // sync ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô
  if(!S.names.includes(S.current) || (S.filterBranch!=="ALL" && S.nameToBranch[S.current]!==S.filterBranch)){
    S.current = selPerson.value = (elBody.querySelector('tr .sticky-0')?.textContent || "");
  }
});

/* Reset */
$("resetBtn").onclick = ()=>{ S.dirty.clear(); buildTbody(); setStatus("‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß"); };

/* Save (‡∏ß‡∏¥‡∏ò‡∏µ B: u_skill[]/u_level[] ‡∏ú‡πà‡∏≤‡∏ô iframe) */
$("saveBtn").onclick = ()=>{
  if(!S.current){ setStatus("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠"); return; }
  if(S.dirty.size===0){ setStatus("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"); return; }
  const form=$("gasForm"), ifr=$("gasTarget");
  form.action = GAS_ENDPOINT;
  $("f_name").value = S.current;
  $("f_branch").value = S.nameToBranch[S.current]||"";

  [...form.querySelectorAll('input[name="u_skill[]"],input[name="u_level[]"]')].forEach(e=>e.remove());
  for(const [skill,lv] of S.dirty.entries()){
    const a=document.createElement('input'); a.type='hidden'; a.name='u_skill[]'; a.value=skill; form.appendChild(a);
    const b=document.createElement('input'); b.type='hidden'; b.name='u_level[]'; b.value=lv; form.appendChild(b);
  }
  const done=()=>{
    ifr.removeEventListener('load',done);
    const mp=S.levelsByName[S.current]||(S.levelsByName[S.current]={});
    for(const [k,v] of S.dirty.entries()) mp[k]=v;
    S.dirty.clear(); buildTbody(); setStatus("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  };
  ifr.addEventListener('load',done,{once:true});
  setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶"); form.submit();
};

/* Add / Delete name (‡∏°‡∏µ branch) */
$("btnAdd").onclick=()=>{
  const nm=($("newName").value||"").trim();
  const br=($("newBranch").value||"").trim();
  if(!nm || !br){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Name ‡πÅ‡∏•‡∏∞ Branch"); return; }
  const f=$("gasForm"), ifr=$("gasTarget"); f.action=GAS_ENDPOINT;
  $("f_action").value="addName"; $("f_new_name").value=nm; $("f_new_branch").value=br;
  const done = ()=>{
    ifr.removeEventListener('load',done);
    $("f_action").value=""; $("f_new_name").value=""; $("f_new_branch").value="";
    $("newName").value=""; $("newBranch").value="";
    setStatus("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); loadCSV();
  };
  ifr.addEventListener('load',done,{once:true});
  f.submit();
};
$("btnDel").onclick=()=>{
  const nm=($("newName").value||selPerson.value||"").trim();
  if(!nm){ alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö"); return; }
  if(!confirm(`‡∏•‡∏ö "${nm}" ?`)) return;
  const f=$("gasForm"), ifr=$("gasTarget"); f.action=GAS_ENDPOINT;
  $("f_action").value="deleteName"; $("f_new_name").value=nm; $("f_new_branch").value="";
  const done=()=>{
    ifr.removeEventListener('load',done);
    $("f_action").value=""; $("f_new_name").value="";
    $("newName").value=""; setStatus("‚úÖ ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); loadCSV();
  };
  ifr.addEventListener('load',done,{once:true});
  f.submit();
};

/* Boot */
window.addEventListener('resize', updateStickyHeaderOffset);
loadCSV().catch(e=>setStatus("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+(e.message||e)));
</script>
</body>
</html>
