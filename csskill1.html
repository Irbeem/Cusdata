<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Skill Matrix (0/1/2) ‚Äî YAPTCSSKILL</title>
<style>
:root{
  --nameW: 200px; --branchW: 120px; --border:#e5e7eb;
  --brand-50:#eef2ff; --brand-200:#c7d2fe; --brand-500:#4f46e5; --brand-600:#4338ca;
  --row-select-bg:#F6C8B6; --row-select-left:#6366f1; --row-hover:#f0f4ff;
  --header-grad: linear-gradient(180deg,#6366f1 0%, #4f46e5 80%, #4338ca 100%);
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans",Arial;color:#111827;background:#fff}
header{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--border)}
header .bar{padding:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center}
h1{margin:0 0 6px 0; font-size:18px; font-weight:800}
.controls select,.controls input{border:1px solid var(--border); border-radius:10px; padding:8px 12px; background:#fff}
button{border-radius:10px; padding:10px 14px; border:1px solid transparent; font-weight:700; cursor:pointer}
button.primary{background:var(--brand-500); color:#fff}
button.primary:hover{background:var(--brand-600)}
button.secondary{background:#fff; border:1px solid var(--brand-200); color:#1f2937}
.status{font-size:13px; color:#374151; padding:0 12px 10px}
.wrap{padding:12px}
.table-wrap{max-height:calc(100vh - 220px); overflow:auto; border:1px solid var(--border); border-radius:12px; background:#fff; box-shadow:0 10px 24px rgba(15,23,42,.06)}
table{border-collapse:separate;border-spacing:0;width:max-content;min-width:100%}
th,td{border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:10px 12px;background:#fff;white-space:nowrap}
th:first-child,td:first-child{border-left:1px solid var(--border)}
thead th{position:sticky;background:#fff; z-index:5; top:0}
thead tr:first-child th{top:0; color:#fff; background:var(--header-grad); border-bottom:2px solid #c7d2fe}
thead tr:nth-child(2) th{top:34px; background:#fafbff}
thead th.sticky-left-1{left:0; z-index:7; width:var(--nameW); min-width:var(--nameW); max-width:var(--nameW)}
thead th.sticky-left-2{left:var(--nameW); z-index:6; width:var(--branchW); min-width:var(--branchW); max-width:var(--branchW)}
tbody td.sticky-left-1{position:sticky; left:0; z-index:3; background:#f8fafc; font-weight:700}
tbody td.sticky-left-2{position:sticky; left:var(--nameW); z-index:2; background:linear-gradient(90deg,#f8fafc 0%, #fff 100%); box-shadow: inset -1px 0 0 var(--border)}
tbody tr:nth-child(even) td{ background:#fcfcff }
tbody tr:hover td{ background:var(--row-hover) }
tr.is-selected td{ background:var(--row-select-bg) !important; position:relative }
tr.is-selected td.sticky-left-1{ background:linear-gradient(90deg,#eaf0ff 0%, var(--row-select-bg) 100%) !important }
tr.is-selected td.sticky-left-1::before{content:""; position:absolute; inset:0 auto 0 0; width:4px; background:var(--row-select-left); border-top-left-radius:6px; border-bottom-left-radius:6px}
td.center{ text-align:center; vertical-align:middle }
.lvbtn{
  display:inline-flex; align-items:center; justify-content:center;
  width:32px; height:32px; font-size:20px; border-radius:10px; margin:0;
  border:1px solid var(--brand-200); background:#fff; color:#111827;
  box-shadow:0 1px 0 rgba(0,0,0,.04);
}
.lvbtn[data-value="0"]{ background:#f8fafc; color:#6b7280; border-color:#e5e7eb }
.lvbtn[data-value="1"]{ background:#10b98122; color:#047857; border-color:#34d399 }
.lvbtn[data-value="2"]{ background:#3b82f622; color:#1d4ed8; border-color:#93c5fd }
.lvbtn.readonly{ background:#eef2ff; color:#374151; border-color:#c7d2fe }
.lvbtn.dirty{ outline:2px solid #f59e0b; outline-offset:-3px }
.small{ font-size:12px; color:#6b7280; margin-left:12px }
.badge{font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--brand-200); background:#fff}
</style>
</head>
<body>
<header>
  <div class="bar" style="border-bottom:1px solid var(--border)">
    <h1>Skill Matrix ‚Äî ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏™‡∏Å‡∏¥‡∏• (0/1/2)</h1>
    <span id="badgeCount" class="badge">0 ‡∏Ñ‡∏ô</span>
  </div>
  <div class="bar controls">
    <label>Branch:
      <select id="branchFilter"></select>
    </label>
    <label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç):
      <select id="person"></select>
    </label>
    <button id="saveBtn" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
    <button id="resetBtn" class="secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    <span class="small">Skill: '-' = No, '‚óã' = Can do, '‚óè' = Can teach</span>
  </div>
  <div class="bar controls" style="border-top:1px solid var(--border)">
    <input id="newName" placeholder="Name (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö)" style="min-width:160px" />
    <input id="newBranch" placeholder="Branch (‡πÄ‡∏ä‡πà‡∏ô BKK, CBI)" style="min-width:140px" />
    <button id="btnAdd" class="secondary">‚ûï Add</button>
    <button id="btnDel" class="secondary">üóë Delete</button>
  </div>
  <div id="msg" class="status"></div>
</header>

<div class="wrap">
  <div class="table-wrap">
    <table id="skillTable" aria-label="Skill matrix table">
      <thead>
        <tr id="groupRow"></tr>
        <tr id="skillRow"></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
// ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å CSV ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
const CSV_URL = "https://docs.google.com/spreadsheets/d/1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k/export?format=csv&gid=0"; 
// ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô Apps Script ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (Web App URL)
const GAS_URL = "https://script.google.com/macros/s/AKfycbzPMwWO8ir9wa8kSVDn_aWn_-vyY11K8Z2msF4nY2Aj7iyRyYJctzEo3F-VlYW-w-68jQ/exec"; 
//const CSV_URL = "https://docs.google.com/spreadsheets/d/1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k/export?format=csv&gid=0"; 
//const GAS_URL = "https://script.google.com/macros/s/AKfycbzPMwWO8ir9wa8kSVDn_aWn_-vyY11K8Z2msF4nY2Aj7iyRyYJctzEo3F-VlYW-w-68jQ/exec";

/* ===== STATE ===== */
const S = {
  meta: { skills: [], nameCol:-1, branchCol:-1 },
  rows: [], // [{name, branch, levels:{label:lv}}]
  current: "",
  dirty: new Map(), // label -> newLevel
  filterBranch: "All",
};

/* ===== HELPERS ===== */
const $ = (id) => document.getElementById(id);
const elMsg = $("msg"), elGroupRow=$("groupRow"), elSkillRow=$("skillRow"), elTbody=$("tbody");
const elPerson=$("person"), elBranchFilter=$("branchFilter"), elBadge=$("badgeCount");

function setMessage(t){ elMsg.textContent = t; }
function sym(lv){ return lv==='2'?'‚óè':(lv==='1'?'‚óã':'-'); }
function next(lv){ return lv==='0'?'1':(lv==='1'?'2':'0'); }
function byThaiLocale(a,b){ return a.localeCompare(b,'th'); }

/* --- CSV parser (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏±‡∏ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®) --- */
function parseCSV(text){
  const rows=[]; let i=0, cur="", row=[], inq=false;
  while(i<text.length){
    const ch=text[i];
    if(inq){
      if(ch==='\"'){
        if(text[i+1]==='\"'){cur+='\"'; i+=2; continue;}
        inq=false; i++; continue;
      }else{ cur+=ch; i++; continue; }
    }else{
      if(ch==='\"'){inq=true; i++; continue;}
      if(ch===','){row.push(cur); cur=""; i++; continue;}
      if(ch==='\n'){row.push(cur); rows.push(row); row=[]; cur=""; i++; continue;}
      if(ch==='\r'){i++; continue;}
      cur+=ch; i++;
    }
  }
  row.push(cur); rows.push(row);
  return rows;
}
const norm = s => String(s ?? '').replace(/\s+/g,' ').trim();
const normLower = s => norm(s).toLowerCase();

function uniqueBranches(){
  const set = new Set();
  for(const r of S.rows){ if (r.branch) set.add(r.branch); }
  return ["All", ...[...set].sort(byThaiLocale)];
}
function filteredNames(){
  if (S.filterBranch==="All") return S.rows.map(r=>r.name);
  return S.rows.filter(r=>r.branch===S.filterBranch).map(r=>r.name);
}
function findRowByName(name){ return S.rows.find(r => r.name===name); }

/* ====== CSV ‚Üí Model ====== */
function csvToModel(matrix){
  // ‡∏´‡∏≤ header "name" ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 20 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å
  let hdrIdx=-1, nameCol=-1;
  for(let i=0;i<Math.min(20,matrix.length);i++){
    const idx = matrix[i].findIndex(v=>{
      const t = normLower(v);
      return ['name','‡∏ä‡∏∑‡πà‡∏≠','employee','person','emp','staff'].includes(t);
    });
    if(idx!==-1){ hdrIdx=i; nameCol=idx; break; }
  }
  if(hdrIdx<0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå name");

  const groupRowRaw = matrix[Math.max(0, hdrIdx-1)].map(norm);
  let skillRow = matrix[hdrIdx].map(norm);

  // ‡πÄ‡∏î‡∏≤ branchCol
  let branchCol = skillRow.findIndex(v=>{
    const t=normLower(v);
    return t==='branch' || t==='brance' || t==='department';
  });
  if(branchCol<0){
    const guess=nameCol+1;
    if (guess < skillRow.length) branchCol=guess;
  }

  // forward-fill group header
  const groupRow=[]; let last="";
  for(let c=0;c<groupRowRaw.length;c++){ last = groupRowRaw[c] || last; groupRow[c]=last; }

  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏Å‡∏¥‡∏•
  const skillCols=[];
  for(let c=0;c<skillRow.length;c++){
    if (c===nameCol || c===branchCol) continue;
    const label = skillRow[c]; if (!label) continue;
    skillCols.push({ idx:c, label, group: groupRow[c] || '' });
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á rows ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á header
  const rows=[];
  for(let r=hdrIdx+1; r<matrix.length; r++){
    const row = matrix[r];
    const name = norm(row[nameCol]);
    if (!name) continue;
    const branch = branchCol>=0 ? norm(row[branchCol]) : '';
    const levels = {};
    for(const sc of skillCols){
      const v = norm(row[sc.idx]);
      levels[sc.label] = (v===''||v==='0'||v==='1'||v==='2') ? (v||'') : '';
    }
    rows.push({ name, branch, levels });
  }

  return {
    meta:{ nameCol, branchCol, skills: skillCols.map(s=>({label:s.label, group:s.group})) },
    rows
  };
}

/* ===== RENDER ===== */
function buildHeader(){
  elGroupRow.innerHTML=""; elSkillRow.innerHTML="";
  const th1 = document.createElement("th"); th1.textContent="name"; th1.className="sticky-left-1"; th1.rowSpan=2; elGroupRow.appendChild(th1);
  const th2 = document.createElement("th"); th2.textContent="branch"; th2.className="sticky-left-2"; th2.rowSpan=2; elGroupRow.appendChild(th2);

  let i=0, sc=S.meta.skills;
  while(i<sc.length){
    const g=sc[i].group||""; let span=1, j=i+1;
    while(j<sc.length && (sc[j].group||"")===g){ span++; j++; }
    const th=document.createElement("th"); th.textContent=g; th.colSpan=span; elGroupRow.appendChild(th);
    i=j;
  }
  for(const col of S.meta.skills){
    const th=document.createElement("th"); th.textContent=col.label; elSkillRow.appendChild(th);
  }
}
function buildBranchFilter(){
  const items = uniqueBranches();
  elBranchFilter.innerHTML = items.map(b=>`<option value="${b}">${b}</option>`).join("");
  if (!items.includes(S.filterBranch)) S.filterBranch="All";
  elBranchFilter.value = S.filterBranch;
}
function buildPersonDropdown(){
  const names = filteredNames();
  $("badgeCount").textContent = `${names.length} ‡∏Ñ‡∏ô`;
  elPerson.innerHTML = names.map(n=>`<option value="${n}">${n}</option>`).join("");
  if (names.length){
    if(!names.includes(S.current)) S.current = names[0];
    elPerson.value = S.current;
  }else{
    S.current = "";
  }
}
function buildBody(){
  elTbody.innerHTML="";
  for(const name of filteredNames()){
    const r = findRowByName(name);
    const tr=document.createElement("tr");
    if (name===S.current) tr.classList.add("is-selected");

    const tdN=document.createElement("td"); tdN.textContent=name; tdN.className="sticky-left-1"; tr.appendChild(tdN);
    const tdB=document.createElement("td"); tdB.textContent=r.branch||""; tdB.className="sticky-left-2"; tr.appendChild(tdB);

    const editable = (name===S.current);
    for(const col of S.meta.skills){
      const label = col.label;
      const base  = (r.levels[label] ?? '') || '0';
      const cur   = (editable && S.dirty.has(label)) ? S.dirty.get(label) : base;

      const td=document.createElement("td"); td.className="center";
      const btn=document.createElement("button"); btn.type="button"; btn.className="lvbtn";
      btn.dataset.skill=label; btn.dataset.value=cur; btn.textContent=sym(cur);
      if (!editable) btn.classList.add("readonly");
      else {
        if (cur!==base) btn.classList.add("dirty");
        btn.addEventListener("click", ()=>{
          const newV=next(btn.dataset.value);
          btn.dataset.value=newV; btn.textContent=sym(newV);
          if (newV===base){ S.dirty.delete(label); btn.classList.remove("dirty"); }
          else{ S.dirty.set(label,newV); btn.classList.add("dirty"); }
        });
      }
      td.appendChild(btn); tr.appendChild(td);
    }
    elTbody.appendChild(tr);
  }
}

/* ===== LOAD (CSV only) ===== */
async function loadAll(){
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
  const r = await fetch(CSV_URL, { cache:'no-store' });
  if (!r.ok) throw new Error(`‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${r.status})`);
  const text = await r.text();
  const matrix = parseCSV(text);

  const { meta, rows } = csvToModel(matrix);
  S.meta = meta; S.rows = rows;
  if (!S.current && S.rows.length) S.current = S.rows[0].name;

  buildHeader(); buildBranchFilter(); buildPersonDropdown(); buildBody();
  setMessage("‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
}

/* ===== WRITE (Apps Script only) ===== */
async function gasPost(payload){
  const r = await fetch(GAS_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  const j = await r.json().catch(()=>({ ok:false, error:'Bad JSON response'}));
  if(!j.ok) throw new Error(j.error || 'Unknown error');
  return j;
}

/* ===== EVENTS ===== */
$("saveBtn").addEventListener("click", async ()=>{
  const name = S.current;
  if (!name){ setMessage("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); return; }
  if (S.dirty.size===0){ setMessage("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"); return; }
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");

  try{
    const updates = [...S.dirty.entries()].map(([skill, level])=>({ skill, level }));
    await gasPost({ action:'update', name, updates });
    // apply local
    const row = findRowByName(name);
    for(const {skill, level} of updates){ row.levels[skill]=level; }
    S.dirty.clear(); buildBody();
    setMessage("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    // reload ‡∏à‡∏≤‡∏Å CSV ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
    await loadAll();
  }catch(err){
    setMessage("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
  }
});

$("resetBtn").addEventListener("click", ()=>{
  S.dirty.clear(); buildBody(); setMessage("‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
});
elPerson.addEventListener("change", ()=>{ S.current = elPerson.value; S.dirty.clear(); buildBody(); });
elBranchFilter.addEventListener("change", ()=>{ S.filterBranch = elBranchFilter.value||"All"; S.dirty.clear(); buildPersonDropdown(); buildBody(); });

$("btnAdd").addEventListener("click", async ()=>{
  const nm = ($("newName").value||"").trim();
  const br = ($("newBranch").value||"").trim();
  if (!nm){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); return; }
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠...");
  try{
    await gasPost({ action:'add', name:nm, branch:br });
    $("newName").value=""; $("newBranch").value="";
    await loadAll();
    S.current = nm; if (br) S.filterBranch=br;
    buildBranchFilter(); buildPersonDropdown(); buildBody();
    setMessage("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }catch(err){
    setMessage("‚ùå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
  }
});

$("btnDel").addEventListener("click", async ()=>{
  const nm = ($("newName").value||elPerson.value||"").trim();
  if (!nm){ alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö"); return; }
  if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠ "${nm}" ?`)) return;
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠...");
  try{
    await gasPost({ action:'delete', name:nm });
    $("newName").value="";
    await loadAll();
    buildBranchFilter(); buildPersonDropdown(); buildBody();
    setMessage("‚úÖ ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }catch(err){
    setMessage("‚ùå ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
  }
});

/* BOOT */
loadAll().catch(err => setMessage("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message));
</script>
</body>
</html>
