<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Skill Matrix (0/1/2) ‚Äî YAPTCSSKILL</title>
<style>
  :root{
    --border:#e5e7eb; --muted:#6b7280; --ink:#0f172a; --bg:#fff;
    --brand-50:#eef2ff; --brand-100:#e0e7ff; --brand-200:#c7d2fe;
    --brand-400:#6366f1; --brand-500:#4f46e5; --brand-600:#4338ca;

    /* ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
    --green-50:#ecfdf5; --green-100:#d1fae5; --green-200:#a7f3d0; --green-600:#059669;
    --blue-50:#eff6ff;  --blue-100:#dbeafe;  --blue-200:#bfdbfe;  --blue-600:#2563eb;

    --rose-500:#f43f5e; --amber-500:#f59e0b;

    --header-grad:linear-gradient(180deg,#f8fafc 0%,#ffffff 100%);
    --table-top-1:#4424d6;
    --table-top-2:#5a3aec;

    --hover:#e8f0ff;         /* hover ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
    --row-selected:#eaf4ff;  /* ‡πÅ‡∏ñ‡∏ß‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
  }

  html,body{margin:0;background:var(--bg);color:var(--ink);
    font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans",Arial}
  header{position:sticky;top:0;z-index:5;background:var(--header-grad);
    border-bottom:1px solid var(--border);padding:12px 12px 10px;
    box-shadow:0 4px 14px rgba(15,23,42,.06)}
  h1{margin:0 0 10px;font-size:16px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  select,input[type=text]{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;min-width:160px}
  select:focus,input[type=text]:focus{outline:none;border-color:var(--brand-400);box-shadow:0 0 0 4px color-mix(in srgb,var(--brand-400) 20%,transparent)}
  button{border-radius:10px;border:1px solid transparent;padding:10px 14px;font-weight:700;cursor:pointer}
  .primary{background:var(--brand-500);color:#fff;border-color:var(--brand-500);box-shadow:0 6px 14px rgba(79,70,229,.25)}
  .primary:hover{background:var(--brand-600)}
  .secondary{background:#fff;color:var(--brand-600);border-color:var(--brand-200)}
  .secondary:hover{background:var(--brand-50);border-color:var(--brand-400)}
  .small{font-size:12px;color:var(--muted)}
  .status{margin-top:6px;font-size:13px;color:#374151}
  .wrap{padding:12px}

  .table-wrap{border:1px solid var(--border);border-radius:14px;overflow:auto;
    max-height:calc(100vh - 210px);box-shadow:0 12px 24px rgba(15,23,42,.05);background:#fff}
  table{border-collapse:separate;border-spacing:0;min-width:100%;width:max-content}
  th,td{
    border-right:1px solid var(--border);border-bottom:1px solid var(--border);
    background:#fff;padding:10px 12px;white-space:nowrap;vertical-align:middle
  }
  th:first-child,td:first-child{border-left:1px solid var(--border)}

  /* Sticky header 2 ‡πÅ‡∏ñ‡∏ß */
  thead th{position:sticky;background:#fff;z-index:2}
  thead tr:first-child th{top:0;z-index:40}
  thead tr:nth-child(2) th{top:var(--h1,38px);z-index:39}

  /* ‡∏™‡∏µ‡∏´‡∏±‡∏ß‡∏Å‡∏•‡∏∏‡πà‡∏° */
  #groupRow th{
    background:linear-gradient(180deg,var(--table-top-1) 0%, var(--table-top-2) 100%);
    color:#fff;border-bottom:2px solid color-mix(in srgb, var(--table-top-2) 70%, #000);
    letter-spacing:.2px
  }
  #skillRow th{
    background:#fff;font-weight:800;color:var(--ink);
    border-bottom:2px solid var(--brand-100)
  }

  /* Sticky name + branch */
  tbody td:first-child{position:sticky;left:0;background:linear-gradient(90deg,#f8fafc 0%,#ffffff 100%);z-index:20;font-weight:800}
  thead th:first-child{position:sticky;left:0;z-index:41;background:linear-gradient(90deg,#4c40dd 0%,#573cf7 100%);color:#fff}
  thead th:nth-child(2){position:sticky;left:var(--namew,170px);z-index:41;background:linear-gradient(90deg,#4c40dd 0%,#573cf7 100%);color:#fff}
  tbody td:nth-child(2){position:sticky;left:var(--namew,170px);z-index:20;background:linear-gradient(90deg,#f8fafc 0%,#ffffff 100%);font-weight:700}

  /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≤‡∏¢ */
  th:first-child, td:first-child {min-width: 170px}
  thead th:nth-child(2), tbody td:nth-child(2){min-width: 90px}

  /* hover & selected row */
  tbody tr:hover td{background:var(--hover)}
  tr.is-selected td{background:var(--row-selected) !important}

  /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ ‚Äú‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏™‡∏Å‡∏¥‡∏•‚Äù ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á/‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
  td.center{
    display:grid;             /* ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡∏Å‡∏£‡∏¥‡∏î 1 ‡∏ä‡πà‡∏≠‡∏á = ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô */
    place-items:center;       /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏Å‡∏ô X/Y */
    text-align:center;
  }
  td.center .lvbtn{margin:0}  /* ‡∏Å‡∏±‡∏ô‡πÄ‡∏ú‡∏∑‡πà‡∏≠ */

  /* ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏Å‡∏¥‡∏• */
  .lvbtn{
    display:inline-grid;place-items:center;
    width:36px;height:36px;border:1px solid var(--brand-200);
    border-radius:12px;background:#fff;font-size:22px;line-height:1;user-select:none
  }
  .lvbtn.readonly{opacity:.75;filter:saturate(0.85)}
  .lvbtn.dirty{outline:2px solid var(--amber-500);outline-offset:-2px}

  /* ‡∏™‡∏µ ‚Äú‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‚Äù ‡∏ß‡∏á‡∏Å‡∏•‡∏° + ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö 2 ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏∂‡∏ö */
  .lv-0{color:#9aa0a6}
  .lv-1{color:var(--green-600)}
  .lv-2{color:#fff;background:var(--blue-600);border-color:var(--blue-600)}

  /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö ‚Üí ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ */
  td.lvbg-1{background:var(--green-200)} /* ‡πÄ‡∏î‡∏¥‡∏° 50 -> 200 */
  td.lvbg-2{background:var(--blue-200)}  /* ‡πÄ‡∏î‡∏¥‡∏° 50 -> 200 */

  .group-cap{box-shadow: inset 0 -2px 0 color-mix(in srgb, var(--table-top-2) 65%, #000)}
  iframe{display:none}
</style>
</head>
<body>
  <header>
    <h1>Skill Matrix ‚Äî ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏™‡∏Å‡∏¥‡∏• (0/1/2)</h1>
    <div class="toolbar" style="gap:10px 12px">
      <label>Branch:
        <select id="branchFilter"></select>
      </label>
      <label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç):
        <select id="person"></select>
      </label>
      <button id="saveBtn" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
      <button id="resetBtn" class="secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <span class="small">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
    </div>
    <div class="toolbar" style="margin-top:8px">
      <input id="newName" placeholder="Name (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö)" />
      <input id="newBranch" placeholder="Branch (‡πÄ‡∏ä‡πà‡∏ô BKK, CBI)" />
      <button id="btnAdd" class="secondary">‚ûï Add</button>
      <button id="btnDel" class="secondary" style="color:var(--rose-500);border-color:color-mix(in srgb,var(--rose-500) 35%,#fff)">üóë Delete</button>
    </div>
    <div id="msg" class="status"></div>
  </header>

  <div class="wrap">
    <div class="table-wrap">
      <table id="skillTable" aria-label="Skill matrix table">
        <thead>
          <tr id="groupRow" class="group-cap"></tr>
          <tr id="skillRow"></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <iframe id="gasTarget" name="gasTarget"></iframe>
  <form id="gasForm" method="POST" target="gasTarget" action="">
    <input type="hidden" name="name" id="f_name"/>
    <input type="hidden" name="action" id="f_action"/>
    <input type="hidden" name="new_name" id="f_new_name"/>
    <input type="hidden" name="new_branch" id="f_new_branch"/>
  </form>

<script>
/* ================= CONFIG ================= */
const CSV_URL = "https://docs.google.com/spreadsheets/d/1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k/export?format=csv&gid=0";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzPMwWO8ir9wa8kSVDn_aWn_-vyY11K8Z2msF4nY2Aj7iyRyYJctzEo3F-VlYW-w-68jQ/exec";
/* ========================================== */

const $ = (id)=>document.getElementById(id);
const elBranchFilter = $("branchFilter");
const elPerson = $("person");
const elGroupRow = $("groupRow");
const elSkillRow = $("skillRow");
const elTbody = $("tbody");
const elMsg = $("msg");

function setMsg(t){ elMsg.textContent = t; }
const toStr = v => String(v ?? "").replace(/\s+/g," ").trim();

let state = {
  nameCol:0, branchCol:1,
  names:[], branches:[],
  groups:[], skills:[],
  levels:{}, mapBranchOf:{},
  dirty:new Map(),
  current:"",
  allRows:[],
  uniqueBranches:new Set(),
  activeBranch:"__ALL__"
};

/* -------- CSV parser -------- */
function parseCSV(text){
  const rows=[]; let i=0, cur="", row=[], inq=false;
  while(i<text.length){
    const ch=text[i];
    if(inq){
      if(ch === '"'){
        if(text[i+1] === '"'){ cur+='"'; i+=2; continue; }
        inq=false; i++; continue;
      }else{ cur+=ch; i++; continue; }
    }else{
      if(ch === '"'){ inq=true; i++; continue; }
      if(ch === ','){ row.push(cur); cur=""; i++; continue; }
      if(ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=""; i++; continue; }
      if(ch === '\r'){ i++; continue; }
      cur+=ch; i++;
    }
  }
  row.push(cur); rows.push(row);
  return rows;
}

/* -------- Load + detect headers robustly -------- */
async function loadCSV(){
  setMsg("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet...");
  const r = await fetch(CSV_URL, {cache:"no-store"});
  if(!r.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î CSV ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  const matrix = parseCSV(await r.text());

  // 1) ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ 'name'
  let headerIdx=-1, nameCol=-1;
  for(let i=0;i<Math.min(15,matrix.length);i++){
    const idx = matrix[i].findIndex(v => toStr(v).toLowerCase() === 'name');
    if(idx !== -1){ headerIdx=i; nameCol=idx; break; }
  }
  if(headerIdx<0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå name");

  // 2) ‡∏´‡∏≤ branch col
  let branchCol = matrix[headerIdx].findIndex(v => toStr(v).toLowerCase() === 'brance');
  if(branchCol === -1) branchCol = matrix[headerIdx].findIndex(v => toStr(v).toLowerCase() === 'branch');
  if(branchCol === -1) branchCol = nameCol+1;

  // 3) group row
  const groupRowRaw = matrix[Math.max(0, headerIdx-1)].map(toStr);

  // 4) ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß name ‡∏¢‡∏±‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏±‡∏ß‡∏Å‡∏•‡∏∏‡πà‡∏° ‚Üí ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á 1
  let skillRow = matrix[headerIdx].map(toStr);
  const startForCheck = Math.max(nameCol, branchCol) + 1;
  let nonEmpty=0, sameAsGroup=0;
  for(let c=startForCheck;c<skillRow.length;c++){
    const sv = toStr(skillRow[c]), gv = toStr(groupRowRaw[c]);
    if(sv){ nonEmpty++; if(sv===gv) sameAsGroup++; }
  }
  const looksLikeGroup = (nonEmpty>0) && (sameAsGroup/nonEmpty >= 0.6);
  if(looksLikeGroup && matrix[headerIdx+1]){
    headerIdx += 1;
    skillRow = matrix[headerIdx].map(toStr);
  }

  // 5) forward fill group
  const groupRow = [];
  let last="";
  const len = Math.max(groupRowRaw.length, skillRow.length);
  for(let c=0;c<len;c++){
    const g = toStr(groupRowRaw[c]);
    if(g) last=g;
    groupRow[c]=last;
  }

  // 6) skills
  const skillCols=[];
  for(let c=0;c<skillRow.length;c++){
    if(c===nameCol || c===branchCol) continue;
    const s = toStr(skillRow[c]);
    if(!s) continue;
    skillCols.push({idx:c,label:s,group:groupRow[c]||""});
  }

  // 7) data
  const dataRows = matrix.slice(headerIdx+1);
  const names=[], branches=[], levels={}, mapBranch={}, uniq=new Set();

  for(const row of dataRows){
    const nm = toStr(row[nameCol]);
    const br = toStr(row[branchCol]);
    if(!nm) continue;
    names.push(nm); branches.push(br);
    uniq.add(br||"");
    mapBranch[nm]=br||"";
    const mp={};
    for(const col of skillCols){
      const v = toStr(row[col.idx]);
      mp[col.label] = (v==='0'||v==='1'||v==='2') ? v : '';
    }
    levels[nm]=mp;
  }

  // 8) state
  state.nameCol=nameCol; state.branchCol=branchCol;
  state.groups=groupRow; state.skills=skillCols;
  state.allRows=dataRows; state.names=names; state.branches=branches;
  state.levels=levels; state.mapBranchOf=mapBranch; state.uniqueBranches=uniq;
  if(!state.current || !names.includes(state.current)) state.current = names[0] || "";
  state.dirty.clear();

  fillBranchFilter();
  fillPersonOptions();
  buildThead();
  buildTbody();
  updateStickyOffsets();
  setMsg("‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
}

/* -------- UI fill -------- */
function fillBranchFilter(){
  const opts = ['<option value="__ALL__">All branches</option>'];
  [...state.uniqueBranches].filter(Boolean).sort().forEach(b=>{
    opts.push(`<option value="${b}">${b}</option>`);
  });
  elBranchFilter.innerHTML = opts.join('');
  elBranchFilter.value = state.activeBranch;
}
function fillPersonOptions(){
  const persons = state.names.filter((nm,i)=>{
    if(state.activeBranch==='__ALL__') return true;
    return (state.branches[i]||"") === state.activeBranch;
  });
  elPerson.innerHTML = persons.map(n=>`<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');
  if(!persons.includes(state.current)) state.current = persons[0] || "";
  elPerson.value = state.current || "";
}
const escapeHtml = s => s.replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));

/* -------- THEAD -------- */
function buildThead(){
  elGroupRow.innerHTML = "";
  elSkillRow.innerHTML = "";

  const thName = document.createElement("th");
  thName.textContent = "name";
  thName.rowSpan = 2;
  elGroupRow.appendChild(thName);

  const thBr = document.createElement("th");
  thBr.textContent = "branch";
  thBr.rowSpan = 2;
  elGroupRow.appendChild(thBr);

  let i=0; const skills=state.skills;
  while(i<skills.length){
    const g = skills[i].group || "";
    let span=1; let j=i+1;
    while(j<skills.length && (skills[j].group||"")===g){ span++; j++; }
    const th = document.createElement("th");
    th.textContent = g;
    th.colSpan = span;
    elGroupRow.appendChild(th);
    i=j;
  }

  for(const col of state.skills){
    const th = document.createElement("th");
    th.textContent = col.label;
    elSkillRow.appendChild(th);
  }
}

/* -------- TBODY -------- */
function buildTbody(){
  elTbody.innerHTML = "";
  const rows = state.names.map((nm,idx)=>({name:nm,branch:state.branches[idx]}))
    .filter(r => state.activeBranch==='__ALL__' ? true : (r.branch||"")===state.activeBranch);

  for(const r of rows){
    const tr = document.createElement("tr");
    if(r.name === state.current) tr.classList.add("is-selected");

    const tdN = document.createElement("td"); tdN.textContent = r.name; tr.appendChild(tdN);
    const tdB = document.createElement("td"); tdB.textContent = r.branch || ""; tr.appendChild(tdB);

    const editable = (r.name === state.current);
    const baselineMap = state.levels[r.name] || {};

    for(const col of state.skills){
      const skill = col.label;
      const base = (baselineMap[skill] ?? '') || '0';
      const cur = (editable && state.dirty.has(skill)) ? state.dirty.get(skill) : base;

      const td = document.createElement("td");
      td.className = "center";
      if(cur==='1') td.classList.add('lvbg-1');
      if(cur==='2') td.classList.add('lvbg-2');

      const btn = document.createElement("button");
      btn.type="button"; btn.className = "lvbtn";
      btn.dataset.skill = skill; btn.dataset.value = cur;
      setButtonFace(btn, cur);

      if(!editable){
        btn.classList.add("readonly");
      }else{
        if(cur !== base) btn.classList.add("dirty");
        btn.addEventListener("click", ()=>{
          const oldV = btn.dataset.value;
          const newV = nextLevel(oldV);
          btn.dataset.value = newV;
          setButtonFace(btn, newV);

          td.classList.remove('lvbg-1','lvbg-2');
          if(newV==='1') td.classList.add('lvbg-1');
          if(newV==='2') td.classList.add('lvbg-2');

          if(newV === base){ state.dirty.delete(skill); btn.classList.remove("dirty"); }
          else{ state.dirty.set(skill, newV); btn.classList.add("dirty"); }
        });
      }

      td.appendChild(btn);
      tr.appendChild(td);
    }
    elTbody.appendChild(tr);
  }
}

function setButtonFace(btn, lv){
  btn.classList.remove('lv-0','lv-1','lv-2');
  if(lv==='2'){ btn.textContent='‚óè'; btn.classList.add('lv-2'); }
  else if(lv==='1'){ btn.textContent='‚óã'; btn.classList.add('lv-1'); }
  else { btn.textContent='-'; btn.classList.add('lv-0'); }
}
const nextLevel = lv => (lv==='0'?'1':(lv==='1'?'2':'0'));

/* -------- Events -------- */
elPerson.addEventListener("change", ()=>{
  state.current = elPerson.value;
  state.dirty.clear();
  buildTbody();
});
$("resetBtn").addEventListener("click", ()=>{
  state.dirty.clear();
  buildTbody();
  setMsg("‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
});
elBranchFilter.addEventListener("change", ()=>{
  state.activeBranch = elBranchFilter.value;
  fillPersonOptions();
  state.dirty.clear();
  buildTbody();
});

/* -------- Save via iframe -------- */
$("saveBtn").addEventListener("click", ()=>{
  const selectedName = state.current;
  if(!selectedName){ setMsg("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"); return; }
  if(state.dirty.size===0){ setMsg("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"); return; }

  const form = $("gasForm"); const iframe = $("gasTarget");
  form.action = GAS_ENDPOINT; $("f_name").value = selectedName;

  [...form.querySelectorAll('input[name="u_skill[]"],input[name="u_level[]"]')].forEach(el=>el.remove());
  for(const [skill, level] of state.dirty.entries()){
    const a=document.createElement('input'); a.type='hidden'; a.name='u_skill[]'; a.value=skill; form.appendChild(a);
    const b=document.createElement('input'); b.type='hidden'; b.name='u_level[]'; b.value=level; form.appendChild(b);
  }

  const onLoad = ()=>{
    const mp = state.levels[selectedName] ||= {};
    for(const [s,l] of state.dirty.entries()) mp[s]=l;
    state.dirty.clear(); buildTbody(); setMsg("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    iframe.removeEventListener('load', onLoad);
  };
  iframe.addEventListener('load', onLoad, {once:true});
  setMsg("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."); form.submit();
});

/* -------- Add/Delete -------- */
$("btnAdd").addEventListener("click", ()=>{
  const nm = toStr($("newName").value);
  const br = toStr($("newBranch").value);
  if(!nm){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); return; }
  if(!br){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Branch"); return; }

  const form=$("gasForm"), iframe=$("gasTarget");
  form.action = GAS_ENDPOINT; $("f_action").value="addName"; $("f_new_name").value=nm; $("f_new_branch").value=br;

  const cleanup=()=>{ $("f_action").value=""; $("f_new_name").value=""; $("f_new_branch").value=""; $("newName").value=""; $("newBranch").value=""; };

  iframe.onload=()=>{
    iframe.onload=null; cleanup(); setMsg(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${nm} (${br})`);
    loadCSV().then(()=>{
      state.activeBranch="__ALL__"; elBranchFilter.value="__ALL__";
      fillPersonOptions(); if([...elPerson.options].some(o=>o.value===nm)){ state.current=nm; elPerson.value=nm; }
      buildTbody();
    });
  };
  setMsg("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠..."); form.submit();
});

$("btnDel").addEventListener("click", ()=>{
  const target = toStr($("newName").value) || state.current || "";
  if(!target){ alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö"); return; }
  if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö "${target}" ?`)) return;

  const form=$("gasForm"), iframe=$("gasTarget");
  form.action = GAS_ENDPOINT; $("f_action").value="deleteName"; $("f_new_name").value=target; $("f_new_branch").value="";

  const cleanup=()=>{ $("f_action").value=""; $("f_new_name").value=""; $("newName").value=""; };

  iframe.onload=()=>{
    iframe.onload=null; cleanup(); setMsg(`‚úÖ ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${target}`);
    loadCSV().then(()=>{ fillPersonOptions(); buildTbody(); });
  };
  setMsg("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠..."); form.submit();
});

/* -------- Sticky offsets -------- */
function updateStickyOffsets(){
  const r1h = elGroupRow?.offsetHeight || 38;
  document.documentElement.style.setProperty('--h1', r1h + 'px');
  const thName = elGroupRow?.querySelector('th:first-child');
  const nameW = thName ? thName.offsetWidth : 170;
  document.documentElement.style.setProperty('--namew', nameW + 'px');
}
window.addEventListener('resize', updateStickyOffsets);

/* -------- Boot -------- */
loadCSV().catch(err=>setMsg("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (err.message||err)));
</script>
</body>
</html>
