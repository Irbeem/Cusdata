<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Skill Matrix (0/1/2) ‚Äî YAPTCSSKILL</title>
<style>
  :root{
    --border:#e5e7eb;
    --sticky:#f9fafb;
    --brand-200:#c7d2fe;
    --brand-400:#6366f1;
    --brand-500:#4f46e5;
    --amber-500:#f59e0b;
    --nameW: 200px; /* JS will update */
    --h1: 34px;     /* height of first header row (JS updates) */

    --row-select-bg:#fff7d6;
    --row-hover-bg:#f6f9ff;
  }

  html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans",Arial;color:#111827;background:#fff}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#f9fafb 0%,#fff 100%);border-bottom:1px solid var(--border);padding:12px 12px 8px}
  h1{font-size:16px;margin:0 0 8px}

  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .controls select,.controls input{border:1px solid var(--border);border-radius:10px;padding:8px 12px}
  .controls input{min-width:160px}
  button{border-radius:10px;padding:10px 14px;border:1px solid transparent;font-weight:600;cursor:pointer}
  .primary{background:var(--brand-500);border-color:var(--brand-500);color:#fff}
  .secondary{background:#fff;color:#4f46e5;border:1px solid var(--brand-200)}
  .danger{background:#fff;color:#b91c1c;border:1px solid #fecaca}
  .status{font-size:13px;color:#374151;margin-top:6px}

  .wrap{padding:12px}
  .table-wrap{max-height:calc(100vh - 220px);overflow:auto;border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 22px rgba(15,23,42,.06);background:#fff}

  table{border-collapse:separate;border-spacing:0;width:max-content;min-width:100%}
  th,td{border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:10px 12px;background:#fff;white-space:nowrap;vertical-align:middle}
  th:first-child,td:first-child{border-left:1px solid var(--border)}
  thead th{position:sticky;background:#fff}
  thead tr:first-child th{top:0;z-index:40}
  thead tr:nth-child(2) th{top:var(--h1);z-index:39}

  /* sticky left two columns */
  .sticky-1{position:sticky;left:0;background:linear-gradient(90deg,#f8fafc 0%,#fff 100%);z-index:41;font-weight:700}
  .sticky-2{position:sticky;left:var(--nameW);background:linear-gradient(90deg,#f8fafc 0%,#fff 100%);z-index:40;font-weight:700}

  /* group header aesthetics */
  #groupRow th{background:linear-gradient(180deg,#eef2ff 0%,#fff 90%);border-bottom:2px solid var(--brand-200);font-weight:700}
  #skillRow th{font-weight:700}

  /* hover/selected row */
  tbody tr:hover td{background:var(--row-hover-bg)}
  tr.selected-row td{background:var(--row-select-bg) !important}
  tr.selected-row td.sticky-1, tr.selected-row td.sticky-2{background:var(--row-select-bg) !important}

  /* level buttons */
  .center{text-align:center}
  .lvbtn{
    display:inline-flex;align-items:center;justify-content:center;
    width:34px;height:34px;font-size:20px;border:1px solid var(--brand-200);
    border-radius:10px;background:#fff;color:#1f2937;user-select:none;
    transition:box-shadow .15s ease;
  }
  .lvbtn:hover{box-shadow:0 0 0 4px color-mix(in srgb,var(--brand-400) 18%,transparent)}
  .lvbtn.readonly{background:#f3f4f6;color:#6b7280;border-color:#e5e7eb}
  .lvbtn.dirty{border-color:var(--amber-500);box-shadow:0 0 0 4px color-mix(in srgb,var(--amber-500) 25%,transparent)}

  iframe{display:none}
</style>
</head>
<body>

<header>
  <h1>Skill Matrix ‚Äî ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏™‡∏Å‡∏¥‡∏• (0/1/2)</h1>

  <div class="controls">
    <label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:
      <select id="person"></select>
    </label>
    <button id="saveBtn" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
    <button id="resetBtn" class="secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>

  <div class="controls" style="margin-top:6px">
    <input id="newName"   placeholder="Name (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö)" />
    <input id="newBranch" placeholder="Branch (‡πÄ‡∏ä‡πà‡∏ô BKK, CBI)" />
    <button id="btnAdd" class="secondary">‚ûï Add</button>
    <button id="btnDel" class="danger">üóë Delete</button>
  </div>

  <div class="status" id="msg"></div>
</header>

<div class="wrap">
  <div class="table-wrap">
    <table id="skillTable" aria-label="Skill matrix">
      <thead>
        <tr id="groupRow"></tr>
        <tr id="skillRow"></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- form ‡∏™‡πà‡∏á Apps Script -->
<iframe id="gasTarget" name="gasTarget"></iframe>
<form id="gasForm" method="POST" target="gasTarget" action="">
  <input type="hidden" name="name" id="f_name">
  <input type="hidden" name="action" id="f_action">
  <input type="hidden" name="new_name" id="f_new_name">
  <input type="hidden" name="new_branch" id="f_new_branch">
  <!-- u_skill[] / u_level[] ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≠‡∏ô‡∏Å‡∏î Save -->
</form>

<script>
/* =================== CONFIG =================== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k/export?format=csv&gid=0";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzPMwWO8ir9wa8kSVDn_aWn_-vyY11K8Z2msF4nY2Aj7iyRyYJctzEo3F-VlYW-w-68jQ/exec";
/* ============================================== */

const $ = (id) => document.getElementById(id);
const elPerson   = $("person");
const elMsg      = $("msg");
const elGroupRow = $("groupRow");
const elSkillRow = $("skillRow");
const elTbody    = $("tbody");

const elNewName   = $("newName");
const elNewBranch = $("newBranch");
const elBtnAdd    = $("btnAdd");
const elBtnDel    = $("btnDel");

let state = {
  nameCol: 0,
  branchCol: -1,
  names: [],
  branches: {},        // { name: 'BKK' }
  skills: [],          // [{idx,label,group}]
  levels: {},          // { name: { skillLabel: "0"|"1"|"2"|"" } }
  current: "",
  dirty: new Map()
};

function setMessage(t){ elMsg.textContent = t || ""; }
function norm(x){ return String(x ?? '').replace(/\u00A0/g,' ').trim(); }
function normLower(x){ return norm(x).toLowerCase(); }

/* -------- CSV Parser (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î) ---------- */
function parseCSV(text){
  const rows=[]; let i=0,cur="",row=[],inq=false;
  while(i<text.length){
    const ch=text[i];
    if(inq){
      if(ch==='"'){ if(text[i+1]==='"'){cur+='"'; i+=2;} else {inq=false; i++;} }
      else {cur+=ch; i++;}
    }else{
      if(ch==='"'){inq=true; i++; continue;}
      if(ch===','){row.push(cur);cur="";i++;continue;}
      if(ch==='\n'){row.push(cur);rows.push(row);row=[];cur="";i++;continue;}
      if(ch==='\r'){i++;continue;}
      cur+=ch;i++;
    }
  }
  row.push(cur); rows.push(row);
  return rows;
}

/* =================== LOAD CSV =================== */
async function loadCSV(){
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
  const r = await fetch(CSV_URL, {cache:"no-store"});
  if(!r.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î CSV ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  const text = await r.text();
  const matrix = parseCSV(text);

  // 1) ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏™‡∏Å‡∏¥‡∏• (‡∏°‡∏µ "name")
  let skillHeaderRowIdx = -1, nameCol = -1;
  for(let i=0;i<Math.min(15,matrix.length);i++){
    const row = matrix[i].map(normLower);
    const idx = row.findIndex(v => v === 'name');
    if(idx !== -1){ skillHeaderRowIdx = i; nameCol = idx; break; }
  }
  if(skillHeaderRowIdx<0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "name"');

  // 2) ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏Å‡∏•‡∏∏‡πà‡∏°
  const groupHeaderRowIdx = Math.max(0, skillHeaderRowIdx-1);
  const groupRowRaw = matrix[groupHeaderRowIdx].map(norm);

  // 3) ‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏™‡∏Å‡∏¥‡∏•‡∏à‡∏£‡∏¥‡∏á
  let skillRow = matrix[skillHeaderRowIdx].map(norm);
  const sLower = skillRow.map(x => x.toLowerCase());
  const gLower = groupRowRaw.map(x => x.toLowerCase());
  const looksLikeGroup = sLower.some((v,i)=>i!==nameCol && v) &&
                         sLower.every((v,i)=>i===nameCol || v=== (gLower[i]||""));
  if(looksLikeGroup && matrix[skillHeaderRowIdx+1]){
    skillHeaderRowIdx += 1;
    skillRow = matrix[skillHeaderRowIdx].map(norm);
  }

  // 4) ‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå branch ‡πÅ‡∏ö‡∏ö‡∏ó‡∏ô‡∏ó‡∏≤‡∏ô
  const hdrSkill = matrix[skillHeaderRowIdx].map(normLower);
  const hdrGroup = matrix[groupHeaderRowIdx].map(normLower);
  let branchCol = -1;
  for(let c=0;c<Math.max(hdrSkill.length,hdrGroup.length);c++){
    const v1 = hdrSkill[c] || '', v2 = hdrGroup[c] || '';
    if(v1==='brance' || v1==='branch' || v2==='brance' || v2==='branch'){ branchCol=c; break; }
  }
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏•‡∏≠‡∏á‡πÄ‡∏î‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á: ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ñ‡∏±‡∏î‡∏à‡∏≤‡∏Å name
  if(branchCol===-1){
    const guessCol = nameCol+1;
    const sample = matrix.slice(skillHeaderRowIdx+1, skillHeaderRowIdx+1+12)
                         .map(r => normLower(r[guessCol]));
    const score = sample.filter(v => v && v.length<=5).length; // BKK/CBI/xxx
    if(score>=3) branchCol = guessCol;
  }

  // forward-fill group row
  const groupRow = [];
  let lastGroup="";
  for(let c=0;c<groupRowRaw.length;c++){
    const g = norm(groupRowRaw[c]);
    if(g) lastGroup = g;
    groupRow[c]=lastGroup;
  }

  // 5) ‡∏£‡∏ß‡∏° skill columns
  const skillCols=[];
  for(let c=0;c<skillRow.length;c++){
    if(c===nameCol) continue;
    if(c===branchCol) continue;
    const s=norm(skillRow[c]);
    if(!s) continue;
    skillCols.push({idx:c,label:s,group:groupRow[c]||""});
  }

  // 6) data rows
  const dataRows = matrix.slice(skillHeaderRowIdx+1);

  // names, branches, levels
  const names=[]; const branches={}; const levels={};
  for(const r2 of dataRows){
    const nm = norm(r2[nameCol]);
    if(!nm) continue;
    names.push(nm);
    if(branchCol>=0) branches[nm]= norm(r2[branchCol]);

    const mp={};
    for(const col of skillCols){
      const raw = r2[col.idx];
      const v = raw==null? '' : String(raw).trim();
      mp[col.label] = (v==='0'||v==='1'||v==='2') ? v : (v===''? '' : '0'); // fallback
    }
    levels[nm]=mp;
  }

  // update state
  state.nameCol = nameCol;
  state.branchCol = branchCol;
  state.names = names;
  state.branches = branches;
  state.skills = skillCols;
  state.levels = levels;
  state.current = names[0] || "";
  state.dirty.clear();

  buildThead();
  buildTbody();

  // dropdown ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
  elPerson.innerHTML = names.map(n=>`<option value="${n.replace(/&/g,"&amp;").replace(/</g,"&lt;")}">${n}</option>`).join("");
  elPerson.value = state.current;

  requestAnimationFrame(updateStickyHeaderOffset);
  requestAnimationFrame(updateStickyLefts);
  setMessage("‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
}

/* =============== Build THEAD ================== */
function buildThead(){
  elGroupRow.innerHTML="";
  elSkillRow.innerHTML="";

  // name (rowspan 2)
  const thName=document.createElement("th");
  thName.textContent="name";
  thName.rowSpan=2;
  thName.className="sticky-1";
  elGroupRow.appendChild(thName);

  // branch (rowspan 2) ‡∏´‡∏≤‡∏Å‡∏°‡∏µ
  if(state.branchCol>=0){
    const thBr=document.createElement("th");
    thBr.textContent="branch";
    thBr.rowSpan=2;
    thBr.className="sticky-2";
    elGroupRow.appendChild(thBr);
  }

  // groups with colspan
  let i=0;
  while(i<state.skills.length){
    const g=state.skills[i].group||"";
    let span=1, j=i+1;
    while(j<state.skills.length && (state.skills[j].group||"")===g){ span++; j++; }
    const th=document.createElement("th");
    th.textContent=g;
    th.colSpan=span;
    elGroupRow.appendChild(th);
    i=j;
  }

  // skill names row
  for(const col of state.skills){
    const th=document.createElement("th");
    th.textContent=col.label;
    elSkillRow.appendChild(th);
  }
}

/* =============== Build TBODY ================== */
function buildTbody(){
  elTbody.innerHTML="";

  for(const name of state.names){
    const tr=document.createElement("tr");
    if(name===state.current) tr.classList.add("selected-row");

    // name cell
    const tdName=document.createElement("td");
    tdName.className="sticky-1";
    tdName.textContent=name;
    tr.appendChild(tdName);

    // branch cell (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    if(state.branchCol>=0){
      const tdBr=document.createElement("td");
      tdBr.className="sticky-2";
      tdBr.textContent=state.branches[name]||"";
      tr.appendChild(tdBr);
    }

    const editable=(name===state.current);

    // skills
    for(const col of state.skills){
      const skill=col.label;
      const baseline=(state.levels[name]?.[skill] ?? '0') || '0';
      const current= (editable && state.dirty.has(skill)) ? state.dirty.get(skill) : baseline;

      const td=document.createElement("td");
      td.className="center";

      const btn=document.createElement("button");
      btn.type="button";
      btn.className="lvbtn";
      btn.textContent=symbolForLevel(current);
      btn.dataset.skill=skill;
      btn.dataset.value=current;

      if(!editable){
        btn.classList.add("readonly");
      }else{
        if(current!==baseline) btn.classList.add("dirty");
        btn.addEventListener("click", ()=>{
          const oldVal=btn.dataset.value;
          const newVal=nextLevel(oldVal);
          btn.dataset.value=newVal;
          btn.textContent=symbolForLevel(newVal);

          if(newVal===baseline){
            state.dirty.delete(skill);
            btn.classList.remove("dirty");
          }else{
            state.dirty.set(skill,newVal);
            btn.classList.add("dirty");
          }
        });
      }

      td.appendChild(btn);
      tr.appendChild(td);
    }

    elTbody.appendChild(tr);
  }
}

/* ========= Sticky helpers ========= */
function updateStickyHeaderOffset(){
  const r1=document.querySelector('#groupRow');
  const h=(r1 && r1.offsetHeight) ? r1.offsetHeight : 34;
  document.documentElement.style.setProperty('--h1', h+'px');
}
function updateStickyLefts(){
  const thName=document.querySelector('thead th.sticky-1');
  const w = thName ? (thName.getBoundingClientRect().width || thName.offsetWidth || 200) : 200;
  document.documentElement.style.setProperty('--nameW', w+'px');
}
window.addEventListener('resize', ()=>{
  updateStickyHeaderOffset();
  updateStickyLefts();
});

/* =============== Events =============== */
elPerson.addEventListener("change", ()=>{
  state.current = elPerson.value;
  state.dirty.clear();
  buildTbody();
  requestAnimationFrame(updateStickyLefts);
});

$("resetBtn").addEventListener("click", ()=>{
  state.dirty.clear();
  buildTbody();
  setMessage("‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
});

/* ====== Save via iframe (u_skill[] / u_level[]) ====== */
$("saveBtn").addEventListener("click", ()=>{
  const selectedName = state.current;
  if(!selectedName){ setMessage("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); return; }
  if(state.dirty.size===0){ setMessage("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"); return; }

  const form=$("gasForm");
  const iframe=$("gasTarget");
  form.action = GAS_ENDPOINT;

  $("f_name").value = selectedName;

  // ‡∏•‡∏ö input ‡πÄ‡∏î‡∏¥‡∏°
  [...form.querySelectorAll('input[name="u_skill[]"],input[name="u_level[]"]')]
    .forEach(el=>el.remove());

  // ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ
  for(const [skill,level] of state.dirty.entries()){
    const a=document.createElement('input'); a.type='hidden'; a.name='u_skill[]'; a.value=skill; form.appendChild(a);
    const b=document.createElement('input'); b.type='hidden'; b.name='u_level[]'; b.value=level; form.appendChild(b);
  }

  const onLoad=()=>{
    const mp = state.levels[selectedName] || (state.levels[selectedName]={});
    for(const [skill,level] of state.dirty.entries()) mp[skill]=level;
    state.dirty.clear();
    buildTbody();
    setMessage("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    iframe.removeEventListener('load', onLoad);
  };
  iframe.addEventListener('load', onLoad, {once:true});
  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");
  form.submit();
});

/* ====== Add / Delete Name + Branch (GAS expects new_name, new_branch) ====== */
elBtnAdd.addEventListener("click", ()=>{
  const name = (elNewName.value||"").trim();
  const branch = (elNewBranch.value||"").trim();
  if(!name){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Name"); return; }
  if(!branch){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Branch"); return; }

  const form=$("gasForm");
  const iframe=$("gasTarget");
  form.action = GAS_ENDPOINT;

  $("f_action").value    = "addName";
  $("f_new_name").value  = name;
  $("f_new_branch").value= branch;

  elBtnAdd.disabled = true; elBtnDel.disabled = true;

  const cleanup = ()=>{
    $("f_action").value = "";
    $("f_new_name").value = "";
    $("f_new_branch").value = "";
    elNewName.value = "";
    elNewBranch.value = "";
    elBtnAdd.disabled = false; elBtnDel.disabled = false;
  };

  iframe.onload = ()=>{
    iframe.onload = null;
    cleanup();
    setMessage("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    loadCSV().then(()=>{
      if([...elPerson.options].some(o=>o.value===name)){
        elPerson.value = name;
        state.current = name;
        buildTbody();
      }
    });
  };

  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠...");
  form.submit();
});

elBtnDel.addEventListener("click", ()=>{
  const target = (elNewName.value || elPerson.value || "").trim();
  if(!target){ alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö"); return; }
  if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö "${target}" ?`)) return;

  const form=$("gasForm");
  const iframe=$("gasTarget");
  form.action = GAS_ENDPOINT;

  // ‡∏•‡πâ‡∏≤‡∏á payload ‡∏™‡∏Å‡∏¥‡∏•
  $("f_name").value = "";
  [...form.querySelectorAll('input[name="u_skill[]"],input[name="u_level[]"]')].forEach(el=>el.remove());

  $("f_action").value    = "deleteName";
  $("f_new_name").value  = target;
  $("f_new_branch").value= ""; // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏•‡∏ö

  elBtnAdd.disabled = true; elBtnDel.disabled = true;

  const cleanup = ()=>{
    $("f_action").value = "";
    $("f_new_name").value = "";
    $("f_new_branch").value = "";
    elNewName.value = "";
    elNewBranch.value = "";
    elBtnAdd.disabled = false; elBtnDel.disabled = false;
  };

  iframe.onload = ()=>{
    iframe.onload = null;
    cleanup();
    setMessage("‚úÖ ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    loadCSV().then(()=>{
      if(![...elPerson.options].some(o=>o.value===state.current)){
        state.current = elPerson.options[0]?.value || "";
        elPerson.value = state.current;
        buildTbody();
      }
    });
  };

  setMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠...");
  form.submit();
});

/* ====== Helpers ====== */
function symbolForLevel(lv){ return lv==='2' ? '‚óè' : (lv==='1' ? '‚óã' : '‚Äì'); }
function nextLevel(lv){ return lv==='0' ? '1' : (lv==='1' ? '2' : '0'); }

/* Boot */
loadCSV().catch(err=> setMessage("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+(err.message||err)));
</script>
</body>
</html>
