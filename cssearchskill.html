function buildGroupedSkills(){
  groups = new Map();

  const n = Math.max(header1.length, header2.length);
  let lastGroup = ''; // เก็บชื่อกลุ่มล่าสุด (simulate merge)

  for(let i=2; i<n; i++){
    const gRaw = String(header1[i] ?? '').trim();
    const sRaw = String(header2[i] ?? '').trim();

    // อัปเดตชื่อกลุ่มล่าสุดเฉพาะเมื่อ head1 มีค่า (ช่องแรกของ merge)
    if (gRaw) lastGroup = gRaw;

    // ถ้ายังไม่มีชื่อกลุ่ม (ทั้งก่อนหน้า/ปัจจุบันว่าง) ให้ถือเป็น 'Other'
    const groupName = lastGroup || 'Other';

    // ถ้า head2 ว่าง ส่วนมากคือคอลัมน์หัวกลุ่ม/ตัวคั่น -> ข้าม
    if (!sRaw) continue;

    // label เต็ม = "กลุ่ม › สกิลย่อย"
    const full = `${groupName} › ${sRaw}`;
    const short = toShortLabel(full);

    if (!groups.has(groupName)) groups.set(groupName, []);
    groups.get(groupName).push({ idx: i, labelFull: full, short });
  }

  // ----- render <details> per group เหมือนเดิม -----
  const totalSkills = [...groups.values()].reduce((a,arr)=>a+arr.length,0);
  skillCountEl.textContent = `รวมสกิลทั้งหมด: ${totalSkills} รายการ / กลุ่ม: ${groups.size}`;

  const html = [...groups.entries()].map(([gName, arr], gi)=>`
    <details class="group" ${gi<3?'open':''}>
      <summary class="group-head">
        <span class="group-title">${escapeHtml(gName)}</span>
        <span class="muted">(${arr.length})</span>
        <span class="group-tools">
          <button type="button" class="pill" data-act="group-all" data-group="${escapeHtml(gName)}">เลือกทั้งหมด</button>
          <button type="button" class="pill" data-act="group-none" data-group="${escapeHtml(gName)}">ล้าง</button>
        </span>
      </summary>
      <div class="group-body">
        <div class="skill-grid">
          ${arr.map(o => `
            <label class="skill-item" title="${escapeHtml(o.labelFull)}">
              <input type="checkbox" name="skill" value="${o.idx}" data-group="${escapeHtml(gName)}">
              <span>${escapeHtml(o.labelFull)}</span>
            </label>
          `).join('')}
        </div>
      </div>
    </details>
  `).join('') || '<div class="muted">ไม่พบสกิลจากหัวตาราง</div>';

  skillGroupsEl.innerHTML = html;
}
