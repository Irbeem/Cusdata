<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Visit Summary Advanced</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    select, button { margin: 5px 10px 15px 0; padding: 6px; }
    h2 { margin-bottom: 10px; }
    #mainContent { display: none; }
  </style>
</head>
<body>

<div id="mainContent">
  <h2>📊 Visit Plan Summary (Advanced)</h2>

<label for="fromDate">From Date:</label>
<input type="date" id="fromDate">

<label for="toDate">To Date:</label>
<input type="date" id="toDate">

  <label for="viewType">View:</label>
  <select id="viewType">
    <option value="monthly_total">Monthly (All Users)</option>
    <option value="monthly_by_user">Monthly (Per User)</option>
    <option value="yearly_total">Yearly (All Users)</option>
    <option value="yearly_by_user">Yearly (Per User)</option>
  </select>

  <button onclick="exportPNG()">📸 Export PNG</button>
  <button onclick="exportPDF()">📄 Export PDF</button>

  <canvas id="visitChart" width="800" height="400"></canvas>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCSYG70O7gB17kwrXwL_S5e9dDwec7zhS0",
  authDomain: "custdata-92ebe.firebaseapp.com",
  databaseURL: "https://custdata-92ebe-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "custdata-92ebe"
};
firebase.initializeApp(firebaseConfig);

let allData = [];
let chart;

const fromDate = document.getElementById("fromDate");
const toDate = document.getElementById("toDate");
const viewType = document.getElementById("viewType");

firebase.auth().onAuthStateChanged(user => {
  if (!user) return window.location.href = "index.html";
  document.getElementById("mainContent").style.display = "block";

  firebase.database().ref("visit_plan").once("value", snapshot => {
    const raw = snapshot.val() || {};
    allData = Object.values(raw).filter(p => p.visitDate && p.loginEmail);
    renderChart();
  });
});

[fromDate, toDate, viewType].forEach(e => e.addEventListener("change", renderChart));

document.getElementById("fromDate").addEventListener("change", renderChart);
document.getElementById("toDate").addEventListener("change", renderChart);

function renderChart() {
  const type = viewType.value;

const fd = fromDate.value;
const td = toDate.value;

const filtered = allData.filter(p => {
  if (!p.visitDate) return false;
  const date = p.visitDate;
  if (fd && date < fd) return false;
  if (td && date > td) return false;
  return true;
});



  const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                      "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
  let labels = [], datasets = [];

if (type === "monthly_total" || type === "monthly_by_user") {
  const monthMap = {}; // key = YYYY-MM
  const users = [...new Set(filtered.map(p => p.loginEmail))];

  // รวบรวมข้อมูลแบบ key = YYYY-MM
  filtered.forEach(p => {
    const d = new Date(p.visitDate);
    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    if (!monthMap[key]) monthMap[key] = {};
    const user = p.loginEmail;
    monthMap[key][user] = (monthMap[key][user] || 0) + 1;
  });

  // เรียงเดือนแบบมีปี
  labels = Object.keys(monthMap).sort();

  if (type === "monthly_total") {
    const totals = labels.map(label => {
      const monthlyData = monthMap[label];
      return Object.values(monthlyData).reduce((sum, v) => sum + v, 0);
    });
    datasets = [{
      label: "Total Visits",
      data: totals,
      backgroundColor: "#007bff"
    }];
  }

  else if (type === "monthly_by_user") {
    datasets = users.map(user => {
      const data = labels.map(label => monthMap[label][user] || 0);
      return {
        label: user,
        data,
        backgroundColor: getRandomColor()
      };
    });
  }
}


  else if (type === "yearly_total") {
    const yearMap = {};
    filtered.forEach(p => {
      const y = p.visitDate.split('-')[0];
      yearMap[y] = (yearMap[y] || 0) + 1;
    });
    labels = Object.keys(yearMap).sort();
    datasets = [{
      label: "Total Visits",
      data: labels.map(y => yearMap[y]),
      backgroundColor: "#28a745"
    }];
  }

  else if (type === "yearly_by_user") {
    const years = [...new Set(filtered.map(p => p.visitDate.split('-')[0]))].sort();
    const users = [...new Set(filtered.map(p => p.loginEmail))];
    labels = years;
    datasets = users.map(user => {
      const counts = years.map(y => filtered.filter(p => p.loginEmail === user && p.visitDate.startsWith(y)).length);
      return {
        label: user,
        data: counts,
        backgroundColor: getRandomColor()
      };
    });
  }

  if (chart) chart.destroy();
  const ctx = document.getElementById("visitChart").getContext("2d");
  chart = new Chart(ctx, {
    type: "bar",
    data: { labels, datasets },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.dataset.label}: ${ctx.formattedValue} visits`
          }
        },
        legend: { position: 'top' }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

function getRandomColor() {
  const letters = '89ABCDEF';
  return '#' + Array(6).fill().map(() => letters[Math.floor(Math.random() * letters.length)]).join('');
}

// 🖼 Export PNG
function exportPNG() {
  const link = document.createElement('a');
  link.download = "visit_chart.png";
  link.href = chart.toBase64Image();
  link.click();
}

// 📄 Export PDF
function exportPDF() {
  html2canvas(document.getElementById("visitChart")).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jspdf.jsPDF('landscape');
    pdf.addImage(imgData, 'PNG', 10, 10, 270, 150);
    pdf.save("visit_chart.pdf");
  });
}
</script>
</body>
</html>
