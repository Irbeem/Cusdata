<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>CS Calendar Log Viewer</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #1976d2; color: white; }
    #controls { margin-top: 10px; }
    button { margin: 5px; padding: 6px 12px; cursor: pointer; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // ==== Firebase Config (‡πÉ‡∏ä‡πâ config ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Calendar) ====
    const firebaseConfig = {
      apiKey: "AIzaSyCWTkIN4dKaRI1ZlyHxxhxovhoMGF_8wPc",
      authDomain: "cusdata-51e4f.firebaseapp.com",
      databaseURL: "https://cusdata-51e4f-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "cusdata-51e4f"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // ==== Guard ====
    const appRoot = document.getElementById("app");
    const guardEl = document.getElementById("guard");
    function showGuard(msg){
      guardEl.style.display="block";
      guardEl.innerHTML = msg + ' <a href="index.html">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login</a>';
      appRoot.style.display="none";
    }
    function showApp(){
      guardEl.style.display="none";
      appRoot.style.display="block";
    }

    // ==== Auth Check ====
    onAuthStateChanged(auth, user=>{
      if(!user){ showGuard("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô"); return; }
      showApp();
      loadLog();
    });

    // ==== Google Sheet Config ====
    const SHEET_ID = "1ySiuPMVyrNOpNxx5fR0olf2Dbaq84zKVlVaVo6mFBi8";  // <== ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô sheet ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const SHEET_NAME = "Log";  // ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö
    let currentDate = new Date(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

    // ==== ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ====
    async function loadLog(){
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
      const res = await fetch(url);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0,-2));

      const rows = json.table.rows.map(r => ({
        date: r.c[0]?.v || "",
        detail: r.c[1]?.v || ""
      }));

      renderLog(rows);
    }

    // ==== ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á ====
    function renderLog(rows){
      const table = document.getElementById("logTable");
      const tbody = table.querySelector("tbody");
      tbody.innerHTML="";

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth()+1; // 1-12

      document.getElementById("currentMonth").textContent = `${year}-${String(month).padStart(2,"0")}`;

      const filtered = rows.filter(r=>{
        if(!r.date) return false;
        const d = new Date(r.date);
        return d.getFullYear()===year && (d.getMonth()+1)===month;
      });

      filtered.forEach(r=>{
        const tr = document.createElement("tr");
        const td1 = document.createElement("td");
        const td2 = document.createElement("td");
        td1.textContent = r.date;
        td2.textContent = r.detail;
        tr.appendChild(td1);
        tr.appendChild(td2);
        tbody.appendChild(tr);
      });
    }

    // ==== ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ====
    window.prevMonth = function(){
      currentDate.setMonth(currentDate.getMonth()-1);
      loadLog();
    }
    window.nextMonth = function(){
      currentDate.setMonth(currentDate.getMonth()+1);
      loadLog();
    }
    window.thisMonth = function(){
      currentDate = new Date();
      loadLog();
    }
    window.logout = async function(){
      await signOut(auth);
    }
  </script>
</head>
<body>
  <div id="guard" style="display:none;color:red;font-weight:bold"></div>
  <div id="app" style="display:none">
    <h2>üìë Log Viewer</h2>
    <div id="controls">
      <button onclick="prevMonth()">¬´ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
      <button onclick="thisMonth()">This Month</button>
      <button onclick="nextMonth()">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ¬ª</button>
      <button onclick="logout()" style="float:right">üö™ Logout</button>
    </div>
    <h3>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á: <span id="currentMonth"></span></h3>
    <table id="logTable">
      <thead>
        <tr><th>DateTime</th><th>Detail</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</body>
</html>
