<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>CS Log Viewer</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .hidden { display:none; }
    #toolbar { margin: 8px 0 12px; }
    button { padding: 6px 12px; margin-right: 6px; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; vertical-align: top; }
    th { background: #1976d2; color: #fff; }
    .right { float: right; }
  </style>

  <!-- Firebase v9 (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // ===== Firebase Config (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) =====
    const firebaseConfig = {
      apiKey: "AIzaSyCWTkIN4dKaRI1ZlyHxxhxovhoMGF_8wPc",
      authDomain: "cusdata-51e4f.firebaseapp.com",
      databaseURL: "https://cusdata-51e4f-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "cusdata-51e4f"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // ===== DOM =====
    const guardEl = document.getElementById('guard');
    const appEl   = document.getElementById('app');
    const monthLabel = document.getElementById('monthLabel');
    const tbody   = document.querySelector('#logTable tbody');

    function showGuard(msg){
      guardEl.innerHTML = msg + ' <a href="index.html">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login</a>';
      guardEl.classList.remove('hidden');
      appEl.classList.add('hidden');
    }
    function showApp(){
      guardEl.classList.add('hidden');
      appEl.classList.remove('hidden');
    }

    // ===== Sheet Config =====
    const SHEET_ID   = "1ySiuPMVyrNOpNxx5fR0olf2Dbaq84zKVlVaVo6mFBi8"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const SHEET_NAME = "Log"; // ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö
    // ‡πÉ‡∏ä‡πâ gviz API
    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

    // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π (default = ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)
    let current = new Date();

    // ===== Auth Gate =====
    onAuthStateChanged(auth, async (user) => {
      if (!user) { showGuard("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô"); return; }
      showApp();
      await loadAndRender();
    });

    // ===== Helper: ‡πÅ‡∏õ‡∏•‡∏á "18/9/2025, 14:43:49" => Date =====
    function parseDMY(value) {
  if (!value) return null;

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô object date ‡∏à‡∏≤‡∏Å gviz
  if (typeof value === "object" && value instanceof Date) {
    return value;
  }

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô string ‡πÄ‡∏ä‡πà‡∏ô "18/9/2025, 14:43:49"
  if (typeof value === "string") {
    const [dpart, tpartRaw] = value.split(",");
    if (!dpart) return null;
    const [dd, mm, yyyy] = dpart.trim().split("/").map(v => parseInt(v, 10));
    let hh = 0, mi = 0, ss = 0;
    if (tpartRaw) {
      const ts = tpartRaw.trim().split(":").map(v => parseInt(v, 10));
      hh = ts[0] || 0;
      mi = ts[1] || 0;
      ss = ts[2] || 0;
    }
    return new Date(yyyy, mm - 1, dd, hh, mi, ss);
  }

  return null;
}

    // ===== ‡πÇ‡∏´‡∏•‡∏î & ‡πÅ‡∏™‡∏î‡∏á =====
    async function loadAndRender() {
      tbody.innerHTML = `<tr><td colspan="2">Loading...</td></tr>`;
      let text;
      try {
        const res = await fetch(GVIZ_URL, { cache: "no-store" });
        text = await res.text();
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="2" style="color:#b00">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${e}</td></tr>`;
        return;
      }

      // gviz response ‡∏°‡∏µ prefix "/*O_o*/google.visualization.Query.setResponse(...);"
      let json;
      try {
        json = JSON.parse(text.substring(47).slice(0, -2));
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="2" style="color:#b00">‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå/Publish): ${e}</td></tr>`;
        return;
      }

      const rows = (json.table.rows || []).map(r => ({
        dateRaw:   r.c[0]?.v ?? "",
        detailRaw: r.c[1]?.v ?? ""
      }));

      renderRows(rows);
    }

    function renderRows(rows) {
      const year  = current.getFullYear();
      const month = current.getMonth() + 1; // 1..12
      monthLabel.textContent = `${year}-${String(month).padStart(2, '0')}`;

      // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡πâ‡∏ô
      const filtered = rows.filter(r => {
        const d = parseDMY(r.dateRaw);
        return d && d.getFullYear() === year && (d.getMonth()+1) === month;
      });

      tbody.innerHTML = "";
      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="2" style="color:#555">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</td></tr>`;
        return;
      }

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
      filtered.sort((a, b) => parseDMY(b.dateRaw) - parseDMY(a.dateRaw));

      for (const r of filtered) {
        const tr  = document.createElement('tr');
        const td1 = document.createElement('td');
        const td2 = document.createElement('td');

        td1.textContent = r.dateRaw;
        td2.textContent = r.detailRaw;

        tr.appendChild(td1);
        tr.appendChild(td2);
        tbody.appendChild(tr);
      }
    }

    // ===== ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô =====
    window.prevMonth = () => { current.setMonth(current.getMonth() - 1); loadAndRender(); };
    window.nextMonth = () => { current.setMonth(current.getMonth() + 1); loadAndRender(); };
    window.thisMonth = () => { current = new Date(); loadAndRender(); };
    window.logout    = async () => { await signOut(auth); };
  </script>
</head>
<body>
  <!-- guard -->
  <div id="guard" class="hidden" style="color:#b00; font-weight:700"></div>

  <!-- app -->
  <div id="app" class="hidden">
    <h2>üìë CS Log Viewer</h2>
    <div id="toolbar">
      <button onclick="prevMonth()">¬´ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
      <button onclick="thisMonth()">This Month</button>
      <button onclick="nextMonth()">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ¬ª</button>
      <button class="right" onclick="logout()">üö™ Logout</button>
    </div>

    <h3>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á: <span id="monthLabel"></span></h3>
    <table id="logTable">
      <thead>
        <tr><th style="width:220px">DateTime</th><th>Detail</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</body>
</html>
