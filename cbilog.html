<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>CS Log Viewer</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    .hidden { display:none; }
    #toolbar { margin: 8px 0 12px; }
    button { padding: 6px 12px; margin-right: 6px; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; vertical-align: top; }
    th { background: #1976d2; color: #fff; }
    .right { float: right; }
  </style>

  <script type="module">
    // ===== Firebase SDK =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ===== Firebase Config (‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) =====
    const firebaseConfig = {
      apiKey: "AIzaSyCWTkIN4dKaRI1ZlyHxxhxovhoMGF_8wPc",
      authDomain: "cusdata-51e4f.firebaseapp.com",
      databaseURL: "https://cusdata-51e4f-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "cusdata-51e4f"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // ===== Sheet Config =====
    const SHEET_ID   = "1Yv7-SwI9Iuv9QcEaqFVCEejEe3_8Ja77NNwrM61x-oA"; // <- ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const SHEET_NAME = "Log";
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A,B ‡πÄ‡∏õ‡πá‡∏ô CSV (‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Å‡∏ß‡πà‡∏≤ out:json)
    const CSV_URL    = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}&tq=${encodeURIComponent("select A,B")}`;

    // ===== DOM =====
    const guardEl     = document.getElementById('guard');
    const appEl       = document.getElementById('app');
    const monthLabel  = document.getElementById('monthLabel');
    const tbody       = document.querySelector('#logTable tbody');

    function showGuard(msg){
      guardEl.innerHTML = msg + ' <a href="index.html">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login</a>';
      guardEl.classList.remove('hidden');
      appEl.classList.add('hidden');
    }
    function showApp(){
      guardEl.classList.add('hidden');
      appEl.classList.remove('hidden');
    }

    // ===== ‡∏≠‡πà‡∏≤‡∏ô role ‡∏à‡∏≤‡∏Å RTDB =====
    async function getUserRole(uid) {
      try {
        const snap = await get(ref(db, `users/${uid}/role`));
        return snap.exists() ? snap.val() : null;
      } catch {
        return null;
      }
    }

    // ===== Auth Gate =====
    let current = new Date(); // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π
    onAuthStateChanged(auth, async (user) => {
      if (!user) { showGuard("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô"); return; }

      const role = await getUserRole(user.uid);
      if (role !== 'admin') {
        showGuard(`‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (role: ${role || 'none'})`);
        try { await signOut(auth); } catch {}
        return;
      }

      showApp();
      await loadAndRender();
    });

    // ===== CSV Parser (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î) =====
    function parseCSV(text) {
      const rows = [];
      let row = [];
      let cur = '';
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (inQuotes) {
          if (ch === '"') {
            if (text[i+1] === '"') { cur += '"'; i++; } // escape ""
            else { inQuotes = false; }
          } else {
            cur += ch;
          }
        } else {
          if (ch === '"') inQuotes = true;
          else if (ch === ',') { row.push(cur); cur=''; }
          else if (ch === '\n') { row.push(cur); rows.push(row); row=[]; cur=''; }
          else if (ch === '\r') { /* ignore */ }
          else { cur += ch; }
        }
      }
      if (cur.length || row.length) { row.push(cur); rows.push(row); }
      return rows;
    }

    // ===== parse ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö d/m/yyyy, HH:MM:SS =====
    function parseDMY(str) {
      if (!str) return null;
      // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤
      const [dpart, tpartRaw] = str.split(',');
      if (!dpart) return null;
      const [dd, mm, yyyy] = dpart.trim().split('/').map(x => parseInt(x,10));
      let hh=0, mi=0, ss=0;
      if (tpartRaw) {
        const t = tpartRaw.trim().split(':').map(x=>parseInt(x,10));
        hh=t[0]||0; mi=t[1]||0; ss=t[2]||0;
      }
      if (!yyyy || !mm || !dd) return null;
      return new Date(yyyy, mm-1, dd, hh, mi, ss);
    }

    async function loadAndRender() {
      tbody.innerHTML = `<tr><td colspan="2">Loading...</td></tr>`;
      let csvText = '';
      try {
        const res = await fetch(CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
        csvText = await res.text();
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="2">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${e.message}</td></tr>`;
        return;
      }

      const rows = parseCSV(csvText);
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
        return;
      }

      // ‡∏ï‡∏±‡∏î header: A1= "date", B1= "detail"
      const dataRows = rows.slice(1).map(r => ({
        dateRaw: r[0] || '',
        detailRaw: r[1] || ''
      }));

      renderRows(dataRows);
    }

    function renderRows(rows) {
      const year  = current.getFullYear();
      const month = current.getMonth()+1;
      monthLabel.textContent = `${year}-${String(month).padStart(2,'0')}`;

      const filtered = rows.filter(r => {
        const d = parseDMY(r.dateRaw);
        return d && d.getFullYear() === year && (d.getMonth()+1) === month;
      });

      tbody.innerHTML = '';
      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</td></tr>`;
        return;
      }

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î
      filtered.sort((a,b) => parseDMY(b.dateRaw) - parseDMY(a.dateRaw));

      filtered.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="white-space:nowrap">${r.dateRaw}</td><td>${r.detailRaw}</td>`;
        tbody.appendChild(tr);
      });
    }

    // ===== ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô =====
    window.prevMonth = () => { current.setMonth(current.getMonth() - 1); loadAndRender(); }
    window.nextMonth = () => { current.setMonth(current.getMonth() + 1); loadAndRender(); }
    window.thisMonth = () => { current = new Date(); loadAndRender(); }
    window.logout    = async () => { await signOut(auth); }
  </script>
</head>
<body>
  <div id="guard" class="hidden" style="color:#b00;font-weight:700"></div>

  <div id="app" class="hidden">
    <h2>üìë CS Log Viewer</h2>
    <div id="toolbar">
      <button onclick="prevMonth()">¬´ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
      <button onclick="thisMonth()">This Month</button>
      <button onclick="nextMonth()">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ¬ª</button>
      <button class="right" onclick="logout()">üö™ Logout</button>
    </div>

    <h3>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á: <span id="monthLabel"></span></h3>

    <table id="logTable">
      <thead>
        <tr><th style="width:220px">DateTime</th><th>Detail</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</body>
</html>
