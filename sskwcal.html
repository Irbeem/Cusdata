<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Search Skill YAPT + Availability</title>
<style>
  :root{
    --row-h: 40px;
    --c-bg:#ffffff; --c-fg:#0f172a; --c-line:#e5e7eb; --c-head-bg:#111827; --c-head-fg:#ffffff;
    --accent:#2563eb;
    --sticky-w-name: 180px; --sticky-w-branch: 120px; --sticky-w-match: 110px; --sticky-w-status: 120px;
    --head1: 44px; /* first header row height; JS will update after render */
  }
  html,body{height:100%;margin:0}
  body{background:var(--c-bg);color:var(--c-fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
  .wrap{width:100%;max-width:none;margin:0;padding:12px}

  h1{margin:0 0 10px}

  .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0 12px}
  .group{display:flex;gap:8px;align-items:center;border:1px solid var(--c-line);border-radius:12px;padding:8px 10px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .bar select,.bar input{height:40px;border:1px solid #d1d5db;border-radius:10px;padding:0 12px;background:#fff;color:#0f172a}
  .btn{height:40px;border:1px solid #d1d5db;background:var(--accent);color:#fff;border-radius:10px;padding:0 14px;cursor:pointer}
  .pill{display:inline-block;border:1px solid #d1d5db;border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
  .pill:hover{background:#f3f4f6}
  small.mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;opacity:.75}

  /* Skill picker */
  .skills-toolbar{display:flex;gap:8px;align-items:center;margin:6px 0}
  .skills-toolbar .title{opacity:.8}
  details.skillgrp{border:1px solid var(--c-line);border-radius:12px;background:#fff;margin:10px 0}
  details.skillgrp summary{cursor:pointer;padding:10px 12px;font-weight:700;background:#f8fafc;border-bottom:1px solid #e5e7eb;list-style:none;display:flex;align-items:center;gap:8px}
  details.skillgrp[open] summary{border-bottom-color:#e5e7eb}
  .grp-tools{margin-left:auto;display:flex;gap:6px}
  .skillbox{padding:10px 12px}
  .skill-grid{display:grid;grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));gap:10px}
  .skill-item{display:flex;gap:8px;align-items:center;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;background:#fff;white-space:nowrap}

  /* Results table */
  .table-shell{border:1px solid var(--c-line);border-radius:12px;overflow:hidden;background:#fff;height:calc(100vh - 240px);min-height:360px;width:100%}
  .scroll{overflow:auto;width:100%;height:100%}
  table{border-collapse:separate;border-spacing:0;min-width:1200px;width:max-content}
  thead th{
    position:sticky;
    background:var(--c-head-bg);
    color:var(--c-head-fg);
    z-index:4;
    border-bottom:1px solid var(--c-line);
    font-weight:700;
    height:42px;
    white-space:nowrap
  }
  /* two sticky header rows */
  thead tr:nth-child(1) th{ top:0; }
  thead tr:nth-child(2) th{ top:var(--head1); }

  th,td{padding:8px 10px;border-right:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb;height:var(--row-h);white-space:nowrap}
  tbody tr:nth-child(odd) td{background:#fafafa}

  /* Sticky columns */
  .sticky-name{position:sticky;left:0;z-index:3;background:#f8fafc;min-width:var(--sticky-w-name)}
  .sticky-branch{position:sticky;left:var(--sticky-w-name);z-index:3;background:#f8fafc;min-width:var(--sticky-w-branch)}
  .sticky-match{position:sticky;left:calc(var(--sticky-w-name) + var(--sticky-w-branch));z-index:3;background:#f1f5f9;min-width:var(--sticky-w-match);text-align:center}
  .sticky-status{position:sticky;left:calc(var(--sticky-w-name) + var(--sticky-w-branch) + var(--sticky-w-match));z-index:3;background:#f1f5f9;min-width:var(--sticky-w-status);text-align:center}
  thead .sticky-name, thead .sticky-branch, thead .sticky-match, thead .sticky-status { z-index:5; background:var(--c-head-bg);}

  /* Match % */
  .chip{display:inline-block;min-width:52px;padding:2px 10px;border-radius:999px;border:1px solid #c7d2fe;background:#dbeafe;font-weight:700}
  .pct-good{background:#dcfce7;border-color:#86efac}
  .pct-mid{background:#fef9c3;border-color:#fde68a}
  .pct-low{background:#ffedd5;border-color:#fed7aa}

  /* Status */
  .stat-free{background:#dcfce7;border:1px solid #86efac}
  .stat-busy{background:#fee2e2;border:1px solid #fecaca}
  .stat-standby{background:#e0e7ff;border:1px solid #bfdbfe}

  /* Skill icons */
  td.skill { text-align:center; }
  .skill-pill{display:inline-flex;align-items:center;justify-content:center;gap:6px;width:48px;height:26px;border:1px solid #d1d5db;border-radius:14px;background:#fff;user-select:none}
  .skill-pill .dot{width:10px;height:10px;border-radius:50%;display:inline-block}
  .skill-pill[data-skill="1"]{background:#22c55e;color:#fff}.skill-pill[data-skill="1"] .dot{background:#fff}
  .skill-pill[data-skill="2"]{background:#2563eb;color:#fff}.skill-pill[data-skill="2"] .dot{background:#000}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Search Skill YAPT</h1>

  <!-- Controls -->
  <div class="bar">
    <div class="group">
      <label>Branch:</label>
      <select id="filterBranch"><option value="*">All branches</option></select>
    </div>

    <div class="group">
      <label>Min level:</label>
      <select id="minLevel">
        <option value="1" selected>Can do (â‰¥1)</option>
        <option value="2">Can teach (=2)</option>
      </select>
      <label style="margin-left:10px">Match mode:</label>
      <label><input type="radio" name="mode" value="AND" checked> AND (must match all)</label>
      <label><input type="radio" name="mode" value="OR"> OR (match any)</label>
    </div>

    <div class="group">
      <label><input type="checkbox" id="useDate"> Use this date:</label>
      <input id="dDay"   type="number" min="1" max="31" placeholder="Day" style="width:80px">
      <input id="dMonth" type="number" min="1" max="12" placeholder="Month" style="width:90px">
      <input id="dYear"  type="number" min="2020" max="2100" placeholder="Year" style="width:100px">
      <label style="margin-left:8px"><input type="checkbox" id="chkBKK" checked> Check BKK</label>
      <label><input type="checkbox" id="chkCBI" checked> Check CBI</label>
    </div>

    <button class="btn" id="btnSearch">Search</button>
    <small id="meta" class="mono"></small>
  </div>

  <!-- Global select/clear -->
  <div class="skills-toolbar">
    <span class="title">Select skills (multi-select):</span>
    <button type="button" id="selectAllGlobal" class="pill">Select all</button>
    <button type="button" id="clearAllGlobal"  class="pill">Clear</button>
  </div>

  <!-- Skill groups (Head1 -> Head2 list) -->
  <div id="skillGroups"></div>

  <!-- Results -->
  <div class="table-shell">
    <div class="scroll" id="scroller">
      <table id="result">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const SKILL_SHEET_ID = '1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k';
const SKILL_GID = '0';
const SKILL_CSV = `https://docs.google.com/spreadsheets/d/${SKILL_SHEET_ID}/export?format=csv&gid=${SKILL_GID}`;

const BKK_SHEET_ID = '1ySiuPMVyrNOpNxx5fR0olf2Dbaq84zKVlVaVo6mFBi8';
const CBI_SHEET_ID = '1Yv7-SwI9Iuv9QcEaqFVCEejEe3_8Ja77NNwrM61x-oA';
const gviz = (id, sheet='Carlendar') => `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}`;

/* ===================== STATE ===================== */
let header1=[], header2=[], rows=[];
let groups=[];
let selectedSkillIdx = new Set();
let resolvedH1=[]; // Head1 after left-fill (inherit last non-empty)

/* ===================== LOAD SKILLS ===================== */
async function loadSkills(){
  const text = await fetch(SKILL_CSV, {cache:'no-store'}).then(r=>r.text());
  const data = Papa.parse(text, {skipEmptyLines:false}).data || [];
  header1 = data[0]||[]; header2=data[1]||[]; rows = data.slice(2);

  // Build resolved Head1 (inherit previous non-empty)
  resolvedH1 = header1.slice();
  let cur = '';
  for(let i=0;i<resolvedH1.length;i++){
    const t = (resolvedH1[i]||'').trim();
    if(i<2){ resolvedH1[i]=''; continue; } // first 2 are name/branch
    if(t){ cur=t; resolvedH1[i]=t; }
    else resolvedH1[i]=cur;
  }

  buildGroups();
  populateBranch();
  renderSkillGroups();
  setToday(); // fill date fields with today (checkbox is OFF by default)
}

function buildGroups(){
  const n = Math.max(header1.length, header2.length);
  groups=[]; let i=0;
  while(i<n){
    const h1=(header1[i]||'').trim();
    if(i<2){ i++; continue; }
    if(!h1){ i++; continue; }
    let j=i+1; while(j<n && (header1[j]||'').trim()==='') j++;
    const items=[];
    for(let k=i;k<j;k++){
      const name=(header2[k]||'').trim() || (header1[k]||'').trim() || `Skill ${k}`;
      items.push({idx:k, name});
    }
    groups.push({title:h1, items});
    i=j;
  }
}

function uniqueBranches(){
  const seen=new Set(), out=[];
  rows.forEach(r=>{ const b=String(r[1]??'').trim(); if(b && !seen.has(b)){ seen.add(b); out.push(b);} });
  out.sort((a,b)=>a.localeCompare(b,'en')); return out;
}
function populateBranch(){
  const sel=document.getElementById('filterBranch');
  const cur=sel.value||'*';
  const list=uniqueBranches();
  sel.innerHTML='<option value="*">All branches</option>'+list.map(b=>`<option value="${b}">${b}</option>`).join('');
  if([...sel.options].some(o=>o.value===cur)) sel.value=cur;
}

/* ========== Render skill groups ========== */
function renderSkillGroups(){
  const host=document.getElementById('skillGroups');
  host.innerHTML='';
  groups.forEach(g=>{
    const det=document.createElement('details');
    det.className='skillgrp'; det.open=true;
    det.innerHTML=`
      <summary>
        <span>${escapeHtml(g.title)}</span>
        <small class="mono">(${g.items.length})</small>
        <span class="grp-tools">
          <button class="pill" data-act="all">Select all</button>
          <button class="pill" data-act="clear">Clear</button>
        </span>
      </summary>
      <div class="skillbox"><div class="skill-grid"></div></div>`;
    const grid=det.querySelector('.skill-grid');
    g.items.forEach(it=>{
      const id=`sk_${it.idx}`;
      const el=document.createElement('label');
      el.className='skill-item';
      el.innerHTML=`<input type="checkbox" id="${id}" data-idx="${it.idx}"> ${escapeHtml(it.name)}`;
      grid.appendChild(el);
    });
    det.querySelector('[data-act="all"]').onclick=()=>{
      grid.querySelectorAll('input[type="checkbox"]').forEach(ch=>{ ch.checked=true; selectedSkillIdx.add(Number(ch.dataset.idx)); });
    };
    det.querySelector('[data-act="clear"]').onclick=()=>{
      grid.querySelectorAll('input[type="checkbox"]').forEach(ch=>{ ch.checked=false; selectedSkillIdx.delete(Number(ch.dataset.idx)); });
    };
    grid.addEventListener('change', e=>{
      const ch=e.target.closest('input[type="checkbox"]'); if(!ch) return;
      const idx=Number(ch.dataset.idx);
      if(ch.checked) selectedSkillIdx.add(idx); else selectedSkillIdx.delete(idx);
    });
    host.appendChild(det);
  });
}

/* ========== Global select/clear ========== */
document.getElementById('selectAllGlobal').addEventListener('click',()=>{
  document.querySelectorAll('#skillGroups input[type="checkbox"]').forEach(ch=>{ ch.checked=true; selectedSkillIdx.add(Number(ch.dataset.idx)); });
});
document.getElementById('clearAllGlobal').addEventListener('click',()=>{
  document.querySelectorAll('#skillGroups input[type="checkbox"]').forEach(ch=>{ ch.checked=false; selectedSkillIdx.delete(Number(ch.dataset.idx)); });
});

/* ===================== Helpers ===================== */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function setToday(){
  const t=new Date();
  document.getElementById('dDay').value   = t.getDate();
  document.getElementById('dMonth').value = t.getMonth()+1;
  document.getElementById('dYear').value  = t.getFullYear();
}

/* ===================== Search + Availability ===================== */
function getVisibleRows(){
  const branch=document.getElementById('filterBranch').value||'*';
  const indices=[...selectedSkillIdx];
  const minLv=Number(document.getElementById('minLevel').value||1);
  const mode=document.querySelector('input[name="mode"]:checked')?.value||'AND';

  const visible=[];
  rows.forEach((r,ri)=>{
    if(branch!=='*' && String(r[1]||'').trim()!==branch) return;
    if(indices.length===0){ visible.push({ri, r, matchedCols:[], pct:0}); return; }
    const vals = indices.map(ci => Number(r[ci]||0) );
    const pass = (mode==='AND') ? vals.every(v => v>=minLv) : vals.some(v => v>=minLv);
    if(pass){
      const matchedCols = indices.filter(ci => Number(r[ci]||0)>=minLv);
      visible.push({ri,r,matchedCols, pct: Math.round((matchedCols.length / indices.length)*100)});
    }
  });
  return visible;
}
function pctClass(p){ if(p>=80) return 'pct-good'; if(p>=50) return 'pct-mid'; return 'pct-low'; }

/* Availability from Carlendar: Free / Busy / Standby (Type) */
async function fetchStatusMap(y,m,d, ids){
  const fetchOne = async (sheetId) => {
    const txt = await fetch(gviz(sheetId), {cache:'no-store'}).then(r=>r.text());
    const json = JSON.parse(txt.substring(47).slice(0,-2));
    const cols = json.table.cols.map(c=>String(c.label||''));
    const Y = cols.findIndex(x=>/^year$/i.test(x));
    const M = cols.findIndex(x=>/^month$/i.test(x));
    const D = cols.findIndex(x=>/^date$/i.test(x));
    const N = cols.findIndex(x=>/^name$/i.test(x));
    const T = cols.findIndex(x=>/^type$/i.test(x));
    const map = new Map(); // name -> 'busy' | 'standby'
    json.table.rows.forEach(row=>{
      const c=row.c||[];
      const yy = c[Y]?.v ?? c[Y]?.f ?? c[Y];
      const mm = c[M]?.v ?? c[M]?.f ?? c[M];
      const dd = c[D]?.v ?? c[D]?.f ?? c[D];
      if(Number(yy)!==Number(y) || Number(mm)!==Number(m) || Number(dd)!==Number(d)) return;
      const nm = (c[N]?.v ?? '').toString().trim();
      if(!nm) return;
      const typeRaw = (c[T]?.v ?? c[T]?.f ?? '').toString().trim().toLowerCase();
      const cur = map.get(nm);
      if(typeRaw==='standby'){
        map.set(nm,'standby');
      }else{
        if(cur!=='standby') map.set(nm,'busy');
      }
    });
    return map;
  };

  const result = new Map();
  if(!ids.length) return result;
  const settled = await Promise.allSettled(ids.map(fetchOne));
  settled.forEach(s=>{
    if(s.status==='fulfilled'){
      s.value.forEach((v,k)=>{
        const cur = result.get(k);
        if(v==='standby' || cur==='standby') result.set(k,'standby');
        else result.set(k,'busy');
      });
    }
  });
  return result; // names not present => Free
}

/* ===================== Render Table ===================== */
function renderHeader(){
  const thead=document.querySelector('#result thead');
  const selected=[...selectedSkillIdx].sort((a,b)=>a-b);

  if(selected.length===0){
    thead.innerHTML = `
      <tr>
        <th class="sticky-name">Name</th>
        <th class="sticky-branch">Branch</th>
        <th class="sticky-match">Match %</th>
        <th class="sticky-status">Status</th>
      </tr>`;
    requestAnimationFrame(fixHeaderTop);
    return;
  }

  // sticky leading columns with rowspan=2 + grouped Head1 using resolvedH1
  let topFixed = `
    <th class="sticky-name" rowspan="2">Name</th>
    <th class="sticky-branch" rowspan="2">Branch</th>
    <th class="sticky-match" rowspan="2">Match %</th>
    <th class="sticky-status" rowspan="2">Status</th>`;

  let htmlTop='', i=0;
  while(i<selected.length){
    const idxStart = selected[i];
    const gname = (resolvedH1[idxStart]||'').trim();
    let j=i+1;
    while(j<selected.length && (resolvedH1[selected[j]]||'').trim()===gname) j++;
    const colspan = j-i;
    htmlTop += `<th ${colspan>1?`colspan="${colspan}"`:''}>${escapeHtml(gname)}</th>`;
    i=j;
  }
  const htmlBottom = selected.map(ci=>{
    const t2 = (header2[ci]||'').trim() || (header1[ci]||'').trim();
    return `<th>${escapeHtml(t2)}</th>`;
  }).join('');

  thead.innerHTML = `
    <tr>${topFixed}${htmlTop}</tr>
    <tr>${htmlBottom}</tr>`;
  requestAnimationFrame(fixHeaderTop);
}

function renderBody(items, statusMap, dateGiven){
  const tbody=document.querySelector('#result tbody');
  const selected=[...selectedSkillIdx].sort((a,b)=>a-b);

  const rowsHtml = items.map(it=>{
    const name = String(it.r[0]||'');
    const branch = String(it.r[1]||'');
    const pct = it.pct || 0;
    const pctCls = pctClass(pct);

    let statChip = `<span class="chip">-</span>`;
    if(dateGiven){
      const st = statusMap.get(name);
      if(st==='standby') statChip = `<span class="chip stat-standby">Standby</span>`;
      else if(st==='busy') statChip = `<span class="chip stat-busy">Busy</span>`;
      else statChip = `<span class="chip stat-free">Free</span>`;
    }

    const skillCells = selected.map(ci=>{
      const v = String(it.r[ci]||'0');
      if(v==='2') return `<td class="skill"><span class="skill-pill" data-skill="2"><span class="dot"></span></span></td>`;
      if(v==='1') return `<td class="skill"><span class="skill-pill" data-skill="1"><span class="dot"></span></span></td>`;
      return `<td class="skill"><span class="skill-pill" data-skill="0">-</span></td>`;
    }).join('');

    return `
      <tr>
        <td class="sticky-name">${escapeHtml(name)}</td>
        <td class="sticky-branch">${escapeHtml(branch)}</td>
        <td class="sticky-match"><span class="chip ${pctCls}">${pct}%</span></td>
        <td class="sticky-status">${statChip}</td>
        ${skillCells}
      </tr>`;
  }).join('');

  const colSpan = 4 + selected.length;
  tbody.innerHTML = rowsHtml || `<tr><td class="sticky-name" colspan="${colSpan}">No results</td></tr>`;
}

/* keep row-2 header sticky aligned */
function fixHeaderTop(){
  const tr1 = document.querySelector('#result thead tr:first-child');
  if(!tr1) return;
  const h = Math.round(tr1.getBoundingClientRect().height);
  document.documentElement.style.setProperty('--head1', h+'px');
}

/* ===================== Events ===================== */
document.getElementById('selectAllGlobal').addEventListener('click',()=>{
  document.querySelectorAll('#skillGroups input[type="checkbox"]').forEach(ch=>{ ch.checked=true; selectedSkillIdx.add(Number(ch.dataset.idx)); });
});
document.getElementById('clearAllGlobal').addEventListener('click',()=>{
  document.querySelectorAll('#skillGroups input[type="checkbox"]').forEach(ch=>{ ch.checked=false; selectedSkillIdx.delete(Number(ch.dataset.idx)); });
});
window.addEventListener('resize', fixHeaderTop);

document.getElementById('btnSearch').addEventListener('click', async ()=>{
  const t0 = performance.now();
  const useDate = document.getElementById('useDate').checked;
  const day = Number(document.getElementById('dDay').value||0);
  const mon = Number(document.getElementById('dMonth').value||0);
  const yr  = Number(document.getElementById('dYear').value||0);
  const chkBKK = document.getElementById('chkBKK').checked;
  const chkCBI = document.getElementById('chkCBI').checked;

  const items = getVisibleRows();

  let statusMap = new Map();
  const dateGiven = useDate && day>0 && mon>0 && yr>0;
  if(dateGiven){
    const ids=[]; if(chkBKK) ids.push(BKK_SHEET_ID); if(chkCBI) ids.push(CBI_SHEET_ID);
    statusMap = await fetchStatusMap(yr, mon, day, ids).catch(()=>new Map());
  }

  // Sort: Free -> Standby -> Busy, then Match% desc, then original row index
  const rank = (nm)=>{
    if(!dateGiven) return 0;
    const st = statusMap.get(nm);
    if(st==='busy') return 2;
    if(st==='standby') return 1;
    return 0; // free
  };
  items.sort((a,b)=>{
    const an = String(a.r[0]||''), bn = String(b.r[0]||'');
    const ra = rank(an), rb = rank(bn);
    if(ra!==rb) return ra-rb;
    const pa = a.pct||0, pb = b.pct||0;
    if(pa!==pb) return pb-pa;
    return a.ri - b.ri;
  });

  renderHeader();
  renderBody(items, statusMap, dateGiven);
  requestAnimationFrame(fixHeaderTop);

  const took=Math.round(performance.now()-t0);
  document.getElementById('meta').textContent =
    `Found ${items.length} people | ${took} ms` + (dateGiven?` | ${String(day).padStart(2,'0')}/${String(mon).padStart(2,'0')}/${yr}${chkBKK?' | BKK':''}${chkCBI?' | CBI':''}`:'');
});

/* ===================== Init ===================== */
loadSkills().catch(()=>alert('Failed to load skills data'));
</script>
</body>
</html>
