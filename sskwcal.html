<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Search Skill YAPT</title>
<style>
  :root{
    --row-h: 40px;
    --c-bg:#ffffff; --c-fg:#0f172a; --c-line:#e5e7eb; --c-head-bg:#111827; --c-head-fg:#ffffff;
    --accent:#2563eb;
    --sticky-w-name: 180px; --sticky-w-branch: 120px; --sticky-w-match: 110px; --sticky-w-status: 120px;
    --head1: 44px;
  }
  html,body{height:100%;margin:0}
  body{background:var(--c-bg);color:var(--c-fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
  .wrap{width:100%;max-width:none;margin:0;padding:12px}
  h1{margin:0 0 10px}
  .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0 12px}
  .group{display:flex;gap:8px;align-items:center;border:1px solid var(--c-line);border-radius:12px;padding:8px 10px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .bar select,.bar input{height:40px;border:1px solid #d1d5db;border-radius:10px;padding:0 12px;background:#fff;color:#0f172a}
  .btn{height:40px;border:1px solid #d1d5db;background:var(--accent);color:#fff;border-radius:10px;padding:0 14px;cursor:pointer}
  .pill{display:inline-block;border:1px solid #d1d5db;border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
  .pill:hover{background:#f3f4f6}
  small.mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;opacity:.75}
  .skills-toolbar{display:flex;gap:8px;align-items:center;margin:6px 0}
  .skills-toolbar .title{opacity:.8}
  details.skillgrp{border:1px solid var(--c-line);border-radius:12px;background:#fff;margin:10px 0}
  details.skillgrp summary{cursor:pointer;padding:10px 12px;font-weight:700;background:#f8fafc;border-bottom:1px solid #e5e7eb;list-style:none;display:flex;align-items:center;gap:8px}
  details.skillgrp[open] summary{border-bottom-color:#e5e7eb}
  .grp-tools{margin-left:auto;display:flex;gap:6px}
  .skillbox{padding:10px 12px}
  .skill-grid{display:grid;grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));gap:10px}
  .skill-item{display:flex;gap:8px;align-items:center;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;background:#fff;white-space:nowrap}
  .table-shell{border:1px solid var(--c-line);border-radius:12px;overflow:hidden;background:#fff;height:calc(100vh - 240px);min-height:360px;width:100%}
  .scroll{overflow:auto;width:100%;height:100%}
  table{border-collapse:separate;border-spacing:0;min-width:1200px;width:max-content}
  thead th{position:sticky;background:var(--c-head-bg);color:var(--c-head-fg);z-index:4;border-bottom:1px solid var(--c-line);font-weight:700;height:42px;white-space:nowrap}
  thead tr:nth-child(1) th{ top:0; }
  thead tr:nth-child(2) th{ top:var(--head1); }
  th,td{padding:8px 10px;border-right:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb;height:var(--row-h);white-space:nowrap}
  tbody tr:nth-child(odd) td{background:#fafafa}
  .sticky-name{position:sticky;left:0;z-index:3;background:#f8fafc;min-width:var(--sticky-w-name)}
  .sticky-branch{position:sticky;left:var(--sticky-w-name);z-index:3;background:#f8fafc;min-width:var(--sticky-w-branch)}
  .sticky-match{position:sticky;left:calc(var(--sticky-w-name) + var(--sticky-w-branch));z-index:3;background:#f1f5f9;min-width:var(--sticky-w-match);text-align:center}
  .sticky-status{position:sticky;left:calc(var(--sticky-w-name) + var(--sticky-w-branch) + var(--sticky-w-match));z-index:3;background:#f1f5f9;min-width:var(--sticky-w-status);text-align:center}
  thead .sticky-name, thead .sticky-branch, thead .sticky-match, thead .sticky-status { z-index:5; background:var(--c-head-bg);}
  .chip{display:inline-block;min-width:52px;padding:2px 10px;border-radius:999px;border:1px solid #c7d2fe;background:#dbeafe;font-weight:700}
  .pct-good{background:#dcfce7;border-color:#86efac}
  .pct-mid{background:#fef9c3;border-color:#fde68a}
  .pct-low{background:#ffedd5;border-color:#fed7aa}
  .stat-free{background:#dcfce7;border:1px solid #86efac}
  .stat-busy{background:#fee2e2;border:1px solid #fecaca}
  .stat-standby{background:#e0e7ff;border:1px solid #bfdbfe}
  td.skill { text-align:center; }
  .skill-pill{display:inline-flex;align-items:center;justify-content:center;gap:6px;width:48px;height:26px;border:1px solid #d1d5db;border-radius:14px;background:#fff;user-select:none}
  .skill-pill .dot{width:10px;height:10px;border-radius:50%;display:inline-block}
  .skill-pill[data-skill="1"]{background:#22c55e;color:#fff}.skill-pill[data-skill="1"] .dot{background:#fff}
  .skill-pill[data-skill="2"]{background:#2563eb;color:#fff}.skill-pill[data-skill="2"] .dot{background:#000}
  /* Topbar/Auth */
  #topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  #topbar .right{display:flex;gap:8px;align-items:center}
  #authGate{padding:24px 16px}
  #authGate .muted{opacity:.7}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<!-- ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å Firebase/‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï -->
<script src="config.js" defer></script>
</head>
<body>

<!-- ‡πÄ‡∏Å‡∏ó‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ -->
<div id="authGate">
  <div id="checkingMsg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‚Ä¶</div>
  <div class="muted" id="authDetail">‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</div>
</div>

<!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å: ‡∏ã‡πà‡∏≠‡∏ô‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ú‡πà‡∏≤‡∏ô Auth -->
<div id="app" style="display:none">
  <div class="wrap">
    <div id="topbar">
      <h1>Search Skill YAPT</h1>
      <div class="right">
        <span id="whoami" class="muted"></span>
        <button id="logoutBtn" class="btn" style="background:#6b7280;border-color:#9ca3af">Sign out</button>
      </div>
    </div>

    <!-- Controls -->
    <div class="bar">
      <div class="group">
        <label>Branch:</label>
        <select id="filterBranch"><option value="*">All branches</option></select>
      </div>

      <div class="group">
        <label>Min level:</label>
        <select id="minLevel">
          <option value="1" selected>Can do (‚â•1)</option>
          <option value="2">Can teach (=2)</option>
        </select>
        <label style="margin-left:10px">Match mode:</label>
        <label><input type="radio" name="mode" value="AND"> AND (must match all)</label>
        <label><input type="radio" name="mode" value="OR" checked> OR (match any)</label>
      </div>

      <div class="group">
        <label><input type="checkbox" id="useDate"> Use this date:</label>
        <input id="dDay"   type="number" min="1" max="31" placeholder="Day" style="width:80px">
        <input id="dMonth" type="number" min="1" max="12" placeholder="Month" style="width:90px">
        <input id="dYear"  type="number" min="2020" max="2100" placeholder="Year" style="width:100px">
        <label style="margin-left:8px"><input type="checkbox" id="chkBKK" checked> Check BKK</label>
        <label><input type="checkbox" id="chkCBI" checked> Check CBI</label>
      </div>

      <button class="btn" id="btnSearch">Search</button>
      <small id="meta" class="mono"></small>
    </div>

    <!-- Global select/clear -->
    <div class="skills-toolbar">
      <span class="title">Select skills (multi-select):</span>
      <button type="button" id="selectAllGlobal" class="pill">Select all</button>
      <button type="button" id="clearAllGlobal"  class="pill">Clear</button>
    </div>

    <!-- Skill groups -->
    <div id="skillGroups"></div>

    <!-- Results -->
    <div class="table-shell">
      <div class="scroll" id="scroller">
        <table id="result">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const SKILL_SHEET_ID = '1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k';
const SKILL_GID = '0';
const SKILL_CSV = `https://docs.google.com/spreadsheets/d/${SKILL_SHEET_ID}/export?format=csv&gid=${SKILL_GID}`;

const BKK_SHEET_ID = '1ySiuPMVyrNOpNxx5fR0olf2Dbaq84zKVlVaVo6mFBi8';
const CBI_SHEET_ID = '1Yv7-SwI9Iuv9QcEaqFVCEejEe3_8Ja77NNwrM61x-oA';
const gviz = (id, sheet='Carlendar') => `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}`;

/* ===================== STATE ===================== */
let header1=[], header2=[], rows=[];
let groups=[];
let selectedSkillIdx = new Set();
let resolvedH1=[];

/* ===================== LOAD SKILLS ===================== */
async function loadSkills(){
  const text = await fetch(SKILL_CSV, {cache:'no-store'}).then(r=>r.text());
  const data = Papa.parse(text, {skipEmptyLines:false}).data || [];
  header1 = data[0]||[]; header2=data[1]||[]; rows = data.slice(2);

  resolvedH1 = header1.slice();
  let cur = '';
  for(let i=0;i<resolvedH1.length;i++){
    const t = (resolvedH1[i]||'').trim();
    if(i<2){ resolvedH1[i]=''; continue; }
    if(t){ cur=t; resolvedH1[i]=t; } else { resolvedH1[i]=cur; }
  }

  buildGroups();
  populateBranch();
  renderSkillGroups();
  setToday();
}
window.loadSkills = loadSkills; // ‡πÉ‡∏´‡πâ auth-guard ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏î‡πâ

function buildGroups(){
  const n = Math.max(header1.length, header2.length);
  groups=[]; let i=0;
  while(i<n){
    const h1=(header1[i]||'').trim();
    if(i<2){ i++; continue; }
    if(!h1){ i++; continue; }
    let j=i+1; while(j<n && (header1[j]||'').trim()==='') j++;
    const items=[];
    for(let k=i;k<j;k++){
      const name=(header2[k]||'').trim() || (header1[k]||'').trim() || `Skill ${k}`;
      items.push({idx:k, name});
    }
    groups.push({title:h1, items});
    i=j;
  }
}
function uniqueBranches(){
  const seen=new Set(), out=[];
  rows.forEach(r=>{ const b=String(r[1]??'').trim(); if(b && !seen.has(b)){ seen.add(b); out.push(b);} });
  out.sort((a,b)=>a.localeCompare(b,'en')); return out;
}
function populateBranch(){
  const sel=document.getElementById('filterBranch');
  const cur=sel.value||'*';
  const list=uniqueBranches();
  sel.innerHTML='<option value="*">All branches</option>'+list.map(b=>`<option value="${b}">${b}</option>`).join('');
  if([...sel.options].some(o=>o.value===cur)) sel.value=cur;
}

/* ========== Render skill groups ========== */
function renderSkillGroups(){
  const host=document.getElementById('skillGroups');
  host.innerHTML='';
  groups.forEach(g=>{
    const det=document.createElement('details');
    det.className='skillgrp'; det.open=true;
    det.innerHTML=`
      <summary>
        <span>${escapeHtml(g.title)}</span>
        <small class="mono">(${g.items.length})</small>
        <span class="grp-tools">
          <button class="pill" data-act="all">Select all</button>
          <button class="pill" data-act="clear">Clear</button>
        </span>
      </summary>
      <div class="skillbox"><div class="skill-grid"></div></div>`;
    const grid=det.querySelector('.skill-grid');
    g.items.forEach(it=>{
      const id=`sk_${it.idx}`;
      const el=document.createElement('label');
      el.className='skill-item';
      el.innerHTML=`<input type="checkbox" id="${id}" data-idx="${it.idx}"> ${escapeHtml(it.name)}`;
      grid.appendChild(el);
    });
    det.querySelector('[data-act="all"]').onclick=()=>{
      grid.querySelectorAll('input[type="checkbox"]').forEach(ch=>{ ch.checked=true; selectedSkillIdx.add(Number(ch.dataset.idx)); });
    };
    det.querySelector('[data-act="clear"]').onclick=()=>{
      grid.querySelectorAll('input[type="checkbox"]').forEach(ch=>{ ch.checked=false; selectedSkillIdx.delete(Number(ch.dataset.idx)); });
    };
    grid.addEventListener('change', e=>{
      const ch=e.target.closest('input[type="checkbox"]'); if(!ch) return;
      const idx=Number(ch.dataset.idx);
      if(ch.checked) selectedSkillIdx.add(idx); else selectedSkillIdx.delete(idx);
    });
    host.appendChild(det);
  });
}

/* ========== Global select/clear ========== */
document.getElementById('selectAllGlobal').addEventListener('click',()=>{
  document.querySelectorAll('#skillGroups input[type="checkbox"]').forEach(ch=>{ ch.checked=true; selectedSkillIdx.add(Number(ch.dataset.idx)); });
});
document.getElementById('clearAllGlobal').addEventListener('click',()=>{
  document.querySelectorAll('#skillGroups input[type="checkbox"]').forEach(ch=>{ ch.checked=false; selectedSkillIdx.delete(Number(ch.dataset.idx)); });
});

/* ===================== Helpers ===================== */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function setToday(){
  const t=new Date();
  document.getElementById('dDay').value   = t.getDate();
  document.getElementById('dMonth').value = t.getMonth()+1;
  document.getElementById('dYear').value  = t.getFullYear();
}

/* ===================== Search + Availability ===================== */
function getVisibleRows(){
  const branch=document.getElementById('filterBranch').value||'*';
  const indices=[...selectedSkillIdx];
  const minLv=Number(document.getElementById('minLevel').value||1);
  const mode=document.querySelector('input[name="mode"]:checked')?.value||'AND';

  const visible=[];
  rows.forEach((r,ri)=>{
    if(branch!=='*' && String(r[1]||'').trim()!==branch) return;
    if(indices.length===0){ visible.push({ri, r, matchedCols:[], pct:0}); return; }
    const vals = indices.map(ci => Number(r[ci]||0) );
    const pass = (mode==='AND') ? vals.every(v => v>=minLv) : vals.some(v => v>=minLv);
    if(pass){
      const matchedCols = indices.filter(ci => Number(r[ci]||0)>=minLv);
      visible.push({ri,r,matchedCols, pct: Math.round((matchedCols.length / indices.length)*100)});
    }
  });
  return visible;
}
function pctClass(p){ if(p>=80) return 'pct-good'; if(p>=50) return 'pct-mid'; return 'pct-low'; }

async function fetchStatusMap(y,m,d, ids){
  const fetchOne = async (sheetId) => {
    const txt = await fetch(gviz(sheetId), {cache:'no-store'}).then(r=>r.text());
    const json = JSON.parse(txt.substring(47).slice(0,-2));
    const cols = json.table.cols.map(c=>String(c.label||''));
    const Y = cols.findIndex(x=>/^year$/i.test(x));
    const M = cols.findIndex(x=>/^month$/i.test(x));
    const D = cols.findIndex(x=>/^date$/i.test(x));
    const N = cols.findIndex(x=>/^name$/i.test(x));
    const T = cols.findIndex(x=>/^type$/i.test(x));
    const map = new Map();
    json.table.rows.forEach(row=>{
      const c=row.c||[];
      const yy = c[Y]?.v ?? c[Y]?.f ?? c[Y];
      const mm = c[M]?.v ?? c[M]?.f ?? c[M];
      const dd = c[D]?.v ?? c[D]?.f ?? c[D];
      if(Number(yy)!==Number(y) || Number(mm)!==Number(m) || Number(dd)!==Number(d)) return;
      const nm = (c[N]?.v ?? '').toString().trim();
      if(!nm) return;
      const typeRaw = (c[T]?.v ?? c[T]?.f ?? '').toString().trim().toLowerCase();
      const cur = map.get(nm);
      if(typeRaw==='standby'){ map.set(nm,'standby'); }
      else { if(cur!=='standby') map.set(nm,'busy'); }
    });
    return map;
  };

  const result = new Map();
  if(!ids.length) return result;
  const settled = await Promise.allSettled(ids.map(fetchOne));
  settled.forEach(s=>{
    if(s.status==='fulfilled'){
      s.value.forEach((v,k)=>{
        const cur = result.get(k);
        if(v==='standby' || cur==='standby') result.set(k,'standby');
        else result.set(k,'busy');
      });
    }
  });
  return result;
}

/* ===================== Render Table ===================== */
function renderHeader(){
  const thead=document.querySelector('#result thead');
  const selected=[...selectedSkillIdx].sort((a,b)=>a-b);

  if(selected.length===0){
    thead.innerHTML = `
      <tr>
        <th class="sticky-name">Name</th>
        <th class="sticky-branch">Branch</th>
        <th class="sticky-match">Match %</th>
        <th class="sticky-status">Status</th>
      </tr>`;
    requestAnimationFrame(fixHeaderTop);
    return;
  }

  let topFixed = `
    <th class="sticky-name" rowspan="2">Name</th>
    <th class="sticky-branch" rowspan="2">Branch</th>
    <th class="sticky-match" rowspan="2">Match %</th>
    <th class="sticky-status" rowspan="2">Status</th>`;

  let htmlTop='', i=0;
  while(i<selected.length){
    const idxStart = selected[i];
    const gname = (resolvedH1[idxStart]||'').trim();
    let j=i+1;
    while(j<selected.length && (resolvedH1[selected[j]]||'').trim()===gname) j++;
    const colspan = j-i;
    htmlTop += `<th ${colspan>1?`colspan="${colspan}"`:''}>${escapeHtml(gname)}</th>`;
    i=j;
  }
  const htmlBottom = selected.map(ci=>{
    const t2 = (header2[ci]||'').trim() || (header1[ci]||'').trim();
    return `<th>${escapeHtml(t2)}</th>`;
  }).join('');

  thead.innerHTML = `
    <tr>${topFixed}${htmlTop}</tr>
    <tr>${htmlBottom}</tr>`;
  requestAnimationFrame(fixHeaderTop);
}
function renderBody(items, statusMap, dateGiven){
  const tbody=document.querySelector('#result tbody');
  const selected=[...selectedSkillIdx].sort((a,b)=>a-b);

  const rowsHtml = items.map(it=>{
    const name = String(it.r[0]||'');
    const branch = String(it.r[1]||'');
    const pct = it.pct || 0;
    const pctCls = pctClass(pct);

    let statChip = `<span class="chip">-</span>`;
    if(dateGiven){
      const st = statusMap.get(name);
      if(st==='standby') statChip = `<span class="chip stat-standby">Standby</span>`;
      else if(st==='busy') statChip = `<span class="chip stat-busy">Busy</span>`;
      else statChip = `<span class="chip stat-free">Free</span>`;
    }

    const skillCells = selected.map(ci=>{
      const v = String(it.r[ci]||'0');
      if(v==='2') return `<td class="skill"><span class="skill-pill" data-skill="2"><span class="dot"></span></span></td>`;
      if(v==='1') return `<td class="skill"><span class="skill-pill" data-skill="1"><span class="dot"></span></span></td>`;
      return `<td class="skill"><span class="skill-pill" data-skill="0">-</span></td>`;
    }).join('');

    return `
      <tr>
        <td class="sticky-name">${escapeHtml(name)}</td>
        <td class="sticky-branch">${escapeHtml(branch)}</td>
        <td class="sticky-match"><span class="chip ${pctCls}">${pct}%</span></td>
        <td class="sticky-status">${statChip}</td>
        ${skillCells}
      </tr>`;
  }).join('');

  const colSpan = 4 + selected.length;
  tbody.innerHTML = rowsHtml || `<tr><td class="sticky-name" colspan="${colSpan}">No results</td></tr>`;
}

/* keep row-2 header sticky aligned */
function fixHeaderTop(){
  const tr1 = document.querySelector('#result thead tr:first-child');
  if(!tr1) return;
  const h = Math.round(tr1.getBoundingClientRect().height);
  document.documentElement.style.setProperty('--head1', h+'px');
}

/* ===================== Events ===================== */
window.addEventListener('resize', fixHeaderTop);
document.getElementById('btnSearch').addEventListener('click', async ()=>{
  const t0 = performance.now();
  const useDate = document.getElementById('useDate').checked;
  const day = Number(document.getElementById('dDay').value||0);
  const mon = Number(document.getElementById('dMonth').value||0);
  const yr  = Number(document.getElementById('dYear').value||0);
  const chkBKK = document.getElementById('chkBKK').checked;
  const chkCBI = document.getElementById('chkCBI').checked;

  const items = getVisibleRows();

  let statusMap = new Map();
  const dateGiven = useDate && day>0 && mon>0 && yr>0;
  if(dateGiven){
    const ids=[]; if(chkBKK) ids.push(BKK_SHEET_ID); if(chkCBI) ids.push(CBI_SHEET_ID);
    statusMap = await fetchStatusMap(yr, mon, day, ids).catch(()=>new Map());
  }

  const rank = (nm)=>{
    if(!dateGiven) return 0;
    const st = statusMap.get(nm);
    if(st==='busy') return 2;
    if(st==='standby') return 1;
    return 0;
  };
  items.sort((a,b)=>{
    const an = String(a.r[0]||''), bn = String(b.r[0]||'');
    const ra = rank(an), rb = rank(bn);
    if(ra!==rb) return ra-rb;
    const pa = a.pct||0, pb = b.pct||0;
    if(pa!==pb) return pb-pa;
    return a.ri - b.ri;
  });

  renderHeader();
  renderBody(items, statusMap, dateGiven);
  requestAnimationFrame(fixHeaderTop);

  const took=Math.round(performance.now()-t0);
  document.getElementById('meta').textContent =
    `Found ${items.length} people | ${took} ms` + (dateGiven?` | ${String(day).padStart(2,'0')}/${String(mon).padStart(2,'0')}/${yr}${chkBKK?' | BKK':''}${chkCBI?' | CBI':''}`:'');
});

/* ===================== Init ===================== */
/* !! ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å loadSkills() ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÉ‡∏´‡πâ auth-guard ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå !! */
</script>

<!-- ========= AUTH GUARD (Firebase v9) ========= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  // ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å config.js (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Calendar)
  const FIREBASE_CONFIG = window.FIREBASE_CONFIG;
  const REQUIRE_ROLE    = window.REQUIRE_ROLE ?? true;
  const ALLOWED_ROLES   = Array.isArray(window.ALLOWED_ROLES) ? window.ALLOWED_ROLES : [];
  const LOGIN_URL       = window.LOGIN_URL || "index.html";

  const app  = initializeApp(FIREBASE_CONFIG);
  const auth = getAuth(app);
  const db   = getDatabase(app);

  const appRoot   = document.getElementById('app');
  const authGate  = document.getElementById('authGate');
  const whoamiEl  = document.getElementById('whoami');
  const logoutBtn = document.getElementById('logoutBtn');

  logoutBtn.addEventListener('click', async () => {
    try { await signOut(auth); } catch(e) {}
    const back = encodeURIComponent(location.href);
    location.replace(`${LOGIN_URL}?back=${back}`);
  });

  async function getProfile(uid){
    try {
      const snap = await get(ref(db, `users/${uid}`));
      if (!snap.exists()) return { name: null, role: null };
      const v = snap.val() || {};
      return { name: v.name ?? null, role: v.role ?? null };
    } catch(e){
      console.warn('get profile error', e);
      return { name: null, role: null };
    }
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      const back = encodeURIComponent(location.href);
      location.replace(`${LOGIN_URL}?back=${back}`);
      return;
    }

    const profile = await getProfile(user.uid);
    const role = profile.role;

    if (REQUIRE_ROLE) {
      if (!role) {
        alert('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏û‡∏ö role)');
        await signOut(auth);
        const back = encodeURIComponent(location.href);
        location.replace(`${LOGIN_URL}?back=${back}`);
        return;
      }
      if (ALLOWED_ROLES.length > 0 && !ALLOWED_ROLES.includes(role)) {
        alert(`‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ (role = ${role})`);
        await signOut(auth);
        const back = encodeURIComponent(location.href);
        location.replace(`${LOGIN_URL}?back=${back}`);
        return;
      }
      window.CURRENT_ROLE = role;
    }

    // ‡∏ú‡πà‡∏≤‡∏ô ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    authGate.style.display = 'none';
    appRoot.style.display  = '';
    whoamiEl.textContent   = profile.name ? `üëã ${profile.name}` : (user.email || user.uid);

    if (typeof window.loadSkills === 'function') window.loadSkills();
  });
</script>
</body>
</html>
