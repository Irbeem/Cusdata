<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ค้นหาคนตามสกิล + เช็ควันว่าง (YAPT)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
  :root{
    --row-h: 40px;
    --c-bg:#ffffff; --c-fg:#0f172a; --c-line:#e5e7eb; --c-head-bg:#111827; --c-head-fg:#ffffff;
    --accent:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#ea580c;
    --chip-bg:#eef2ff; --chip-border:#c7d2fe;
    --sticky-w-name: 180px; --sticky-w-branch: 120px; --sticky-w-match: 110px; --sticky-w-status: 120px;
  }
  html,body{height:100%;margin:0}
  body{background:var(--c-bg);color:var(--c-fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
  .wrap{max-width:1400px;margin:0 auto;padding:12px}
  h1{margin:0 0 10px}

  .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0 12px}
  .group{display:flex;gap:8px;align-items:center;border:1px solid var(--c-line);border-radius:12px;padding:8px 10px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .bar select,.bar input{height:40px;border:1px solid #d1d5db;border-radius:10px;padding:0 12px;background:#fff;color:#0f172a}
  .btn{height:40px;border:1px solid #d1d5db;background:var(--accent);color:#fff;border-radius:10px;padding:0 14px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .radio{display:flex;gap:10px;align-items:center}

  .skills{display:flex;flex-direction:column;gap:10px;margin:10px 0}
  details.skillgrp{border:1px solid var(--c-line);border-radius:12px;background:#fff}
  details.skillgrp summary{cursor:pointer;padding:10px 12px;font-weight:700;background:#f8fafc;border-bottom:1px solid var(--c-line);list-style:none}
  details.skillgrp[open] summary{border-bottom-color:#e5e7eb}
  .skillbox{display:flex;flex-wrap:wrap;gap:14px;padding:10px 12px}
  .skillbox label{display:flex;gap:6px;align-items:center;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;background:#fff;white-space:nowrap}

  .table-shell{border:1px solid var(--c-line);border-radius:12px;overflow:hidden;background:#fff;height:calc(100vh - 220px);min-height:360px}
  .scroll{overflow:auto;width:100%;height:100%}
  table{border-collapse:separate;border-spacing:0;min-width:1200px;width:max-content}
  thead th{position:sticky;top:0;background:var(--c-head-bg);color:var(--c-head-fg);z-index:4;border-bottom:1px solid var(--c-line);font-weight:700;height:42px;white-space:nowrap}
  th,td{padding:8px 10px;border-right:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb;height:var(--row-h);white-space:nowrap}
  tbody tr:nth-child(odd) td{background:#fafafa}

  /* Sticky columns (ผลลัพธ์) */
  .sticky-name{position:sticky;left:0;z-index:3;background:#f8fafc;min-width:var(--sticky-w-name)}
  .sticky-branch{position:sticky;left:var(--sticky-w-name);z-index:3;background:#f8fafc;min-width:var(--sticky-w-branch)}
  .sticky-match{position:sticky;left:calc(var(--sticky-w-name) + var(--sticky-w-branch));z-index:3;background:#f1f5f9;min-width:var(--sticky-w-match);text-align:center}
  .sticky-status{position:sticky;left:calc(var(--sticky-w-name) + var(--sticky-w-branch) + var(--sticky-w-match));z-index:3;background:#f1f5f9;min-width:var(--sticky-w-status);text-align:center}

  thead .sticky-name, thead .sticky-branch, thead .sticky-match, thead .sticky-status { z-index:5; background:var(--c-head-bg);}

  .chip{display:inline-block;min-width:52px;padding:2px 10px;border-radius:999px;border:1px solid var(--chip-border);background:var(--chip-bg);font-weight:700}
  .pct-good{background:#dcfce7;border-color:#86efac}
  .pct-mid{background:#fef9c3;border-color:#fde68a}
  .pct-low{background:#ffedd5;border-color:#fed7aa}

  .stat-free{background:#dcfce7;border:1px solid #86efac}
  .stat-busy{background:#fee2e2;border:1px solid #fecaca}

  /* ตัวบอกระดับสกิลแบบปุ่ม */
  .skill-dot{display:inline-flex;align-items:center;justify-content:center;gap:6px;width:56px;height:28px;border:1px solid #d1d5db;border-radius:14px;background:#fff}
  .dot{width:12px;height:12px;border-radius:50%;display:inline-block}
  .lv1{background:#22c55e;color:#fff}.lv1 .dot{background:#fff}
  .lv2{background:#2563eb;color:#fff}.lv2 .dot{background:#000}
  .lv0{background:#ffffff;color:#111}

  small.mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;opacity:.75}
  @media (max-width:900px){
    .wrap{padding:10px}
    .table-shell{height:calc(100vh - 260px)}
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>ค้นหาคนตามสกิล + เช็ควันว่าง (YAPT)</h1>

  <!-- Controls -->
  <div class="bar">
    <div class="group">
      <label>Branch:</label>
      <select id="filterBranch"><option value="*">All branch</option></select>
      <span class="radio" style="margin-left:8px">
        <label class="skill-dot lv1"><span class="dot"></span></label><small>= Can do (≥1)</small>
        <label class="skill-dot lv2" style="margin-left:8px"><span class="dot"></span></label><small>= Can teach (=2)</small>
      </span>
    </div>

    <div class="group">
      <label>โหมดจับคู่:</label>
      <label><input type="radio" name="mode" value="AND" checked/> AND (ต้องครบทุกสกิล)</label>
      <label><input type="radio" name="mode" value="OR"/> OR (อย่างน้อยหนึ่ง)</label>
      <label style="margin-left:8px">ระดับขั้นต่ำ:
        <select id="minLevel">
          <option value="1" selected>Can do (≥1)</option>
          <option value="2">Can teach (=2)</option>
        </select>
      </label>
    </div>

    <!-- วันที่ (วัน/เดือน/ปี) + ปฏิทินที่จะเช็ค -->
    <div class="group">
      <label>วันที่:</label>
      <input id="dDay"   type="number" min="1" max="31" placeholder="วัน" style="width:80px">
      <input id="dMonth" type="number" min="1" max="12" placeholder="เดือน" style="width:90px">
      <input id="dYear"  type="number" min="2020" max="2100" placeholder="ปี" style="width:100px">
      <label style="margin-left:8px"><input type="checkbox" id="chkBKK" checked> เช็ค BKK</label>
      <label><input type="checkbox" id="chkCBI" checked> เช็ค CBI</label>
    </div>

    <button class="btn" id="btnSearch">ค้นหา</button>
    <small id="meta" class="mono"></small>
  </div>

  <!-- กลุ่มสกิล (Head1 -> รายการ Head2) -->
  <div class="skills" id="skillGroups"></div>

  <!-- ผลลัพธ์ -->
  <div class="table-shell">
    <div class="scroll" id="scroller">
      <table id="result">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
// --- YAPT Skills Sheet (อ่านสกิล) ---
const SKILL_SHEET_ID = '1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k'; // ของคุณเดิม
const SKILL_GID = '0';
const SKILL_CSV = `https://docs.google.com/spreadsheets/d/${SKILL_SHEET_ID}/export?format=csv&gid=${SKILL_GID}`;

// --- Calendar Sheets (เช็ควันว่าง) ---
// BKK: ใช้ค่าเดียวกับหน้า BKK Calendar เดิมของคุณ
const BKK_SHEET_ID = '1ySiuPMVyrNOpNxx5fR0olf2Dbaq84zKVlVaVo6mFBi8';   // จาก config เดิมของคุณ :contentReference[oaicite:2]{index=2}
const BKK_CALENDAR_SHEET = 'Carlendar';
const BKK_NAMES_SHEET = 'Names';

// CBI: ใส่ไอดีชีตปฏิทิน CBI จริงของคุณที่นี่
const CBI_SHEET_ID = 'PUT_CBI_SHEET_ID_HERE';               // <-- แทนที่ด้วยไอดีจริง
const CBI_CALENDAR_SHEET = 'Carlendar';
const CBI_NAMES_SHEET = 'Names';

// helper for gviz
const gviz = (id, sheet) => `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}`;

/* ===================== STATE ===================== */
let header1=[], header2=[], rows=[];     // จาก YAPT
let groups=[];                           // [{title, items:[{idx, name}] }]
let selectedSkillIdx = new Set();        // index ของคอลัมน์สกิลที่เลือก

/* ===================== LOAD SKILLS ===================== */
async function loadSkills(){
  const text = await fetch(SKILL_CSV, {cache:'no-store'}).then(r=>r.text());
  const data = Papa.parse(text, {skipEmptyLines:false}).data || [];
  header1 = data[0]||[]; header2=data[1]||[]; rows = data.slice(2);
  buildGroups();
  populateBranch();
  renderSkillGroups();
}

// จัดกลุ่ม Head1 -> รายการ Head2 (ไม่พรีฟิกซ์ชื่อด้วย Head1 ตามที่ขอมาก่อนหน้า)
function buildGroups(){
  const n = Math.max(header1.length, header2.length);
  groups = [];
  let i=0;
  while(i<n){
    const h1 = (header1[i]||'').trim();
    if(i<2){ i++; continue; } // ข้าม Name, Branch
    if(!h1){ i++; continue; }
    // ช่วงกลุ่ม
    let j=i+1; while(j<n && (header1[j]||'').trim()==='') j++;
    const items=[];
    for(let k=i;k<j;k++){
      const name = (header2[k]||'').trim() || (header1[k]||'').trim() || `Skill ${k}`;
      items.push({idx:k, name});
    }
    groups.push({title:h1, items});
    i=j;
  }
}

/* ===================== UI: Branch / Skill Groups ===================== */
function uniqueBranches(){
  const seen=new Set(); const out=[];
  rows.forEach(r=>{
    const b=String(r[1]??'').trim();
    if(b && !seen.has(b)){ seen.add(b); out.push(b); }
  });
  out.sort((a,b)=>a.localeCompare(b,'en'));
  return out;
}
function populateBranch(){
  const sel=document.getElementById('filterBranch');
  const cur=sel.value||'*';
  const list=uniqueBranches();
  sel.innerHTML='<option value="*">All branch</option>'+list.map(b=>`<option value="${b}">${b}</option>`).join('');
  if([...sel.options].some(o=>o.value===cur)) sel.value=cur;
}

function renderSkillGroups(){
  const host=document.getElementById('skillGroups');
  host.innerHTML='';
  groups.forEach((g,gi)=>{
    const det=document.createElement('details');
    det.className='skillgrp'; det.open=true;  // ให้แสดงออกมาเลยทุกกลุ่ม
    det.innerHTML=`<summary>${g.title} <small class="mono">(${g.items.length})</small> <button type="button" class="btn-mini" data-act="all" style="margin-left:8px;border:1px solid #e5e7eb;background:#e5e7eb;border-radius:8px;padding:4px 8px;cursor:pointer">เลือกทั้งหมด</button> <button type="button" class="btn-mini" data-act="clear" style="margin-left:6px;border:1px solid #e5e7eb;background:#fff;border-radius:8px;padding:4px 8px;cursor:pointer">ล้าง</button></summary>`;
    const box=document.createElement('div');
    box.className='skillbox';
    g.items.forEach(it=>{
      const id=`sk_${it.idx}`;
      const lbl=document.createElement('label');
      lbl.innerHTML=`<input type="checkbox" id="${id}" data-idx="${it.idx}"> ${escapeHtml(it.name)}`;
      box.appendChild(lbl);
    });
    det.appendChild(box);
    det.querySelector('.btn-mini[data-act="all"]').onclick=()=>{
      box.querySelectorAll('input[type="checkbox"]').forEach(ch=>{ch.checked=true; selectedSkillIdx.add(Number(ch.dataset.idx));});
    };
    det.querySelector('.btn-mini[data-act="clear"]').onclick=()=>{
      box.querySelectorAll('input[type="checkbox"]').forEach(ch=>{ch.checked=false; selectedSkillIdx.delete(Number(ch.dataset.idx));});
    };
    // track change
    box.addEventListener('change',(e)=>{
      const ch=e.target.closest('input[type="checkbox"]'); if(!ch) return;
      const idx=Number(ch.dataset.idx);
      if(ch.checked) selectedSkillIdx.add(idx); else selectedSkillIdx.delete(idx);
    });
    host.appendChild(det);
  });
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* ===================== SEARCH + AVAILABILITY ===================== */
function getVisibleRows(){
  const branch=document.getElementById('filterBranch').value||'*';
  const indices=[...selectedSkillIdx];
  const minLv=Number(document.getElementById('minLevel').value||1);
  const mode=document.querySelector('input[name="mode"]:checked')?.value||'AND';

  const visible=[];
  rows.forEach((r,ri)=>{
    if(branch!=='*' && String(r[1]||'').trim()!==branch) return;
    if(indices.length===0){ visible.push({ri, r, matchedCols:[]}); return; }
    const vals = indices.map(ci => Number(r[ci]||0) );
    const pass = (mode==='AND')
      ? vals.every(v => v>=minLv)
      : vals.some(v => v>=minLv);
    if(pass){
      const matchedCols = indices.filter(ci => Number(r[ci]||0)>=minLv);
      visible.push({ri,r,matchedCols});
    }
  });
  return visible;
}

// match % (สีตามเกณฑ์ ≥80 เขียว, 50–79 เหลือง, ต่ำกว่า ส้ม — เหมือนหน้าที่คุณสั่งไว้)
function calcMatchPercent(item, totalSelected){
  if(totalSelected===0) return 0;
  return Math.round((item.matchedCols.length / totalSelected) * 100);
}
function pctClass(p){ if(p>=80) return 'pct-good'; if(p>=50) return 'pct-mid'; return 'pct-low'; }

// โหลดรายชื่อ “คนไม่ว่าง” จากปฏิทินในวันนั้น ๆ (รวมหลายชีตตามที่ติ๊ก)
async function fetchBusyNameSet(y,m,d, useBKK, useCBI){
  const fetchSet = async (sheetId, calSheet) => {
    const txt = await fetch(gviz(sheetId, calSheet), {cache:'no-store'}).then(r=>r.text());
    const json = JSON.parse(txt.substring(47).slice(0,-2));
    const cols = json.table.cols.map(c=>c.label);
    // อ้างโครงสร้าง Year/Month/Date/Name จากหน้า Calendar เดิมของคุณ :contentReference[oaicite:3]{index=3}
    const Y = cols.indexOf('Year'), M = cols.indexOf('Month'), D = cols.indexOf('Date'), N = cols.indexOf('Name');
    const set=new Set();
    json.table.rows.forEach(row=>{
      const c=row.c;
      const yy = c[Y]?.v || c[Y]?.f || c[Y] || '';
      const mm = c[M]?.v || c[M]?.f || c[M] || '';
      const dd = c[D]?.v || c[D]?.f || c[D] || '';
      const nm = (c[N]?.v || '').toString();
      if(Number(yy)===Number(y) && Number(mm)===Number(m) && Number(dd)===Number(d) && nm){ set.add(nm); }
    });
    return set;
  };

  const allSets=[];
  if(useBKK && BKK_SHEET_ID!=='PUT_BKK_SHEET_ID_HERE'){
    allSets.push( fetchSet(BKK_SHEET_ID, BKK_CALENDAR_SHEET) );
  }
  if(useCBI && CBI_SHEET_ID!=='PUT_CBI_SHEET_ID_HERE'){
    allSets.push( fetchSet(CBI_SHEET_ID, CBI_CALENDAR_SHEET) );
  }
  if(allSets.length===0) return new Set();

  const results = await Promise.allSettled(allSets);
  const busy = new Set();
  results.forEach(res=>{
    if(res.status==='fulfilled'){
      res.value.forEach(n=>busy.add(n));
    }
  });
  return busy;
}

/* ===================== RENDER RESULT ===================== */
function renderResultHeader(){
  const thead=document.querySelector('#result thead');
  // แถวหัวตาราง 2 ชั้น: ชั้นบนคือ Head1, ชั้นล่างคือ Head2 (เฉพาะคอลัมน์ที่ผู้ใช้เลือก)
  const selected=[...selectedSkillIdx].sort((a,b)=>a-b);
  // ตัดต่อคอลัมน์ L/R sticky ก่อน
  const stickyRowTop = `
    <tr>
      <th class="sticky-name">Name</th>
      <th class="sticky-branch">Branch</th>
      <th class="sticky-match">Match %</th>
      <th class="sticky-status">Status</th>
      ${buildHead1Cells(selected)}
    </tr>`;
  const second = `
    <tr>
      <th class="sticky-name"></th>
      <th class="sticky-branch"></th>
      <th class="sticky-match"></th>
      <th class="sticky-status"></th>
      ${buildHead2Cells(selected)}
    </tr>`;
  thead.innerHTML = stickyRowTop + second;
}
function buildHead1Cells(selected){
  let html='';
  let i=0;
  while(i<selected.length){
    const start = selected[i];
    const title = (header1[start]||'').trim() || (header2[start]||'').trim();
    // นับ colspan ต่อเนื่องภายใต้ head1 เดียวกัน
    let j=i+1;
    while(j<selected.length && (header1[selected[j]]||'').trim()===(header1[start]||'').trim()) j++;
    const colspan = j-i;
    html += `<th ${colspan>1?`colspan="${colspan}"`:''}>${escapeHtml(title)}</th>`;
    i=j;
  }
  return html;
}
function buildHead2Cells(selected){
  return selected.map(ci=>`<th>${escapeHtml((header2[ci]||'').trim() || (header1[ci]||'').trim())}</th>`).join('');
}

function renderResultBody(items, totalSelected, busySet){
  const tbody=document.querySelector('#result tbody');
  const selected=[...selectedSkillIdx].sort((a,b)=>a-b);

  const rowsHtml = items.map(it=>{
    const name = String(it.r[0]||'');
    const branch = String(it.r[1]||'');
    const pct = calcMatchPercent(it, totalSelected);
    const pctCls = pctClass(pct);

    const busy = busySet?.has(name);
    const statChip = busy ? `<span class="chip stat-busy">Busy</span>` : `<span class="chip stat-free">Free</span>`;

    const skillCells = selected.map(ci=>{
      const v = String(it.r[ci]||'0');
      if(v==='2') return `<td style="text-align:center"><span class="skill-dot lv2"><span class="dot"></span></span></td>`;
      if(v==='1') return `<td style="text-align:center"><span class="skill-dot lv1"><span class="dot"></span></span></td>`;
      return `<td style="text-align:center"><span class="skill-dot lv0">-</span></td>`;
    }).join('');

    return `
      <tr>
        <td class="sticky-name">${escapeHtml(name)}</td>
        <td class="sticky-branch">${escapeHtml(branch)}</td>
        <td class="sticky-match"><span class="chip ${pctCls}">${pct}%</span></td>
        <td class="sticky-status">${statChip}</td>
        ${skillCells}
      </tr>`;
  }).join('');

  tbody.innerHTML = rowsHtml || `<tr><td class="sticky-name" colspan="${4 + selected.length}">ไม่พบผลลัพธ์</td></tr>`;
}

/* ===================== EVENT: SEARCH ===================== */
document.getElementById('btnSearch').addEventListener('click', async ()=>{
  const t0 = performance.now();
  const day = Number(document.getElementById('dDay').value||0);
  const mon = Number(document.getElementById('dMonth').value||0);
  const yr  = Number(document.getElementById('dYear').value||0);
  const useBKK = document.getElementById('chkBKK').checked;
  const useCBI = document.getElementById('chkCBI').checked;

  const items = getVisibleRows();
  // เรียง “Free มาก่อน” จาก busySet ภายหลัง
  let busySet = new Set();
  const dateGiven = (day>0 && mon>0 && yr>0);

  if(dateGiven){
    try{
      busySet = await fetchBusyNameSet(yr, mon, day, useBKK, useCBI);
    }catch(e){ console.warn('availability error', e); }
  }

  // sort: Free ก่อน, จากนั้นตามชื่อ
  items.sort((a,b)=>{
    const an = String(a.r[0]||''), bn = String(b.r[0]||'');
    const af = busySet.has(an)?1:0, bf = busySet.has(bn)?1:0;
    if(af!==bf) return af-bf;
    return an.localeCompare(bn,'en');
  });

  renderResultHeader();
  renderResultBody(items, selectedSkillIdx.size, busySet);

  const took = Math.round(performance.now()-t0);
  document.getElementById('meta').textContent = `พบ ${items.length} คน | ใช้เวลา ${took} ms` + (dateGiven?` | ตรวจว่างวันที่ ${day}/${mon}/${yr}`:'');
});

/* ===================== INIT ===================== */
loadSkills().catch(err=>{
  console.error(err);
  alert('โหลดข้อมูลสกิลไม่สำเร็จ');
});
</script>
</body>
</html>
