<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YAPT Skills</title>
  <style>
    :root{
      --sticky-left-0:0px;--sticky-left-1:0px;
      --head1:40px; --row-h:40px;
      --c-bg:#ffffff;--c-fg:#0f172a;--c-line:#e5e7eb;--c-head-bg:#111827;--c-head-fg:#ffffff;
      --danger:#ef4444; --accent:#2563eb;
      --edited-bg:#fff7ed; --edited-border:#fb923c;
    }
    html,body{height:100%;margin:0}
    body{background:var(--c-bg);color:var(--c-fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
    .wrap{width:100vw;max-width:none;margin:0;padding:12px}
    .bar{display:flex;gap:8px;align-items:center;justify-content:flex-start;margin:4px 0 8px;flex-wrap:wrap}
    .bar select,.bar input{height:40px;border:1px solid #d1d5db;border-radius:10px;padding:0 12px;background:#fff;color:#0f172a}
    .btn{height:36px;border:1px solid #d1d5db;background:var(--accent);color:#fff;border-radius:10px;padding:0 12px;cursor:pointer}
    .btn.danger{background:var(--danger);border-color:#dc2626}
    .btn.secondary{background:#6b7280;border-color:#9ca3af}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .table-shell{border:1px solid var(--c-line);border-radius:12px;overflow:hidden;background:#fff;height:calc(100vh - 106px)}
    .scroll{overflow:auto;width:100%;height:calc(100% - 40px)}
    table{border-collapse:separate;border-spacing:0;min-width:1100px;width:100%}
    thead th{position:sticky;top:0;background:var(--c-head-bg);color:var(--c-head-fg);z-index:4;border-bottom:1px solid var(--c-line);font-weight:700}
    thead tr:nth-child(1) th{top:0}
    thead tr:nth-child(2) th{top:var(--head1)}
    th,td{padding:8px 10px;border-right:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb;height:var(--row-h);white-space:nowrap}
    tbody tr:nth-child(odd) td{background:#fafafa}
    .sticky-col-0{position:sticky;left:var(--sticky-left-0);z-index:3;background:#f8fafc}
    .sticky-col-1{position:sticky;left:var(--sticky-left-1);z-index:3;background:#f8fafc}
    thead .sticky-col-0, thead .sticky-col-1{z-index:5;background:var(--c-head-bg)}
    td.edited{ background: var(--edited-bg); box-shadow: inset 0 0 0 2px var(--edited-border); }
    td.skill-td{ text-align:center; }
    .skill-btn{ display:inline-flex; align-items:center; justify-content:center; gap:6px; width:56px; height:28px; border:1px solid #d1d5db; border-radius:14px; background:#fff; cursor:pointer; user-select:none; }
    .skill-btn .dot{ width:12px; height:12px; border-radius:50%; display:inline-block; }
    .skill-btn[data-skill="0"]{ background:#ffffff; color:#111827; }
    .skill-btn[data-skill="1"]{ background:#22c55e; color:#ffffff; }
    .skill-btn[data-skill="2"]{ background:#2563eb; color:#ffffff; }
    .skill-btn:focus{ outline:2px solid #93c5fd; outline-offset:2px; }
    .foot{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;height:40px;border-top:1px solid var(--c-line);background:#f9fafb}
    .legend{display:flex;gap:10px;align-items:center}
    .legend .chip{display:inline-block;width:14px;height:14px;border-radius:4px;background:var(--edited-bg);box-shadow: inset 0 0 0 2px var(--edited-border)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 6px">YAPT Skills</h1>

    <div class="bar">
      <select id="filterBranch" title="Filter branch">
        <option value="*">All branch</option>
      </select>

      <button class="btn" id="saveBtn">UPDATE SKILL</button>
      <button class="btn secondary" id="cancelBtn">Cancel edits</button>

      <input id="newName" placeholder="name" />
      <input id="newBranch" placeholder="branch" />
      <button class="btn" id="addRowBtn">Add new engineer</button>
      <button class="btn danger" id="delByNameBtn">Delete name</button>

      <span id="saving" style="display:none;color:#2563eb;margin-left:8px">Working…</span>
    </div>

    <div class="table-shell">
      <div class="scroll" id="scroller">
        <table id="grid"><thead id="thead"></thead><tbody id="tbody"></tbody></table>
      </div>
      <div class="foot">
        <small>Columns <b>name</b> and <b>branch</b> are fixed — 2 header rows remain sticky while scrolling.</small>
        <div class="legend"><span class="chip"></span><small>Edited cell (waiting to save)</small></div>
      </div>
    </div>
  </div>

<script>
const SHEET_ID='1dXM6Coiuj4KKdAjoi-5L7oErf2T6EFZW6xDpy5GCs8k';
const GID='0';
const CSV_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;
const GAS_URL='https://script.google.com/macros/s/AKfycbyKXUiyvt_LHeRBSiWyOinkdK3w-OSlkpLwXbSwHIjWgXW9ACycZio_TTKu6nC-HUSExA/exec';

let header1=[],header2=[],rows=[],originalRows=[];
const edits=new Map();
const editedCells=new Set();
const inflight={add:false,save:false,del:false};
const thead=document.getElementById('thead');
const tbody=document.getElementById('tbody');
const filterEl=document.getElementById('filterBranch');

function makeRequestId(){return'req_'+Date.now()+'_'+Math.random().toString(36).slice(2,8);}

async function fetchCsvAll(){const r=await fetch(CSV_URL,{cache:'no-store'});if(!r.ok)throw new Error('Load CSV failed: '+r.status);return Papa.parse(await r.text(),{skipEmptyLines:false}).data||[];}
async function fetchCsvRows(){const d=await fetchCsvAll();return d.slice(2);}

function uniqueBranches(list){const s=new Set(),o=[];list.forEach(r=>{const b=String(r[1]||'').trim();if(b&&!s.has(b)){s.add(b);o.push(b);}});o.sort((a,b)=>a.localeCompare(b,'en'));return o;}
function populateFilter(){const cur=filterEl.value||'*';const b=uniqueBranches(rows);filterEl.innerHTML='<option value="*">All branch</option>'+b.map(v=>`<option value="${v}">${v}</option>`).join('');if([...filterEl.options].some(o=>o.value===cur))filterEl.value=cur;}

function fixHeaderTop(){const tr1=thead.querySelector('tr:first-child');if(!tr1)return;const h=Math.round(tr1.getBoundingClientRect().height);document.documentElement.style.setProperty('--head1',h+'px');}
function updateStickyLefts(){const f=tbody.querySelector('tr');if(!f)return;const w0=f.children[0]?.getBoundingClientRect().width||160;document.documentElement.style.setProperty('--sticky-left-0','0px');document.documentElement.style.setProperty('--sticky-left-1',w0+'px');}

function makeDot(c){const s=document.createElement('span');s.className='dot';s.style.background=c;return s;}
function setSkillVisual(b,v){b.dataset.skill=String(v);b.innerHTML='';if(v==='0'){b.textContent='-';}else if(v==='1'){b.appendChild(makeDot('#ffffff'));}else{b.appendChild(makeDot('#000000'));}}
function createSkillControl(v,r,c,td){const b=document.createElement('button');b.type='button';b.className='skill-btn';setSkillVisual(b,v);b.addEventListener('click',()=>{const cur=Number(rows[r]?.[c]??0)||0;const next=(cur+1)%3;const cp=rows[r]?rows[r].slice():[];cp[c]=String(next);rows[r]=cp;edits.set(r+2,cp);td.classList.add('edited');editedCells.add(`${r}|${c}`);setSkillVisual(b,next);});return b;}

function renderHeader(h1,h2){const tr1=document.createElement('tr'),tr2=document.createElement('tr');const n=Math.max(h1.length,h2.length);let i=0;while(i<n){const title=(h1[i]||'').trim();if(i===0||i===1){const th=document.createElement('th');th.textContent=title||(i===0?'name':'branch');th.classList.add(i===0?'sticky-col-0':'sticky-col-1');th.rowSpan=2;tr1.appendChild(th);i++;continue;}if(!title){const th=document.createElement('th');th.rowSpan=2;tr1.appendChild(th);i++;continue;}let j=i+1;while(j<n&&(h1[j]||'').trim()==='')j++;const groupEnd=j,colspan=Math.max(1,groupEnd-i);let hasSub=false;for(let k=i;k<groupEnd;k++){if((h2[k]||'').trim()!==''){hasSub=true;break;}}const thGroup=document.createElement('th');thGroup.textContent=title;if(hasSub)thGroup.colSpan=colspan;else thGroup.rowSpan=2;tr1.appendChild(thGroup);if(hasSub){for(let k=i;k<groupEnd;k++){const th2=document.createElement('th');th2.textContent=(h2[k]||'').trim();tr2.appendChild(th2);}}i=groupEnd;}thead.innerHTML='';thead.append(tr1,tr2);}

function getVisibleRowIndices(){const v=filterEl?.value||'*';if(v==='*')return rows.map((_,i)=>i);const out=[];rows.forEach((r,i)=>{if(String(r[1]||'').trim()===v)out.push(i);});return out;}

function renderBody(){tbody.innerHTML='';const vis=getVisibleRowIndices();vis.forEach(rIdx=>{const r=rows[rIdx]||[];const tr=document.createElement('tr');tr.dataset.index=rIdx;const cols=Math.max(r.length,header1.length,header2.length);for(let c=0;c<cols;c++){const td=document.createElement('td');const v=r[c]||'';if(c===0){td.textContent=v;td.classList.add('sticky-col-0');}else if(c===1){td.textContent=v;td.classList.add('sticky-col-1');}else{td.classList.add('skill-td');const ctrl=createSkillControl(v,rIdx,c,td);td.appendChild(ctrl);}if(editedCells.has(`${rIdx}|${c}`))td.classList.add('edited');tr.appendChild(td);}tbody.appendChild(tr);});}

async function loadCsv(){try{const d=await fetchCsvAll();if(!d||d.length<2)throw new Error('CSV format incorrect (need 2 header rows)');header1=d[0]||[];header2=d[1]||[];rows=d.slice(2);originalRows=rows.map(r=>r.slice());populateFilter();render();}catch(e){console.error(e);alert('Load failed: '+e.message+'\nCheck Sheet permissions');thead.innerHTML='';tbody.innerHTML='';}}

async function onSave(){if(inflight.save)return;inflight.save=true;const updates=Array.from(edits.entries()).map(([i,v])=>({sheetRowIndex:i,rowValues:v}));if(updates.length===0){alert('No changes');inflight.save=false;return;}const payload={requestId:makeRequestId(),updates};const saving=document.getElementById('saving');try{saving.style.display='inline';let ok=false;try{const res=await fetch(GAS_URL,{method:'POST',mode:'cors',headers:{'Content-Type':'text/plain;charset=UTF-8'},body:JSON.stringify(payload)});await res.text();ok=res.ok;}catch{ok=false;}edits.clear();editedCells.clear();await loadCsv();alert('Saved');}catch(e){alert('Save failed: '+e.message);console.error(e);}finally{saving.style.display='none';inflight.save=false;}}

function cancelEdits(){if(!originalRows||!originalRows.length){alert('No changes');return;}rows=originalRows.map(r=>r.slice());edits.clear();editedCells.clear();renderBody();requestAnimationFrame(()=>updateStickyLefts());alert('Edits cancelled');}

document.getElementById('saveBtn').addEventListener('click',onSave);
document.getElementById('cancelBtn').addEventListener('click',cancelEdits);
window.addEventListener('resize',()=>{updateStickyLefts();fixHeaderTop();});
filterEl.addEventListener('change',()=>{renderBody();requestAnimationFrame(updateStickyLefts);});
loadCsv();
</script>
</body>
</html>
