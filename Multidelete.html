<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>CS Calendar ‚Äî Multiple Delete</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; padding: 16px; line-height: 1.5; }
    h1 { margin: 0 0 12px; }
    .gate { padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; margin-bottom: 12px; }
    .ok { color: #0a7; font-weight: 600; }
    .warn { color: #c00; font-weight: 600; }

    form { max-width: 900px; }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; margin-top: 10px; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    .col-3 { grid-column: span 3; }
    .col-12 { grid-column: span 12; }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    input, select, button { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; }
    select[multiple] { height: 300px; overflow-y: auto; scroll-behavior: smooth; }
    .hint { font-size: 12px; color: #666; margin-top: 4px; }
    .btn { cursor: pointer; border: none; border-radius: 10px; padding: 12px 16px; font-weight: 600; }
    .btn-primary { background: #d32f2f; color: #fff; }
    .btn-primary:disabled { opacity: .6; cursor: not-allowed; }
    .btn-light { background: #eee; }
    .toolbar { display: flex; gap: 8px; align-items:center; margin: 12px 0; }
    .result { margin-top: 12px; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .flex { display: flex; gap: 8px; align-items: center; }
    .checkbox { width: auto; }
  </style>

  <script type="module">
    /***** Firebase imports *****/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    /***** Config (‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) *****/
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyCWTkIN4dKaRI1ZlyHxxhxovhoMGF_8wPc",
      authDomain: "cusdata-51e4f.firebaseapp.com",
      databaseURL: "https://cusdata-51e4f-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "cusdata-51e4f"
    };

    // ‡∏´‡∏ô‡πâ‡∏≤ login (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ)
    const LOGIN_PAGE_URL = "./index.html";

    // Endpoint ‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ calendar ‡πÉ‡∏ä‡πâ)
    const GOOGLE_SHEET_NAMES_URL = "https://script.google.com/macros/s/AKfycbzr7NVLwYbYDQfaF6Y5SWWwlpKKLnIp_KZUQ8NF9_gXUj7R3tmSEum7yS_Z_A5y23Wi/exec";
    const SUBMIT_URL             = "https://script.google.com/macros/s/AKfycbzr7NVLwYbYDQfaF6Y5SWWwlpKKLnIp_KZUQ8NF9_gXUj7R3tmSEum7yS_Z_A5y23Wi/exec";

    // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö role
    const REQUIRE_ROLE  = true;
    const ALLOWED_ROLES = ["admin"]; // <‚Äî ‡∏•‡∏ö/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£

    /***** Firebase init *****/
    const app  = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    /***** DOM *****/
    const gateBox   = document.getElementById("gate");
    const whoBox    = document.getElementById("who");
    const formEl    = document.getElementById("delForm");
    const namesSel  = document.getElementById("nameDropdown");
    const datesSel  = document.getElementById("dateSelect");
    const typeSel   = document.getElementById("typeSelect");
    const yearInp   = document.getElementById("yearInput");
    const monthInp  = document.getElementById("monthInput");
    const ignoreTypeChk = document.getElementById("ignoreType");
    const resultEl  = document.getElementById("result");

    const actorNameHidden = document.getElementById("actorName");

    // preset ‡∏õ‡∏µ/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    (function presetYM(){
      const now = new Date();
      yearInp.value  = now.getFullYear();
      monthInp.value = now.getMonth() + 1;
    })();

    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å Sheet
    async function loadNames(){
      const res   = await fetch(GOOGLE_SHEET_NAMES_URL);
      const names = await res.json();
      namesSel.innerHTML = names.map(n => `<option value="${n}">${n}</option>`).join("");
    }

    // ‡∏≠‡πà‡∏≤‡∏ô role + name ‡∏à‡∏≤‡∏Å RTDB
    async function getUserProfile(uid){
      try {
        const snap = await get(ref(db, `users/${uid}`));
        return snap.exists() ? snap.val() : { name: null, role: null };
      } catch (e) {
        console.error("getUserProfile error:", e);
        return { name: null, role: null };
      }
    }

    // Auth gate
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        gateBox.innerHTML = `<span class="warn">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</span> ‚Üí ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login...`;
        const back = encodeURIComponent(location.href);
        location.replace(`${LOGIN_PAGE_URL}?back=${back}`);
        return;
      }

      // ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
      const profile = await getUserProfile(user.uid);
      whoBox.textContent = `‡∏Ñ‡∏∏‡∏ì: ${profile?.name || user.email || "Unknown"} (${profile?.role || "no-role"})`;
      actorNameHidden.value = profile?.name || user.email || "";

      // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö role
      if (REQUIRE_ROLE) {
        const role = profile?.role || null;
        if (!role) {
          alert("‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ role");
          await signOut(auth);
          const back = encodeURIComponent(location.href);
          location.replace(`${LOGIN_PAGE_URL}?back=${back}`);
          return;
        }
        if (ALLOWED_ROLES.length && !ALLOWED_ROLES.includes(role)) {
          alert(`‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ (role = ${role})`);
          await signOut(auth);
          const back = encodeURIComponent(location.href);
          location.replace(`${LOGIN_PAGE_URL}?back=${back}`);
          return;
        }
      }

      // ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
      try {
        await loadNames();
        gateBox.innerHTML = `<span class="ok">‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡πâ‡∏ß</span>`;
      } catch (e) {
        console.error(e);
        gateBox.innerHTML = `<span class="warn">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`;
      }
    });

    // ‡∏•‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    formEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = formEl.querySelector("button[type=submit]");
      btn.disabled = true;

      const names  = Array.from(namesSel.selectedOptions).map(o => o.value);
      const dates  = Array.from(datesSel.selectedOptions).map(o => o.value);
      const year   = yearInp.value.trim();
      const month  = monthInp.value.trim();
      let   type   = typeSel.value;

      if (ignoreTypeChk.checked) {
        // ‡∏™‡πà‡∏á type ‡∏ß‡πà‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ GAS branch ‡∏ó‡∏µ‡πà‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡πÑ‡∏õ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ loop ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ type)
        type = "";
      }

      if (!actorNameHidden.value) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö actorName ‡∏à‡∏≤‡∏Å Firebase");
        btn.disabled = false;
        return;
      }
      if (!names.length)  { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠"); btn.disabled=false; return; }
      if (!dates.length)  { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏±‡∏ô"); btn.disabled=false; return; }
      if (!year || !month){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏õ‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"); btn.disabled=false; return; }

      let ok = 0, fail = 0, total = 0;
      resultEl.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...";

      for (const n of names) {
        for (const d of dates) {
          const fd = new FormData();
          fd.set("action", "delete");
          fd.set("year", year);
          fd.set("month", month);
          fd.set("date", d);
          fd.set("name", n);
          fd.set("type", type);               // ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤ check 'ignore type'
          fd.set("actorName", actorNameHidden.value); // ‡∏™‡πà‡∏á‡πÑ‡∏õ log

          try {
            const r = await fetch(SUBMIT_URL, { method: "POST", body: fd });
            if (r.ok) ok++; else fail++;
          } catch (err) {
            console.error(err);
            fail++;
          }
          total++;
        }
      }

      resultEl.textContent = `‚úÖ ‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${ok}  ‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${fail}  (‡∏£‡∏ß‡∏° ${total})`;
      btn.disabled = false;
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠
    document.getElementById("thisMonth").addEventListener("click", () => {
      const now = new Date();
      yearInp.value  = now.getFullYear();
      monthInp.value = now.getMonth() + 1;
    });
    document.getElementById("prevMonth").addEventListener("click", () => {
      let y = +yearInp.value, m = +monthInp.value;
      m--; if (m < 1) { m = 12; y--; }
      yearInp.value = y; monthInp.value = m;
    });
    document.getElementById("nextMonth").addEventListener("click", () => {
      let y = +yearInp.value, m = +monthInp.value;
      m++; if (m > 12) { m = 1; y++; }
      yearInp.value = y; monthInp.value = m;
    });

    // logout link
    document.getElementById("logout").addEventListener("click", async () => {
      try { await signOut(auth); } catch {}
      const back = encodeURIComponent(location.href);
      location.replace(`${LOGIN_PAGE_URL}?back=${back}`);
    });
  </script>
</head>
<body>
  <h1>üóëÔ∏è CS Calendar ‚Äî Multiple Delete</h1>

  <div class="gate" id="gate">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‚Ä¶</div>
  <div class="gate"><span id="who">‡∏Ñ‡∏∏‡∏ì: -</span> ‚Ä¢ <button id="logout" class="btn btn-light" style="width:auto">Logout</button></div>

  <form id="delForm">
    <div class="toolbar">
      <button type="button" class="btn btn-light" id="prevMonth">‚üµ Prev</button>
      <button type="button" class="btn btn-light" id="thisMonth">This Month</button>
      <button type="button" class="btn btn-light" id="nextMonth">Next ‚ü∂</button>
    </div>

    <div class="row">
      <div class="col-3">
        <label>Year</label>
        <input id="yearInput" type="number" required />
      </div>
      <div class="col-3">
        <label>Month</label>
        <input id="monthInput" type="number" min="1" max="12" required />
      </div>
      <div class="col-6">
        <label>Type (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)</label>
        <select id="typeSelect">
          <option value="Service">Service</option>
          <option value="Standby">Standby</option>
          <option value="Meeting">Meeting</option>
          <option value="Inspection">Inspection</option>
          <option value="Telephone">Telephone</option>
          <option value="Training">Training</option>
          <option value="TrainingSafety">TrainingSafety</option>
          <option value="LTC">LTC</option>
          <option value="Warranty">Warranty</option>
          <option value="RepairPP">RepairPP</option>
          <option value="Sales">Sales</option>
          <option value="Holiday">Holiday</option>
          <option value="Leave">Leave</option>
          <option value="SafetyHealth">SafetyHealth</option>
          <option value="Other">Other</option>
        </select>
        <div class="flex" style="margin-top:8px;">
          <input id="ignoreType" class="checkbox" type="checkbox" />
          <label for="ignoreType" style="font-weight:400;margin:0;">‡∏•‡∏ö‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô (‡∏™‡πà‡∏á type ‡∏ß‡πà‡∏≤‡∏á)</label>
        </div>
        <div class="hint">* ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡∏õ‡∏µ/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏ß‡∏±‡∏ô/‡∏ä‡∏∑‡πà‡∏≠ ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ type (‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î Apps Script ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ)</div>
      </div>
    </div>

    <div class="row">
      <div class="col-6">
        <label>‡∏ä‡∏∑‡πà‡∏≠ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô ‚Äî Ctrl/Shift ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</label>
        <select id="nameDropdown" multiple required>
          <option>-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î --</option>
        </select>
      </div>

      <div class="col-6">
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‚Äî Ctrl/Shift ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</label>
        <select id="dateSelect" multiple required size="16">
          <script>for (let i=1;i<=31;i++) document.write(`<option value="${i}">${i}</option>`);</script>
        </select>
      </div>
    </div>

    <!-- ‡∏™‡πà‡∏á‡πÑ‡∏õ log ‡∏î‡πâ‡∏ß‡∏¢ -->
    <input type="hidden" id="actorName" name="actorName" value="" />

    <div class="row">
      <div class="col-12">
        <button type="submit" class="btn btn-primary">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
      </div>
    </div>
  </form>

  <pre id="result" class="result"></pre>
</body>
</html>
