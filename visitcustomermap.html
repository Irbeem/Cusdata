<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multi-Customer Visit Plan - FINAL FULL PRINTABLE</title>

  <!-- Tom Select -->
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- Leaflet + OSM (ฟรี) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Routing Machine (ใช้ OSRM demo server ฟรี) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <style>
    body { font-family: sans-serif; margin: 20px; }
    .container { display: flex; }
    .left-panel { width: 50%; padding-right: 20px; }
    .right-panel { width: 50%; page-break-before: always; }
    .customer-container { display: flex; flex-wrap: wrap; gap: 20px; }
    .customer-card { border: 1px solid #ccc; padding: 15px; border-radius: 8px; box-shadow: 2px 2px 8px rgba(0,0,0,0.1); width: 100%; max-width: 100%; position: relative; margin: auto; }
    .remove-btn {
      position: absolute; top: 8px; right: 8px; background: red; color: white; border: none; border-radius: 50%;
      width: 24px; height: 24px; font-weight: bold; font-size: 40px; cursor: pointer;
      display: flex; justify-content: center; align-items: center;
    }
    input, select { padding: 6px; margin: 4px 0; border-radius: 4px; border: 1px solid #ccc; width: 100%; }
    textarea { padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; width: 95%; resize: none; overflow: hidden; }
    button { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; margin-top: 10px; }
    .green { background-color: #28a745; color: white; }
    label { background-color: #007bff; color: white; padding: 4px 8px; border-radius: 4px; display: inline-block; margin-top: 8px; }
    #map { height: 500px; margin-top: 20px; }
    .summary-container { display: block; }
    .summary-block { border: 2px solid #2c3e50; border-radius: 6px; padding: 10px; background-color: #ecf0f1; margin-bottom: 20px; }
    .summary-block h4 { background-color: #2980b9; color: white; padding: 6px; border-radius: 4px; text-align: center; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    .compact-input { width: 160px; display: inline-block; }
    #routeSummary { page-break-before: always; }

    /* ปรับ UI Routing Machine ให้เรียบ ๆ */
    .leaflet-routing-container { display: none; } /* ซ่อนวิดเจ็ต LRM (เราสรุปเอง) */

    @media print {
      .container { display: block; }
      .left-panel, .right-panel { width: 100%; }
      button, .remove-btn { display: none; }
      .customer-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; }
      .customer-card { page-break-inside: avoid; width: 80%; }
      .summary-block:not(:first-child) { page-break-before: always; }
    }
  </style>
</head>
<body>
<h2>Customer Visit Plan : <span id="loginNameDisplay"></span></h2>

<div class="container">
  <div class="left-panel">
    <label>Visit Date:</label>
    <input type="date" id="visitDateInput"><br>

    <label>Start From:</label>
    <select id="originSelect">
      <option value="13.784431483421942,100.58041213808076">Yaskawa BKK</option>
      <option value="13.092777336086302,101.06298540923027">Yaskawa Chonburi</option>
    </select><br>

    <div id="customerContainer" class="customer-container"></div>

    <button id="addCustomerBtn" class="green">+ Add Customer</button>
    <button id="generateBtn" class="green">Generate Map</button>
    <button id="saveBtn" class="green">Save Plan</button>
    <button id="printBtn" class="green">Print PDF</button>
  </div>

  <div class="right-panel">
    <h3>Summary</h3>
    <div id="summaryContainer"></div>
  </div>
</div>

<div id="routeSummary"></div>
<div id="map"></div>

<script>
/* ---------------- Firebase ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCWTkIN4dKaRI1ZlyHxxhxovhoMGF_8wPc",
  authDomain: "cusdata-51e4f.firebaseapp.com",
  databaseURL: "https://cusdata-51e4f-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "cusdata-51e4f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let allData = [], allCustomers = [], customers = [], partData = [], userData = null;

/* ---------------- Auth + Load Data ---------------- */
firebase.auth().onAuthStateChanged(user => {
  if (!user) return;

  db.ref("users/" + user.uid).once("value", snap => {
    userData = snap.val();
    document.getElementById("loginNameDisplay").textContent = userData?.name || "Unknown";
  });

  Promise.all([
    db.ref("robot_data").once("value"),
    db.ref("part").once("value")
  ]).then(([robotSnap, partSnap]) => {
    allData = Object.values(robotSnap.val() || {});
    allCustomers = [...new Set(allData.map(d => d["Customer name"]).filter(Boolean))].sort();
    partData = Object.values(partSnap.val() || {});
    if (customers.length === 0) customers.push(createEmptyCustomer());
    renderCustomerCards();
    // init map เมื่อข้อมูลพร้อม แผนที่จะแสดงพื้นฐานก่อน
    initMap();
  });
});

/* ---------------- UI Events ---------------- */
document.getElementById("addCustomerBtn").onclick = () => { customers.push(createEmptyCustomer()); renderCustomerCards(); }

document.getElementById("generateBtn").onclick = () => {
  if (!validateTime()) return;
  customers.sort((a, b) => a.timeIn.localeCompare(b.timeIn));
  renderSummaries();
  generateMap(); // Leaflet + OSRM
}

document.getElementById("saveBtn").onclick = () => {
  if (!validateTime()) return;
  const visitDate = document.getElementById("visitDateInput").value;
  if (!visitDate || customers.length === 0) { alert("Please input date and customers"); return; }

  const originMap = {
    "13.784431483421942,100.58041213808076": "Yaskawa BKK",
    "13.092777336086302,101.06298540923027": "Yaskawa Chonburi"
  };
  const originValue = document.getElementById("originSelect").value;

  const plan = {
    timestamp: Date.now(),
    visitDate,
    startFrom: originMap[originValue] || originValue,
    loginName: userData?.name || "-",
    loginEmail: firebase.auth().currentUser?.email || "-",
    customers
  };

  db.ref("visit_plan").push(plan, e => { if (e) alert("Error"); else alert("Saved!"); });
}

document.getElementById("printBtn").onclick = () => {
  if (!validateTime()) return;
  customers.sort((a, b) => a.timeIn.localeCompare(b.timeIn));
  prepareMapForPrint();
}

/* ---------------- Helpers: Customers UI ---------------- */
function createEmptyCustomer() {
  return { name: "", timeIn: "08:00", timeOut: "09:00", companion: "", contactName: "", situation: "", visitDetail: "", opinion: "" };
}

function genTimeOpts(sel) {
  let h = "";
  for (let i = 8; i <= 23; i++) {
    ["00", "30"].forEach(m => {
      let t = `${i.toString().padStart(2, '0')}:${m}`;
      h += `<option ${t == sel ? "selected" : ""}>${t}</option>`;
    });
  }
  h += `<option ${sel == "24:00" ? "selected" : ""}>24:00</option>`;
  return h;
}

function removeCustomer(i) { customers.splice(i, 1); renderCustomerCards(); }

function renderCustomerCards() {
  const c = document.getElementById("customerContainer"); c.innerHTML = "";
  customers.forEach((cust, idx) => {
    const div = document.createElement("div"); div.className = "customer-card";
    div.innerHTML = `
      <button class="remove-btn" onclick="removeCustomer(${idx})">&times;</button>
      <label>Customer:</label><input type="text" id="customerInput${idx}" value="${cust.name}">
      <div style="display:flex; justify-content:space-between; gap:10px;">
        <div style="flex:0 0 40%;">
          <label>Time In:</label>
          <select class="timeIn compact-input" style="width: 80px;">${genTimeOpts(cust.timeIn)}</select>
        </div>
        <div style="flex:0 0 40%;">
          <label>Time Out:</label>
          <select class="timeOut compact-input" style="width: 80px;">${genTimeOpts(cust.timeOut)}</select>
        </div>
      </div>
      <label>Companion:</label><textarea class="companion">${cust.companion}</textarea>
      <label>Contact Name:</label><textarea class="contactName">${cust.contactName}</textarea>
      <label>Situation:</label><textarea class="situation">${cust.situation}</textarea>
      <label>Visit Detail:</label><textarea class="visitDetail">${cust.visitDetail}</textarea>
      <label>Opinion:</label><textarea class="opinion">${cust.opinion}</textarea>
    `;
    c.appendChild(div);

    new TomSelect(`#customerInput${idx}`, {
      options: allCustomers.map(c => ({ value: c, text: c })),
      items: cust.name ? [cust.name] : [],
      create: false,
      maxItems: 1,
      maxOptions: 10000,
      persist: false,
      placeholder: "--Select--",
      plugins: [],
      closeAfterSelect: true,
      onChange: val => { customers[idx].name = val; renderSummaries(); }
    });

    div.querySelector(".timeIn").onchange = e => { customers[idx].timeIn = e.target.value; }
    div.querySelector(".timeOut").onchange = e => { customers[idx].timeOut = e.target.value; }
    div.querySelector(".companion").oninput = e => { customers[idx].companion = e.target.value; }
    div.querySelector(".contactName").oninput = e => { customers[idx].contactName = e.target.value; }
    div.querySelector(".situation").oninput = e => { customers[idx].situation = e.target.value; }
    div.querySelector(".visitDetail").oninput = e => { customers[idx].visitDetail = e.target.value; }
    div.querySelector(".opinion").oninput = e => { customers[idx].opinion = e.target.value; }
  });
  renderSummaries();
}

function renderSummaries() {
  const s = document.getElementById("summaryContainer"); s.innerHTML = "";
  customers.forEach(cust => {
    if (!cust.name) return;
    const filtered = allData.filter(d => d["Customer name"] === cust.name);
    const models = {}, controllers = {}, parts = {};
    filtered.forEach(d => {
      models[d["Robot type"] || "Unknown"] = (models[d["Robot type"] || "Unknown"] || 0) + 1;
      controllers[d["Controller"] || "Unknown"] = (controllers[d["Controller"] || "Unknown"] || 0) + 1;
    });
    partData
      .filter(p => p.Customer && cust.name && p.Customer.toLowerCase().includes(cust.name.toLowerCase()))
      .forEach(p => {
        const y = p.Year || "-";
        parts[y] = parts[y] || { qty: 0, price: 0 };
        parts[y].qty += parseFloat(p.Qt || 0);
        parts[y].price += parseFloat((p.Price || "0").replace(/,/g, ''));
      });

    let html = `<div class="summary-block"><h4>${cust.name}</h4><table><tr><th>Model</th><th>Qty</th></tr>`;
    for (let [m, q] of Object.entries(models)) html += `<tr><td>${m}</td><td>${q}</td></tr>`;
    html += `</table><table><tr><th>Controller</th><th>Qty</th></tr>`;
    for (let [c, q] of Object.entries(controllers)) html += `<tr><td>${c}</td><td>${q}</td></tr>`;
    html += `</table>`;
    if (Object.keys(parts).length > 0) {
      html += `<table><tr><th>Year</th><th>Qty</th><th>Total Price</th></tr>`;
      for (let [y, d] of Object.entries(parts)) html += `<tr><td>${y}</td><td>${d.qty}</td><td>${d.price.toLocaleString()}</td></tr>`;
      html += `</table>`;
    }
    html += `</div>`;
    s.innerHTML += html;
  });
}

function validateTime() {
  for (let i = 0; i < customers.length; i++) {
    let c = customers[i];
    if (!c.timeIn || !c.timeOut) { alert("Time missing at customer " + (i + 1)); return false; }
    if (c.timeIn >= c.timeOut) { alert("Time In must be before Time Out at " + c.name); return false; }
    if (i > 0 && c.timeIn < customers[i - 1].timeOut) { alert("Time overlap at " + c.name); return false; }
  }
  return true;
}

/* ---------------- Leaflet Map + Routing ---------------- */
let map, routingControl, mapMarkers = [];

const gmapPin = (url) => L.icon({
  iconUrl: url,
  iconSize: [40, 40],
  iconAnchor: [20, 40],
  popupAnchor: [0, -35]
});

const redPin = gmapPin("https://maps.google.com/mapfiles/ms/icons/red-dot.png");
const bluePin = gmapPin("https://maps.google.com/mapfiles/ms/icons/blue-dot.png");
const greenPin = gmapPin("https://maps.google.com/mapfiles/ms/icons/green-dot.png");

function clearMapMarkers() {
  mapMarkers.forEach(m => map.removeLayer(m));
  mapMarkers = [];
}

function initMap() {
  map = L.map('map', { center: [13.736717, 100.523186], zoom: 6 });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);
}

function generateMap() {
  // เตรียม waypoints: origin + ลูกค้าตามลำดับเวลา
  const origin = document.getElementById("originSelect").value.split(",").map(Number);
  const originLatLng = L.latLng(origin[0], origin[1]);

  const stops = customers
    .map(c => {
      const d = allData.find(e => e["Customer name"] === c.name);
      if (!d || !d.Address) return null;
      const [lat, lng] = d.Address.split(",").map(Number);
      return { name: c.name, latlng: L.latLng(lat, lng) };
    })
    .filter(Boolean);

  if (stops.length === 0) { alert("No valid addresses"); return; }

  const waypoints = [originLatLng, ...stops.map(s => s.latlng)];

  // ลบ routing เดิม (ถ้ามี)
  if (routingControl) {
    map.removeControl(routingControl);
    routingControl = null;
  }
  clearMapMarkers();

  // วางหมุด origin (สีเขียว) และลูกค้า (แดง/น้ำเงิน)
  const originMarker = L.marker(originLatLng, { icon: greenPin }).addTo(map).bindPopup("Start: Origin");
  mapMarkers.push(originMarker);

  stops.forEach((s, i) => {
    const m = L.marker(s.latlng, { icon: i === stops.length - 1 ? bluePin : redPin })
      .addTo(map)
      .bindPopup(`<strong>${s.name}</strong>`);
    mapMarkers.push(m);
  });

  // Routing: OSRM demo server
  routingControl = L.Routing.control({
    waypoints: waypoints,
    router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
    lineOptions: { addWaypoints: false },
    show: false,
    collapsible: false,
    fitSelectedRoutes: true
  }).addTo(map);

  // อัปเดตสรุปเมื่อคำนวณเส้นทางเสร็จ
  routingControl.on('routesfound', function (e) {
    const route = e.routes[0];
    updateRouteSummaryFromRoute(route, stops);
  });

  routingControl.on('routingerror', function (e) {
    alert("Routing error (OSRM): " + (e?.error?.message || "unknown"));
  });
}

function secondsToHMS(sec) {
  const m = Math.round(sec / 60);
  if (m < 60) return `${m} min`;
  const h = Math.floor(m / 60);
  const mm = m % 60;
  return `${h} h ${mm} min`;
}

function metersToKM(m) {
  return (m / 1000).toFixed(1) + " km";
}

function updateRouteSummaryFromRoute(route, stops) {
  // Leaflet Routing Machine ไม่ให้ legs ชัดแบบ Google; แต่ summary ระยะรวม/เวลา รวมอยู่ใน route.summary
  // เราจะโชว์รวม และแสดงรายชื่อลูกค้าตามลำดับ (ระยะ/เวลาแบบย่อย LRM ไม่ expose ตรงๆ บน demo server)
  // ดังนั้น: แสดงตารางชื่อจุดแวะตามลำดับ + รวมทั้งหมด (ถ้าต้องได้ย่อยจริง ๆ ต้องแตก geometry เป็นช่วง ๆ และคำนวณเอง)
  const totalDist = route.summary.totalDistance; // meters
  const totalTime = route.summary.totalTime;     // seconds

  let html = `<h3>Route Summary</h3>
  <table>
    <tr><th>#</th><th>Customer</th></tr>`;

  stops.forEach((s, i) => {
    html += `<tr><td>${i + 1}</td><td>${s.name}</td></tr>`;
  });

  html += `</table>
  <h4>Total: ${metersToKM(totalDist)}, ${secondsToHMS(totalTime)}</h4>`;

  document.getElementById("routeSummary").innerHTML = html;
}

function prepareMapForPrint() {
  // fit bounds ครอบ origin + ลูกค้าทั้งหมด
  const group = L.featureGroup(mapMarkers);
  if (group.getLayers().length > 0) {
    map.fitBounds(group.getBounds(), { padding: [30, 30] });
    setTimeout(() => { window.print(); }, 800);
  } else {
    window.print();
  }
}

/* ---------------- Print Pointer Events ---------------- */
window.onbeforeprint = () => {
  document.getElementById("map").style.pointerEvents = "none";
};

window.onafterprint = () => {
  document.getElementById("map").style.pointerEvents = "auto";
};
</script>
</body>
</html>
