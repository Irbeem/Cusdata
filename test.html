<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>CS Calendar ‚Äî Summary Only</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background:#f6f8fb; color:#222; }
    header { padding:16px; background:#1976d2; color:#fff; }
    header h1 { margin:0 0 8px 0; font-size:1.4rem; }
    .container { padding:16px; }

    .panel {
      background:#fff; border:1px solid #e5e7eb; border-radius:12px;
      padding:12px; box-shadow:0 2px 10px rgba(0,0,0,0.04);
    }
    .controls {
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    }
    .controls label { font-weight:600; }
    .controls input[type="date"] {
      padding:6px 8px; font-size:15px; border:1px solid #d1d5db; border-radius:8px;
      background:#fff;
    }
    .btn {
      padding:8px 14px; border:none; border-radius:8px; cursor:pointer; font-weight:600;
    }
    .btn-primary { background:#1976d2; color:#fff; }
    .btn-outline { background:#fff; border:1px solid #9ca3af; color:#111827; }

    .hint { color:#6b7280; font-size:.9rem; margin-top:6px; }

    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ */
    #summary-range { margin-top:12px; overflow:auto; max-height:70vh; }
    #summary-range table {
      border-collapse: collapse; width:max-content; background:#fff; font-size:14px;
    }
    #summary-range th, #summary-range td {
      border:1px solid #e5e7eb; padding:6px 8px; text-align:right; white-space:nowrap;
      background:#fff; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™‡πÄ‡∏ß‡∏•‡∏≤ sticky ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô */
    }
    /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏Å‡∏£‡∏≠‡∏• (#summary-range) */
    #summary-range thead th {
      position: sticky; top:0; background:#eef3ff; z-index:3;
    }
    /* ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å‡πÉ‡∏´‡πâ sticky ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    #summary-range th:first-child, #summary-range td:first-child {
      position: sticky; left:0; background:#f9fafb; text-align:left; font-weight:700; z-index:2;
    }
    /* ‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô (‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å) ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡πÇ‡∏î‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏±‡∏á */
    #summary-range thead th:first-child { z-index:4; }

    #summary-range tfoot td { font-weight:700; background:#fff8e1; }

    .badge {
      display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff;
      color:#1f2937; font-size:12px; margin-left:6px;
    }

    .loading { padding:10px; color:#374151; }
    .error {
      padding:10px; color:#b91c1c; background:#fee2e2; border:1px solid #fecaca; border-radius:8px;
      margin-top:10px;
    }
  </style>
</head>
<body>
  <header>
    <h1>üìä CS BKK ‚Äî Summary <span class="badge">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ</span></h1>
    <div style="opacity:.9">‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠ ‚Äú‡∏Ñ‡∏ô‚Äù ‡πÅ‡∏•‡∏∞ ‚Äú‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô‚Äù</div>
  </header>

  <div class="container">
    <div class="panel">
      <div class="controls">
        <label>From:
          <input type="date" id="rangeStart">
        </label>
        <label>To:
          <input type="date" id="rangeEnd">
        </label>

        <button class="btn btn-primary" id="applyRange">üîç ‡∏™‡∏£‡∏∏‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</button>
        <button class="btn btn-outline" id="exportRangeCsv">üì§ Export CSV</button>

        <label style="margin-left:auto; display:flex; gap:6px; align-items:center;">
          <input type="checkbox" id="includeHoliday">
          ‡∏£‡∏ß‡∏° Holiday ‡πÉ‡∏ô‡∏™‡∏£‡∏∏‡∏õ
        </label>
        <label style="display:flex; gap:6px; align-items:center;">
          <input type="checkbox" id="sortByTotals" checked>
          ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏°‡∏≤‡∏Å‚Üí‡∏ô‡πâ‡∏≠‡∏¢
        </label>
      </div>
      <div class="hint">‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å From/To ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
      <div id="status" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>
      <div id="summary-range"></div>
    </div>
  </div>

<script>
  /********** üîß ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• **********/
  const SHEET_ID = '1ySiuPMVyrNOpNxx5fR0olf2Dbaq84zKVlVaVo6mFBi8';
  const CALENDAR_SHEET = 'Carlendar';
  const NAMES_SHEET = 'Names';

  /********** üìö ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å **********/
  let names = [];
  let allData = [];

  const BASE_JOB_TYPES = [
    "Service","Standby","Meeting","Inspection","Telephone",
    "Training","TrainingSafety","LTC","Warranty","RepairPP",
    "Sales","Leave","SafetyHealth","Other"
  ];

  /********** ‚õèÔ∏è Utils: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö Local **********/
  function pad(n){ return String(n).padStart(2,'0'); }
  function formatYMDLocal(d){
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function parseDateInputLocal(s){
    if(!s) return null;
    const [Y,M,D] = s.split('-').map(Number);
    if(!Y||!M||!D) return null;
    return new Date(Y, M-1, D);
  }
  function getCurrentMonthRange(){
    const now = new Date();
    const y = now.getFullYear(), m = now.getMonth();
    return { start:new Date(y,m,1), end:new Date(y,m+1,0) };
  }

  function rowToDate(d){
    const y = parseInt(d.year,10);
    const m = parseInt(d.month,10);
    const day = parseInt(d.date,10);
    if(Number.isNaN(y)||Number.isNaN(m)||Number.isNaN(day)) return null;
    return new Date(y, m-1, day);
  }
  function getAllDistinctNames(){
    const extra = new Set();
    allData.forEach(d=>{
      if(d.name && !names.includes(d.name)) extra.add(d.name);
    });
    return [...names, ...[...extra].sort()];
  }
  function parseGvizTextToJson(txt){
    return JSON.parse(txt.substring(47).slice(0,-2));
  }

  /********** üì• ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• **********/
  async function loadData(){
    const status=document.getElementById('status');
    status.className='loading';
    status.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶';
    try{
      const base=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
      const [namesTxt,dataTxt]=await Promise.all([
        fetch(`${base}&sheet=${encodeURIComponent(NAMES_SHEET)}`).then(r=>r.text()),
        fetch(`${base}&sheet=${encodeURIComponent(CALENDAR_SHEET)}`).then(r=>r.text())
      ]);
      const namesJson=parseGvizTextToJson(namesTxt);
      names=namesJson.table.rows
        .map(r=>r.c[0]?.v)
        .filter(n=>n && String(n).toLowerCase()!=='summary');

      const dataJson=parseGvizTextToJson(dataTxt);
      const cols=dataJson.table.cols.map(c=>c.label);
      allData=dataJson.table.rows.map(r=>{
        const o={};
        r.c.forEach((c,i)=>o[cols[i]]=c?.v??"");
        return o;
      });

      status.textContent='‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      setTimeout(()=>{status.textContent='';},600);
      return true;
    }catch(err){
      console.error(err);
      status.className='error';
      status.textContent='‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ä‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏ä‡∏µ‡∏ï';
      return false;
    }
  }

  /********** üßÆ ‡∏™‡∏£‡∏∏‡∏õ **********/
  function renderRangeSummary(){
    const box=document.getElementById('summary-range');
    const status=document.getElementById('status');
    const startInput=document.getElementById('rangeStart');
    const endInput=document.getElementById('rangeEnd');
    const includeHoliday=document.getElementById('includeHoliday').checked;
    const sortByTotals=document.getElementById('sortByTotals')?.checked ?? true;

    if(!Array.isArray(allData)||allData.length===0){
      box.innerHTML=''; status.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡∏£‡∏∏‡∏õ'; return;
    }

    const JOB_TYPES=includeHoliday?[...BASE_JOB_TYPES,'Holiday']:[...BASE_JOB_TYPES];

    let startDate=parseDateInputLocal(startInput.value);
    let endDate=parseDateInputLocal(endInput.value);
    if(!startDate||!endDate){
      const {start,end}=getCurrentMonthRange();
      startDate=start; endDate=end;
      if(!startInput.value) startInput.value=formatYMDLocal(startDate);
      if(!endInput.value)   endInput.value=formatYMDLocal(endDate);
    }
    endDate=new Date(endDate.getFullYear(),endDate.getMonth(),endDate.getDate(),23,59,59,999);

    const nameList=getAllDistinctNames();
    const tableMap={};
    nameList.forEach(n=>{
      tableMap[n]={};
      JOB_TYPES.forEach(t=>tableMap[n][t]=0);
    });

    let matched=0;
    allData.forEach(d=>{
      const dt=rowToDate(d);
      if(!dt) return;
      if(dt>=startDate && dt<=endDate){
        const nm=d.name||'', tp=d.type||'';
        if(nm && JOB_TYPES.includes(tp)){
          tableMap[nm][tp]+=1; matched++;
        }
      }
    });
    if(matched===0){ box.innerHTML=''; status.textContent='‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ'; return; }

    const colTotalsRaw={};
    JOB_TYPES.forEach(t=>colTotalsRaw[t]=0);
    nameList.forEach(nm=>{
      JOB_TYPES.forEach(tp=>{ colTotalsRaw[tp]+=(tableMap[nm][tp]||0); });
    });
    const TYPES_ORDER=sortByTotals
      ?[...JOB_TYPES].sort((a,b)=>colTotalsRaw[b]-colTotalsRaw[a]||a.localeCompare(b))
      :[...JOB_TYPES];

    const colTotals={};
    TYPES_ORDER.forEach(t=>colTotals[t]=colTotalsRaw[t]);

    const rowsHtml=nameList.map(nm=>{
      const tds=TYPES_ORDER.map(tp=>`<td>${tableMap[nm][tp]||0}</td>`);
      const rowSum=TYPES_ORDER.reduce((s,tp)=>s+(tableMap[nm][tp]||0),0);
      return `<tr><td>${nm}</td>${tds.join('')}<td>${rowSum}</td></tr>`;
    }).join('');

    const grandTotal=TYPES_ORDER.reduce((s,tp)=>s+colTotals[tp],0);
    const footerHtml=`
      <tr>
        <td>‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô</td>
        ${TYPES_ORDER.map(tp=>`<td>${colTotals[tp]}</td>`).join('')}
        <td>${grandTotal}</td>
      </tr>`;

    const headStartTxt=startInput.value;
    const headEndTxt=endInput.value;

    const html=`
      <div style="font-weight:700; margin:8px 0;">
        ‡∏ä‡πà‡∏ß‡∏á ${headStartTxt} ‡∏ñ‡∏∂‡∏á ${headEndTxt}
        ${includeHoliday?'<span class="badge">‡∏£‡∏ß‡∏° Holiday</span>':''}
        ${sortByTotals?'<span class="badge">‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>':''}
      </div>
      <table id="summary-range-table">
        <thead>
          <tr>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            ${TYPES_ORDER.map(t=>`<th>${t}</th>`).join('')}
            <th>‡∏£‡∏ß‡∏°/‡∏Ñ‡∏ô</th>
          </tr>
        </thead>
        <tbody>${rowsHtml}</tbody>
        <tfoot>${footerHtml}</tfoot>
      </table>`;
    box.innerHTML=html;
    status.textContent='';
  }

  /********** üì§ Export CSV **********/
  function exportRangeSummaryCSV(){
    const includeHoliday=document.getElementById('includeHoliday').checked;
    const sortByTotals=document.getElementById('sortByTotals')?.checked ?? true;
    const JOB_TYPES=includeHoliday?[...BASE_JOB_TYPES,'Holiday']:[...BASE_JOB_TYPES];

    const start=document.getElementById('rangeStart').value;
    const end=document.getElementById('rangeEnd').value;

    let startDate=parseDateInputLocal(start);
    let endDate=parseDateInputLocal(end);
    if(!startDate||!endDate){
      const {start:s,end:e}=getCurrentMonthRange();
      startDate=s; endDate=e;
    }
    endDate=new Date(endDate.getFullYear(),endDate.getMonth(),endDate.getDate(),23,59,59,999);

    const nameList=getAllDistinctNames();
    const tableMap={};
    nameList.forEach(n=>{
      tableMap[n]={};
      JOB_TYPES.forEach(t=>tableMap[n][t]=0);
    });

    allData.forEach(d=>{
      const dt=rowToDate(d);
      if(!dt) return;
      if(dt>=startDate && dt<=endDate){
        const nm=d.name||'', tp=d.type||'';
        if(nm && JOB_TYPES.includes(tp)) tableMap[nm][tp]+=1;
      }
    });

    const colTotalsRaw={};
    JOB_TYPES.forEach(t=>colTotalsRaw[t]=0);
    nameList.forEach(nm=>{
      JOB_TYPES.forEach(tp=>{ colTotalsRaw[tp]+=(tableMap[nm][tp]||0); });
    });
    const TYPES_ORDER=sortByTotals
      ?[...JOB_TYPES].sort((a,b)=>colTotalsRaw[b]-colTotalsRaw[a]||a.localeCompare(b))
      :[...JOB_TYPES];

    const headers=["Name",...TYPES_ORDER,"TotalPerPerson"];
    const rows=[headers.join(",")];
    nameList.forEach(nm=>{
      const counts=TYPES_ORDER.map(tp=>tableMap[nm][tp]||0);
      const sum=counts.reduce((s,v)=>s+v,0);
      rows.push([nm,...counts,sum].join(","));
    });
    const colTotals=TYPES_ORDER.map(tp=>nameList.reduce((s,nm)=>s+(tableMap[nm][tp]||0),0));
    const grand=colTotals.reduce((s,v)=>s+v,0);
    rows.push(["TOTAL_BY_TYPE",...colTotals,grand].join(","));

    const BOM="\uFEFF";
    const csvContent=BOM+rows.join("\n");
    const blob=new Blob([csvContent],{type:"text/csv;charset=utf-8;"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    const startName=start||formatYMDLocal(startDate);
    const endName=end||formatYMDLocal(endDate);
    a.download=`summary_${startName}_${endName}${includeHoliday?'_withHoliday':''}${sortByTotals?'_sorted':''}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  /********** üîó Bind & Init **********/
  function bindEvents(){
    document.getElementById('applyRange').onclick=renderRangeSummary;
    document.getElementById('exportRangeCsv').onclick=exportRangeSummaryCSV;
    document.getElementById('rangeStart').onchange=renderRangeSummary;
    document.getElementById('rangeEnd').onchange=renderRangeSummary;
    document.getElementById('includeHoliday').onchange=renderRangeSummary;
  }

  (async function init(){
    bindEvents();
    const ok=await loadData();
    if(!ok) return;
    const startInput=document.getElementById('rangeStart');
    const endInput=document.getElementById('rangeEnd');
    if(!startInput.value||!endInput.value){
      const {start,end}=getCurrentMonthRange();
      startInput.value=formatYMDLocal(start);
      endInput.value=formatYMDLocal(end);
    }
    renderRangeSummary();
  })();
</script>
</body>
</html>
